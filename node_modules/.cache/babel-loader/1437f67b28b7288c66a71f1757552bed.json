{"ast":null,"code":"import _createForOfIteratorHelper from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _toConsumableArray from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _slicedToArray from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{NewConsoleMessageEvent,RoomInviteErrorEvent,RoomInviteEvent,SendMessageComposer as SendMessageComposerPacket}from'@nitrots/nitro-renderer';import{useCallback,useEffect,useMemo,useState}from'react';import{useBetween}from'use-between';import{CloneObject,GetSessionDataManager,LocalizeText,MessengerIconState,MessengerThread,MessengerThreadChat,NotificationAlertType,NotificationUtilities,PlaySound,SendMessageComposer,SoundNames}from'../../api';import{UseMessageEventHook}from'../messages';import{useFriends}from'./useFriends';var useMessengerState=function useMessengerState(){var _useState=useState([]),_useState2=_slicedToArray(_useState,2),messageThreads=_useState2[0],setMessageThreads=_useState2[1];var _useState3=useState(-1),_useState4=_slicedToArray(_useState3,2),activeThreadId=_useState4[0],setActiveThreadId=_useState4[1];var _useState5=useState([]),_useState6=_slicedToArray(_useState5,2),hiddenThreadIds=_useState6[0],setHiddenThreadIds=_useState6[1];var _useState7=useState(MessengerIconState.HIDDEN),_useState8=_slicedToArray(_useState7,2),iconState=_useState8[0],setIconState=_useState8[1];var _useFriends=useFriends(),_useFriends$getFriend=_useFriends.getFriend,getFriend=_useFriends$getFriend===void 0?null:_useFriends$getFriend;var visibleThreads=useMemo(function(){return messageThreads.filter(function(thread){return hiddenThreadIds.indexOf(thread.threadId)===-1;});},[messageThreads,hiddenThreadIds]);var activeThread=useMemo(function(){return activeThreadId>0&&visibleThreads.find(function(thread){return thread.threadId===activeThreadId||null;});},[activeThreadId,visibleThreads]);var getMessageThread=useCallback(function(userId){var thread=messageThreads.find(function(thread){return thread.participant&&thread.participant.id===userId;});if(thread)return thread;var friend=getFriend(userId);if(!friend)return null;thread=new MessengerThread(friend);setMessageThreads(function(prevValue){var newValue=_toConsumableArray(prevValue);newValue.push(thread);return newValue;});setHiddenThreadIds(function(prevValue){var index=prevValue.indexOf(thread.threadId);if(index===-1)return prevValue;var newValue=_toConsumableArray(prevValue);newValue.splice(index,1);return newValue;});return thread;},[messageThreads,getFriend]);var closeThread=function closeThread(threadId){setHiddenThreadIds(function(prevValue){var newValue=_toConsumableArray(prevValue);if(newValue.indexOf(threadId)>=0)return prevValue;newValue.push(threadId);return newValue;});};var sendMessage=function sendMessage(thread,text){if(!thread||!text||!text.length)return;SendMessageComposer(new SendMessageComposerPacket(thread.participant.id,text));if(messageThreads.length===1&&thread.groups.length===1)PlaySound(SoundNames.MESSENGER_NEW_THREAD);setMessageThreads(function(prevValue){var newValue=_toConsumableArray(prevValue);var index=newValue.findIndex(function(newThread){return newThread.threadId===thread.threadId;});if(index===-1)return prevValue;newValue[index]=CloneObject(newValue[index]);thread=newValue[index];thread.addMessage(GetSessionDataManager().userId,text,0,null,MessengerThreadChat.CHAT);if(activeThreadId===thread.threadId)thread.setRead();return newValue;});};var onNewConsoleMessageEvent=useCallback(function(event){var parser=event.getParser();setMessageThreads(function(prevValue){var newValue=_toConsumableArray(prevValue);var existingIndex=newValue.findIndex(function(newThread){return newThread.participant&&newThread.participant.id===parser.senderId;});var thread=null;if(existingIndex===-1){var friend=getFriend(parser.senderId);if(friend){thread=new MessengerThread(friend);newValue.push(thread);}}else{newValue[existingIndex]=CloneObject(newValue[existingIndex]);thread=newValue[existingIndex];}thread.addMessage(parser.senderId,parser.messageText,parser.secondsSinceSent,parser.extraData);if(activeThreadId===thread.threadId)thread.setRead();if(thread.unreadCount>0)PlaySound(SoundNames.MESSENGER_MESSAGE_RECEIVED);return newValue;});},[activeThreadId,getFriend]);UseMessageEventHook(NewConsoleMessageEvent,onNewConsoleMessageEvent);var onRoomInviteEvent=useCallback(function(event){var parser=event.getParser();setMessageThreads(function(prevValue){var newValue=_toConsumableArray(prevValue);var existingIndex=newValue.findIndex(function(newThread){return newThread.participant&&newThread.participant.id===parser.senderId;});var thread=null;if(existingIndex===-1){var friend=getFriend(parser.senderId);if(friend){thread=new MessengerThread(friend);newValue.push(thread);}}else{newValue[existingIndex]=CloneObject(newValue[existingIndex]);thread=newValue[existingIndex];}thread.addMessage(null,parser.messageText,0,null,MessengerThreadChat.ROOM_INVITE);if(activeThreadId===thread.threadId)thread.setRead();if(thread.unreadCount>0)PlaySound(SoundNames.MESSENGER_MESSAGE_RECEIVED);return newValue;});},[activeThreadId,getFriend]);UseMessageEventHook(RoomInviteEvent,onRoomInviteEvent);var onRoomInviteErrorEvent=useCallback(function(event){var parser=event.getParser();var message='Received room invite error: errorCode: '+parser.errorCode+', recipients: '+parser.failedRecipients;NotificationUtilities.simpleAlert(message,NotificationAlertType.DEFAULT,null,null,LocalizeText('friendlist.alert.title'));},[]);UseMessageEventHook(RoomInviteErrorEvent,onRoomInviteErrorEvent);useEffect(function(){if(activeThreadId<=0)return;setMessageThreads(function(prevValue){var newValue=_toConsumableArray(prevValue);var existingIndex=newValue.findIndex(function(newThread){return newThread.threadId===activeThreadId;});if(existingIndex===-1)return;newValue[existingIndex]=CloneObject(newValue[existingIndex]);newValue[existingIndex].setRead();return newValue;});},[activeThreadId]);useEffect(function(){setIconState(function(prevValue){if(!visibleThreads.length)return MessengerIconState.HIDDEN;var isUnread=false;var _iterator=_createForOfIteratorHelper(visibleThreads),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var thread=_step.value;if(thread.unreadCount>0){isUnread=true;break;}}}catch(err){_iterator.e(err);}finally{_iterator.f();}if(isUnread)return MessengerIconState.UNREAD;return MessengerIconState.SHOW;});},[visibleThreads]);return{messageThreads:messageThreads,activeThread:activeThread,iconState:iconState,visibleThreads:visibleThreads,getMessageThread:getMessageThread,setActiveThreadId:setActiveThreadId,closeThread:closeThread,sendMessage:sendMessage};};export var useMessenger=function useMessenger(){return useBetween(useMessengerState);};","map":null,"metadata":{},"sourceType":"module"}