{"ast":null,"code":"import _toConsumableArray from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _slicedToArray from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{GetGuestRoomResultEvent,NitroPoint,RoomChatSettings,RoomChatSettingsEvent,RoomDragEvent}from'@nitrots/nitro-renderer';import{useCallback,useEffect,useRef,useState}from'react';import{AddWorkerEventTracker,GetConfiguration,RemoveWorkerEventTracker,RoomChatFormatter,RoomWidgetChatSelectAvatarMessage,RoomWidgetRoomObjectMessage,RoomWidgetUpdateChatEvent,SendWorkerEvent}from'../../../../api';import{UseEventDispatcherHook,UseMessageEventHook,UseRoomEngineEvent}from'../../../../hooks';import{useRoomContext}from'../../RoomContext';import{ChatWidgetMessageView}from'./ChatWidgetMessageView';import{ChatBubbleMessage}from'./common/ChatBubbleMessage';import{DoChatsOverlap}from'./common/DoChatsOverlap';import{jsx as _jsx}from\"react/jsx-runtime\";var TIMER_TRACKER=0;export var ChatWidgetView=function ChatWidgetView(props){var _useState=useState({mode:RoomChatSettings.CHAT_MODE_FREE_FLOW,weight:RoomChatSettings.CHAT_BUBBLE_WIDTH_NORMAL,speed:RoomChatSettings.CHAT_SCROLL_SPEED_NORMAL,distance:50,protection:RoomChatSettings.FLOOD_FILTER_NORMAL}),_useState2=_slicedToArray(_useState,2),chatSettings=_useState2[0],setChatSettings=_useState2[1];var _useState3=useState([]),_useState4=_slicedToArray(_useState3,2),chatMessages=_useState4[0],setChatMessages=_useState4[1];var _useState5=useState(TIMER_TRACKER++),_useState6=_slicedToArray(_useState5,2),timerId=_useState6[0],setTimerId=_useState6[1];var _useRoomContext=useRoomContext(),_useRoomContext$roomS=_useRoomContext.roomSession,roomSession=_useRoomContext$roomS===void 0?null:_useRoomContext$roomS,_useRoomContext$event=_useRoomContext.eventDispatcher,eventDispatcher=_useRoomContext$event===void 0?null:_useRoomContext$event,_useRoomContext$widge=_useRoomContext.widgetHandler,widgetHandler=_useRoomContext$widge===void 0?null:_useRoomContext$widge;var elementRef=useRef();var removeHiddenChats=useCallback(function(){setChatMessages(function(prevValue){if(prevValue){var newMessages=prevValue.filter(function(chat){return chat.top>-chat.height*2;});if(newMessages.length!==prevValue.length)return newMessages;}return prevValue;});},[]);var moveAllChatsUp=useCallback(function(amount){setChatMessages(function(prevValue){if(prevValue){prevValue.forEach(function(chat){if(chat.skipMovement){chat.skipMovement=false;return;}chat.top-=amount;});}return prevValue;});removeHiddenChats();},[removeHiddenChats]);var checkOverlappingChats=useCallback(function(chat,moved,tempChats){var totalChats=chatMessages.length;if(!totalChats)return;for(var i=totalChats-1;i>=0;i--){var collides=chatMessages[i];if(!collides||chat===collides||tempChats.indexOf(collides)>=0||collides.top-moved>=chat.top+chat.height)continue;if(DoChatsOverlap(chat,collides,-moved,4)){var amount=Math.abs(collides.top+collides.height-chat.top);tempChats.push(collides);collides.top-=amount;collides.skipMovement=true;checkOverlappingChats(collides,amount,tempChats);}}},[chatMessages]);var makeRoom=useCallback(function(chat){if(chatSettings.mode===RoomChatSettings.CHAT_MODE_FREE_FLOW){chat.skipMovement=true;checkOverlappingChats(chat,0,[chat]);removeHiddenChats();}else{var lowestPoint=chat.top+chat.height;var requiredSpace=chat.height;var spaceAvailable=elementRef.current.offsetHeight-lowestPoint;var amount=requiredSpace-spaceAvailable;if(spaceAvailable<requiredSpace){chatMessages.forEach(function(existingChat){if(existingChat===chat)return;existingChat.top-=amount;});removeHiddenChats();}}},[chatSettings,chatMessages,removeHiddenChats,checkOverlappingChats]);var onRoomWidgetUpdateChatEvent=useCallback(function(event){var chatMessage=new ChatBubbleMessage(event.userId,event.userCategory,event.roomId,event.text,RoomChatFormatter(event.text,event.styleId),event.userName,new NitroPoint(event.userX,event.userY),event.chatType,event.styleId,event.userImage,event.userColor&&('#'+event.userColor.toString(16).padStart(6,'0')||null));setChatMessages(function(prevValue){return[].concat(_toConsumableArray(prevValue),[chatMessage]);});},[]);UseEventDispatcherHook(RoomWidgetUpdateChatEvent.CHAT_EVENT,eventDispatcher,onRoomWidgetUpdateChatEvent);var onRoomDragEvent=useCallback(function(event){if(!chatMessages.length||event.roomId!==roomSession.roomId)return;var offsetX=event.offsetX;chatMessages.forEach(function(chat){return chat.elementRef&&(chat.left+=offsetX);});},[roomSession,chatMessages]);UseRoomEngineEvent(RoomDragEvent.ROOM_DRAG,onRoomDragEvent);var onChatClicked=useCallback(function(chat){widgetHandler.processWidgetMessage(new RoomWidgetRoomObjectMessage(RoomWidgetRoomObjectMessage.GET_OBJECT_INFO,chat.senderId,chat.senderCategory));widgetHandler.processWidgetMessage(new RoomWidgetChatSelectAvatarMessage(RoomWidgetChatSelectAvatarMessage.MESSAGE_SELECT_AVATAR,chat.senderId,chat.username,chat.roomId));},[widgetHandler]);var getScrollSpeed=useCallback(function(){if(!chatSettings)return 6000;switch(chatSettings.speed){case RoomChatSettings.CHAT_SCROLL_SPEED_FAST:return 3000;case RoomChatSettings.CHAT_SCROLL_SPEED_NORMAL:return 6000;case RoomChatSettings.CHAT_SCROLL_SPEED_SLOW:return 12000;}},[chatSettings]);var onGetGuestRoomResultEvent=useCallback(function(event){var parser=event.getParser();if(!parser.roomEnter)return;setChatSettings(parser.chat);},[]);UseMessageEventHook(GetGuestRoomResultEvent,onGetGuestRoomResultEvent);var onRoomChatSettingsEvent=useCallback(function(event){var parser=event.getParser();setChatSettings(parser.chat);},[]);UseMessageEventHook(RoomChatSettingsEvent,onRoomChatSettingsEvent);useEffect(function(){var resize=function resize(event){if(!elementRef||!elementRef.current)return;var currentHeight=elementRef.current.offsetHeight;var newHeight=Math.round(document.body.offsetHeight*GetConfiguration('chat.viewer.height.percentage'));elementRef.current.style.height=\"\".concat(newHeight,\"px\");setChatMessages(function(prevValue){if(prevValue){prevValue.forEach(function(chat){return chat.top-=currentHeight-newHeight;});}return prevValue;});};window.addEventListener('resize',resize);resize(null);return function(){window.removeEventListener('resize',resize);};},[]);var workerMessageReceived=useCallback(function(message){switch(message.type){case'MOVE_CHATS':moveAllChatsUp(15);return;}},[moveAllChatsUp]);useEffect(function(){var workerTracker={workerMessageReceived:workerMessageReceived};AddWorkerEventTracker(workerTracker);SendWorkerEvent({type:'CREATE_INTERVAL',time:getScrollSpeed(),timerId:timerId,response:{type:'MOVE_CHATS'}});return function(){SendWorkerEvent({type:'REMOVE_INTERVAL',timerId:timerId});RemoveWorkerEventTracker(workerTracker);};},[timerId,workerMessageReceived,getScrollSpeed]);return/*#__PURE__*/_jsx(\"div\",{ref:elementRef,className:\"nitro-chat-widget\",children:chatMessages.map(function(chat){return/*#__PURE__*/_jsx(ChatWidgetMessageView,{chat:chat,makeRoom:makeRoom,onChatClicked:onChatClicked,bubbleWidth:chatSettings.weight},chat.id);})});};","map":null,"metadata":{},"sourceType":"module"}