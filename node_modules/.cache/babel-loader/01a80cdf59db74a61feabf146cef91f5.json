{"ast":null,"code":"import _createForOfIteratorHelper from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _assertThisInitialized from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js\";import _inherits from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{NitroLogger}from'../../core';import{NitroManager}from'../../core/common/NitroManager';import{NitroEvent}from'../../core/events/NitroEvent';import{Nitro}from'../Nitro';import{FigureDataContainer}from'../utils/FigureDataContainer';import{AssetAliasCollection}from'./alias/AssetAliasCollection';import{AvatarAssetDownloadManager}from'./AvatarAssetDownloadManager';import{AvatarFigureContainer}from'./AvatarFigureContainer';import{AvatarImage}from'./AvatarImage';import{AvatarStructure}from'./AvatarStructure';import{HabboAvatarAnimations}from'./data/HabboAvatarAnimations';import{HabboAvatarGeometry}from'./data/HabboAvatarGeometry';import{HabboAvatarPartSets}from'./data/HabboAvatarPartSets';import{EffectAssetDownloadManager}from'./EffectAssetDownloadManager';import{AvatarSetType}from'./enum/AvatarSetType';import{AvatarRenderEvent}from'./events/AvatarRenderEvent';import{PlaceHolderAvatarImage}from'./PlaceHolderAvatarImage';import{AvatarStructureDownload}from'./structure/AvatarStructureDownload';export var AvatarRenderManager=/*#__PURE__*/function(_NitroManager){_inherits(AvatarRenderManager,_NitroManager);var _super=_createSuper(AvatarRenderManager);function AvatarRenderManager(){var _this;_classCallCheck(this,AvatarRenderManager);_this=_super.call(this);_this._aliasCollection=void 0;_this._structure=void 0;_this._avatarAssetDownloadManager=void 0;_this._effectAssetDownloadManager=void 0;_this._placeHolderFigure=void 0;_this._figureMapReady=void 0;_this._effectMapReady=void 0;_this._actionsReady=void 0;_this._structureReady=void 0;_this._geometryReady=void 0;_this._partSetsReady=void 0;_this._animationsReady=void 0;_this._isReady=void 0;_this._structure=null;_this._avatarAssetDownloadManager=null;_this._placeHolderFigure=null;_this._figureMapReady=false;_this._effectMapReady=false;_this._actionsReady=false;_this._geometryReady=false;_this._partSetsReady=false;_this._animationsReady=false;_this._isReady=false;_this.onAvatarAssetDownloaderReady=_this.onAvatarAssetDownloaderReady.bind(_assertThisInitialized(_this));_this.onAvatarAssetDownloaded=_this.onAvatarAssetDownloaded.bind(_assertThisInitialized(_this));_this.onEffectAssetDownloaderReady=_this.onEffectAssetDownloaderReady.bind(_assertThisInitialized(_this));_this.onEffectAssetDownloaded=_this.onEffectAssetDownloaded.bind(_assertThisInitialized(_this));_this.onAvatarStructureDownloadDone=_this.onAvatarStructureDownloadDone.bind(_assertThisInitialized(_this));return _this;}_createClass(AvatarRenderManager,[{key:\"onInit\",value:function onInit(){this._structure=new AvatarStructure(this);this.loadGeometry();this.loadPartSets();this.loadActions();this.loadAnimations();this.loadFigureData();this._aliasCollection=new AssetAliasCollection(this,Nitro.instance.core.asset);this._aliasCollection.init();if(!this._avatarAssetDownloadManager){this._avatarAssetDownloadManager=new AvatarAssetDownloadManager(Nitro.instance.core.asset,this._structure);this._avatarAssetDownloadManager.addEventListener(AvatarAssetDownloadManager.DOWNLOADER_READY,this.onAvatarAssetDownloaderReady);this._avatarAssetDownloadManager.addEventListener(AvatarAssetDownloadManager.LIBRARY_LOADED,this.onAvatarAssetDownloaded);}if(!this._effectAssetDownloadManager){this._effectAssetDownloadManager=new EffectAssetDownloadManager(Nitro.instance.core.asset,this._structure);this._effectAssetDownloadManager.addEventListener(EffectAssetDownloadManager.DOWNLOADER_READY,this.onEffectAssetDownloaderReady);this._effectAssetDownloadManager.addEventListener(EffectAssetDownloadManager.LIBRARY_LOADED,this.onEffectAssetDownloaded);}this.checkReady();}},{key:\"onDispose\",value:function onDispose(){if(this._avatarAssetDownloadManager){this._avatarAssetDownloadManager.removeEventListener(AvatarAssetDownloadManager.DOWNLOADER_READY,this.onAvatarAssetDownloaderReady);this._avatarAssetDownloadManager.removeEventListener(AvatarAssetDownloadManager.LIBRARY_LOADED,this.onAvatarAssetDownloaded);}if(this._effectAssetDownloadManager){this._effectAssetDownloadManager.removeEventListener(EffectAssetDownloadManager.DOWNLOADER_READY,this.onEffectAssetDownloaderReady);this._effectAssetDownloadManager.removeEventListener(EffectAssetDownloadManager.LIBRARY_LOADED,this.onEffectAssetDownloaded);}}},{key:\"loadGeometry\",value:function loadGeometry(){if(!this._structure)return;this._structure.initGeometry(HabboAvatarGeometry.geometry);this._geometryReady=true;this.checkReady();}},{key:\"loadPartSets\",value:function loadPartSets(){if(!this._structure)return;this._structure.initPartSets(HabboAvatarPartSets.partSets);this._partSetsReady=true;this.checkReady();}},{key:\"loadActions\",value:function loadActions(){var _this2=this;var defaultActions=Nitro.instance.getConfiguration('avatar.default.actions');if(defaultActions)this._structure.initActions(Nitro.instance.core.asset,defaultActions);var request=new XMLHttpRequest();try{request.open('GET',Nitro.instance.getConfiguration('avatar.actions.url'));request.send();request.onloadend=function(e){if(!_this2._structure)return;_this2._structure.updateActions(JSON.parse(request.responseText));_this2._actionsReady=true;_this2.checkReady();};request.onerror=function(e){throw new Error('invalid_avatar_actions');};}catch(e){this.logger.error(e);}}},{key:\"loadAnimations\",value:function loadAnimations(){if(!this._structure)return;this._structure.initAnimation(HabboAvatarAnimations.animations);this._animationsReady=true;this.checkReady();}},{key:\"loadFigureData\",value:function loadFigureData(){var defaultFigureData=Nitro.instance.getConfiguration('avatar.default.figuredata');if(!defaultFigureData||typeof defaultFigureData==='string'){NitroLogger.log('XML figuredata is no longer supported.');return;}if(this._structure)this._structure.initFigureData(defaultFigureData);var structureDownloader=new AvatarStructureDownload(Nitro.instance.getConfiguration('avatar.figuredata.url'),this._structure.figureData);structureDownloader.addEventListener(AvatarStructureDownload.AVATAR_STRUCTURE_DONE,this.onAvatarStructureDownloadDone);}},{key:\"onAvatarStructureDownloadDone\",value:function onAvatarStructureDownloadDone(event){this._structureReady=true;this._structure.init();this.checkReady();}},{key:\"onAvatarAssetDownloaderReady\",value:function onAvatarAssetDownloaderReady(event){if(!event)return;this._figureMapReady=true;this.checkReady();}},{key:\"onAvatarAssetDownloaded\",value:function onAvatarAssetDownloaded(event){if(!event)return;this._aliasCollection.reset();}},{key:\"onEffectAssetDownloaderReady\",value:function onEffectAssetDownloaderReady(event){if(!event)return;this._effectMapReady=true;this.checkReady();}},{key:\"onEffectAssetDownloaded\",value:function onEffectAssetDownloaded(event){if(!event)return;this._aliasCollection.reset();}},{key:\"checkReady\",value:function checkReady(){if(this._isReady)return;if(!this._geometryReady||!this._partSetsReady||!this._actionsReady||!this._animationsReady||!this._figureMapReady||!this._effectMapReady||!this._structureReady)return;this._isReady=true;if(this.events)this.events.dispatchEvent(new NitroEvent(AvatarRenderEvent.AVATAR_RENDER_READY));}},{key:\"createFigureContainer\",value:function createFigureContainer(figure){return new AvatarFigureContainer(figure);}},{key:\"isFigureContainerReady\",value:function isFigureContainerReady(container){if(!this._avatarAssetDownloadManager)return false;return this._avatarAssetDownloadManager.isAvatarFigureContainerReady(container);}},{key:\"createAvatarImage\",value:function createAvatarImage(figure,size,gender){var listener=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var effectListener=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(!this._structure||!this._avatarAssetDownloadManager)return null;var figureContainer=new AvatarFigureContainer(figure);if(gender)this.validateAvatarFigure(figureContainer,gender);if(this._avatarAssetDownloadManager.isAvatarFigureContainerReady(figureContainer)){return new AvatarImage(this._structure,this._aliasCollection,figureContainer,size,this._effectAssetDownloadManager,effectListener);}if(!this._placeHolderFigure)this._placeHolderFigure=new AvatarFigureContainer(AvatarRenderManager.DEFAULT_FIGURE);this._avatarAssetDownloadManager.downloadAvatarFigure(figureContainer,listener);return new PlaceHolderAvatarImage(this._structure,this._aliasCollection,this._placeHolderFigure,size,this._effectAssetDownloadManager);}},{key:\"downloadAvatarFigure\",value:function downloadAvatarFigure(container,listener){if(!this._avatarAssetDownloadManager)return;this._avatarAssetDownloadManager.downloadAvatarFigure(container,listener);}},{key:\"validateAvatarFigure\",value:function validateAvatarFigure(container,gender){var isValid=false;var typeIds=this._structure.getMandatorySetTypeIds(gender,2);if(typeIds){var figureData=this._structure.figureData;var _iterator=_createForOfIteratorHelper(typeIds),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var id=_step.value;if(!container.hasPartType(id)){var figurePartSet=this._structure.getDefaultPartSet(id,gender);if(figurePartSet){container.updatePart(id,figurePartSet.id,[0]);isValid=true;}}else{var setType=figureData.getSetType(id);if(setType){var _figurePartSet=setType.getPartSet(container.getPartSetId(id));if(!_figurePartSet){var partSet=this._structure.getDefaultPartSet(id,gender);if(partSet){container.updatePart(id,partSet.id,[0]);isValid=true;}}}}}}catch(err){_iterator.e(err);}finally{_iterator.f();}}return!isValid;}},{key:\"getFigureClubLevel\",value:function getFigureClubLevel(container,gender){var searchParts=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(!this._structure)return 0;var figureData=this._structure.figureData;var parts=Array.from(container.getPartTypeIds());var clubLevel=0;for(var _i=0,_parts=parts;_i<_parts.length;_i++){var part=_parts[_i];var set=figureData.getSetType(part);if(!set)continue;var setId=container.getPartSetId(part);var partSet=set.getPartSet(setId);if(partSet){clubLevel=Math.max(partSet.clubLevel,clubLevel);var palette=figureData.getPalette(set.paletteID);var colors=container.getPartColorIds(part);var _iterator2=_createForOfIteratorHelper(colors),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var colorId=_step2.value;var color=palette.getColor(colorId);if(!color)continue;clubLevel=Math.max(color.clubLevel,clubLevel);}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}}if(!searchParts)searchParts=this._structure.getBodyPartsUnordered(AvatarSetType.FULL);var _iterator3=_createForOfIteratorHelper(searchParts),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _part=_step3.value;var _set=figureData.getSetType(_part);if(!_set)continue;if(parts.indexOf(_part)===-1)clubLevel=Math.max(_set.optionalFromClubLevel(gender),clubLevel);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}return clubLevel;}},{key:\"isValidFigureSetForGender\",value:function isValidFigureSetForGender(setId,gender){var structure=this.structureData;var partSet=structure.getFigurePartSet(setId);return!!(partSet&&(partSet.gender.toUpperCase()==='U'||partSet.gender.toUpperCase()===gender.toUpperCase()));}},{key:\"getFigureStringWithFigureIds\",value:function getFigureStringWithFigureIds(k,_arg_2,_arg_3){var container=new FigureDataContainer();container.loadAvatarData(k,_arg_2);var partSets=this.resolveFigureSets(_arg_3);var _iterator4=_createForOfIteratorHelper(partSets),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var partSet=_step4.value;container.savePartData(partSet.type,partSet.id,container.getColourIds(partSet.type));}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}return container.getFigureString();}},{key:\"resolveFigureSets\",value:function resolveFigureSets(k){var structure=this.structureData;var partSets=[];var _iterator5=_createForOfIteratorHelper(k),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var _local_4=_step5.value;var partSet=structure.getFigurePartSet(_local_4);if(partSet)partSets.push(partSet);}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}return partSets;}},{key:\"getMandatoryAvatarPartSetIds\",value:function getMandatoryAvatarPartSetIds(k,_arg_2){if(!this._structure)return null;return this._structure.getMandatorySetTypeIds(k,_arg_2);}},{key:\"getAssetByName\",value:function getAssetByName(name){return this._aliasCollection.getAsset(name);}},{key:\"assets\",get:function get(){return Nitro.instance.core.asset;}},{key:\"isReady\",get:function get(){return this._isReady;}},{key:\"structure\",get:function get(){return this._structure;}},{key:\"structureData\",get:function get(){if(this._structure)return this._structure.figureData;return null;}},{key:\"downloadManager\",get:function get(){return this._avatarAssetDownloadManager;}}]);return AvatarRenderManager;}(NitroManager);AvatarRenderManager.DEFAULT_FIGURE='hd-99999-99999';","map":null,"metadata":{},"sourceType":"module"}