{"ast":null,"code":"import _slicedToArray from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _classCallCheck from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{NitroPoint,NitroTilemap,PixiApplicationProxy,POINT_STRUCT_SIZE}from'@nitrots/nitro-renderer';import{GetNitroCore}from'../../../api';import{ActionSettings}from'./ActionSettings';import{FloorAction,HEIGHT_SCHEME,MAX_NUM_TILE_PER_AXIS,TILE_SIZE}from'./Constants';import{Tile}from'./Tile';import{getScreenPositionForTile,getTileFromScreenPosition}from'./Utils';export var FloorplanEditor=/*#__PURE__*/function(_PixiApplicationProxy){_inherits(FloorplanEditor,_PixiApplicationProxy);var _super=_createSuper(FloorplanEditor);function FloorplanEditor(){var _this;_classCallCheck(this,FloorplanEditor);var width=TILE_SIZE*MAX_NUM_TILE_PER_AXIS+20;var height=TILE_SIZE*MAX_NUM_TILE_PER_AXIS/2+100;_this=_super.call(this,{width:width,height:height,backgroundColor:0x000000,antialias:true,autoDensity:true,resolution:1,sharedLoader:true,sharedTicker:true});_this._tilemap=void 0;_this._width=void 0;_this._height=void 0;_this._isHolding=void 0;_this._doorLocation=void 0;_this._lastUsedTile=void 0;_this._tilemapRenderer=void 0;_this._actionSettings=void 0;_this._isInitialized=void 0;_this._assetCollection=void 0;_this._tilemap=[];_this._doorLocation=new NitroPoint(0,0);_this._width=0;_this._height=0;_this._isHolding=false;_this._lastUsedTile=new NitroPoint(-1,-1);_this._actionSettings=new ActionSettings();return _this;}_createClass(FloorplanEditor,[{key:\"initialize\",value:function initialize(){if(this._isInitialized)return;var collection=GetNitroCore().asset.getCollection('floor_editor');if(!collection)return;this._assetCollection=collection;this._tilemapRenderer=new NitroTilemap(collection.baseTexture);this.registerEventListeners();this.stage.addChild(this._tilemapRenderer);this._isInitialized=true;}},{key:\"registerEventListeners\",value:function registerEventListeners(){var _this2=this;//this._tilemapRenderer.interactive = true;\nvar tempPoint=new NitroPoint();// @ts-ignore\nthis._tilemapRenderer.containsPoint=function(position){_this2._tilemapRenderer.worldTransform.applyInverse(position,tempPoint);return _this2.tileHitDetection(tempPoint,false);};this._tilemapRenderer.on('pointerup',function(){_this2._isHolding=false;});this._tilemapRenderer.on('pointerout',function(){_this2._isHolding=false;});this._tilemapRenderer.on('pointerdown',function(event){if(!(event.data.originalEvent instanceof PointerEvent)&&!(event.data.originalEvent instanceof TouchEvent))return;var pointerEvent=event.data.originalEvent;if(pointerEvent instanceof MouseEvent&&pointerEvent.button===2)return;var location=event.data.global;_this2.tileHitDetection(location,true);});this._tilemapRenderer.on('click',function(event){if(!(event.data.originalEvent instanceof PointerEvent))return;var pointerEvent=event.data.originalEvent;if(pointerEvent.button===2)return;var location=event.data.global;_this2.tileHitDetection(location,true,true);});}},{key:\"tileHitDetection\",value:function tileHitDetection(tempPoint,setHolding){var isClick=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;// @ts-ignore\nvar buffer=this._tilemapRenderer.pointsBuf;var bufSize=POINT_STRUCT_SIZE;var len=buffer.length;if(setHolding){this._isHolding=true;}for(var j=0;j<len;j+=bufSize){var bufIndex=j+bufSize;var data=buffer.slice(j,bufIndex);var width=TILE_SIZE;var height=TILE_SIZE/2;var mousePositionX=Math.floor(tempPoint.x);var mousePositionY=Math.floor(tempPoint.y);var tileStartX=data[2];var tileStartY=data[3];var centreX=tileStartX+width/2;var centreY=tileStartY+height/2;var dx=Math.abs(mousePositionX-centreX);var dy=Math.abs(mousePositionY-centreY);var solution=dx/(width*0.5)+dy/(height*0.5)<=1;//todo: improve this\nif(solution){if(this._isHolding){var _getTileFromScreenPos=getTileFromScreenPosition(tileStartX,tileStartY),_getTileFromScreenPos2=_slicedToArray(_getTileFromScreenPos,2),realX=_getTileFromScreenPos2[0],realY=_getTileFromScreenPos2[1];if(isClick){this.onClick(realX,realY);}else if(this._lastUsedTile.x!==realX||this._lastUsedTile.y!==realY){this._lastUsedTile.x=realX;this._lastUsedTile.y=realY;this.onClick(realX,realY);}}return true;}}return false;}},{key:\"onClick\",value:function onClick(x,y){var tile=this._tilemap[y][x];var heightIndex=HEIGHT_SCHEME.indexOf(tile.height);var futureHeightIndex=0;switch(this._actionSettings.currentAction){case FloorAction.DOOR:if(tile.height!=='x'){this._doorLocation.x=x;this._doorLocation.y=y;this.renderTiles();}return;case FloorAction.UP:if(tile.height==='x')return;futureHeightIndex=heightIndex+1;break;case FloorAction.DOWN:if(tile.height==='x'||heightIndex<=1)return;futureHeightIndex=heightIndex-1;break;case FloorAction.SET:futureHeightIndex=HEIGHT_SCHEME.indexOf(this._actionSettings.currentHeight);break;case FloorAction.UNSET:futureHeightIndex=0;break;}if(futureHeightIndex===-1)return;if(heightIndex===futureHeightIndex)return;if(futureHeightIndex>0){if(x+1>this._width)this._width=x+1;if(y+1>this._height)this._height=y+1;}var newHeight=HEIGHT_SCHEME[futureHeightIndex];if(!newHeight)return;if(tile.isBlocked)return;this._tilemap[y][x].height=newHeight;this.renderTiles();}},{key:\"renderTiles\",value:function renderTiles(){this.tilemapRenderer.clear();for(var y=0;y<this._tilemap.length;y++){for(var x=0;x<this.tilemap[y].length;x++){var tile=this.tilemap[y][x];var assetName=tile.height;if(this._doorLocation.x===x&&this._doorLocation.y===y)assetName=FloorplanEditor.TILE_DOOR;if(tile.isBlocked)assetName=FloorplanEditor.TILE_BLOCKED;//if((tile.height === 'x') || tile.height === 'X') continue;\nvar _getScreenPositionFor=getScreenPositionForTile(x,y),_getScreenPositionFor2=_slicedToArray(_getScreenPositionFor,2),positionX=_getScreenPositionFor2[0],positionY=_getScreenPositionFor2[1];this._tilemapRenderer.tile(this._assetCollection.getTexture(\"floor_editor_\".concat(assetName)),positionX,positionY);}}}},{key:\"setTilemap\",value:function setTilemap(map,blockedTiles){this._tilemap=[];var roomMapStringSplit=map.split('\\r');var width=0;var height=roomMapStringSplit.length;// find the map width, height\nfor(var y=0;y<height;y++){var originalRow=roomMapStringSplit[y];if(originalRow.length===0){roomMapStringSplit.splice(y,1);height=roomMapStringSplit.length;y--;continue;}if(originalRow.length>width){width=originalRow.length;}}// fill map with room heightmap tiles\nfor(var _y=0;_y<height;_y++){this._tilemap[_y]=[];var rowString=roomMapStringSplit[_y];for(var x=0;x<width;x++){var blocked=blockedTiles[_y]&&blockedTiles[_y][x]||false;var char=rowString[x];if(!(char==='x')&&!(char==='X')&&char){this._tilemap[_y][x]=new Tile(char,blocked);}else{this._tilemap[_y][x]=new Tile('x',blocked);}}for(var _x=width;_x<MAX_NUM_TILE_PER_AXIS;_x++){this.tilemap[_y][_x]=new Tile('x',false);}}// fill remaining map with empty tiles\nfor(var _y2=height;_y2<MAX_NUM_TILE_PER_AXIS;_y2++){if(!this.tilemap[_y2])this.tilemap[_y2]=[];for(var _x2=0;_x2<MAX_NUM_TILE_PER_AXIS;_x2++){this.tilemap[_y2][_x2]=new Tile('x',false);}}this._width=width;this._height=height;}},{key:\"getCurrentTilemapString\",value:function getCurrentTilemapString(){var highestTile=this._tilemap[this._height-1][this._width-1];if(highestTile.height==='x'){this._width=-1;this._height=-1;for(var y=MAX_NUM_TILE_PER_AXIS-1;y>=0;y--){if(!this._tilemap[y])continue;for(var x=MAX_NUM_TILE_PER_AXIS-1;x>=0;x--){if(!this._tilemap[y][x])continue;var tile=this._tilemap[y][x];if(tile.height!=='x'){if(x+1>this._width)this._width=x+1;if(y+1>this._height)this._height=y+1;}}}}var rows=[];for(var _y3=0;_y3<this._height;_y3++){var row=[];for(var _x3=0;_x3<this._width;_x3++){var _tile=this._tilemap[_y3][_x3];row[_x3]=_tile.height;}rows[_y3]=row.join('');}return rows.join('\\r');}},{key:\"clear\",value:function clear(){this._tilemapRenderer.interactive=false;this._tilemap=[];this._doorLocation.set(-1,-1);this._width=0;this._height=0;this._isHolding=false;this._lastUsedTile.set(-1,-1);this._actionSettings.clear();this._tilemapRenderer.clear();}},{key:\"tilemapRenderer\",get:function get(){return this._tilemapRenderer;}},{key:\"tilemap\",get:function get(){return this._tilemap;}},{key:\"doorLocation\",get:function get(){return this._doorLocation;},set:function set(value){this._doorLocation=value;}},{key:\"actionSettings\",get:function get(){return this._actionSettings;}}],[{key:\"instance\",get:function get(){if(!FloorplanEditor._INSTANCE){FloorplanEditor._INSTANCE=new FloorplanEditor();}return FloorplanEditor._INSTANCE;}}]);return FloorplanEditor;}(PixiApplicationProxy);FloorplanEditor._INSTANCE=null;FloorplanEditor.TILE_BLOCKED='r_blocked';FloorplanEditor.TILE_DOOR='r_door';","map":null,"metadata":{},"sourceType":"module"}