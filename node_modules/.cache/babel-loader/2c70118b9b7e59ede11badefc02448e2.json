{"ast":null,"code":"import _slicedToArray from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _createForOfIteratorHelper from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createClass.js\";import{Loader,LoaderResource}from'@pixi/loaders';import{Spritesheet}from'@pixi/spritesheet';import{NitroBundle}from'../../core/asset/NitroBundle';import{NitroLogger}from'../../core/common/logger/NitroLogger';import{NitroEvent}from'../../core/events/NitroEvent';import{RoomContentLoadedEvent}from'../../room/events/RoomContentLoadedEvent';import{GraphicAssetCollection}from'../../room/object/visualization/utils/GraphicAssetCollection';import{GraphicAssetGifCollection}from'../../room/object/visualization/utils/GraphicAssetGifCollection';import{Nitro}from'../Nitro';import{FurnitureType}from'../session/furniture/FurnitureType';import{RoomObjectCategory}from'./object/RoomObjectCategory';import{RoomObjectUserType}from'./object/RoomObjectUserType';import{RoomObjectVariable}from'./object/RoomObjectVariable';import{RoomObjectVisualizationType}from'./object/RoomObjectVisualizationType';import{PetColorResult}from'./PetColorResult';export var RoomContentLoader=/*#__PURE__*/function(){function RoomContentLoader(){_classCallCheck(this,RoomContentLoader);this._logger=void 0;this._stateEvents=void 0;this._sessionDataManager=void 0;this._waitingForSessionDataManager=void 0;this._iconListener=void 0;this._collections=void 0;this._gifCollections=void 0;this._images=void 0;this._events=void 0;this._activeObjects=void 0;this._activeObjectTypes=void 0;this._activeObjectTypeIds=void 0;this._objectTypeAdUrls=void 0;this._wallItems=void 0;this._wallItemTypes=void 0;this._wallItemTypeIds=void 0;this._furniRevisions=void 0;this._pets=void 0;this._petColors=void 0;this._objectAliases=void 0;this._objectOriginalNames=void 0;this._pendingContentTypes=void 0;this._dataInitialized=void 0;this._logger=new NitroLogger(this.constructor.name);this._stateEvents=null;this._sessionDataManager=null;this._waitingForSessionDataManager=false;this._iconListener=null;this._collections=new Map();this._gifCollections=new Map();this._images=new Map();this._events=new Map();this._activeObjects={};this._activeObjectTypes=new Map();this._activeObjectTypeIds=new Map();this._objectTypeAdUrls=new Map();this._wallItems={};this._wallItemTypes=new Map();this._wallItemTypeIds=new Map();this._furniRevisions=new Map();this._pets={};this._petColors=new Map();this._objectAliases=new Map();this._objectOriginalNames=new Map();this._pendingContentTypes=[];this._dataInitialized=false;}_createClass(RoomContentLoader,[{key:\"initialize\",value:function initialize(events){this._stateEvents=events;this.setFurnitureData();var _iterator=_createForOfIteratorHelper(Nitro.instance.getConfiguration('pet.types').entries()),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var _step$value=_slicedToArray(_step.value,2),_index=_step$value[0],name=_step$value[1];this._pets[name]=_index;}}catch(err){_iterator.e(err);}finally{_iterator.f();}}},{key:\"dispose\",value:function dispose(){}},{key:\"setSessionDataManager\",value:function setSessionDataManager(sessionData){this._sessionDataManager=sessionData;if(this._waitingForSessionDataManager){this._waitingForSessionDataManager=false;this.setFurnitureData();}}},{key:\"loadFurnitureData\",value:function loadFurnitureData(){this.setFurnitureData();}},{key:\"setFurnitureData\",value:function setFurnitureData(){if(!this._sessionDataManager){this._waitingForSessionDataManager=true;return;}var furnitureData=this._sessionDataManager.getAllFurnitureData(this);if(!furnitureData)return;this._sessionDataManager.removePendingFurniDataListener(this);this.processFurnitureData(furnitureData);this._stateEvents.dispatchEvent(new NitroEvent(RoomContentLoader.LOADER_READY));}},{key:\"processFurnitureData\",value:function processFurnitureData(furnitureData){if(!furnitureData)return;var _iterator2=_createForOfIteratorHelper(furnitureData),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var furniture=_step2.value;if(!furniture)continue;var id=furniture.id;var className=furniture.className;if(furniture.hasIndexedColor)className=className+'*'+furniture.colorIndex;var revision=furniture.revision;var adUrl=furniture.adUrl;if(adUrl&&adUrl.length>0)this._objectTypeAdUrls.set(className,adUrl);var name=furniture.className;if(furniture.type===FurnitureType.FLOOR){this._activeObjectTypes.set(id,className);this._activeObjectTypeIds.set(className,id);if(!this._activeObjects[name])this._activeObjects[name]=1;}else if(furniture.type===FurnitureType.WALL){if(name==='post.it'){className='post_it';name='post_it';}if(name==='post.it.vd'){className='post_it_vd';name='post_id_vd';}this._wallItemTypes.set(id,className);this._wallItemTypeIds.set(className,id);if(!this._wallItems[name])this._wallItems[name]=1;}var existingRevision=this._furniRevisions.get(name);if(revision>existingRevision){this._furniRevisions.delete(name);this._furniRevisions.set(name,revision);}}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}},{key:\"getFurnitureFloorNameForTypeId\",value:function getFurnitureFloorNameForTypeId(typeId){var type=this._activeObjectTypes.get(typeId);return this.removeColorIndex(type);}},{key:\"getFurnitureWallNameForTypeId\",value:function getFurnitureWallNameForTypeId(typeId){var extra=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var type=this._wallItemTypes.get(typeId);if(type==='poster'&&extra!==null)type=type+extra;return this.removeColorIndex(type);}},{key:\"getFurnitureFloorColorIndex\",value:function getFurnitureFloorColorIndex(typeId){var type=this._activeObjectTypes.get(typeId);if(!type)return-1;return this.getColorIndexFromName(type);}},{key:\"getFurnitureWallColorIndex\",value:function getFurnitureWallColorIndex(typeId){var type=this._wallItemTypes.get(typeId);if(!type)return-1;return this.getColorIndexFromName(type);}},{key:\"getColorIndexFromName\",value:function getColorIndexFromName(name){if(!name)return-1;var index=name.indexOf('*');if(index===-1)return 0;return parseInt(name.substr(index+1));}},{key:\"removeColorIndex\",value:function removeColorIndex(name){if(!name)return null;var index=name.indexOf('*');if(index===-1)return name;return name.substr(0,index);}},{key:\"getRoomObjectAdUrl\",value:function getRoomObjectAdUrl(type){var value=this._objectTypeAdUrls.get(type);if(!value)return'';return value;}},{key:\"getPetColorResult\",value:function getPetColorResult(petIndex,paletteIndex){var colorResults=this._petColors.get(petIndex);if(!colorResults)return null;return colorResults.get(paletteIndex);}},{key:\"getPetColorResultsForTag\",value:function getPetColorResultsForTag(petIndex,tagName){var colorResults=this._petColors.get(petIndex);var results=[];if(colorResults){var _iterator3=_createForOfIteratorHelper(colorResults.values()),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var result=_step3.value;if(result.tag===tagName)results.push(result);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}}return results;}},{key:\"getCollection\",value:function getCollection(name){if(!name)return null;var existing=this._collections.get(name);if(!existing){var globalCollection=Nitro.instance.core.asset.getCollection(name);if(globalCollection){this._collections.set(name,globalCollection);return globalCollection;}return null;}return existing;}},{key:\"getGifCollection\",value:function getGifCollection(name){if(!name)return null;return this._gifCollections.get(name)||null;}},{key:\"getImage\",value:function getImage(name){if(!name)return null;var existing=this._images.get(name);if(!existing)return null;var image=new Image();image.src=existing.src;return image;}},{key:\"addAssetToCollection\",value:function addAssetToCollection(collectionName,assetName,texture){var override=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;var collection=this.getCollection(collectionName);if(!collection)return false;return collection.addAsset(assetName,texture,override,0,0,false,false);}},{key:\"createGifCollection\",value:function createGifCollection(collectionName,textures,durations){if(!collectionName||!textures||!durations)return null;var collection=new GraphicAssetGifCollection(collectionName,textures,durations);this._gifCollections.set(collectionName,collection);return collection;}},{key:\"createCollection\",value:function createCollection(data,spritesheet){if(!data||!spritesheet)return null;var collection=new GraphicAssetCollection(data,spritesheet);this._collections.set(collection.name,collection);var petIndex=this._pets[collection.name];if(petIndex!==undefined){var keys=collection.getPaletteNames();var palettes=new Map();var _iterator4=_createForOfIteratorHelper(keys),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var key=_step4.value;var palette=collection.getPalette(key);var paletteData=data.palettes[key];var primaryColor=palette.primaryColor;var secondaryColor=palette.secondaryColor;var breed=paletteData.breed!==undefined?paletteData.breed:0;var tag=paletteData.colorTag!==undefined?paletteData.colorTag:-1;var master=paletteData.master!==undefined?paletteData.master:false;var layerTags=paletteData.tags!==undefined?paletteData.tags:[];palettes.set(parseInt(key),new PetColorResult(primaryColor,secondaryColor,breed,tag,key,master,layerTags));}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}this._petColors.set(petIndex,palettes);}}},{key:\"getPlaceholderName\",value:function getPlaceholderName(type){var category=this.getCategoryForType(type);switch(category){case RoomObjectCategory.FLOOR:return RoomContentLoader.PLACE_HOLDER;case RoomObjectCategory.WALL:return RoomContentLoader.PLACE_HOLDER_WALL;default:if(this._pets[type]!==undefined)return RoomContentLoader.PLACE_HOLDER_PET;return RoomContentLoader.PLACE_HOLDER_DEFAULT;}}},{key:\"getCategoryForType\",value:function getCategoryForType(type){if(!type)return RoomObjectCategory.MINIMUM;if(this._activeObjects[type]!==undefined)return RoomObjectCategory.FLOOR;if(this._wallItems[type]!==undefined)return RoomObjectCategory.WALL;if(this._pets[type]!==undefined)return RoomObjectCategory.UNIT;if(type.indexOf('poster')===0)return RoomObjectCategory.WALL;if(type==='room')return RoomObjectCategory.ROOM;if(type===RoomObjectUserType.USER)return RoomObjectCategory.UNIT;if(type===RoomObjectUserType.PET)return RoomObjectCategory.UNIT;if(type===RoomObjectUserType.BOT)return RoomObjectCategory.UNIT;if(type===RoomObjectUserType.RENTABLE_BOT)return RoomObjectCategory.UNIT;if(type===RoomContentLoader.TILE_CURSOR||type===RoomContentLoader.SELECTION_ARROW)return RoomObjectCategory.CURSOR;return RoomObjectCategory.MINIMUM;}},{key:\"getPetNameForType\",value:function getPetNameForType(type){return Nitro.instance.getConfiguration('pet.types')[type]||null;}},{key:\"isLoaderType\",value:function isLoaderType(type){type=RoomObjectUserType.getRealType(type);if(type===RoomObjectVisualizationType.USER)return false;return true;}},{key:\"downloadImage\",value:function downloadImage(id,type,param){var _this=this;var events=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var typeName=null;var assetUrls=[];if(type&&type.indexOf(',')>=0){typeName=type;type=typeName.split(',')[0];}if(typeName){assetUrls=this.getAssetUrls(typeName,param,true);}else{assetUrls=this.getAssetUrls(type,param,true);}if(assetUrls&&assetUrls.length){var url=assetUrls[0];var image=new Image();image.src=url;image.onload=function(){image.onerror=null;_this._images.set([type,param].join('_'),image);_this._iconListener.onRoomContentLoaded(id,[type,param].join('_'),true);};image.onerror=function(){image.onload=null;_this._logger.error('Failed to download asset: '+url);_this._iconListener.onRoomContentLoaded(id,[type,param].join('_'),false);};return true;}return false;}},{key:\"downloadAsset\",value:function downloadAsset(type,events){var _this2=this;var assetUrls=this.getAssetUrls(type);if(!assetUrls||!assetUrls.length)return;if(this._pendingContentTypes.indexOf(type)>=0||this.getOrRemoveEventDispatcher(type))return;this._pendingContentTypes.push(type);this._events.set(type,events);var loader=new Loader();var _iterator5=_createForOfIteratorHelper(assetUrls),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var url=_step5.value;if(!url||!url.length)continue;loader.add({url:url,crossOrigin:'anonymous',loadType:LoaderResource.LOAD_TYPE.XHR,xhrType:LoaderResource.XHR_RESPONSE_TYPE.BUFFER});}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}var remaining=assetUrls.length;var onDownloaded=function onDownloaded(status,url){if(!status){_this2._logger.error('Failed to download asset: '+url);loader.destroy();events.dispatchEvent(new RoomContentLoadedEvent(RoomContentLoadedEvent.RCLE_FAILURE,type));return;}remaining--;if(!remaining){loader.destroy();var _events=_this2._events.get(type);if(!_events)return;_events.dispatchEvent(new RoomContentLoadedEvent(RoomContentLoadedEvent.RCLE_SUCCESS,type));return;}};loader.load(function(loader,resources){var _loop=function _loop(key){var resource=resources[key];if(!resource||resource.error||!resource.xhr){onDownloaded(false,resource.url);return{v:void 0};}var resourceType=resource.xhr.getResponseHeader('Content-Type')||'application/octet-stream';if(resourceType==='application/octet-stream'){var nitroBundle=new NitroBundle(resource.data);_this2.processAsset(nitroBundle.baseTexture,nitroBundle.jsonFile,function(status){onDownloaded(status,resource.url);});return\"continue\";}};for(var key in resources){var _ret=_loop(key);if(_ret===\"continue\")continue;if(typeof _ret===\"object\")return _ret.v;}});}},{key:\"processAsset\",value:function processAsset(baseTexture,data,onDownloaded){var _this3=this;var spritesheetData=data.spritesheet;if(!baseTexture||!spritesheetData||!Object.keys(spritesheetData).length){this.createCollection(data,null);onDownloaded(true);return;}var createAsset=function createAsset(){var spritesheet=new Spritesheet(baseTexture,spritesheetData);spritesheet.parse(function(){_this3.createCollection(data,spritesheet);onDownloaded(true);});};if(baseTexture.valid){createAsset();}else{baseTexture.once('update',function(){return createAsset();});}}},{key:\"setAssetAliasName\",value:function setAssetAliasName(name,originalName){this._objectAliases.set(name,originalName);this._objectOriginalNames.set(originalName,name);}},{key:\"getAssetAliasName\",value:function getAssetAliasName(name){var existing=this._objectAliases.get(name);if(!existing)return name;return existing;}},{key:\"getAssetOriginalName\",value:function getAssetOriginalName(name){var existing=this._objectOriginalNames.get(name);if(!existing)return name;return existing;}},{key:\"getAssetUrls\",value:function getAssetUrls(type){var param=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var icon=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;switch(type){case RoomContentLoader.PLACE_HOLDER:return[this.getAssetUrlWithGenericBase(RoomContentLoader.PLACE_HOLDER)];case RoomContentLoader.PLACE_HOLDER_WALL:return[this.getAssetUrlWithGenericBase(RoomContentLoader.PLACE_HOLDER_WALL)];case RoomContentLoader.PLACE_HOLDER_PET:return[this.getAssetUrlWithGenericBase(RoomContentLoader.PLACE_HOLDER_PET)];case RoomContentLoader.ROOM:return[this.getAssetUrlWithGenericBase('room')];case RoomContentLoader.TILE_CURSOR:return[this.getAssetUrlWithGenericBase(RoomContentLoader.TILE_CURSOR)];case RoomContentLoader.SELECTION_ARROW:return[this.getAssetUrlWithGenericBase(RoomContentLoader.SELECTION_ARROW)];default:{var category=this.getCategoryForType(type);if(category===RoomObjectCategory.FLOOR||category===RoomObjectCategory.WALL){var name=this.getAssetAliasName(type);var assetUrl=icon?this.getAssetUrlWithFurniIconBase(name):this.getAssetUrlWithFurniBase(type);if(icon){var active=param&&param!==''&&this._activeObjectTypeIds.has(name+'*'+param);assetUrl=assetUrl.replace(/%param%/gi,active?'_'+param:'');}return[assetUrl];}if(category===RoomObjectCategory.UNIT){return[this.getAssetUrlWithPetBase(type)];}return null;}}}},{key:\"getAssetIconUrl\",value:function getAssetIconUrl(type,colorIndex){var assetName=null;var assetUrls=[];if(type&&type.indexOf(',')>=0){assetName=type;type=assetName.split(',')[0];}if(assetName){assetUrls=this.getAssetUrls(assetName,colorIndex,true);}else{assetUrls=this.getAssetUrls(type,colorIndex,true);}if(assetUrls&&assetUrls.length)return assetUrls[0];return null;}},{key:\"getAssetUrlWithGenericBase\",value:function getAssetUrlWithGenericBase(assetName){return Nitro.instance.getConfiguration('generic.asset.url').replace(/%libname%/gi,assetName);}},{key:\"getAssetUrlWithFurniBase\",value:function getAssetUrlWithFurniBase(assetName){return Nitro.instance.getConfiguration('furni.asset.url').replace(/%libname%/gi,assetName);}},{key:\"getAssetUrlWithFurniIconBase\",value:function getAssetUrlWithFurniIconBase(assetName){return Nitro.instance.getConfiguration('furni.asset.icon.url').replace(/%libname%/gi,assetName);}},{key:\"getAssetUrlWithPetBase\",value:function getAssetUrlWithPetBase(assetName){return Nitro.instance.getConfiguration('pet.asset.url').replace(/%libname%/gi,assetName);}},{key:\"setRoomObjectRoomId\",value:function setRoomObjectRoomId(object,roomId){var model=object&&object.model;if(!model)return;model.setValue(RoomObjectVariable.OBJECT_ROOM_ID,roomId);}},{key:\"getOrRemoveEventDispatcher\",value:function getOrRemoveEventDispatcher(type){var remove=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var existing=this._events.get(type);if(remove)this._events.delete(type);return existing;}},{key:\"setIconListener\",value:function setIconListener(listener){this._iconListener=listener;}}]);return RoomContentLoader;}();RoomContentLoader.PLACE_HOLDER='place_holder';RoomContentLoader.PLACE_HOLDER_WALL='place_holder_wall';RoomContentLoader.PLACE_HOLDER_PET='place_holder_pet';RoomContentLoader.PLACE_HOLDER_DEFAULT=RoomContentLoader.PLACE_HOLDER;RoomContentLoader.ROOM='room';RoomContentLoader.TILE_CURSOR='tile_cursor';RoomContentLoader.SELECTION_ARROW='selection_arrow';RoomContentLoader.LOADER_READY='RCL_LOADER_READY';RoomContentLoader.MANDATORY_LIBRARIES=[RoomContentLoader.PLACE_HOLDER,RoomContentLoader.PLACE_HOLDER_WALL,RoomContentLoader.PLACE_HOLDER_PET,RoomContentLoader.ROOM,RoomContentLoader.TILE_CURSOR,RoomContentLoader.SELECTION_ARROW];","map":null,"metadata":{},"sourceType":"module"}