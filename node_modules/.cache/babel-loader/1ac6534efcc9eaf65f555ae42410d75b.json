{"ast":null,"code":"import _createForOfIteratorHelper from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _toConsumableArray from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _classCallCheck from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _assertThisInitialized from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js\";import _get from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/get.js\";import _getPrototypeOf from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js\";import _inherits from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{Nitro}from'../../../nitro/Nitro';import{NitroLogger}from'../../common/logger/NitroLogger';import{EventDispatcher}from'../../events/EventDispatcher';import{EvaWireFormat}from'../codec/evawire/EvaWireFormat';import{SocketConnectionEvent}from'../events/SocketConnectionEvent';import{MessageClassManager}from'../messages/MessageClassManager';import{WebSocketEventEnum}from'./enums/WebSocketEventEnum';export var SocketConnection=/*#__PURE__*/function(_EventDispatcher){_inherits(SocketConnection,_EventDispatcher);var _super=_createSuper(SocketConnection);function SocketConnection(communicationManager,stateListener){var _this;_classCallCheck(this,SocketConnection);_this=_super.call(this);_this._communicationManager=void 0;_this._stateListener=void 0;_this._socket=void 0;_this._messages=void 0;_this._codec=void 0;_this._dataBuffer=void 0;_this._isReady=void 0;_this._pendingClientMessages=void 0;_this._pendingServerMessages=void 0;_this._isAuthenticated=void 0;_this._communicationManager=communicationManager;_this._stateListener=stateListener;_this._socket=null;_this._messages=new MessageClassManager();_this._codec=new EvaWireFormat();_this._dataBuffer=null;_this._isReady=false;_this._pendingClientMessages=[];_this._pendingServerMessages=[];_this._isAuthenticated=false;_this.onOpen=_this.onOpen.bind(_assertThisInitialized(_this));_this.onClose=_this.onClose.bind(_assertThisInitialized(_this));_this.onError=_this.onError.bind(_assertThisInitialized(_this));_this.onMessage=_this.onMessage.bind(_assertThisInitialized(_this));return _this;}_createClass(SocketConnection,[{key:\"init\",value:function init(socketUrl){if(this._stateListener){this._stateListener.connectionInit(socketUrl);}this.createSocket(socketUrl);}},{key:\"onDispose\",value:function onDispose(){_get(_getPrototypeOf(SocketConnection.prototype),\"onDispose\",this).call(this);this.destroySocket();this._communicationManager=null;this._stateListener=null;this._messages=null;this._codec=null;this._dataBuffer=null;}},{key:\"onReady\",value:function onReady(){if(this._isReady)return;this._isReady=true;if(this._pendingServerMessages&&this._pendingServerMessages.length)this.processWrappers.apply(this,_toConsumableArray(this._pendingServerMessages));if(this._pendingClientMessages&&this._pendingClientMessages.length)this.send.apply(this,_toConsumableArray(this._pendingClientMessages));this._pendingServerMessages=[];this._pendingClientMessages=[];}},{key:\"createSocket\",value:function createSocket(socketUrl){if(!socketUrl)return;this.destroySocket();this._dataBuffer=new ArrayBuffer(0);this._socket=new WebSocket(socketUrl);this._socket.addEventListener(WebSocketEventEnum.CONNECTION_OPENED,this.onOpen);this._socket.addEventListener(WebSocketEventEnum.CONNECTION_CLOSED,this.onClose);this._socket.addEventListener(WebSocketEventEnum.CONNECTION_ERROR,this.onError);this._socket.addEventListener(WebSocketEventEnum.CONNECTION_MESSAGE,this.onMessage);}},{key:\"destroySocket\",value:function destroySocket(){if(!this._socket)return;this._socket.removeEventListener(WebSocketEventEnum.CONNECTION_OPENED,this.onOpen);this._socket.removeEventListener(WebSocketEventEnum.CONNECTION_CLOSED,this.onClose);this._socket.removeEventListener(WebSocketEventEnum.CONNECTION_ERROR,this.onError);this._socket.removeEventListener(WebSocketEventEnum.CONNECTION_MESSAGE,this.onMessage);if(this._socket.readyState===WebSocket.OPEN)this._socket.close();this._socket=null;}},{key:\"onOpen\",value:function onOpen(event){this.dispatchConnectionEvent(SocketConnectionEvent.CONNECTION_OPENED,event);}},{key:\"onClose\",value:function onClose(event){this.dispatchConnectionEvent(SocketConnectionEvent.CONNECTION_CLOSED,event);}},{key:\"onError\",value:function onError(event){this.dispatchConnectionEvent(SocketConnectionEvent.CONNECTION_ERROR,event);}},{key:\"onMessage\",value:function onMessage(event){var _this2=this;if(!event)return;//this.dispatchConnectionEvent(SocketConnectionEvent.CONNECTION_MESSAGE, event);\nvar reader=new FileReader();reader.readAsArrayBuffer(event.data);reader.onloadend=function(){_this2._dataBuffer=_this2.concatArrayBuffers(_this2._dataBuffer,reader.result);_this2.processReceivedData();};}},{key:\"dispatchConnectionEvent\",value:function dispatchConnectionEvent(type,event){this.dispatchEvent(new SocketConnectionEvent(type,this,event));}},{key:\"authenticated\",value:function authenticated(){this._isAuthenticated=true;}},{key:\"send\",value:function send(){for(var _len=arguments.length,composers=new Array(_len),_key=0;_key<_len;_key++){composers[_key]=arguments[_key];}if(this.disposed||!composers)return false;composers=_toConsumableArray(composers);if(this._isAuthenticated&&!this._isReady){var _this$_pendingClientM;if(!this._pendingClientMessages)this._pendingClientMessages=[];(_this$_pendingClientM=this._pendingClientMessages).push.apply(_this$_pendingClientM,_toConsumableArray(composers));return false;}var _iterator=_createForOfIteratorHelper(composers),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var composer=_step.value;if(!composer)continue;var header=this._messages.getComposerId(composer);if(header===-1){NitroLogger.log(\"Unknown Composer: \".concat(composer.constructor.name));continue;}var message=composer.getMessageArray();var encoded=this._codec.encode(header,message);if(!encoded){if(Nitro.instance.getConfiguration('system.packet.log'))console.log(\"Encoding Failed: \".concat(composer.constructor.name));continue;}if(Nitro.instance.getConfiguration('system.packet.log'))console.log(\"OutgoingComposer: [\".concat(header,\"] \").concat(composer.constructor.name),message);this.write(encoded.getBuffer());}}catch(err){_iterator.e(err);}finally{_iterator.f();}return true;}},{key:\"write\",value:function write(buffer){if(this._socket.readyState!==WebSocket.OPEN)return;this._socket.send(buffer);}},{key:\"processReceivedData\",value:function processReceivedData(){try{this.processData();}catch(err){NitroLogger.log(err);}}},{key:\"processData\",value:function processData(){var wrappers=this.splitReceivedMessages();if(!wrappers||!wrappers.length)return;if(this._isAuthenticated&&!this._isReady){var _this$_pendingServerM;if(!this._pendingServerMessages)this._pendingServerMessages=[];(_this$_pendingServerM=this._pendingServerMessages).push.apply(_this$_pendingServerM,_toConsumableArray(wrappers));return;}this.processWrappers.apply(this,_toConsumableArray(wrappers));}},{key:\"processWrappers\",value:function processWrappers(){for(var _len2=arguments.length,wrappers=new Array(_len2),_key2=0;_key2<_len2;_key2++){wrappers[_key2]=arguments[_key2];}if(!wrappers||!wrappers.length)return;for(var _i=0,_wrappers=wrappers;_i<_wrappers.length;_i++){var wrapper=_wrappers[_i];if(!wrapper)continue;var messages=this.getMessagesForWrapper(wrapper);if(!messages||!messages.length)continue;if(Nitro.instance.getConfiguration('system.packet.log')){console.log(\"IncomingMessage: [\".concat(wrapper.header,\"] \").concat(messages[0].constructor.name),messages[0].parser);}this.handleMessages.apply(this,_toConsumableArray(messages));}}},{key:\"splitReceivedMessages\",value:function splitReceivedMessages(){if(!this._dataBuffer||!this._dataBuffer.byteLength)return null;return this._codec.decode(this);}},{key:\"concatArrayBuffers\",value:function concatArrayBuffers(buffer1,buffer2){var array=new Uint8Array(buffer1.byteLength+buffer2.byteLength);array.set(new Uint8Array(buffer1),0);array.set(new Uint8Array(buffer2),buffer1.byteLength);return array.buffer;}},{key:\"getMessagesForWrapper\",value:function getMessagesForWrapper(wrapper){if(!wrapper)return null;var events=this._messages.getEvents(wrapper.header);if(!events||!events.length){if(Nitro.instance.getConfiguration('system.packet.log')){console.log(\"IncomingMessage: [\".concat(wrapper.header,\"] UNREGISTERED\"),wrapper);}return;}try{//@ts-ignore\nvar parser=new events[0].parserClass();if(!parser||!parser.flush()||!parser.parse(wrapper))return null;var _iterator2=_createForOfIteratorHelper(events),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var event=_step2.value;event.parser=parser;}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}catch(e){NitroLogger.log(\"Error parsing message: \".concat(e),events[0].constructor.name);return null;}return events;}},{key:\"handleMessages\",value:function handleMessages(){for(var _len3=arguments.length,messages=new Array(_len3),_key3=0;_key3<_len3;_key3++){messages[_key3]=arguments[_key3];}messages=_toConsumableArray(messages);var _iterator3=_createForOfIteratorHelper(messages),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var message=_step3.value;if(!message)continue;message.connection=this;if(message.callBack)message.callBack(message);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}}},{key:\"registerMessages\",value:function registerMessages(configuration){if(!configuration)return;this._messages.registerMessages(configuration);}},{key:\"addMessageEvent\",value:function addMessageEvent(event){if(!event||!this._messages)return;this._messages.registerMessageEvent(event);}},{key:\"removeMessageEvent\",value:function removeMessageEvent(event){if(!event||!this._messages)return;this._messages.removeMessageEvent(event);}},{key:\"isAuthenticated\",get:function get(){return this._isAuthenticated;}},{key:\"dataBuffer\",get:function get(){return this._dataBuffer;},set:function set(buffer){this._dataBuffer=buffer;}}]);return SocketConnection;}(EventDispatcher);","map":null,"metadata":{},"sourceType":"module"}