{"ast":null,"code":"import _createForOfIteratorHelper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _slicedToArray from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{HabboClubLevelEnum,RoomControllerLevel}from'@nitrots/nitro-renderer';import{useCallback,useEffect,useMemo,useRef,useState}from'react';import{createPortal}from'react-dom';import{GetClubMemberLevel,GetConfiguration,GetRoomSession,GetSessionDataManager,LocalizeText,RoomWidgetChatMessage,RoomWidgetChatTypingMessage,RoomWidgetFloodControlEvent,RoomWidgetUpdateChatInputContentEvent,RoomWidgetUpdateInfostandUserEvent,RoomWidgetUpdateRoomObjectEvent}from'../../../../api';import{Text}from'../../../../common';import{UseEventDispatcherHook}from'../../../../hooks';import{useRoomContext}from'../../RoomContext';import{ChatInputEmojisSelectorView}from'./ChatInputEmojisSelectorView';import{ChatInputStickersSelectorView}from'./ChatInputStickersSelectorView';import{ChatInputStyleSelectorView}from'./ChatInputStyleSelectorView';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";export var ChatInputView=function ChatInputView(props){var _useState=useState(''),_useState2=_slicedToArray(_useState,2),chatValue=_useState2[0],setChatValue=_useState2[1];var _useState3=useState(''),_useState4=_slicedToArray(_useState3,2),selectedUsername=_useState4[0],setSelectedUsername=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),isTyping=_useState6[0],setIsTyping=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),typingStartedSent=_useState8[0],setTypingStartedSent=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),isIdle=_useState10[0],setIsIdle=_useState10[1];var _useState11=useState(GetSessionDataManager().chatStyle),_useState12=_slicedToArray(_useState11,2),chatStyleId=_useState12[0],setChatStyleId=_useState12[1];var _useState13=useState(false),_useState14=_slicedToArray(_useState13,2),needsChatStyleUpdate=_useState14[0],setNeedsChatStyleUpdate=_useState14[1];var _useState15=useState(false),_useState16=_slicedToArray(_useState15,2),floodBlocked=_useState16[0],setFloodBlocked=_useState16[1];var _useState17=useState(0),_useState18=_slicedToArray(_useState17,2),floodBlockedSeconds=_useState18[0],setFloodBlockedSeconds=_useState18[1];var _useRoomContext=useRoomContext(),_useRoomContext$event=_useRoomContext.eventDispatcher,eventDispatcher=_useRoomContext$event===void 0?null:_useRoomContext$event,_useRoomContext$widge=_useRoomContext.widgetHandler,widgetHandler=_useRoomContext$widge===void 0?null:_useRoomContext$widge;var inputRef=useRef();var mediaRecorder;var audioChunks=[];var deletedAudio=false;function startRecording(){var microphoneOn=document.getElementById(\"microphoneOn\");var microphoneOff=document.getElementById(\"microphoneOff\");var deleteAudio=document.getElementById(\"deleteAudio\");microphoneOn.style.display=\"none\";microphoneOff.style.display=\"inline-block\";deleteAudio.style.display=\"inline-block\";navigator.mediaDevices.getUserMedia({audio:true}).then(function(stream){mediaRecorder=new MediaRecorder(stream);mediaRecorder.start();mediaRecorder.addEventListener(\"dataavailable\",function(event){audioChunks.push(event.data);});mediaRecorder.addEventListener(\"stop\",function(){microphoneOn.style.display=\"inline-block\";microphoneOff.style.display=\"none\";deleteAudio.style.display=\"none\";if(!deletedAudio){var audioBlob=new Blob(audioChunks);if(audioBlob.size<378461){var fd=new FormData();fd.append(\"audio\",audioBlob);fetch(\"https://int.kubbo.city/audio\",{method:\"POST\",body:fd}).then(function(response){return response.text();}).then(function(resp){sendMessage(\"https://int.kubbo.city/audios/\"+resp+\".mp3\",RoomWidgetChatMessage.CHAT_DEFAULT,'',0);});}else sendMessage(\"No puedes subir un audio tan largo.\",RoomWidgetChatMessage.CHAT_DEFAULT,'',0);}deletedAudio=false;audioChunks=[];});});}function stopRecording(){mediaRecorder.stop();}function deleteRecording(){deletedAudio=true;mediaRecorder.stop();}function showSubMenu(){if(document.getElementById(\"submenuChat\").style.display==\"block\")document.getElementById(\"submenuChat\").style.display=\"none\";else document.getElementById(\"submenuChat\").style.display=\"block\";}function hideSubMenu(){document.getElementById(\"submenuChat\").style.display=\"none\";}var chatModeIdWhisper=useMemo(function(){return LocalizeText('widgets.chatinput.mode.whisper');},[]);var chatModeIdShout=useMemo(function(){return LocalizeText('widgets.chatinput.mode.shout');},[]);var chatModeIdSpeak=useMemo(function(){return LocalizeText('widgets.chatinput.mode.speak');},[]);var maxChatLength=useMemo(function(){return GetConfiguration('chat.input.maxlength',100);},[]);var anotherInputHasFocus=useCallback(function(){var activeElement=document.activeElement;if(!activeElement)return false;if(inputRef&&inputRef.current===activeElement)return false;if(!(activeElement instanceof HTMLInputElement)&&!(activeElement instanceof HTMLTextAreaElement))return false;return true;},[inputRef]);var sendMessage=useCallback(function(text,chatType){var recipientName=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'';var styleId=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;widgetHandler.processWidgetMessage(new RoomWidgetChatMessage(RoomWidgetChatMessage.MESSAGE_CHAT,text,chatType,recipientName,styleId));},[widgetHandler]);var setInputFocus=useCallback(function(){inputRef.current.focus();inputRef.current.setSelectionRange(inputRef.current.value.length*2,inputRef.current.value.length*2);},[inputRef]);var checkSpecialKeywordForInput=useCallback(function(){setChatValue(function(prevValue){if(prevValue!==chatModeIdWhisper||!selectedUsername.length)return prevValue;return\"\".concat(prevValue,\" \").concat(selectedUsername);});},[selectedUsername,chatModeIdWhisper]);var sendChat=useCallback(function(text,chatType){var recipientName=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'';var styleId=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;setChatValue('');widgetHandler.processWidgetMessage(new RoomWidgetChatMessage(RoomWidgetChatMessage.MESSAGE_CHAT,text,chatType,recipientName,styleId));},[widgetHandler]);var sendChatValue=useCallback(function(value){var shiftKey=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!value||value==='')return;var chatType=shiftKey?RoomWidgetChatMessage.CHAT_SHOUT:RoomWidgetChatMessage.CHAT_DEFAULT;var text=value;var parts=text.split(' ');var recipientName='';var append='';switch(parts[0]){case chatModeIdWhisper:chatType=RoomWidgetChatMessage.CHAT_WHISPER;recipientName=parts[1];append=chatModeIdWhisper+' '+recipientName+' ';parts.shift();parts.shift();break;case chatModeIdShout:chatType=RoomWidgetChatMessage.CHAT_SHOUT;parts.shift();break;case chatModeIdSpeak:chatType=RoomWidgetChatMessage.CHAT_DEFAULT;parts.shift();break;}text=parts.join(' ');setIsTyping(false);setIsIdle(false);if(text.length<=maxChatLength){if(needsChatStyleUpdate){GetSessionDataManager().sendChatStyleUpdate(chatStyleId);setNeedsChatStyleUpdate(false);}sendChat(text,chatType,recipientName,chatStyleId);}setChatValue(append);},[chatModeIdWhisper,chatModeIdShout,chatModeIdSpeak,maxChatLength,chatStyleId,needsChatStyleUpdate,sendChat]);var updateChatInput=useCallback(function(value){if(!value||!value.length){setIsTyping(false);}else{setIsTyping(true);setIsIdle(true);}setChatValue(value);},[]);var onKeyDownEvent=useCallback(function(event){if(floodBlocked||!inputRef.current||anotherInputHasFocus())return;if(document.activeElement!==inputRef.current)setInputFocus();var value=event.target.value;switch(event.key){case' ':case'Space':checkSpecialKeywordForInput();return;case'NumpadEnter':case'Enter':sendChatValue(value,event.shiftKey);return;case'Backspace':if(value){var parts=value.split(' ');if(parts[0]===chatModeIdWhisper&&parts.length===3&&parts[2]===''){setChatValue('');}}return;}},[floodBlocked,inputRef,chatModeIdWhisper,anotherInputHasFocus,setInputFocus,checkSpecialKeywordForInput,sendChatValue]);var onRoomWidgetRoomObjectUpdateEvent=useCallback(function(event){setSelectedUsername('');},[]);UseEventDispatcherHook(RoomWidgetUpdateRoomObjectEvent.OBJECT_DESELECTED,eventDispatcher,onRoomWidgetRoomObjectUpdateEvent);var onRoomWidgetUpdateInfostandUserEvent=useCallback(function(event){setSelectedUsername(event.name);},[]);UseEventDispatcherHook(RoomWidgetUpdateInfostandUserEvent.PEER,eventDispatcher,onRoomWidgetUpdateInfostandUserEvent);var onRoomWidgetChatInputContentUpdateEvent=useCallback(function(event){switch(event.chatMode){case RoomWidgetUpdateChatInputContentEvent.WHISPER:{setChatValue(\"\".concat(chatModeIdWhisper,\" \").concat(event.userName,\" \"));return;}case RoomWidgetUpdateChatInputContentEvent.SHOUT:return;}},[chatModeIdWhisper]);UseEventDispatcherHook(RoomWidgetUpdateChatInputContentEvent.CHAT_INPUT_CONTENT,eventDispatcher,onRoomWidgetChatInputContentUpdateEvent);var onRoomWidgetFloodControlEvent=useCallback(function(event){setFloodBlocked(true);setFloodBlockedSeconds(event.seconds);},[]);UseEventDispatcherHook(RoomWidgetFloodControlEvent.FLOOD_CONTROL,eventDispatcher,onRoomWidgetFloodControlEvent);var selectChatStyleId=useCallback(function(styleId){setChatStyleId(styleId);setNeedsChatStyleUpdate(true);},[]);var chatStyleIds=useMemo(function(){var styleIds=[];var styles=GetConfiguration('chat.styles');var _iterator=_createForOfIteratorHelper(styles),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var style=_step.value;if(!style)continue;if(style.minRank>0){if(GetSessionDataManager().hasSecurity(style.minRank))styleIds.push(style.styleId);continue;}if(style.isSystemStyle){if(GetSessionDataManager().hasSecurity(RoomControllerLevel.MODERATOR)){styleIds.push(style.styleId);continue;}}if(GetConfiguration('chat.styles.disabled').indexOf(style.styleId)>=0)continue;if(style.isHcOnly&&GetClubMemberLevel()>=HabboClubLevelEnum.CLUB){styleIds.push(style.styleId);continue;}if(style.isAmbassadorOnly&&GetSessionDataManager().isAmbassador){styleIds.push(style.styleId);continue;}if(!style.isHcOnly&&!style.isAmbassadorOnly)styleIds.push(style.styleId);}}catch(err){_iterator.e(err);}finally{_iterator.f();}return styleIds;},[]);useEffect(function(){if(isTyping){if(!typingStartedSent){setTypingStartedSent(true);widgetHandler.processWidgetMessage(new RoomWidgetChatTypingMessage(isTyping));}}else{if(typingStartedSent){setTypingStartedSent(false);widgetHandler.processWidgetMessage(new RoomWidgetChatTypingMessage(isTyping));}}},[widgetHandler,isTyping,typingStartedSent]);useEffect(function(){if(!isIdle)return;var timeout=null;if(isIdle){timeout=setTimeout(function(){setIsIdle(false);setIsTyping(false);},10000);}return function(){return clearTimeout(timeout);};},[isIdle]);useEffect(function(){if(!floodBlocked)return;var seconds=0;var interval=setInterval(function(){setFloodBlockedSeconds(function(prevValue){seconds=(prevValue||0)-1;return seconds;});if(seconds<0){clearInterval(interval);setFloodBlocked(false);}},1000);return function(){return clearInterval(interval);};},[floodBlocked]);useEffect(function(){document.body.addEventListener('keydown',onKeyDownEvent);return function(){document.body.removeEventListener('keydown',onKeyDownEvent);};},[onKeyDownEvent]);useEffect(function(){if(!inputRef.current)return;inputRef.current.parentElement.dataset.value=chatValue;},[chatValue]);if(GetRoomSession().isSpectator)return null;/*\n    <ChatInputStyleSelectorView chatStyleId={ chatStyleId } chatStyleIds={ chatStyleIds } selectChatStyleId={ selectChatStyleId } />\n                <ChatInputStickersSelectorView /> \n                <div id=\"microphoneOn\" onClick={e => startRecording()} style={{marginLeft: \"10px\"}} className=\"icon chatmicrophone-on-icon\" />\n                <div id=\"microphoneOff\" onClick={e => stopRecording()} style={{marginLeft: \"10px\", display: \"none\"}} className=\"icon chatmicrophone-off-icon\" />\n                <div id=\"deleteAudio\" onClick={e => deleteRecording()} style={{marginLeft: \"10px\", display: \"none\"}} className=\"icon chatdeleteaudio-icon\" />*/return/*#__PURE__*/createPortal(/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"div\",{id:\"submenuChat\",className:\"animate__animated animate__fadeInUp\",style:{paddingLeft:\"16px\",paddingRight:\"13px\",paddingTop:\"11px\",paddingBottom:\"7px\",position:\"absolute\",backgroundColor:\"rgba(43, 43, 43, 0.8)\",top:\"-48px\",borderRadius:\"7px\",display:\"none\",border:\"1px #fff solid\"},children:[/*#__PURE__*/_jsx(ChatInputStyleSelectorView,{chatStyleId:chatStyleId,chatStyleIds:chatStyleIds,selectChatStyleId:selectChatStyleId}),/*#__PURE__*/_jsx(ChatInputStickersSelectorView,{}),/*#__PURE__*/_jsx(ChatInputEmojisSelectorView,{}),/*#__PURE__*/_jsx(\"div\",{id:\"microphoneOn\",onClick:function onClick(e){return startRecording();},style:{marginLeft:\"10px\",display:\"inline-block\"},className:\"icon chatmicrophone-on-icon\"}),/*#__PURE__*/_jsx(\"div\",{id:\"microphoneOff\",onClick:function onClick(e){return stopRecording();},style:{marginLeft:\"10px\",display:\"none\"},className:\"icon chatmicrophone-off-icon\"}),/*#__PURE__*/_jsx(\"div\",{id:\"deleteAudio\",onClick:function onClick(e){return deleteRecording();},style:{marginLeft:\"10px\",display:\"none\"},className:\"icon chatdeleteaudio-icon\"}),/*#__PURE__*/_jsx(\"div\",{onClick:function onClick(){return hideSubMenu();},className:\"icon chatequis-icon\",style:{marginLeft:\"10px\",display:\"inline-block\"}})]}),/*#__PURE__*/_jsx(\"div\",{className:\"nitro-chat-input-container\",style:{height:\"49px\"},children:/*#__PURE__*/_jsxs(\"div\",{className:\"chat-size input-sizer align-items-center\",style:{justifyContent:\"start\"},children:[/*#__PURE__*/_jsx(\"div\",{onClick:function onClick(){return showSubMenu();},className:\"icon chatmas-icon\",style:{marginRight:\"3px\"}}),!floodBlocked&&/*#__PURE__*/_jsx(\"input\",{style:{marginLeft:\"5px\"},ref:inputRef,type:\"text\",className:\"chat-input\",placeholder:LocalizeText('widgets.chatinput.default'),value:chatValue,maxLength:maxChatLength,onChange:function onChange(event){return updateChatInput(event.target.value);},onMouseDown:function onMouseDown(event){return setInputFocus();}}),floodBlocked&&/*#__PURE__*/_jsxs(Text,{variant:\"danger\",children:[LocalizeText('chat.input.alert.flood',['time'],[floodBlockedSeconds.toString()]),\" \"]})]})})]}),document.getElementById('toolbar-chat-input-container'));};function setSelectorVisible(arg0){throw new Error('Function not implemented.');}","map":null,"metadata":{},"sourceType":"module"}