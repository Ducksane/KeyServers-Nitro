{"ast":null,"code":"import _slicedToArray from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _createForOfIteratorHelper from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _assertThisInitialized from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js\";import _inherits from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{NitroLogger}from'../../core/common/logger/NitroLogger';import{EventDispatcher}from'../../core/events/EventDispatcher';import{NitroEvent}from'../../core/events/NitroEvent';import{Nitro}from'../Nitro';import{EffectAssetDownloadLibrary}from'./EffectAssetDownloadLibrary';import{AvatarRenderEffectLibraryEvent}from'./events/AvatarRenderEffectLibraryEvent';import{AvatarRenderEvent}from'./events/AvatarRenderEvent';export var EffectAssetDownloadManager=/*#__PURE__*/function(_EventDispatcher){_inherits(EffectAssetDownloadManager,_EventDispatcher);var _super=_createSuper(EffectAssetDownloadManager);function EffectAssetDownloadManager(assets,structure){var _this;_classCallCheck(this,EffectAssetDownloadManager);_this=_super.call(this);_this._assets=void 0;_this._structure=void 0;_this._missingMandatoryLibs=void 0;_this._effectMap=void 0;_this._initDownloadBuffer=void 0;_this._effectListeners=void 0;_this._incompleteEffects=void 0;_this._pendingDownloadQueue=void 0;_this._currentDownloads=void 0;_this._libraryNames=void 0;_this._isReady=void 0;_this._assets=assets;_this._structure=structure;_this._missingMandatoryLibs=Nitro.instance.getConfiguration('avatar.mandatory.effect.libraries');_this._effectMap=new Map();_this._effectListeners=new Map();_this._incompleteEffects=new Map();_this._initDownloadBuffer=[];_this._pendingDownloadQueue=[];_this._currentDownloads=[];_this._libraryNames=[];_this._isReady=false;_this.onLibraryLoaded=_this.onLibraryLoaded.bind(_assertThisInitialized(_this));_this.onAvatarRenderReady=_this.onAvatarRenderReady.bind(_assertThisInitialized(_this));_this.loadEffectMap();_this._structure.renderManager.events.addEventListener(AvatarRenderEvent.AVATAR_RENDER_READY,_this.onAvatarRenderReady);return _this;}_createClass(EffectAssetDownloadManager,[{key:\"loadEffectMap\",value:function loadEffectMap(){var _this2=this;var request=new XMLHttpRequest();try{request.open('GET',Nitro.instance.getConfiguration('avatar.effectmap.url'));request.send();request.onloadend=function(e){if(request.responseText){var data=JSON.parse(request.responseText);_this2.processEffectMap(data.effects);_this2.processMissingLibraries();_this2._isReady=true;_this2.dispatchEvent(new NitroEvent(EffectAssetDownloadManager.DOWNLOADER_READY));}};request.onerror=function(e){throw new Error('invalid_avatar_effect_map');};}catch(e){NitroLogger.log(e);}}},{key:\"processEffectMap\",value:function processEffectMap(data){if(!data)return;var _iterator=_createForOfIteratorHelper(data),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var effect=_step.value;if(!effect)continue;var id=effect.id;var lib=effect.lib;var revision=effect.revision||'';if(this._libraryNames.indexOf(lib)>=0)continue;this._libraryNames.push(lib);var downloadLibrary=new EffectAssetDownloadLibrary(lib,revision,this._assets,Nitro.instance.getConfiguration('avatar.asset.effect.url'));downloadLibrary.addEventListener(AvatarRenderEffectLibraryEvent.DOWNLOAD_COMPLETE,this.onLibraryLoaded);var existing=this._effectMap.get(id);if(!existing)existing=[];existing.push(downloadLibrary);this._effectMap.set(id,existing);}}catch(err){_iterator.e(err);}finally{_iterator.f();}}},{key:\"downloadAvatarEffect\",value:function downloadAvatarEffect(id,listener){if(!this._isReady||!this._structure.renderManager.isReady){this._initDownloadBuffer.push([id,listener]);return;}var pendingLibraries=this.getAvatarEffectPendingLibraries(id);if(pendingLibraries&&pendingLibraries.length){if(listener&&!listener.disposed){var listeners=this._effectListeners.get(id.toString());if(!listeners)listeners=[];listeners.push(listener);this._effectListeners.set(id.toString(),listeners);}this._incompleteEffects.set(id.toString(),pendingLibraries);var _iterator2=_createForOfIteratorHelper(pendingLibraries),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var library=_step2.value;if(!library)continue;this.downloadLibrary(library);}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}else{if(listener&&!listener.disposed)listener.resetEffect(id);}}},{key:\"onAvatarRenderReady\",value:function onAvatarRenderReady(event){if(!event)return;var _iterator3=_createForOfIteratorHelper(this._initDownloadBuffer),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _step3$value=_slicedToArray(_step3.value,2),id=_step3$value[0],listener=_step3$value[1];this.downloadAvatarEffect(id,listener);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}this._initDownloadBuffer=[];}},{key:\"onLibraryLoaded\",value:function onLibraryLoaded(event){if(!event||!event.library)return;var loadedEffects=[];this._structure.registerAnimation(event.library.animation);var _iterator4=_createForOfIteratorHelper(this._incompleteEffects.entries()),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _step4$value=_slicedToArray(_step4.value,2),_id=_step4$value[0],libraries=_step4$value[1];var isReady=true;var _iterator5=_createForOfIteratorHelper(libraries),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var library=_step5.value;if(!library||library.isLoaded)continue;isReady=false;break;}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}if(isReady){loadedEffects.push(_id);var listeners=this._effectListeners.get(_id);var _iterator6=_createForOfIteratorHelper(listeners),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var listener=_step6.value;if(!listener||listener.disposed)continue;listener.resetEffect(parseInt(_id));}}catch(err){_iterator6.e(err);}finally{_iterator6.f();}this._effectListeners.delete(_id);this.dispatchEvent(new NitroEvent(EffectAssetDownloadManager.LIBRARY_LOADED));}}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}for(var _i=0,_loadedEffects=loadedEffects;_i<_loadedEffects.length;_i++){var id=_loadedEffects[_i];this._incompleteEffects.delete(id);}var index=0;while(index<this._currentDownloads.length){var download=this._currentDownloads[index];if(download){if(download.libraryName===event.library.libraryName)this._currentDownloads.splice(index,1);}index++;}}},{key:\"processMissingLibraries\",value:function processMissingLibraries(){var libraries=this._missingMandatoryLibs.slice();var _iterator7=_createForOfIteratorHelper(libraries),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var library=_step7.value;if(!library)continue;var map=this._effectMap.get(library);if(map){var _iterator8=_createForOfIteratorHelper(map),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var effect=_step8.value;effect&&this.downloadLibrary(effect);}}catch(err){_iterator8.e(err);}finally{_iterator8.f();}}}}catch(err){_iterator7.e(err);}finally{_iterator7.f();}}},{key:\"isAvatarEffectReady\",value:function isAvatarEffectReady(effect){if(!this._isReady||!this._structure.renderManager.isReady){return false;}var pendingLibraries=this.getAvatarEffectPendingLibraries(effect);return!pendingLibraries.length;}},{key:\"getAvatarEffectPendingLibraries\",value:function getAvatarEffectPendingLibraries(id){var pendingLibraries=[];if(!this._structure)return pendingLibraries;var libraries=this._effectMap.get(id.toString());if(libraries){var _iterator9=_createForOfIteratorHelper(libraries),_step9;try{for(_iterator9.s();!(_step9=_iterator9.n()).done;){var library=_step9.value;if(!library||library.isLoaded)continue;if(pendingLibraries.indexOf(library)===-1)pendingLibraries.push(library);}}catch(err){_iterator9.e(err);}finally{_iterator9.f();}}return pendingLibraries;}},{key:\"downloadLibrary\",value:function downloadLibrary(library){if(!library||library.isLoaded)return;if(this._pendingDownloadQueue.indexOf(library)>=0||this._currentDownloads.indexOf(library)>=0)return;this._pendingDownloadQueue.push(library);this.processDownloadQueue();}},{key:\"processDownloadQueue\",value:function processDownloadQueue(){while(this._pendingDownloadQueue.length){var library=this._pendingDownloadQueue[0];library.downloadAsset();this._currentDownloads.push(this._pendingDownloadQueue.shift());}}}]);return EffectAssetDownloadManager;}(EventDispatcher);EffectAssetDownloadManager.DOWNLOADER_READY='EADM_DOWNLOADER_READY';EffectAssetDownloadManager.LIBRARY_LOADED='EADM_LIBRARY_LOADED';EffectAssetDownloadManager.MAX_DOWNLOADS=2;","map":null,"metadata":{},"sourceType":"module"}