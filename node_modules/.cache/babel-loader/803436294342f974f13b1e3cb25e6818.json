{"ast":null,"code":"import _slicedToArray from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _createForOfIteratorHelper from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _inherits from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{BaseTexture,Texture}from'@pixi/core';import{Loader,LoaderResource}from'@pixi/loaders';import{Spritesheet}from'@pixi/spritesheet';import{GraphicAssetCollection}from'../../room/object/visualization/utils/GraphicAssetCollection';import{Disposable}from'../common/disposable/Disposable';import{NitroLogger}from'../common/logger/NitroLogger';import{ArrayBufferToBase64}from'../utils';import{NitroBundle}from'./NitroBundle';export var AssetManager=/*#__PURE__*/function(_Disposable){_inherits(AssetManager,_Disposable);var _super=_createSuper(AssetManager);function AssetManager(){var _this;_classCallCheck(this,AssetManager);_this=_super.call(this);_this._logger=void 0;_this._textures=void 0;_this._collections=void 0;_this._logger=new NitroLogger(_this.constructor.name);_this._textures=new Map();_this._collections=new Map();return _this;}_createClass(AssetManager,[{key:\"getTexture\",value:function getTexture(name){if(!name)return null;var existing=this._textures.get(name);if(!existing)return null;return existing;}},{key:\"setTexture\",value:function setTexture(name,texture){if(!name||!texture)return;this._textures.set(name,texture);}},{key:\"getAsset\",value:function getAsset(name){if(!name)return null;var _iterator=_createForOfIteratorHelper(this._collections.values()),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var collection=_step.value;if(!collection)continue;var existing=collection.getAsset(name);if(!existing)continue;return existing;}}catch(err){_iterator.e(err);}finally{_iterator.f();}return null;}},{key:\"getCollection\",value:function getCollection(name){if(!name)return null;var existing=this._collections.get(name);if(!existing)return null;return existing;}},{key:\"createCollection\",value:function createCollection(data,spritesheet){if(!data)return null;var collection=new GraphicAssetCollection(data,spritesheet);if(collection){var _iterator2=_createForOfIteratorHelper(collection.textures.entries()),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _step2$value=_slicedToArray(_step2.value,2),name=_step2$value[0],texture=_step2$value[1];this.setTexture(name,texture);}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}this._collections.set(collection.name,collection);}return collection;}},{key:\"downloadAsset\",value:function downloadAsset(assetUrl,cb){this.downloadAssets([assetUrl],cb);}},{key:\"downloadAssets\",value:function downloadAssets(assetUrls,cb){var _this2=this;if(!assetUrls||!assetUrls.length){cb(true);return;}var loader=new Loader();var _iterator3=_createForOfIteratorHelper(assetUrls),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var url=_step3.value;if(!url)continue;loader.add({url:url,crossOrigin:'anonymous',loadType:LoaderResource.LOAD_TYPE.XHR,xhrType:LoaderResource.XHR_RESPONSE_TYPE.BUFFER});}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}var remaining=assetUrls.length;var onDownloaded=function onDownloaded(status,url){if(!status){_this2._logger.error('Failed to download asset: '+url);loader.destroy();cb(false);return;}remaining--;if(!remaining){loader.destroy();cb(true);return;}};loader.load(function(loader,resources){var _loop=function _loop(key){var resource=resources[key];if(!resource||resource.error||!resource.xhr){onDownloaded(false,resource.url);return{v:void 0};}var resourceType=resource.xhr.getResponseHeader('Content-Type')||'application/octet-stream';if(resourceType==='application/octet-stream'){var nitroBundle=new NitroBundle(resource.data);_this2.processAsset(nitroBundle.baseTexture,nitroBundle.jsonFile,function(status){onDownloaded(status,resource.url);});return\"continue\";}if(resourceType==='image/png'||resourceType==='image/gif'){var base64=ArrayBufferToBase64(resource.data);var baseTexture=new BaseTexture(\"data:\".concat(resourceType,\";base64,\").concat(base64));if(baseTexture.valid){var texture=new Texture(baseTexture);_this2.setTexture(resource.name,texture);onDownloaded(true,resource.url);}else{baseTexture.once('update',function(){var texture=new Texture(baseTexture);_this2.setTexture(resource.name,texture);onDownloaded(true,resource.url);});}return\"continue\";}onDownloaded(false,resource.url);};for(var key in resources){var _ret=_loop(key);if(_ret===\"continue\")continue;if(typeof _ret===\"object\")return _ret.v;}});}},{key:\"processAsset\",value:function processAsset(baseTexture,data,onDownloaded){var _this3=this;var spritesheetData=data.spritesheet;if(!baseTexture||!spritesheetData||!Object.keys(spritesheetData).length){this.createCollection(data,null);onDownloaded(true);return;}var createAsset=function createAsset(){var spritesheet=new Spritesheet(baseTexture,spritesheetData);spritesheet.parse(function(){_this3.createCollection(data,spritesheet);onDownloaded(true);});};if(baseTexture.valid){createAsset();}else{baseTexture.once('update',function(){return createAsset();});}}},{key:\"collections\",get:function get(){return this._collections;}}],[{key:\"removeFileExtension\",value:function removeFileExtension(name){return name.substring(0,name.lastIndexOf('.'))||name;}}]);return AssetManager;}(Disposable);","map":null,"metadata":{},"sourceType":"module"}