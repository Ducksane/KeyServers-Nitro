{"ast":null,"code":"import _classCallCheck from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _get from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/get.js\";import _getPrototypeOf from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js\";import _inherits from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{Point}from'@pixi/math';import{RoomObjectMouseEvent}from'../../../../../room/events/RoomObjectMouseEvent';import{RoomObjectLogicBase}from'../../../../../room/object/logic/RoomObjectLogicBase';import{ColorConverter}from'../../../../../room/utils/ColorConverter';import{Vector3d}from'../../../../../room/utils/Vector3d';import{Nitro}from'../../../../Nitro';import{MouseEventType}from'../../../../ui/MouseEventType';import{RoomObjectTileMouseEvent}from'../../../events/RoomObjectTileMouseEvent';import{RoomObjectWallMouseEvent}from'../../../events/RoomObjectWallMouseEvent';import{ObjectRoomColorUpdateMessage}from'../../../messages/ObjectRoomColorUpdateMessage';import{ObjectRoomFloorHoleUpdateMessage}from'../../../messages/ObjectRoomFloorHoleUpdateMessage';import{ObjectRoomMapUpdateMessage}from'../../../messages/ObjectRoomMapUpdateMessage';import{ObjectRoomMaskUpdateMessage}from'../../../messages/ObjectRoomMaskUpdateMessage';import{ObjectRoomPlanePropertyUpdateMessage}from'../../../messages/ObjectRoomPlanePropertyUpdateMessage';import{ObjectRoomPlaneVisibilityUpdateMessage}from'../../../messages/ObjectRoomPlaneVisibilityUpdateMessage';import{ObjectRoomUpdateMessage}from'../../../messages/ObjectRoomUpdateMessage';import{RoomMapData}from'../../RoomMapData';import{RoomObjectVariable}from'../../RoomObjectVariable';import{RoomPlaneBitmapMaskData}from'../../RoomPlaneBitmapMaskData';import{RoomPlaneBitmapMaskParser}from'../../RoomPlaneBitmapMaskParser';import{RoomPlaneData}from'../../RoomPlaneData';import{RoomPlaneParser}from'../../RoomPlaneParser';export var RoomLogic=/*#__PURE__*/function(_RoomObjectLogicBase){_inherits(RoomLogic,_RoomObjectLogicBase);var _super=_createSuper(RoomLogic);function RoomLogic(){var _this;_classCallCheck(this,RoomLogic);_this=_super.call(this);_this._planeParser=void 0;_this._planeBitmapMaskParser=void 0;_this._color=void 0;_this._light=void 0;_this._originalColor=void 0;_this._originalLight=void 0;_this._targetColor=void 0;_this._targetLight=void 0;_this._colorChangedTime=void 0;_this._colorTransitionLength=void 0;_this._lastHoleUpdate=void 0;_this._needsMapUpdate=void 0;_this._skipColorTransition=void 0;_this._planeParser=new RoomPlaneParser();_this._planeBitmapMaskParser=new RoomPlaneBitmapMaskParser();_this._color=0xFFFFFF;_this._light=0xFF;_this._originalColor=0xFFFFFF;_this._originalLight=0xFF;_this._targetColor=0xFFFFFF;_this._targetLight=0xFF;_this._colorChangedTime=0;_this._colorTransitionLength=1500;_this._lastHoleUpdate=0;_this._needsMapUpdate=false;_this._skipColorTransition=false;return _this;}_createClass(RoomLogic,[{key:\"getEventTypes\",value:function getEventTypes(){var types=[RoomObjectMouseEvent.MOUSE_MOVE,RoomObjectMouseEvent.CLICK];return this.mergeTypes(_get(_getPrototypeOf(RoomLogic.prototype),\"getEventTypes\",this).call(this),types);}},{key:\"dispose\",value:function dispose(){_get(_getPrototypeOf(RoomLogic.prototype),\"dispose\",this).call(this);if(this._planeParser){this._planeParser.dispose();this._planeParser=null;}if(this._planeBitmapMaskParser){this._planeBitmapMaskParser.dispose();this._planeBitmapMaskParser=null;}}},{key:\"initialize\",value:function initialize(roomMap){if(!roomMap||!this.object)return;if(!(roomMap instanceof RoomMapData))return;if(!this._planeParser.initializeFromMapData(roomMap))return;this.object.model.setValue(RoomObjectVariable.ROOM_MAP_DATA,roomMap);this.object.model.setValue(RoomObjectVariable.ROOM_BACKGROUND_COLOR,0xFFFFFF);this.object.model.setValue(RoomObjectVariable.ROOM_FLOOR_VISIBILITY,1);this.object.model.setValue(RoomObjectVariable.ROOM_WALL_VISIBILITY,1);this.object.model.setValue(RoomObjectVariable.ROOM_LANDSCAPE_VISIBILITY,1);this._skipColorTransition=Nitro.instance.getConfiguration('room.color.skip.transition')===true;}},{key:\"update\",value:function update(time){_get(_getPrototypeOf(RoomLogic.prototype),\"update\",this).call(this,time);this.updateBackgroundColor(time);if(this._needsMapUpdate){if(this._lastHoleUpdate&&time-this._lastHoleUpdate<5)return;var model=this.object&&this.object.model;if(model){var mapData=this._planeParser.getMapData();model.setValue(RoomObjectVariable.ROOM_MAP_DATA,mapData);model.setValue(RoomObjectVariable.ROOM_FLOOR_HOLE_UPDATE_TIME,time);this._planeParser.initializeFromMapData(mapData);}this._lastHoleUpdate=0;this._needsMapUpdate=false;}}},{key:\"updateBackgroundColor\",value:function updateBackgroundColor(k){if(!this.object||!this._colorChangedTime)return;var color=this._color;var newColor=this._light;if(k-this._colorChangedTime>=this._colorTransitionLength){color=this._targetColor;newColor=this._targetLight;this._colorChangedTime=0;}else{var _local_7=this._originalColor>>16&0xFF;var _local_8=this._originalColor>>8&0xFF;var _local_9=this._originalColor&0xFF;var _local_10=this._targetColor>>16&0xFF;var _local_11=this._targetColor>>8&0xFF;var _local_12=this._targetColor&0xFF;var _local_13=(k-this._colorChangedTime)/this._colorTransitionLength;_local_7=_local_7+(_local_10-_local_7)*_local_13;_local_8=_local_8+(_local_11-_local_8)*_local_13;_local_9=_local_9+(_local_12-_local_9)*_local_13;color=(_local_7<<16)+(_local_8<<8)+_local_9;newColor=this._originalLight+(this._targetLight-this._originalLight)*_local_13;this._color=color;this._light=newColor;}var _local_5=ColorConverter.rgbToHSL(color);_local_5=(_local_5&0xFFFF00)+newColor;color=ColorConverter.hslToRGB(_local_5);if(this.object.model)this.object.model.setValue(RoomObjectVariable.ROOM_BACKGROUND_COLOR,color);}},{key:\"processUpdateMessage\",value:function processUpdateMessage(message){if(!message||!this.object)return;var model=this.object.model;if(!model)return;if(message instanceof ObjectRoomUpdateMessage){this.onObjectRoomUpdateMessage(message,model);return;}if(message instanceof ObjectRoomMaskUpdateMessage){this.onObjectRoomMaskUpdateMessage(message,model);return;}if(message instanceof ObjectRoomPlaneVisibilityUpdateMessage){this.onObjectRoomPlaneVisibilityUpdateMessage(message,model);return;}if(message instanceof ObjectRoomPlanePropertyUpdateMessage){this.onObjectRoomPlanePropertyUpdateMessage(message,model);return;}if(message instanceof ObjectRoomFloorHoleUpdateMessage){this.onObjectRoomFloorHoleUpdateMessage(message,model);return;}if(message instanceof ObjectRoomColorUpdateMessage){this.onObjectRoomColorUpdateMessage(message,model);return;}if(message instanceof ObjectRoomMapUpdateMessage){this.onObjectRoomMapUpdateMessage(message);}}},{key:\"onObjectRoomUpdateMessage\",value:function onObjectRoomUpdateMessage(message,model){switch(message.type){case ObjectRoomUpdateMessage.ROOM_FLOOR_UPDATE:model.setValue(RoomObjectVariable.ROOM_FLOOR_TYPE,message.value);return;case ObjectRoomUpdateMessage.ROOM_WALL_UPDATE:model.setValue(RoomObjectVariable.ROOM_WALL_TYPE,message.value);return;case ObjectRoomUpdateMessage.ROOM_LANDSCAPE_UPDATE:model.setValue(RoomObjectVariable.ROOM_LANDSCAPE_TYPE,message.value);return;}}},{key:\"onObjectRoomMaskUpdateMessage\",value:function onObjectRoomMaskUpdateMessage(message,_arg_2){var maskType=null;var update=false;switch(message.type){case ObjectRoomMaskUpdateMessage.ADD_MASK:maskType=RoomPlaneBitmapMaskData.WINDOW;if(message.maskCategory===ObjectRoomMaskUpdateMessage.HOLE)maskType=RoomPlaneBitmapMaskData.HOLE;this._planeBitmapMaskParser.addMask(message.maskId,message.maskType,message.maskLocation,maskType);update=true;break;case ObjectRoomMaskUpdateMessage.REMOVE_MASK:update=this._planeBitmapMaskParser.removeMask(message.maskId);break;}if(update)_arg_2.setValue(RoomObjectVariable.ROOM_PLANE_MASK_XML,this._planeBitmapMaskParser.getXML());}},{key:\"onObjectRoomPlaneVisibilityUpdateMessage\",value:function onObjectRoomPlaneVisibilityUpdateMessage(message,model){var visible=0;if(message.visible)visible=1;switch(message.type){case ObjectRoomPlaneVisibilityUpdateMessage.FLOOR_VISIBILITY:model.setValue(RoomObjectVariable.ROOM_FLOOR_VISIBILITY,visible);return;case ObjectRoomPlaneVisibilityUpdateMessage.WALL_VISIBILITY:model.setValue(RoomObjectVariable.ROOM_WALL_VISIBILITY,visible);model.setValue(RoomObjectVariable.ROOM_LANDSCAPE_VISIBILITY,visible);return;}}},{key:\"onObjectRoomPlanePropertyUpdateMessage\",value:function onObjectRoomPlanePropertyUpdateMessage(message,model){switch(message.type){case ObjectRoomPlanePropertyUpdateMessage.FLOOR_THICKNESS:model.setValue(RoomObjectVariable.ROOM_FLOOR_THICKNESS,message.value);return;case ObjectRoomPlanePropertyUpdateMessage.WALL_THICKNESS:model.setValue(RoomObjectVariable.ROOM_WALL_THICKNESS,message.value);return;}}},{key:\"onObjectRoomFloorHoleUpdateMessage\",value:function onObjectRoomFloorHoleUpdateMessage(message,model){switch(message.type){case ObjectRoomFloorHoleUpdateMessage.ADD:this._planeParser.addFloorHole(message.id,message.x,message.y,message.width,message.height);this._needsMapUpdate=true;return;case ObjectRoomFloorHoleUpdateMessage.REMOVE:this._planeParser.removeFloorHole(message.id);this._needsMapUpdate=true;return;}this._lastHoleUpdate=this.time;}},{key:\"onObjectRoomColorUpdateMessage\",value:function onObjectRoomColorUpdateMessage(message,model){if(!message||!model)return;this._originalColor=this._color;this._originalLight=this._light;this._targetColor=message.color;this._targetLight=message.light;this._colorChangedTime=this.time;if(this._skipColorTransition)this._colorTransitionLength=0;else this._colorTransitionLength=1500;model.setValue(RoomObjectVariable.ROOM_COLORIZE_BG_ONLY,message.backgroundOnly);}},{key:\"onObjectRoomMapUpdateMessage\",value:function onObjectRoomMapUpdateMessage(message){if(!message||!message.mapData)return;this.object.model.setValue(RoomObjectVariable.ROOM_MAP_DATA,message.mapData);this.object.model.setValue(RoomObjectVariable.ROOM_FLOOR_HOLE_UPDATE_TIME,this.time);this._planeParser.initializeFromMapData(message.mapData);}},{key:\"mouseEvent\",value:function mouseEvent(event,geometry){if(!event||!geometry||!this.object||!this.object.model)return;var tag=event.spriteTag;var planeId=0;if(tag&&tag.indexOf('@')>=0){planeId=parseInt(tag.substr(tag.indexOf('@')+1));}if(planeId<1||planeId>this._planeParser.planeCount){if(event.type===MouseEventType.ROLL_OUT){this.object.model.setValue(RoomObjectVariable.ROOM_SELECTED_PLANE,0);}return;}planeId--;var planePosition=null;var planeLocation=this._planeParser.getPlaneLocation(planeId);var planeLeftSide=this._planeParser.getPlaneLeftSide(planeId);var planeRightSide=this._planeParser.getPlaneRightSide(planeId);var planeNormalDirection=this._planeParser.getPlaneNormalDirection(planeId);var planeType=this._planeParser.getPlaneType(planeId);if(planeLocation==null||planeLeftSide==null||planeRightSide==null||planeNormalDirection==null)return;var leftSideLength=planeLeftSide.length;var rightSideLength=planeRightSide.length;if(leftSideLength==0||rightSideLength==0)return;var screenX=event.screenX;var screenY=event.screenY;var screenPoint=new Point(screenX,screenY);planePosition=geometry.getPlanePosition(screenPoint,planeLocation,planeLeftSide,planeRightSide);if(!planePosition){this.object.model.setValue(RoomObjectVariable.ROOM_SELECTED_PLANE,0);return;}var _local_18=Vector3d.product(planeLeftSide,planePosition.x/leftSideLength);_local_18.add(Vector3d.product(planeRightSide,planePosition.y/rightSideLength));_local_18.add(planeLocation);var tileX=_local_18.x;var tileY=_local_18.y;var tileZ=_local_18.z;if(planePosition.x>=0&&planePosition.x<leftSideLength&&planePosition.y>=0&&planePosition.y<rightSideLength){this.object.model.setValue(RoomObjectVariable.ROOM_SELECTED_X,tileX);this.object.model.setValue(RoomObjectVariable.ROOM_SELECTED_Y,tileY);this.object.model.setValue(RoomObjectVariable.ROOM_SELECTED_Z,tileZ);this.object.model.setValue(RoomObjectVariable.ROOM_SELECTED_PLANE,planeId+1);}else{this.object.model.setValue(RoomObjectVariable.ROOM_SELECTED_PLANE,0);return;}var eventType=null;if(event.type===MouseEventType.MOUSE_MOVE||event.type===MouseEventType.ROLL_OVER)eventType=RoomObjectMouseEvent.MOUSE_MOVE;else if(event.type===MouseEventType.MOUSE_CLICK)eventType=RoomObjectMouseEvent.CLICK;switch(event.type){case MouseEventType.MOUSE_MOVE:case MouseEventType.ROLL_OVER:case MouseEventType.MOUSE_CLICK:{var newEvent=null;if(planeType===RoomPlaneData.PLANE_FLOOR){newEvent=new RoomObjectTileMouseEvent(eventType,this.object,event.eventId,tileX,tileY,tileZ,event.altKey,event.ctrlKey,event.shiftKey,event.buttonDown);}else if(planeType===RoomPlaneData.PLANE_WALL||planeType===RoomPlaneData.PLANE_LANDSCAPE){var direction=90;if(planeNormalDirection){direction=planeNormalDirection.x+90;if(direction>360)direction-=360;}var _local_27=planeLeftSide.length*planePosition.x/leftSideLength;var _local_28=planeRightSide.length*planePosition.y/rightSideLength;newEvent=new RoomObjectWallMouseEvent(eventType,this.object,event.eventId,planeLocation,planeLeftSide,planeRightSide,_local_27,_local_28,direction,event.altKey,event.ctrlKey,event.shiftKey,event.buttonDown);}if(this.eventDispatcher)this.eventDispatcher.dispatchEvent(newEvent);return;}}}}]);return RoomLogic;}(RoomObjectLogicBase);","map":null,"metadata":{},"sourceType":"module"}