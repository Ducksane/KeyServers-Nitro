{"ast":null,"code":"import _createForOfIteratorHelper from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/home/muphy/Documents/habboom/Nitro-Edit-main/node_modules/@babel/runtime/helpers/esm/createClass.js\";import{Texture}from'@pixi/core';import{Matrix,Point,Rectangle}from'@pixi/math';import{NitroContainer,NitroSprite}from'../../../core';import{RoomObjectSpriteData}from'../../../room/data/RoomObjectSpriteData';import{Nitro}from'../../Nitro';import{AvatarAnimationLayerData}from'../animation/AvatarAnimationLayerData';import{AvatarImageBodyPartContainer}from'../AvatarImageBodyPartContainer';import{AvatarDirectionAngle}from'../enum/AvatarDirectionAngle';import{AvatarFigurePartType}from'../enum/AvatarFigurePartType';import{AvatarScaleType}from'../enum/AvatarScaleType';import{GeometryType}from'../enum/GeometryType';import{AvatarImageActionCache}from'./AvatarImageActionCache';import{AvatarImageBodyPartCache}from'./AvatarImageBodyPartCache';import{AvatarImageDirectionCache}from'./AvatarImageDirectionCache';import{ImageData}from'./ImageData';export var AvatarImageCache=/*#__PURE__*/function(){function AvatarImageCache(k,_arg_2,_arg_3,_arg_4){_classCallCheck(this,AvatarImageCache);this._structure=void 0;this._avatar=void 0;this._assets=void 0;this._scale=void 0;this._cache=void 0;this._canvas=void 0;this._disposed=void 0;this._geometryType=void 0;this._unionImages=void 0;this._matrix=void 0;this._serverRenderData=void 0;this._structure=k;this._avatar=_arg_2;this._assets=_arg_3;this._scale=_arg_4;this._cache=new Map();this._canvas=null;this._disposed=false;this._unionImages=[];this._matrix=new Matrix();this._serverRenderData=[];}_createClass(AvatarImageCache,[{key:\"dispose\",value:function dispose(){if(this._disposed)return;this._structure=null;this._avatar=null;this._assets=null;this._canvas=null;this._disposed=true;if(this._cache){var _iterator=_createForOfIteratorHelper(this._cache.values()),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var cache=_step.value;if(!cache)continue;cache.dispose();}}catch(err){_iterator.e(err);}finally{_iterator.f();}this._cache=null;}if(this._unionImages){var _iterator2=_createForOfIteratorHelper(this._unionImages),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var image=_step2.value;if(!image)continue;image.dispose();}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}this._unionImages=[];}}},{key:\"disposeInactiveActions\",value:function disposeInactiveActions(){var k=arguments.length>0&&arguments[0]!==undefined?arguments[0]:60000;var time=Nitro.instance.time;if(this._cache){var _iterator3=_createForOfIteratorHelper(this._cache.values()),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var cache=_step3.value;if(!cache)continue;cache.disposeActions(k,time);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}}}},{key:\"resetBodyPartCache\",value:function resetBodyPartCache(k){if(this._cache){var _iterator4=_createForOfIteratorHelper(this._cache.values()),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var cache=_step4.value;if(!cache)continue;cache.setAction(k,0);}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}}}},{key:\"setDirection\",value:function setDirection(k,_arg_2){var parts=this._structure.getBodyPartsUnordered(k);if(parts){var _iterator5=_createForOfIteratorHelper(parts),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var part=_step5.value;var actionCache=this.getBodyPartCache(part);if(!actionCache)continue;actionCache.setDirection(_arg_2);}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}}}},{key:\"setAction\",value:function setAction(k,_arg_2){var _local_3=this._structure.getActiveBodyPartIds(k,this._avatar);var _iterator6=_createForOfIteratorHelper(_local_3),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var _local_4=_step6.value;var _local_5=this.getBodyPartCache(_local_4);if(_local_5)_local_5.setAction(k,_arg_2);}}catch(err){_iterator6.e(err);}finally{_iterator6.f();}}},{key:\"setGeometryType\",value:function setGeometryType(k){if(this._geometryType===k)return;if(this._geometryType===GeometryType.SITTING&&k===GeometryType.VERTICAL||this._geometryType===GeometryType.VERTICAL&&k===GeometryType.SITTING||this._geometryType===GeometryType.SNOWWARS_HORIZONTAL&&(k=GeometryType.SNOWWARS_HORIZONTAL)){this._geometryType=k;this._canvas=null;return;}this.disposeInactiveActions(0);this._geometryType=k;this._canvas=null;}},{key:\"getImageContainer\",value:function getImageContainer(k,frameNumber){var _arg_3=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var _local_4=this.getBodyPartCache(k);if(!_local_4){_local_4=new AvatarImageBodyPartCache();this._cache.set(k,_local_4);}var _local_5=_local_4.getDirection();var _local_7=_local_4.getAction();var frameCount=frameNumber;if(_local_7.definition.startFromFrameZero)frameCount-=_local_7.startFrame;var _local_8=_local_7;var _local_9=[];var _local_10=new Map();var _local_11=new Point();if(!(!_local_7||!_local_7.definition)){if(_local_7.definition.isAnimation){var _local_15=_local_5;var _local_16=this._structure.getAnimation(_local_7.definition.state+'.'+_local_7.actionParameter);var _local_17=frameNumber-_local_7.startFrame;if(_local_16){var _local_18=_local_16.getLayerData(_local_17,k,_local_7.overridingAction);if(_local_18){_local_15=_local_5+_local_18.dd;if(_local_18.dd<0){if(_local_15<0){_local_15=8+_local_15;}else if(_local_15>7)_local_15=8-_local_15;}else{if(_local_15<0){_local_15=_local_15+8;}else if(_local_15>7)_local_15=_local_15-8;}if(this._scale===AvatarScaleType.LARGE){_local_11.x=_local_18.dx;_local_11.y=_local_18.dy;}else{_local_11.x=_local_18.dx/2;_local_11.y=_local_18.dy/2;}frameCount=_local_18.animationFrame;if(_local_18.action){_local_7=_local_18.action;}if(_local_18.type===AvatarAnimationLayerData.BODYPART){if(_local_18.action!=null){_local_8=_local_18.action;}_local_5=_local_15;}else if(_local_18.type===AvatarAnimationLayerData.FX)_local_5=_local_15;_local_10=_local_18.items;}_local_9=_local_16.removeData;}}}var _local_12=_local_4.getActionCache(_local_8);if(!_local_12||_arg_3){_local_12=new AvatarImageActionCache();_local_4.updateActionCache(_local_8,_local_12);}var _local_13=_local_12.getDirectionCache(_local_5);if(!_local_13||_arg_3){var _local_19=this._structure.getParts(k,this._avatar.getFigure(),_local_8,this._geometryType,_local_5,_local_9,this._avatar,_local_10);_local_13=new AvatarImageDirectionCache(_local_19);_local_12.updateDirectionCache(_local_5,_local_13);}var _local_14=_local_13.getImageContainer(frameCount);if(!_local_14||_arg_3){var _local_20=_local_13.getPartList();_local_14=this.renderBodyPart(_local_5,_local_20,frameCount,_local_7,_arg_3);if(_local_14&&!_arg_3){if(_local_14.isCacheable)_local_13.updateImageContainer(_local_14,frameCount);}else{return null;}}var offset=this._structure.getFrameBodyPartOffset(_local_8,_local_5,frameCount,k);_local_11.x+=offset.x;_local_11.y+=offset.y;_local_14.offset=_local_11;return _local_14;}},{key:\"getServerRenderData\",value:function getServerRenderData(){this._serverRenderData=[];return this._serverRenderData;}},{key:\"getBodyPartCache\",value:function getBodyPartCache(k){var existing=this._cache.get(k);if(!existing){existing=new AvatarImageBodyPartCache();this._cache.set(k,existing);}return existing;}},{key:\"renderBodyPart\",value:function renderBodyPart(direction,containers,frameCount,_arg_4){var renderServerData=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;if(!containers||!containers.length)return null;if(!this._canvas){this._canvas=this._structure.getCanvas(this._scale,this._geometryType);if(!this._canvas)return null;}var isFlipped=AvatarDirectionAngle.DIRECTION_IS_FLIPPED[direction]||false;var assetPartDefinition=_arg_4.definition.assetPartDefinition;var isCacheable=true;var containerIndex=containers.length-1;while(containerIndex>=0){var container=containers[containerIndex];var color=16777215;if(!(direction==7&&(container.partType==='fc'||container.partType==='ey'))){if(!(container.partType==='ri'&&!container.partId)){var partId=container.partId;var animationFrame=container.getFrameDefinition(frameCount);var partType=container.partType;var frameNumber=0;if(animationFrame){frameNumber=animationFrame.number;if(animationFrame.assetPartDefinition&&animationFrame.assetPartDefinition!=='')assetPartDefinition=animationFrame.assetPartDefinition;}else frameNumber=container.getFrameIndex(frameCount);var assetDirection=direction;var flipH=false;if(isFlipped){if(assetPartDefinition==='wav'&&(partType===AvatarFigurePartType.LEFT_HAND||partType===AvatarFigurePartType.LEFT_SLEEVE||partType===AvatarFigurePartType.LEFT_COAT_SLEEVE)||assetPartDefinition==='drk'&&(partType===AvatarFigurePartType.RIGHT_HAND||partType===AvatarFigurePartType.RIGHT_SLEEVE||partType===AvatarFigurePartType.RIGHT_COAT_SLEEVE)||assetPartDefinition==='blw'&&partType===AvatarFigurePartType.RIGHT_HAND||assetPartDefinition==='sig'&&partType===AvatarFigurePartType.LEFT_HAND||assetPartDefinition==='respect'&&partType===AvatarFigurePartType.LEFT_HAND||partType===AvatarFigurePartType.RIGHT_HAND_ITEM||partType===AvatarFigurePartType.LEFT_HAND_ITEM||partType===AvatarFigurePartType.CHEST_PRINT){flipH=true;}else{if(direction===4)assetDirection=2;else if(direction===5)assetDirection=1;else if(direction===6)assetDirection=0;if(container.flippedPartType!==partType)partType=container.flippedPartType;}}var assetName=this._scale+'_'+assetPartDefinition+'_'+partType+'_'+partId+'_'+assetDirection+'_'+frameNumber;var asset=this._assets.getAsset(assetName);if(!asset){assetName=this._scale+'_std_'+partType+'_'+partId+'_'+assetDirection+'_0';asset=this._assets.getAsset(assetName);}if(asset){var texture=asset.texture;if(!texture||!texture.valid||!texture.baseTexture){isCacheable=false;}else{if(container.isColorable&&container.color)color=container.color.rgb;var _offset=new Point(-asset.x,-asset.y);if(flipH)_offset.x=_offset.x+(this._scale===AvatarScaleType.LARGE?65:31);if(renderServerData){var spriteData=new RoomObjectSpriteData();spriteData.name=this._assets.getAssetName(assetName);spriteData.x=-_offset.x-33;spriteData.y=-_offset.y;spriteData.z=this._serverRenderData.length*-0.0001;spriteData.width=asset.rectangle.width;spriteData.height=asset.rectangle.height;spriteData.flipH=flipH;if(assetPartDefinition==='lay')spriteData.x=spriteData.x+53;if(isFlipped){spriteData.flipH=!spriteData.flipH;if(spriteData.flipH)spriteData.x=-spriteData.x-texture.width;else spriteData.x=spriteData.x+65;}if(container.isColorable)spriteData.color=\"\".concat(color);this._serverRenderData.push(spriteData);}this._unionImages.push(new ImageData(texture,asset.rectangle,_offset,flipH,color));}}}}containerIndex--;}if(!this._unionImages.length)return null;var imageData=this.createUnionImage(this._unionImages,isFlipped);var canvasOffset=this._scale===AvatarScaleType.LARGE?this._canvas.height-16:this._canvas.height-8;var offset=new Point(-imageData.regPoint.x,canvasOffset-imageData.regPoint.y);if(isFlipped&&assetPartDefinition!=='lay')offset.x=offset.x+(this._scale===AvatarScaleType.LARGE?67:31);var imageIndex=this._unionImages.length-1;while(imageIndex>=0){var _local_17=this._unionImages.pop();if(_local_17)_local_17.dispose();imageIndex--;}return new AvatarImageBodyPartContainer(imageData.container,offset,isCacheable);}},{key:\"convertColorToHex\",value:function convertColorToHex(k){var _local_2=(k*0xFF).toString(16);if(_local_2.length<2){_local_2='0'+_local_2;}return _local_2;}},{key:\"createUnionImage\",value:function createUnionImage(k,isFlipped){var bounds=new Rectangle();var _iterator7=_createForOfIteratorHelper(k),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var data=_step7.value;data&&bounds.enlarge(data.offsetRect);}}catch(err){_iterator7.e(err);}finally{_iterator7.f();}var point=new Point(-bounds.x,-bounds.y);var container=new NitroContainer();var sprite=new NitroSprite(Texture.EMPTY);sprite.width=bounds.width;sprite.height=bounds.height;container.addChild(sprite);var _iterator8=_createForOfIteratorHelper(k),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var _data=_step8.value;if(!_data)continue;var texture=_data.texture;var color=_data.colorTransform;var flipH=!(isFlipped&&_data.flipH)&&(isFlipped||_data.flipH);var regPoint=point.clone();regPoint.x-=_data.regPoint.x;regPoint.y-=_data.regPoint.y;if(isFlipped)regPoint.x=container.width-(regPoint.x+_data.rect.width);if(flipH){this._matrix.a=-1;this._matrix.tx=_data.rect.x+_data.rect.width+regPoint.x;this._matrix.ty=regPoint.y-_data.rect.y;}else{this._matrix.a=1;this._matrix.tx=regPoint.x-_data.rect.x;this._matrix.ty=regPoint.y-_data.rect.y;}var _sprite=new NitroSprite(texture);_sprite.tint=color;_sprite.transform.setFromMatrix(this._matrix);container.addChild(_sprite);}}catch(err){_iterator8.e(err);}finally{_iterator8.f();}return new ImageData(null,container.getLocalBounds(),point,isFlipped,null,container);}}]);return AvatarImageCache;}();AvatarImageCache.DEFAULT_MAX_CACHE_STORAGE_TIME_MS=60000;","map":null,"metadata":{},"sourceType":"module"}