{"ast":null,"code":"import _slicedToArray from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _createForOfIteratorHelper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createClass.js\";import{Point}from'@pixi/math';import{Vector3d}from'../../../room/utils/Vector3d';import{RoomFloorHole}from'./RoomFloorHole';import{RoomMapData}from'./RoomMapData';import{RoomPlaneData}from'./RoomPlaneData';import{RoomWallData}from'./RoomWallData';export var RoomPlaneParser=/*#__PURE__*/function(){function RoomPlaneParser(){_classCallCheck(this,RoomPlaneParser);this._tileMatrix=void 0;this._tileMatrixOriginal=void 0;this._width=0;this._height=0;this._minX=0;this._maxX=0;this._minY=0;this._maxY=0;this._planes=void 0;this._wallHeight=void 0;this._wallThicknessMultiplier=void 0;this._floorThicknessMultiplier=void 0;this._fixedWallHeight=-1;this._floorHeight=0;this._floorHoles=void 0;this._floorHoleMatrix=void 0;this._restrictsDragging=void 0;this._restrictsScaling=false;this._restrictedScale=1;this._tileMatrix=[];this._tileMatrixOriginal=[];this._planes=[];this._floorHoleMatrix=[];this._wallHeight=3.6;this._wallThicknessMultiplier=1;this._floorThicknessMultiplier=1;this._floorHoles=new Map();}_createClass(RoomPlaneParser,[{key:\"minX\",get:function get(){return this._minX;}},{key:\"maxX\",get:function get(){return this._maxX;}},{key:\"minY\",get:function get(){return this._minY;}},{key:\"maxY\",get:function get(){return this._maxY;}},{key:\"tileMapWidth\",get:function get(){return this._width;}},{key:\"tileMapHeight\",get:function get(){return this._height;}},{key:\"planeCount\",get:function get(){return this._planes.length;}},{key:\"floorHeight\",get:function get(){if(this._fixedWallHeight!=-1){return this._fixedWallHeight;}return this._floorHeight;}},{key:\"wallHeight\",get:function get(){if(this._fixedWallHeight!=-1){return this._fixedWallHeight+3.6;}return this._wallHeight;},set:function set(k){if(k<0){k=0;}this._wallHeight=k;}},{key:\"wallThicknessMultiplier\",get:function get(){return this._wallThicknessMultiplier;},set:function set(k){if(k<0){k=0;}this._wallThicknessMultiplier=k;}},{key:\"floorThicknessMultiplier\",get:function get(){return this._floorThicknessMultiplier;},set:function set(k){if(k<0){k=0;}this._floorThicknessMultiplier=k;}},{key:\"dispose\",value:function dispose(){this._planes=null;this._tileMatrix=null;this._tileMatrixOriginal=null;this._floorHoleMatrix=null;if(this._floorHoles!=null){this._floorHoles.clear();this._floorHoles=null;}}},{key:\"reset\",value:function reset(){this._planes=[];this._tileMatrix=[];this._tileMatrixOriginal=[];this._width=0;this._height=0;this._minX=0;this._maxX=0;this._minY=0;this._maxY=0;this._floorHeight=0;this._floorHoleMatrix=[];}},{key:\"initializeTileMap\",value:function initializeTileMap(width,height){if(width<0)width=0;if(height<0)height=0;this._tileMatrix=[];this._tileMatrixOriginal=[];this._floorHoleMatrix=[];var y=0;while(y<height){var tileMatrix=[];var tileMatrixOriginal=[];var floorHoleMatrix=[];var x=0;while(x<width){tileMatrix[x]=RoomPlaneParser.TILE_BLOCKED;tileMatrixOriginal[x]=RoomPlaneParser.TILE_BLOCKED;floorHoleMatrix[x]=false;x++;}this._tileMatrix.push(tileMatrix);this._tileMatrixOriginal.push(tileMatrixOriginal);this._floorHoleMatrix.push(floorHoleMatrix);y++;}this._width=width;this._height=height;this._minX=this._width;this._maxX=-1;this._minY=this._height;this._maxY=-1;return true;}},{key:\"setTileHeight\",value:function setTileHeight(k,_arg_2,_arg_3){var _local_4;var _local_5;var _local_6;var _local_7;var _local_8;if(k>=0&&k<this._width&&_arg_2>=0&&_arg_2<this._height){_local_4=this._tileMatrix[_arg_2];_local_4[k]=_arg_3;if(_arg_3>=0){if(k<this._minX){this._minX=k;}if(k>this._maxX){this._maxX=k;}if(_arg_2<this._minY){this._minY=_arg_2;}if(_arg_2>this._maxY){this._maxY=_arg_2;}}else{if(k==this._minX||k==this._maxX){_local_5=false;_local_6=this._minY;while(_local_6<this._maxY){if(this.getTileHeightInternal(k,_local_6)>=0){_local_5=true;break;}_local_6++;}if(!_local_5){if(k==this._minX){this._minX++;}if(k==this._maxX){this._maxX--;}}}if(_arg_2==this._minY||_arg_2==this._maxY){_local_7=false;_local_8=this._minX;while(_local_8<this._maxX){if(this.getTileHeight(_local_8,_arg_2)>=0){_local_7=true;break;}_local_8++;}if(!_local_7){if(_arg_2==this._minY){this._minY++;}if(_arg_2==this._maxY){this._maxY--;}}}}return true;}return false;}},{key:\"getTileHeight\",value:function getTileHeight(k,_arg_2){if(k<0||k>=this._width||_arg_2<0||_arg_2>=this._height){return RoomPlaneParser.TILE_BLOCKED;}var _local_3=this._tileMatrix[_arg_2];if(_local_3[k]===undefined)return 0;return Math.abs(_local_3[k]);}},{key:\"getTileHeightOriginal\",value:function getTileHeightOriginal(k,_arg_2){if(k<0||k>=this._width||_arg_2<0||_arg_2>=this._height){return RoomPlaneParser.TILE_BLOCKED;}if(this._floorHoleMatrix[_arg_2][k]){return RoomPlaneParser.TILE_HOLE;}var _local_3=this._tileMatrixOriginal[_arg_2];return _local_3[k];}},{key:\"getTileHeightInternal\",value:function getTileHeightInternal(k,_arg_2){if(k<0||k>=this._width||_arg_2<0||_arg_2>=this._height){return RoomPlaneParser.TILE_BLOCKED;}var _local_3=this._tileMatrix[_arg_2];return _local_3[k];}},{key:\"initializeFromTileData\",value:function initializeFromTileData(){var k=arguments.length>0&&arguments[0]!==undefined?arguments[0]:-1;var _local_2;var _local_3;this._fixedWallHeight=k;_local_3=0;while(_local_3<this._height){_local_2=0;while(_local_2<this._width){if(this._tileMatrixOriginal[_local_3]===undefined)this._tileMatrixOriginal[_local_3]=[];this._tileMatrixOriginal[_local_3][_local_2]=this._tileMatrix[_local_3][_local_2];_local_2++;}_local_3++;}var _local_4=RoomPlaneParser.findEntranceTile(this._tileMatrix);_local_3=0;while(_local_3<this._height){_local_2=0;while(_local_2<this._width){if(this._floorHoleMatrix[_local_3]===undefined)this._floorHoleMatrix[_local_3]=[];if(this._floorHoleMatrix[_local_3][_local_2]){this.setTileHeight(_local_2,_local_3,RoomPlaneParser.TILE_HOLE);}_local_2++;}_local_3++;}return this.initialize(_local_4);}},{key:\"initialize\",value:function initialize(k){var _local_2=0;if(k!=null){_local_2=this.getTileHeight(k.x,k.y);this.setTileHeight(k.x,k.y,RoomPlaneParser.TILE_BLOCKED);}this._floorHeight=RoomPlaneParser.getFloorHeight(this._tileMatrix);this.createWallPlanes();var _local_3=[];var _iterator=_createForOfIteratorHelper(this._tileMatrix),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var _local_4=_step.value;_local_3.push(_local_4.concat());}}catch(err){_iterator.e(err);}finally{_iterator.f();}RoomPlaneParser.padHeightMap(_local_3);RoomPlaneParser.addTileTypes(_local_3);RoomPlaneParser.unpadHeightMap(_local_3);var _local_5=RoomPlaneParser.expandFloorTiles(_local_3);this.extractPlanes(_local_5);if(k!=null){this.setTileHeight(k.x,k.y,_local_2);this.addFloor(new Vector3d(k.x+0.5,k.y+0.5,_local_2),new Vector3d(-1,0,0),new Vector3d(0,-1,0),false,false,false,false);}return true;}},{key:\"generateWallData\",value:function generateWallData(k,_arg_2){var _local_8;var _local_9;var _local_10;var _local_11;var _local_12;var _local_3=new RoomWallData();var _local_4=[this.extractTopWall.bind(this),this.extractRightWall.bind(this),this.extractBottomWall.bind(this),this.extractLeftWall.bind(this)];var _local_5=0;var _local_6=new Point(k.x,k.y);var _local_7=0;while(_local_7++<1000){_local_8=false;_local_9=false;_local_10=_local_5;if(_local_6.x<this.minX||_local_6.x>this.maxX||_local_6.y<this.minY||_local_6.y>this.maxY){_local_8=true;}_local_11=_local_4[_local_5](_local_6,_arg_2);if(_local_11==null){return null;}_local_12=Math.abs(_local_11.x-_local_6.x)+Math.abs(_local_11.y-_local_6.y);if(_local_6.x==_local_11.x||_local_6.y==_local_11.y){_local_5=(_local_5-1+_local_4.length)%_local_4.length;_local_12=_local_12+1;_local_9=true;}else{_local_5=(_local_5+1)%_local_4.length;_local_12--;}_local_3.addWall(_local_6,_local_10,_local_12,_local_8,_local_9);if(_local_11.x==k.x&&_local_11.y==k.y&&(!(_local_11.x==_local_6.x)||!(_local_11.y==_local_6.y))){break;}_local_6=_local_11;}if(_local_3.count==0){return null;}return _local_3;}},{key:\"hidePeninsulaWallChains\",value:function hidePeninsulaWallChains(k){var _local_5;var _local_6;var _local_7;var _local_8;var _local_2=0;var _local_3=k.count;while(_local_2<_local_3){var _local_4=_local_2;_local_5=_local_2;_local_6=0;_local_7=false;while(!k.getBorder(_local_2)&&_local_2<_local_3){if(k.getLeftTurn(_local_2)){_local_6++;}else{if(_local_6>0){_local_6--;}}if(_local_6>1){_local_7=true;}_local_5=_local_2;_local_2++;}if(_local_7){_local_8=_local_4;while(_local_8<=_local_5){k.setHideWall(_local_8,true);_local_8++;}}_local_2++;}}},{key:\"updateWallsNextToHoles\",value:function updateWallsNextToHoles(k){var _local_4;var _local_5;var _local_6;var _local_7;var _local_8;var _local_9;var _local_10;var _local_2=k.count;var _local_3=0;while(_local_3<_local_2){if(!k.getHideWall(_local_3)){_local_4=k.getCorner(_local_3);_local_5=k.getDirection(_local_3);_local_6=k.getLength(_local_3);_local_7=RoomWallData.WALL_DIRECTION_VECTORS[_local_5];_local_8=RoomWallData.WALL_NORMAL_VECTORS[_local_5];_local_9=0;_local_10=0;while(_local_10<_local_6){if(this.getTileHeightInternal(_local_4.x+_local_10*_local_7.x-_local_8.x,_local_4.y+_local_10*_local_7.y-_local_8.y)==RoomPlaneParser.TILE_HOLE){if(_local_10>0&&_local_9==0){k.setLength(_local_3,_local_10);break;}_local_9++;}else{if(_local_9>0){k.moveCorner(_local_3,_local_9);break;}}_local_10++;}if(_local_9==_local_6){k.setHideWall(_local_3,true);}}_local_3++;}}},{key:\"resolveOriginalWallIndex\",value:function resolveOriginalWallIndex(k,_arg_2,_arg_3){var _local_10;var _local_11;var _local_12;var _local_13;var _local_14;var _local_15;var _local_4=Math.min(k.y,_arg_2.y);var _local_5=Math.max(k.y,_arg_2.y);var _local_6=Math.min(k.x,_arg_2.x);var _local_7=Math.max(k.x,_arg_2.x);var _local_8=_arg_3.count;var _local_9=0;while(_local_9<_local_8){_local_10=_arg_3.getCorner(_local_9);_local_11=_arg_3.getEndPoint(_local_9);if(k.x==_arg_2.x){if(_local_10.x==k.x&&_local_11.x==k.x){_local_12=Math.min(_local_10.y,_local_11.y);_local_13=Math.max(_local_10.y,_local_11.y);if(_local_12<=_local_4&&_local_5<=_local_13){return _local_9;}}}else{if(k.y==_arg_2.y){if(_local_10.y==k.y&&_local_11.y==k.y){_local_14=Math.min(_local_10.x,_local_11.x);_local_15=Math.max(_local_10.x,_local_11.x);if(_local_14<=_local_6&&_local_7<=_local_15){return _local_9;}}}}_local_9++;}return-1;}},{key:\"hideOriginallyHiddenWalls\",value:function hideOriginallyHiddenWalls(k,_arg_2){var _local_5;var _local_6;var _local_7;var _local_8;var _local_9;var _local_3=k.count;var _local_4=0;while(_local_4<_local_3){if(!k.getHideWall(_local_4)){_local_5=k.getCorner(_local_4);_local_6=new Point(_local_5.x,_local_5.y);_local_7=RoomWallData.WALL_DIRECTION_VECTORS[k.getDirection(_local_4)];_local_8=k.getLength(_local_4);_local_6.x=_local_6.x+_local_7.x*_local_8;_local_6.y=_local_6.y+_local_7.y*_local_8;_local_9=this.resolveOriginalWallIndex(_local_5,_local_6,_arg_2);if(_local_9>=0){if(_arg_2.getHideWall(_local_9)){k.setHideWall(_local_4,true);}}else{k.setHideWall(_local_4,true);}}_local_4++;}}},{key:\"checkWallHiding\",value:function checkWallHiding(k,_arg_2){this.hidePeninsulaWallChains(_arg_2);this.updateWallsNextToHoles(k);this.hideOriginallyHiddenWalls(k,_arg_2);}},{key:\"addWalls\",value:function addWalls(k,_arg_2){var _local_3=k.count;var _local_4=_arg_2.count;var _local_7=0;while(_local_7<_local_3){if(!k.getHideWall(_local_7)){var _local_8=k.getCorner(_local_7);var _local_9=k.getDirection(_local_7);var _local_10=k.getLength(_local_7);var _local_11=RoomWallData.WALL_DIRECTION_VECTORS[_local_9];var _local_12=RoomWallData.WALL_NORMAL_VECTORS[_local_9];var _local_13=-1;var _local_14=0;while(_local_14<_local_10){var _local_27=this.getTileHeightInternal(_local_8.x+_local_14*_local_11.x+_local_12.x,_local_8.y+_local_14*_local_11.y+_local_12.y);if(_local_27>=0&&(_local_27<_local_13||_local_13<0)){_local_13=_local_27;}_local_14++;}var _local_15=_local_13;var _local_16=new Vector3d(_local_8.x,_local_8.y,_local_15);_local_16=Vector3d.sum(_local_16,Vector3d.product(_local_12,0.5));_local_16=Vector3d.sum(_local_16,Vector3d.product(_local_11,-0.5));var _local_17=this.wallHeight+Math.min(RoomPlaneParser.MAX_WALL_ADDITIONAL_HEIGHT,this.floorHeight)-_local_13;var _local_18=Vector3d.product(_local_11,-_local_10);var _local_19=new Vector3d(0,0,_local_17);_local_16=Vector3d.dif(_local_16,_local_18);var _local_20=this.resolveOriginalWallIndex(_local_8,k.getEndPoint(_local_7),_arg_2);var _local_5=0;var _local_6=0;if(_local_20>=0){_local_5=_arg_2.getDirection((_local_20+1)%_local_4);_local_6=_arg_2.getDirection((_local_20-1+_local_4)%_local_4);}else{_local_5=k.getDirection((_local_7+1)%_local_3);_local_6=k.getDirection((_local_7-1+_local_3)%_local_3);}var _local_21=null;if((_local_5-_local_9+4)%4==3){_local_21=RoomWallData.WALL_NORMAL_VECTORS[_local_5];}else{if((_local_9-_local_6+4)%4==3){_local_21=RoomWallData.WALL_NORMAL_VECTORS[_local_6];}}var _local_22=k.getLeftTurn(_local_7);var _local_23=k.getLeftTurn((_local_7-1+_local_3)%_local_3);var _local_24=k.getHideWall((_local_7+1)%_local_3);var _local_25=k.getManuallyLeftCut(_local_7);var _local_26=k.getManuallyRightCut(_local_7);this.addWall(_local_16,_local_18,_local_19,_local_21,!_local_23||_local_25,!_local_22||_local_26,!_local_24);}_local_7++;}}},{key:\"createWallPlanes\",value:function createWallPlanes(){var _local_13;var _local_14;var k=this._tileMatrix;if(k==null){return false;}var _local_2;var _local_3;var _local_4;var _local_5=k.length;var _local_6=0;if(_local_5==0){return false;}_local_2=0;while(_local_2<_local_5){_local_4=k[_local_2];if(_local_4==null||_local_4.length==0){return false;}if(_local_6>0){_local_6=Math.min(_local_6,_local_4.length);}else{_local_6=_local_4.length;}_local_2++;}var _local_7=Math.min(RoomPlaneParser.MAX_WALL_ADDITIONAL_HEIGHT,this._fixedWallHeight!=-1?this._fixedWallHeight:RoomPlaneParser.getFloorHeight(k));var _local_8=this.minX;var _local_9=this.minY;_local_9=this.minY;while(_local_9<=this.maxY){if(this.getTileHeightInternal(_local_8,_local_9)>RoomPlaneParser.TILE_HOLE){_local_9--;break;}_local_9++;}if(_local_9>this.maxY){return false;}var _local_10=new Point(_local_8,_local_9);var _local_11=this.generateWallData(_local_10,true);var _local_12=this.generateWallData(_local_10,false);if(_local_11!=null){_local_13=_local_11.count;_local_14=_local_12.count;this.checkWallHiding(_local_11,_local_12);this.addWalls(_local_11,_local_12);}_local_3=0;while(_local_3<this.tileMapHeight){_local_2=0;while(_local_2<this.tileMapWidth){if(this.getTileHeightInternal(_local_2,_local_3)<0){this.setTileHeight(_local_2,_local_3,-(_local_7+this.wallHeight));}_local_2++;}_local_3++;}return true;}},{key:\"extractTopWall\",value:function extractTopWall(k,_arg_2){if(k==null){return null;}var _local_3=1;var _local_4=RoomPlaneParser.TILE_HOLE;if(!_arg_2){_local_4=RoomPlaneParser.TILE_BLOCKED;}while(_local_3<1000){if(this.getTileHeightInternal(k.x+_local_3,k.y)>_local_4){return new Point(k.x+_local_3-1,k.y);}if(this.getTileHeightInternal(k.x+_local_3,k.y+1)<=_local_4){return new Point(k.x+_local_3,k.y+1);}_local_3++;}return null;}},{key:\"extractRightWall\",value:function extractRightWall(k,_arg_2){if(k==null){return null;}var _local_3=1;var _local_4=RoomPlaneParser.TILE_HOLE;if(!_arg_2){_local_4=RoomPlaneParser.TILE_BLOCKED;}while(_local_3<1000){if(this.getTileHeightInternal(k.x,k.y+_local_3)>_local_4){return new Point(k.x,k.y+(_local_3-1));}if(this.getTileHeightInternal(k.x-1,k.y+_local_3)<=_local_4){return new Point(k.x-1,k.y+_local_3);}_local_3++;}return null;}},{key:\"extractBottomWall\",value:function extractBottomWall(k,_arg_2){if(k==null){return null;}var _local_3=1;var _local_4=RoomPlaneParser.TILE_HOLE;if(!_arg_2){_local_4=RoomPlaneParser.TILE_BLOCKED;}while(_local_3<1000){if(this.getTileHeightInternal(k.x-_local_3,k.y)>_local_4){return new Point(k.x-(_local_3-1),k.y);}if(this.getTileHeightInternal(k.x-_local_3,k.y-1)<=_local_4){return new Point(k.x-_local_3,k.y-1);}_local_3++;}return null;}},{key:\"extractLeftWall\",value:function extractLeftWall(k,_arg_2){if(k==null){return null;}var _local_3=1;var _local_4=RoomPlaneParser.TILE_HOLE;if(!_arg_2){_local_4=RoomPlaneParser.TILE_BLOCKED;}while(_local_3<1000){if(this.getTileHeightInternal(k.x,k.y-_local_3)>_local_4){return new Point(k.x,k.y-(_local_3-1));}if(this.getTileHeightInternal(k.x+1,k.y-_local_3)<=_local_4){return new Point(k.x+1,k.y-_local_3);}_local_3++;}return null;}},{key:\"addWall\",value:function addWall(k,_arg_2,_arg_3,_arg_4,_arg_5,_arg_6,_arg_7){this.addPlane(RoomPlaneData.PLANE_WALL,k,_arg_2,_arg_3,[_arg_4]);//this.addPlane(RoomPlaneData.PLANE_LANDSCAPE, k, _arg_2, _arg_3, [_arg_4]);\nvar _local_8=RoomPlaneParser.WALL_THICKNESS*this._wallThicknessMultiplier;var _local_9=RoomPlaneParser.FLOOR_THICKNESS*this._floorThicknessMultiplier;var _local_10=Vector3d.crossProduct(_arg_2,_arg_3);var _local_11=Vector3d.product(_local_10,1/_local_10.length*-_local_8);this.addPlane(RoomPlaneData.PLANE_WALL,Vector3d.sum(k,_arg_3),_arg_2,_local_11,[_local_10,_arg_4]);if(_arg_5){this.addPlane(RoomPlaneData.PLANE_WALL,Vector3d.sum(Vector3d.sum(k,_arg_2),_arg_3),Vector3d.product(_arg_3,-(_arg_3.length+_local_9)/_arg_3.length),_local_11,[_local_10,_arg_4]);}if(_arg_6){this.addPlane(RoomPlaneData.PLANE_WALL,Vector3d.sum(k,Vector3d.product(_arg_3,-_local_9/_arg_3.length)),Vector3d.product(_arg_3,(_arg_3.length+_local_9)/_arg_3.length),_local_11,[_local_10,_arg_4]);if(_arg_7){var _local_12=Vector3d.product(_arg_2,_local_8/_arg_2.length);this.addPlane(RoomPlaneData.PLANE_WALL,Vector3d.sum(Vector3d.sum(k,_arg_3),Vector3d.product(_local_12,-1)),_local_12,_local_11,[_local_10,_arg_2,_arg_4]);}}}},{key:\"addFloor\",value:function addFloor(k,_arg_2,_arg_3,_arg_4,_arg_5,_arg_6,_arg_7){var _local_9;var _local_10;var _local_11;var _local_8=this.addPlane(RoomPlaneData.PLANE_FLOOR,k,_arg_2,_arg_3);if(_local_8!=null){_local_9=RoomPlaneParser.FLOOR_THICKNESS*this._floorThicknessMultiplier;_local_10=new Vector3d(0,0,_local_9);_local_11=Vector3d.dif(k,_local_10);if(_arg_6){this.addPlane(RoomPlaneData.PLANE_FLOOR,_local_11,_arg_2,_local_10);}if(_arg_7){this.addPlane(RoomPlaneData.PLANE_FLOOR,Vector3d.sum(_local_11,Vector3d.sum(_arg_2,_arg_3)),Vector3d.product(_arg_2,-1),_local_10);}if(_arg_4){this.addPlane(RoomPlaneData.PLANE_FLOOR,Vector3d.sum(_local_11,_arg_3),Vector3d.product(_arg_3,-1),_local_10);}if(_arg_5){this.addPlane(RoomPlaneData.PLANE_FLOOR,Vector3d.sum(_local_11,_arg_2),_arg_3,_local_10);}}}},{key:\"initializeFromMapData\",value:function initializeFromMapData(data){if(!data)return false;this.reset();this.resetFloorHoles();var width=data.width;var height=data.height;var wallHeight=data.wallHeight;var fixedWallsHeight=data.fixedWallsHeight;this.initializeTileMap(width,height);if(data.tileMap){var y=0;while(y<data.tileMap.length){var row=data.tileMap[y];if(row){var x=0;while(x<row.length){var column=row[x];if(column)this.setTileHeight(x,y,column.height);x++;}}y++;}}if(data.holeMap&&data.holeMap.length){var index=0;while(index<data.holeMap.length){var hole=data.holeMap[index];if(!hole)continue;this.addFloorHole(hole.id,hole.x,hole.y,hole.width,hole.height);index++;}this.initializeHoleMap();}this.wallHeight=wallHeight;this.restrictsDragging=data.restrictsDragging;this.restrictsScaling=data.restrictsScaling;this.restrictedScale=data.restrictedScale;this.initializeFromTileData(fixedWallsHeight);return true;}},{key:\"addPlane\",value:function addPlane(k,_arg_2,_arg_3,_arg_4){var _arg_5=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(_arg_3.length==0||_arg_4.length==0){return null;}var _local_6=new RoomPlaneData(k,_arg_2,_arg_3,_arg_4,_arg_5);this._planes.push(_local_6);return _local_6;}},{key:\"getMapData\",value:function getMapData(){var data=new RoomMapData();data.width=this._width;data.height=this._height;data.wallHeight=this._wallHeight;data.fixedWallsHeight=this._fixedWallHeight;data.dimensions.minX=this.minX;data.dimensions.maxX=this.maxX;data.dimensions.minY=this.minY;data.dimensions.maxY=this.maxY;data.restrictsDragging=this.restrictsDragging;data.restrictsScaling=this.restrictsScaling;data.restrictedScale=this.restrictedScale;var y=0;while(y<this._height){var tileRow=[];var tileMatrix=this._tileMatrixOriginal[y];var x=0;while(x<this._width){var tileHeight=tileMatrix[x];tileRow.push({height:tileHeight});x++;}data.tileMap.push(tileRow);y++;}var _iterator2=_createForOfIteratorHelper(this._floorHoles.entries()),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _step2$value=_slicedToArray(_step2.value,2),holeId=_step2$value[0],holeData=_step2$value[1];if(!holeData)continue;data.holeMap.push({id:holeId,x:holeData.x,y:holeData.y,width:holeData.width,height:holeData.height});}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}return data;}},{key:\"getPlaneLocation\",value:function getPlaneLocation(k){if(k<0||k>=this.planeCount)return null;var planeData=this._planes[k];if(!planeData)return null;return planeData.loc;}},{key:\"getPlaneNormal\",value:function getPlaneNormal(k){if(k<0||k>=this.planeCount)return null;var planeData=this._planes[k];if(!planeData)return null;return planeData.normal;}},{key:\"getPlaneLeftSide\",value:function getPlaneLeftSide(k){if(k<0||k>=this.planeCount)return null;var planeData=this._planes[k];if(!planeData)return null;return planeData.leftSide;}},{key:\"getPlaneRightSide\",value:function getPlaneRightSide(k){if(k<0||k>=this.planeCount)return null;var planeData=this._planes[k];if(!planeData)return null;return planeData.rightSide;}},{key:\"getPlaneNormalDirection\",value:function getPlaneNormalDirection(k){if(k<0||k>=this.planeCount)return null;var planeData=this._planes[k];if(!planeData)return null;return planeData.normalDirection;}},{key:\"getPlaneSecondaryNormals\",value:function getPlaneSecondaryNormals(k){var _local_3;var _local_4;if(k<0||k>=this.planeCount){return null;}var _local_2=this._planes[k];if(_local_2!=null){_local_3=[];_local_4=0;while(_local_4<_local_2.secondaryNormalCount){_local_3.push(_local_2.getSecondaryNormal(_local_4));_local_4++;}return _local_3;}return null;}},{key:\"getPlaneType\",value:function getPlaneType(k){if(k<0||k>=this.planeCount)return RoomPlaneData.PLANE_UNDEFINED;var planeData=this._planes[k];if(!planeData)return RoomPlaneData.PLANE_UNDEFINED;return planeData.type;}},{key:\"getPlaneMaskCount\",value:function getPlaneMaskCount(k){if(k<0||k>=this.planeCount)return 0;var planeData=this._planes[k];if(!planeData)return 0;return planeData.maskCount;}},{key:\"getPlaneMaskLeftSideLoc\",value:function getPlaneMaskLeftSideLoc(k,_arg_2){if(k<0||k>=this.planeCount)return-1;var planeData=this._planes[k];if(!planeData)return-1;return planeData.getMaskLeftSideLoc(_arg_2);}},{key:\"getPlaneMaskRightSideLoc\",value:function getPlaneMaskRightSideLoc(k,_arg_2){if(k<0||k>=this.planeCount)return-1;var planeData=this._planes[k];if(!planeData)return-1;return planeData.getMaskRightSideLoc(_arg_2);}},{key:\"getPlaneMaskLeftSideLength\",value:function getPlaneMaskLeftSideLength(k,_arg_2){if(k<0||k>=this.planeCount)return-1;var planeData=this._planes[k];if(!planeData)return-1;return planeData.getMaskLeftSideLength(_arg_2);}},{key:\"getPlaneMaskRightSideLength\",value:function getPlaneMaskRightSideLength(k,_arg_2){if(k<0||k>=this.planeCount)return-1;var planeData=this._planes[k];if(!planeData)return-1;return planeData.getMaskRightSideLength(_arg_2);}},{key:\"addFloorHole\",value:function addFloorHole(k,_arg_2,_arg_3,_arg_4,_arg_5){this.removeFloorHole(k);this._floorHoles.set(k,new RoomFloorHole(_arg_2,_arg_3,_arg_4,_arg_5));}},{key:\"removeFloorHole\",value:function removeFloorHole(k){this._floorHoles.delete(k);}},{key:\"resetFloorHoles\",value:function resetFloorHoles(){this._floorHoles.clear();}},{key:\"initializeHoleMap\",value:function initializeHoleMap(){var k;var _local_2;var _local_3;var _local_5;var _local_6;var _local_7;var _local_8;var _local_9;_local_2=0;while(_local_2<this._height){_local_3=this._floorHoleMatrix[_local_2];k=0;while(k<this._width){_local_3[k]=false;k++;}_local_2++;}var _iterator3=_createForOfIteratorHelper(this._floorHoles.values()),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _local_4=_step3.value;_local_5=_local_4;if(_local_5!=null){_local_6=_local_5.x;_local_7=_local_5.x+_local_5.width-1;_local_8=_local_5.y;_local_9=_local_5.y+_local_5.height-1;_local_6=_local_6<0?0:_local_6;_local_7=_local_7>=this._width?this._width-1:_local_7;_local_8=_local_8<0?0:_local_8;_local_9=_local_9>=this._height?this._height-1:_local_9;_local_2=_local_8;while(_local_2<=_local_9){_local_3=this._floorHoleMatrix[_local_2];k=_local_6;while(k<=_local_7){_local_3[k]=true;k++;}_local_2++;}}}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}}},{key:\"extractPlanes\",value:function extractPlanes(k){var _local_7;var _local_8;var _local_9;var _local_10;var _local_11;var _local_12;var _local_13;var _local_14;var _local_15;var _local_16;var _local_17;var _local_18;var _local_19;var _local_20;var _local_21;var _local_2=k.length;var _local_3=k[0].length;var _local_4=[];var _local_5=0;while(_local_5<_local_2){_local_4[_local_5]=[];_local_5++;}var _local_6=0;while(_local_6<_local_2){_local_7=0;while(_local_7<_local_3){_local_8=k[_local_6][_local_7];if(_local_8<0||_local_4[_local_6][_local_7]){//\n}else{_local_11=_local_7==0||!(k[_local_6][_local_7-1]==_local_8);_local_12=_local_6==0||!(k[_local_6-1][_local_7]==_local_8);_local_9=_local_7+1;while(_local_9<_local_3){if(!(k[_local_6][_local_9]==_local_8)||_local_4[_local_6][_local_9]||_local_6>0&&k[_local_6-1][_local_9]==_local_8==_local_12){break;}_local_9++;}_local_13=_local_9==_local_3||!(k[_local_6][_local_9]==_local_8);_local_17=false;_local_10=_local_6+1;while(_local_10<_local_2&&!_local_17){_local_14=!(k[_local_10][_local_7]==_local_8);_local_17=_local_14||_local_7>0&&k[_local_10][_local_7-1]==_local_8==_local_11||_local_9<_local_3&&k[_local_10][_local_9]==_local_8==_local_13;_local_15=_local_7;while(_local_15<_local_9){if(k[_local_10][_local_15]==_local_8==_local_14){_local_17=true;_local_9=_local_15;break;}_local_15++;}if(_local_17){break;}_local_10++;}_local_14=_local_14||_local_10==_local_2;_local_13=_local_9==_local_3||!(k[_local_6][_local_9]==_local_8);_local_16=_local_6;while(_local_16<_local_10){_local_15=_local_7;while(_local_15<_local_9){_local_4[_local_16][_local_15]=true;_local_15++;}_local_16++;}_local_18=_local_7/4-0.5;_local_19=_local_6/4-0.5;_local_20=(_local_9-_local_7)/4;_local_21=(_local_10-_local_6)/4;this.addFloor(new Vector3d(_local_18+_local_20,_local_19+_local_21,_local_8/4),new Vector3d(-_local_20,0,0),new Vector3d(0,-_local_21,0),_local_13,_local_11,_local_14,_local_12);}_local_7++;}_local_6++;}}},{key:\"restrictsDragging\",get:function get(){return this._restrictsDragging;},set:function set(flag){this._restrictsDragging=flag;}},{key:\"restrictsScaling\",get:function get(){return this._restrictsScaling;},set:function set(flag){this._restrictsScaling=flag;}},{key:\"restrictedScale\",get:function get(){return this._restrictedScale;},set:function set(scale){this._restrictedScale=scale;}}],[{key:\"getFloorHeight\",value:function getFloorHeight(matricies){var length=matricies.length;if(!length)return 0;var tileHeight=0;var i=0;while(i<length){var matrix=matricies[i];var j=0;while(j<matrix.length){var height=matrix[j];if(height>tileHeight)tileHeight=height;j++;}i++;}return tileHeight;}},{key:\"findEntranceTile\",value:function findEntranceTile(matricies){if(!matricies)return null;var length=matricies.length;if(!length)return null;var _local_6=[];var i=0;while(i<length){var matrix=matricies[i];if(!matrix||!matrix.length)return null;var j=0;while(j<matrix.length){if(matrix[j]>=0){_local_6.push(j);break;}j++;}if(_local_6.length<i+1)_local_6.push(matrix.length+1);i++;}i=1;while(i<_local_6.length-1){if(Math.trunc(_local_6[i])<=Math.trunc(_local_6[i-1])-1&&Math.trunc(_local_6[i])<=Math.trunc(_local_6[i+1])-1)return new Point(Math.trunc(_local_6[i]|0),i);i++;}return null;}},{key:\"expandFloorTiles\",value:function expandFloorTiles(k){var _local_5;var _local_6;var _local_7;var _local_8;var _local_10;var _local_11;var _local_12;var _local_13;var _local_14;var _local_15;var _local_16;var _local_17;var _local_2=k.length;var _local_3=k[0].length;var _local_4=[];_local_6=0;while(_local_6<_local_2*4){_local_4[_local_6]=[];_local_6++;}var _local_9=0;_local_6=0;while(_local_6<_local_2){_local_10=0;_local_5=0;while(_local_5<_local_3){_local_11=k[_local_6][_local_5];if(_local_11<0||_local_11<=0xFF){_local_8=0;while(_local_8<4){_local_7=0;while(_local_7<4){if(_local_4[_local_9+_local_8]===undefined)_local_4[_local_9+_local_8]=[];_local_4[_local_9+_local_8][_local_10+_local_7]=_local_11<0?_local_11:_local_11*4;_local_7++;}_local_8++;}}else{_local_12=(_local_11&0xFF)*4;_local_13=_local_12+(_local_11>>11&0x01)*3;_local_14=_local_12+(_local_11>>10&0x01)*3;_local_15=_local_12+(_local_11>>9&0x01)*3;_local_16=_local_12+(_local_11>>8&0x01)*3;_local_7=0;while(_local_7<3){_local_17=_local_7+1;_local_4[_local_9][_local_10+_local_7]=(_local_13*(3-_local_7)+_local_14*_local_7)/3;_local_4[_local_9+3][_local_10+_local_17]=(_local_15*(3-_local_17)+_local_16*_local_17)/3;_local_4[_local_9+_local_17][_local_10]=(_local_13*(3-_local_17)+_local_15*_local_17)/3;_local_4[_local_9+_local_7][_local_10+3]=(_local_14*(3-_local_7)+_local_16*_local_7)/3;_local_7++;}_local_4[_local_9+1][_local_10+1]=_local_13>_local_12?_local_12+2:_local_12+1;_local_4[_local_9+1][_local_10+2]=_local_14>_local_12?_local_12+2:_local_12+1;_local_4[_local_9+2][_local_10+1]=_local_15>_local_12?_local_12+2:_local_12+1;_local_4[_local_9+2][_local_10+2]=_local_16>_local_12?_local_12+2:_local_12+1;}_local_10=_local_10+4;_local_5++;}_local_9=_local_9+4;_local_6++;}return _local_4;}},{key:\"addTileTypes\",value:function addTileTypes(k){var _local_4;var _local_5;var _local_6;var _local_7;var _local_8;var _local_9;var _local_10;var _local_11;var _local_12;var _local_13;var _local_14;var _local_15;var _local_16;var _local_17;var _local_2=k.length-1;var _local_3=k[0].length-1;_local_5=1;while(_local_5<_local_2){_local_4=1;while(_local_4<_local_3){_local_6=k[_local_5][_local_4];if(_local_6<0){//\n}else{_local_7=k[_local_5-1][_local_4-1]&0xFF;_local_8=k[_local_5-1][_local_4]&0xFF;_local_9=k[_local_5-1][_local_4+1]&0xFF;_local_10=k[_local_5][_local_4-1]&0xFF;_local_11=k[_local_5][_local_4+1]&0xFF;_local_12=k[_local_5+1][_local_4-1]&0xFF;_local_13=k[_local_5+1][_local_4]&0xFF;_local_14=k[_local_5+1][_local_4+1]&0xFF;_local_15=_local_6+1;_local_16=_local_6-1;_local_17=(_local_7==_local_15||_local_8==_local_15||_local_10==_local_15?8:0)|(_local_9==_local_15||_local_8==_local_15||_local_11==_local_15?4:0)|(_local_12==_local_15||_local_13==_local_15||_local_10==_local_15?2:0)|(_local_14==_local_15||_local_13==_local_15||_local_11==_local_15?1:0);if(_local_17==15){_local_17=0;}k[_local_5][_local_4]=_local_6|_local_17<<8;}_local_4++;}_local_5++;}}},{key:\"unpadHeightMap\",value:function unpadHeightMap(k){k.shift();k.pop();var _iterator4=_createForOfIteratorHelper(k),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _local_2=_step4.value;_local_2.shift();_local_2.pop();}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}}},{key:\"padHeightMap\",value:function padHeightMap(k){var _local_2=[];var _local_3=[];var _iterator5=_createForOfIteratorHelper(k),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var _local_4=_step5.value;_local_4.push(RoomPlaneParser.TILE_BLOCKED);_local_4.unshift(RoomPlaneParser.TILE_BLOCKED);}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}var _iterator6=_createForOfIteratorHelper(k[0]),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var _local_5=_step6.value;_local_2.push(RoomPlaneParser.TILE_BLOCKED);_local_3.push(RoomPlaneParser.TILE_BLOCKED);}}catch(err){_iterator6.e(err);}finally{_iterator6.f();}k.push(_local_3);k.unshift(_local_2);}}]);return RoomPlaneParser;}();RoomPlaneParser.FLOOR_THICKNESS=0.25;RoomPlaneParser.WALL_THICKNESS=0.25;RoomPlaneParser.MAX_WALL_ADDITIONAL_HEIGHT=20;RoomPlaneParser.TILE_BLOCKED=-110;RoomPlaneParser.TILE_HOLE=-100;","map":null,"metadata":{},"sourceType":"module"}