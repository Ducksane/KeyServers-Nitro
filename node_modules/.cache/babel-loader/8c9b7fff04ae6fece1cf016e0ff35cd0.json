{"ast":null,"code":"import _slicedToArray from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _createForOfIteratorHelper from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _assertThisInitialized from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js\";import _get from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/get.js\";import _getPrototypeOf from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js\";import _inherits from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{Texture}from'@pixi/core';import{Matrix,Point,Rectangle}from'@pixi/math';import{NitroSprite}from'../../core';import{NitroLogger}from'../../core/common/logger/NitroLogger';import{NitroManager}from'../../core/common/NitroManager';import{TextureUtils}from'../../room';import{RoomObjectMouseEvent}from'../../room/events/RoomObjectMouseEvent';import{RoomObjectUpdateMessage}from'../../room/messages/RoomObjectUpdateMessage';import{RoomRendererFactory}from'../../room/renderer/RoomRendererFactory';import{NumberBank}from'../../room/utils/NumberBank';import{RoomEnterEffect}from'../../room/utils/RoomEnterEffect';import{RoomGeometry}from'../../room/utils/RoomGeometry';import{Vector3d}from'../../room/utils/Vector3d';import{PetFigureData}from'../avatar/pets/PetFigureData';import{RenderRoomMessageComposer,RenderRoomThumbnailMessageComposer}from'../communication';import{ToolbarIconEnum}from'../enums/ToolbarIconEnum';import{NitroToolbarAnimateIconEvent}from'../events/NitroToolbarAnimateIconEvent';import{Nitro}from'../Nitro';import{RoomControllerLevel}from'../session/enum/RoomControllerLevel';import{BadgeImageReadyEvent}from'../session/events/BadgeImageReadyEvent';import{RoomSessionEvent}from'../session/events/RoomSessionEvent';import{MouseEventType}from'../ui/MouseEventType';import{FurniId}from'../utils/FurniId';import{RoomDragEvent}from'./events';import{RoomBackgroundColorEvent}from'./events/RoomBackgroundColorEvent';import{RoomEngineEvent}from'./events/RoomEngineEvent';import{RoomEngineObjectEvent}from'./events/RoomEngineObjectEvent';import{RoomObjectFurnitureActionEvent}from'./events/RoomObjectFurnitureActionEvent';import{RoomToObjectOwnAvatarMoveEvent}from'./events/RoomToObjectOwnAvatarMoveEvent';import{ImageResult}from'./ImageResult';import{ObjectAvatarCarryObjectUpdateMessage}from'./messages/ObjectAvatarCarryObjectUpdateMessage';import{ObjectAvatarChatUpdateMessage}from'./messages/ObjectAvatarChatUpdateMessage';import{ObjectAvatarDanceUpdateMessage}from'./messages/ObjectAvatarDanceUpdateMessage';import{ObjectAvatarEffectUpdateMessage}from'./messages/ObjectAvatarEffectUpdateMessage';import{ObjectAvatarExperienceUpdateMessage}from'./messages/ObjectAvatarExperienceUpdateMessage';import{ObjectAvatarExpressionUpdateMessage}from'./messages/ObjectAvatarExpressionUpdateMessage';import{ObjectAvatarFigureUpdateMessage}from'./messages/ObjectAvatarFigureUpdateMessage';import{ObjectAvatarFlatControlUpdateMessage}from'./messages/ObjectAvatarFlatControlUpdateMessage';import{ObjectAvatarGestureUpdateMessage}from'./messages/ObjectAvatarGestureUpdateMessage';import{ObjectAvatarGuideStatusUpdateMessage}from'./messages/ObjectAvatarGuideStatusUpdateMessage';import{ObjectAvatarMutedUpdateMessage}from'./messages/ObjectAvatarMutedUpdateMessage';import{ObjectAvatarOwnMessage}from'./messages/ObjectAvatarOwnMessage';import{ObjectAvatarPetGestureUpdateMessage}from'./messages/ObjectAvatarPetGestureUpdateMessage';import{ObjectAvatarPlayerValueUpdateMessage}from'./messages/ObjectAvatarPlayerValueUpdateMessage';import{ObjectAvatarPlayingGameUpdateMessage}from'./messages/ObjectAvatarPlayingGameUpdateMessage';import{ObjectAvatarPostureUpdateMessage}from'./messages/ObjectAvatarPostureUpdateMessage';import{ObjectAvatarSignUpdateMessage}from'./messages/ObjectAvatarSignUpdateMessage';import{ObjectAvatarSleepUpdateMessage}from'./messages/ObjectAvatarSleepUpdateMessage';import{ObjectAvatarTypingUpdateMessage}from'./messages/ObjectAvatarTypingUpdateMessage';import{ObjectAvatarUpdateMessage}from'./messages/ObjectAvatarUpdateMessage';import{ObjectAvatarUseObjectUpdateMessage}from'./messages/ObjectAvatarUseObjectUpdateMessage';import{ObjectDataUpdateMessage}from'./messages/ObjectDataUpdateMessage';import{ObjectGroupBadgeUpdateMessage}from'./messages/ObjectGroupBadgeUpdateMessage';import{ObjectHeightUpdateMessage}from'./messages/ObjectHeightUpdateMessage';import{ObjectItemDataUpdateMessage}from'./messages/ObjectItemDataUpdateMessage';import{ObjectModelDataUpdateMessage}from'./messages/ObjectModelDataUpdateMessage';import{ObjectMoveUpdateMessage}from'./messages/ObjectMoveUpdateMessage';import{ObjectRoomColorUpdateMessage}from'./messages/ObjectRoomColorUpdateMessage';import{ObjectRoomFloorHoleUpdateMessage}from'./messages/ObjectRoomFloorHoleUpdateMessage';import{ObjectRoomMaskUpdateMessage}from'./messages/ObjectRoomMaskUpdateMessage';import{ObjectRoomPlanePropertyUpdateMessage}from'./messages/ObjectRoomPlanePropertyUpdateMessage';import{ObjectRoomPlaneVisibilityUpdateMessage}from'./messages/ObjectRoomPlaneVisibilityUpdateMessage';import{ObjectRoomUpdateMessage}from'./messages/ObjectRoomUpdateMessage';import{ObjectDataFactory}from'./object/data/ObjectDataFactory';import{LegacyDataType}from'./object/data/type/LegacyDataType';import{RoomObjectCategory}from'./object/RoomObjectCategory';import{RoomObjectUserType}from'./object/RoomObjectUserType';import{RoomObjectVariable}from'./object/RoomObjectVariable';import{RoomObjectVisualizationFactory}from'./object/RoomObjectVisualizationFactory';import{RoomContentLoader}from'./RoomContentLoader';import{RoomMessageHandler}from'./RoomMessageHandler';import{RoomObjectEventHandler}from'./RoomObjectEventHandler';import{RoomObjectLogicFactory}from'./RoomObjectLogicFactory';import{RoomVariableEnum}from'./RoomVariableEnum';import{RoomData}from'./utils/RoomData';import{RoomFurnitureData}from'./utils/RoomFurnitureData';import{RoomInstanceData}from'./utils/RoomInstanceData';import{RoomObjectBadgeImageAssetListener}from'./utils/RoomObjectBadgeImageAssetListener';import{SpriteDataCollector}from'./utils/SpriteDataCollector';export var RoomEngine=/*#__PURE__*/function(_NitroManager){_inherits(RoomEngine,_NitroManager);var _super=_createSuper(RoomEngine);function RoomEngine(communication){var _this;_classCallCheck(this,RoomEngine);_this=_super.call(this);_this._communication=void 0;_this._roomRendererFactory=void 0;_this._roomManager=void 0;_this._visualizationFactory=void 0;_this._sessionDataManager=void 0;_this._roomSessionManager=void 0;_this._roomObjectEventHandler=void 0;_this._roomMessageHandler=void 0;_this._roomContentLoader=void 0;_this._ready=void 0;_this._roomContentLoaderReady=void 0;_this._imageObjectIdBank=void 0;_this._imageCallbacks=void 0;_this._thumbnailObjectIdBank=void 0;_this._thumbnailCallbacks=void 0;_this._activeRoomId=void 0;_this._activeRoomActiveCanvas=void 0;_this._activeRoomActiveCanvasMouseX=void 0;_this._activeRoomActiveCanvasMouseY=void 0;_this._activeRoomIsDragged=void 0;_this._activeRoomWasDragged=void 0;_this._activeRoomDragStartX=void 0;_this._activeRoomDragStartY=void 0;_this._activeRoomDragX=void 0;_this._activeRoomDragY=void 0;_this._roomDraggingAlwaysCenters=void 0;_this._roomAllowsDragging=void 0;_this._roomDatas=void 0;_this._roomInstanceDatas=void 0;_this._skipFurnitureCreationForNextFrame=void 0;_this._mouseCursorUpdate=void 0;_this._badgeListenerObjects=void 0;_this._logicFactory=void 0;_this._communication=communication;_this._sessionDataManager=null;_this._roomSessionManager=null;_this._roomManager=null;_this._roomObjectEventHandler=new RoomObjectEventHandler(_assertThisInitialized(_this));_this._roomMessageHandler=new RoomMessageHandler(_assertThisInitialized(_this));_this._roomContentLoader=new RoomContentLoader();_this._ready=false;_this._roomContentLoaderReady=false;_this._activeRoomId=-1;_this._activeRoomActiveCanvas=-1;_this._roomInstanceDatas=new Map();_this._roomDatas=new Map();_this._roomRendererFactory=new RoomRendererFactory();_this._visualizationFactory=new RoomObjectVisualizationFactory();_this._logicFactory=new RoomObjectLogicFactory();_this._activeRoomActiveCanvasMouseX=0;_this._activeRoomActiveCanvasMouseY=0;_this._activeRoomIsDragged=false;_this._activeRoomWasDragged=false;_this._activeRoomDragStartX=0;_this._activeRoomDragStartY=0;_this._activeRoomDragX=0;_this._activeRoomDragY=0;_this._skipFurnitureCreationForNextFrame=false;_this._mouseCursorUpdate=false;_this._imageObjectIdBank=null;_this._imageCallbacks=new Map();_this._thumbnailCallbacks=new Map();_this._roomDraggingAlwaysCenters=false;_this._roomAllowsDragging=true;_this._badgeListenerObjects=new Map();_this.runVisibilityUpdate=_this.runVisibilityUpdate.bind(_assertThisInitialized(_this));_this.processRoomObjectEvent=_this.processRoomObjectEvent.bind(_assertThisInitialized(_this));_this.onRoomSessionEvent=_this.onRoomSessionEvent.bind(_assertThisInitialized(_this));_this.onRoomContentLoaderReadyEvent=_this.onRoomContentLoaderReadyEvent.bind(_assertThisInitialized(_this));_this.onBadgeImageReadyEvent=_this.onBadgeImageReadyEvent.bind(_assertThisInitialized(_this));return _this;}_createClass(RoomEngine,[{key:\"onInit\",value:function onInit(){if(this._ready)return;this._imageObjectIdBank=new NumberBank(1000);this._thumbnailObjectIdBank=new NumberBank(1000);this._logicFactory.registerEventFunction(this.processRoomObjectEvent);if(this._roomManager){this._roomManager.setContentLoader(this._roomContentLoader);this._roomManager.addUpdateCategory(RoomObjectCategory.FLOOR);this._roomManager.addUpdateCategory(RoomObjectCategory.WALL);this._roomManager.addUpdateCategory(RoomObjectCategory.UNIT);this._roomManager.addUpdateCategory(RoomObjectCategory.CURSOR);this._roomManager.addUpdateCategory(RoomObjectCategory.ROOM);}this._roomMessageHandler.setConnection(this._communication.connection);this._roomContentLoader.initialize(this.events);this._roomContentLoader.setSessionDataManager(this._sessionDataManager);this._roomContentLoader.setIconListener(this);if(this._roomSessionManager){this._roomSessionManager.events.addEventListener(RoomSessionEvent.STARTED,this.onRoomSessionEvent);this._roomSessionManager.events.addEventListener(RoomSessionEvent.ENDED,this.onRoomSessionEvent);}this.events.addEventListener(RoomContentLoader.LOADER_READY,this.onRoomContentLoaderReadyEvent);Nitro.instance.ticker.add(this.update,this);document.addEventListener('visibilitychange',this.runVisibilityUpdate);}},{key:\"onDispose\",value:function onDispose(){if(!this._ready)return;var _iterator=_createForOfIteratorHelper(this._roomInstanceDatas),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var _step$value=_slicedToArray(_step.value,2),key=_step$value[0],value=_step$value[1];this.removeRoomInstance(key);}}catch(err){_iterator.e(err);}finally{_iterator.f();}document.removeEventListener('visibilitychange',this.runVisibilityUpdate);Nitro.instance.ticker.remove(this.update,this);if(this._roomObjectEventHandler)this._roomObjectEventHandler.dispose();if(this._roomMessageHandler)this._roomMessageHandler.dispose();if(this._roomContentLoader)this._roomContentLoader.dispose();this.events.removeEventListener(RoomContentLoader.LOADER_READY,this.onRoomContentLoaderReadyEvent);if(this._roomSessionManager){this._roomSessionManager.events.removeEventListener(RoomSessionEvent.STARTED,this.onRoomSessionEvent);this._roomSessionManager.events.removeEventListener(RoomSessionEvent.ENDED,this.onRoomSessionEvent);}_get(_getPrototypeOf(RoomEngine.prototype),\"onDispose\",this).call(this);}},{key:\"onRoomSessionEvent\",value:function onRoomSessionEvent(event){if(!(event instanceof RoomSessionEvent))return;switch(event.type){case RoomSessionEvent.STARTED:if(this._roomMessageHandler)this._roomMessageHandler.setRoomId(event.session.roomId);return;case RoomSessionEvent.ENDED:if(this._roomMessageHandler){this._roomMessageHandler.clearRoomId();this.removeRoomInstance(event.session.roomId);}return;}}},{key:\"onRoomContentLoaderReadyEvent\",value:function onRoomContentLoaderReadyEvent(event){this._roomContentLoaderReady=true;this._roomManager.init();}},{key:\"setActiveRoomId\",value:function setActiveRoomId(roomId){this._activeRoomId=roomId;}},{key:\"destroyRoom\",value:function destroyRoom(roomId){this.removeRoomInstance(roomId);}},{key:\"getRoomInstance\",value:function getRoomInstance(roomId){return this._roomManager&&this._roomManager.getRoomInstance(this.getRoomId(roomId))||null;}},{key:\"removeRoomInstance\",value:function removeRoomInstance(roomId){var instance=this.getRoomInstance(roomId);if(instance){this._roomManager&&this._roomManager.removeRoomInstance(this.getRoomId(roomId));}var existing=this._roomInstanceDatas.get(roomId);if(existing){this._roomInstanceDatas.delete(existing.roomId);existing.dispose();}this.events.dispatchEvent(new RoomEngineEvent(RoomEngineEvent.DISPOSED,roomId));}},{key:\"createRoomInstance\",value:function createRoomInstance(roomId,roomMap){var floorType='111';var wallType='201';var landscapeType='1';if(!this._ready){var _data=this._roomDatas.get(roomId);if(_data){this._roomDatas.delete(roomId);floorType=_data.floorType;wallType=_data.wallType;landscapeType=_data.landscapeType;}_data=new RoomData(roomId,roomMap);_data.floorType=floorType;_data.wallType=wallType;_data.landscapeType=landscapeType;this._roomDatas.set(roomId,_data);NitroLogger.log('Room Engine not initilized yet, can not create room. Room data stored for later initialization.');return;}if(!roomMap){NitroLogger.log('Room property messages received before floor height map, will initialize when floor height map received.');return;}var data=this._roomDatas.get(roomId);if(data){this._roomDatas.delete(roomId);if(data.floorType)floorType=data.floorType;if(data.wallType)wallType=data.wallType;if(data.landscapeType)landscapeType=data.landscapeType;}var instance=this.setupRoomInstance(roomId,roomMap,floorType,wallType,landscapeType,this.getRoomInstanceModelName(roomId));if(!instance)return;if(roomMap.restrictsDragging){this._roomAllowsDragging=false;}else{this._roomAllowsDragging=true;}this.events.dispatchEvent(new RoomEngineEvent(RoomEngineEvent.INITIALIZED,roomId));}},{key:\"setupRoomInstance\",value:function setupRoomInstance(roomId,roomMap,floorType,wallType,landscapeType,worldType){if(!this._ready||!this._roomManager)return;var instance=this._roomManager.createRoomInstance(this.getRoomId(roomId));if(!instance)return null;var category=RoomObjectCategory.ROOM;var roomObject=instance.createRoomObjectAndInitalize(RoomEngine.ROOM_OBJECT_ID,RoomEngine.ROOM_OBJECT_TYPE,category);instance.model.setValue(RoomVariableEnum.ROOM_IS_PUBLIC,0);instance.model.setValue(RoomVariableEnum.ROOM_Z_SCALE,1);if(roomMap){instance.model.setValue(RoomVariableEnum.RESTRICTS_DRAGGING,roomMap.restrictsDragging);instance.model.setValue(RoomVariableEnum.RESTRICTS_SCALING,roomMap.restrictsScaling);instance.model.setValue(RoomVariableEnum.RESTRICTED_SCALE,roomMap.restrictedScale);var dimensions=roomMap.dimensions;if(dimensions){var minX=roomMap.dimensions.minX;var maxX=roomMap.dimensions.maxX;var minY=roomMap.dimensions.minY;var maxY=roomMap.dimensions.maxY;instance.model.setValue(RoomVariableEnum.ROOM_MIN_X,minX);instance.model.setValue(RoomVariableEnum.ROOM_MAX_X,maxX);instance.model.setValue(RoomVariableEnum.ROOM_MIN_Y,minY);instance.model.setValue(RoomVariableEnum.ROOM_MAX_Y,maxY);var seed=minX*423+maxX*671+minY*913+maxY*7509;if(roomObject&&roomObject.model)roomObject.model.setValue(RoomObjectVariable.ROOM_RANDOM_SEED,seed);}}var logic=roomObject&&roomObject.logic||null;if(logic){logic.initialize(roomMap);if(floorType){logic.processUpdateMessage(new ObjectRoomUpdateMessage(ObjectRoomUpdateMessage.ROOM_FLOOR_UPDATE,floorType));instance.model.setValue(RoomObjectVariable.ROOM_FLOOR_TYPE,floorType);}if(wallType){logic.processUpdateMessage(new ObjectRoomUpdateMessage(ObjectRoomUpdateMessage.ROOM_WALL_UPDATE,wallType));instance.model.setValue(RoomObjectVariable.ROOM_WALL_TYPE,wallType);}if(landscapeType){logic.processUpdateMessage(new ObjectRoomUpdateMessage(ObjectRoomUpdateMessage.ROOM_LANDSCAPE_UPDATE,landscapeType));instance.model.setValue(RoomObjectVariable.ROOM_LANDSCAPE_TYPE,landscapeType);}}if(roomMap&&roomMap.doors.length){var doorIndex=0;while(doorIndex<roomMap.doors.length){var door=roomMap.doors[doorIndex];if(door){var doorX=door.x;var doorY=door.y;var doorZ=door.z;var doorDir=door.dir;var maskType=ObjectRoomMaskUpdateMessage.DOOR;var maskId='door_'+doorIndex;var maskLocation=new Vector3d(doorX,doorY,doorZ);logic.processUpdateMessage(new ObjectRoomMaskUpdateMessage(ObjectRoomMaskUpdateMessage.ADD_MASK,maskId,maskType,maskLocation,ObjectRoomMaskUpdateMessage.HOLE));if(doorDir===90||doorDir===180){if(doorDir===90){instance.model.setValue(RoomObjectVariable.ROOM_DOOR_X,doorX-0.5);instance.model.setValue(RoomObjectVariable.ROOM_DOOR_Y,doorY);}if(doorDir===180){instance.model.setValue(RoomObjectVariable.ROOM_DOOR_X,doorX);instance.model.setValue(RoomObjectVariable.ROOM_DOOR_Y,doorY-0.5);}instance.model.setValue(RoomObjectVariable.ROOM_DOOR_Z,doorZ);instance.model.setValue(RoomObjectVariable.ROOM_DOOR_DIR,doorDir);}}doorIndex++;}}instance.createRoomObjectAndInitalize(RoomEngine.CURSOR_OBJECT_ID,RoomEngine.CURSOR_OBJECT_TYPE,RoomObjectCategory.CURSOR);if(Nitro.instance.getConfiguration('enable.avatar.arrow',false))instance.createRoomObjectAndInitalize(RoomEngine.ARROW_OBJECT_ID,RoomEngine.ARROW_OBJECT_TYPE,RoomObjectCategory.CURSOR);return instance;}},{key:\"getRoomInstanceDisplay\",value:function getRoomInstanceDisplay(roomId,id,width,height,scale){var instance=this.getRoomInstance(roomId);if(!instance)return null;var renderer=instance.renderer;if(!renderer){renderer=this._roomRendererFactory.createRenderer();if(!renderer)return null;}renderer.roomObjectVariableAccurateZ=RoomObjectVariable.OBJECT_ACCURATE_Z_VALUE;instance.setRenderer(renderer);var canvas=renderer.createCanvas(id,width,height,scale);if(!canvas)return null;var restrictedScaling=instance.model.getValue(RoomVariableEnum.RESTRICTS_SCALING);if(restrictedScaling){var restrictedScale=instance.model.getValue(RoomVariableEnum.RESTRICTED_SCALE);if(!restrictedScale)restrictedScale=1;canvas.setScale(restrictedScale);canvas.restrictsScaling=true;}else{canvas.restrictsScaling=false;}canvas.setMouseListener(this._roomObjectEventHandler);if(canvas.geometry){canvas.geometry.z_scale=instance.model.getValue(RoomVariableEnum.ROOM_Z_SCALE);var doorX=instance.model.getValue(RoomObjectVariable.ROOM_DOOR_X);var doorY=instance.model.getValue(RoomObjectVariable.ROOM_DOOR_Y);var doorZ=instance.model.getValue(RoomObjectVariable.ROOM_DOOR_Z);var doorDirection=instance.model.getValue(RoomObjectVariable.ROOM_DOOR_DIR);var vector=new Vector3d(doorX,doorY,doorZ);var direction=null;if(doorDirection===90)direction=new Vector3d(-2000,0,0);if(doorDirection===180)direction=new Vector3d(0,-2000,0);canvas.geometry.setDisplacement(vector,direction);var displayObject=canvas.master;if(displayObject){var overlay=new NitroSprite(Texture.EMPTY);overlay.name=RoomEngine.OVERLAY;overlay.interactive=false;displayObject.addChild(overlay);}}return canvas.master;}},{key:\"setRoomInstanceRenderingCanvasMask\",value:function setRoomInstanceRenderingCanvasMask(roomId,canvasId,flag){var roomCanvas=this.getRoomInstanceRenderingCanvas(roomId,canvasId);if(roomCanvas)roomCanvas.setMask(flag);}},{key:\"setRoomInstanceRenderingCanvasScale\",value:function setRoomInstanceRenderingCanvasScale(roomId,canvasId,scale){var point=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var offsetPoint=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var override=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;var asDelta=arguments.length>6&&arguments[6]!==undefined?arguments[6]:false;var roomCanvas=this.getRoomInstanceRenderingCanvas(roomId,canvasId);if(roomCanvas){if(roomCanvas.restrictsScaling&&!override)return;roomCanvas.setScale(scale,point,offsetPoint,override,asDelta);this.events.dispatchEvent(new RoomEngineEvent(RoomEngineEvent.ROOM_ZOOMED,roomId));}}},{key:\"getRoomInstanceRenderingCanvas\",value:function getRoomInstanceRenderingCanvas(roomId){var canvasId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:-1;var instance=this.getRoomInstance(roomId);if(!instance)return null;var renderer=instance.renderer;if(!renderer)return null;if(canvasId===-1)canvasId=this._activeRoomActiveCanvas;var canvas=renderer.getCanvas(canvasId);if(!canvas)return null;return canvas;}},{key:\"getActiveRoomInstanceRenderingCanvas\",value:function getActiveRoomInstanceRenderingCanvas(){return this.getRoomInstanceRenderingCanvas(this._activeRoomId,this._activeRoomActiveCanvas);}},{key:\"getRoomInstanceRenderingCanvasOffset\",value:function getRoomInstanceRenderingCanvasOffset(roomId){var canvasId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:-1;if(canvasId===-1)canvasId=this._activeRoomActiveCanvas;var renderingCanvas=this.getRoomInstanceRenderingCanvas(roomId,canvasId);if(!renderingCanvas)return null;return new Point(renderingCanvas.screenOffsetX,renderingCanvas.screenOffsetY);}},{key:\"setRoomInstanceRenderingCanvasOffset\",value:function setRoomInstanceRenderingCanvasOffset(roomId,canvasId,point){var renderingCanvas=this.getRoomInstanceRenderingCanvas(roomId,canvasId);if(!renderingCanvas||!point)return false;var x=~~point.x;var y=~~point.y;if(renderingCanvas.screenOffsetX===x&&renderingCanvas.screenOffsetY===y)return;this.events.dispatchEvent(new RoomDragEvent(roomId,-(renderingCanvas.screenOffsetX-x),-(renderingCanvas.screenOffsetY-y)));renderingCanvas.screenOffsetX=x;renderingCanvas.screenOffsetY=y;return true;}},{key:\"getRoomInstanceRenderingCanvasScale\",value:function getRoomInstanceRenderingCanvasScale(){var roomId=arguments.length>0&&arguments[0]!==undefined?arguments[0]:-1000;var canvasId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:-1;if(roomId===-1000)roomId=this._activeRoomId;if(canvasId===-1)canvasId=this._activeRoomActiveCanvas;var canvas=this.getRoomInstanceRenderingCanvas(roomId,canvasId);if(!canvas)return 1;return canvas.scale;}},{key:\"initializeRoomInstanceRenderingCanvas\",value:function initializeRoomInstanceRenderingCanvas(roomId,canvasId,width,height){var canvas=this.getRoomInstanceRenderingCanvas(roomId,canvasId);if(!canvas)return;canvas.initialize(width,height);}},{key:\"getRoomInstanceGeometry\",value:function getRoomInstanceGeometry(roomId){var canvasId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:-1;var instance=this.getRoomInstance(roomId);if(!instance)return null;var renderer=instance.renderer;if(!renderer)return null;if(canvasId===-1)canvasId=this._activeRoomActiveCanvas;var canvas=renderer.getCanvas(canvasId);if(!canvas)return null;return canvas.geometry;}},{key:\"getRoomInstanceVariable\",value:function getRoomInstanceVariable(roomId,key){var instance=this.getRoomInstance(roomId);if(!instance)return null;return instance.model&&instance.model.getValue(key)||null;}},{key:\"updateRoomInstancePlaneVisibility\",value:function updateRoomInstancePlaneVisibility(roomId,wallVisible){var floorVisible=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var object=this.getRoomOwnObject(roomId);if(!object)return false;object.processUpdateMessage(new ObjectRoomPlaneVisibilityUpdateMessage(ObjectRoomPlaneVisibilityUpdateMessage.WALL_VISIBILITY,wallVisible));object.processUpdateMessage(new ObjectRoomPlaneVisibilityUpdateMessage(ObjectRoomPlaneVisibilityUpdateMessage.FLOOR_VISIBILITY,floorVisible));return true;}},{key:\"updateRoomInstancePlaneThickness\",value:function updateRoomInstancePlaneThickness(roomId,wallThickness,floorThickness){var object=this.getRoomOwnObject(roomId);if(!object)return false;object.processUpdateMessage(new ObjectRoomPlanePropertyUpdateMessage(ObjectRoomPlanePropertyUpdateMessage.WALL_THICKNESS,wallThickness));object.processUpdateMessage(new ObjectRoomPlanePropertyUpdateMessage(ObjectRoomPlanePropertyUpdateMessage.FLOOR_THICKNESS,floorThickness));return true;}},{key:\"updateRoomInstancePlaneType\",value:function updateRoomInstancePlaneType(roomId){var floorType=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var wallType=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var landscapeType=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var _arg_5=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;var roomObject=this.getRoomOwnObject(roomId);var roomInstance=this.getRoomInstance(roomId);if(!roomObject){var roomData=this._roomDatas.get(roomId);if(!roomData){roomData=new RoomData(roomId,null);this._roomDatas.set(roomId,roomData);}if(floorType)roomData.floorType=floorType;if(wallType)roomData.wallType=wallType;if(landscapeType)roomData.landscapeType=landscapeType;return true;}if(floorType){if(roomInstance&&!_arg_5)roomInstance.model.setValue(RoomObjectVariable.ROOM_FLOOR_TYPE,floorType);roomObject.processUpdateMessage(new ObjectRoomUpdateMessage(ObjectRoomUpdateMessage.ROOM_FLOOR_UPDATE,floorType));}if(wallType){if(roomInstance&&!_arg_5)roomInstance.model.setValue(RoomObjectVariable.ROOM_WALL_TYPE,wallType);roomObject.processUpdateMessage(new ObjectRoomUpdateMessage(ObjectRoomUpdateMessage.ROOM_WALL_UPDATE,wallType));}if(landscapeType){if(roomInstance&&!_arg_5)roomInstance.model.setValue(RoomObjectVariable.ROOM_LANDSCAPE_TYPE,landscapeType);roomObject.processUpdateMessage(new ObjectRoomUpdateMessage(ObjectRoomUpdateMessage.ROOM_LANDSCAPE_UPDATE,landscapeType));}return true;}},{key:\"updateObjectRoomColor\",value:function updateObjectRoomColor(k,_arg_2,_arg_3,_arg_4){var roomObject=this.getRoomOwnObject(k);if(!roomObject||!roomObject.logic)return false;var event=new ObjectRoomColorUpdateMessage(ObjectRoomColorUpdateMessage.BACKGROUND_COLOR,_arg_2,_arg_3,_arg_4);roomObject.logic.processUpdateMessage(event);this.events.dispatchEvent(new RoomBackgroundColorEvent(k,_arg_2,_arg_3,_arg_4));return true;}},{key:\"addRoomInstanceFloorHole\",value:function addRoomInstanceFloorHole(roomId,objectId){if(objectId<0)return;var roomOwnObject=this.getRoomOwnObject(roomId);var roomObject=this.getRoomObjectFloor(roomId,objectId);if(roomOwnObject&&roomOwnObject.logic&&roomObject&&roomObject.model){var location=roomObject.getLocation();var sizeX=roomObject.model.getValue(RoomObjectVariable.FURNITURE_SIZE_X);var sizeY=roomObject.model.getValue(RoomObjectVariable.FURNITURE_SIZE_Y);roomOwnObject.processUpdateMessage(new ObjectRoomFloorHoleUpdateMessage(ObjectRoomFloorHoleUpdateMessage.ADD,objectId,location.x,location.y,sizeX,sizeY));}}},{key:\"removeRoomInstanceFloorHole\",value:function removeRoomInstanceFloorHole(roomId,objectId){if(objectId<0)return;var roomOwnObject=this.getRoomOwnObject(roomId);if(roomOwnObject){roomOwnObject.processUpdateMessage(new ObjectRoomFloorHoleUpdateMessage(ObjectRoomFloorHoleUpdateMessage.REMOVE,objectId));}}},{key:\"setRoomEngineGameMode\",value:function setRoomEngineGameMode(roomId,isPlaying){var roomInstance=this.getRoomInstance(roomId);if(!roomInstance)return;var mode=isPlaying?1:0;roomInstance.model.setValue(RoomVariableEnum.IS_PLAYING_GAME,mode);if(mode===0){this.events.dispatchEvent(new RoomEngineEvent(RoomEngineEvent.NORMAL_MODE,roomId));}else{this.events.dispatchEvent(new RoomEngineEvent(RoomEngineEvent.GAME_MODE,roomId));}}},{key:\"isRoomIdPlayingGame\",value:function isRoomIdPlayingGame(roomId){var roomInstance=this.getRoomInstance(roomId);if(!roomInstance)return false;return roomInstance.model.getValue(RoomVariableEnum.IS_PLAYING_GAME)>0;}},{key:\"isPlayingGame\",value:function isPlayingGame(){return this.isRoomIdPlayingGame(this._activeRoomId);}},{key:\"disableUpdate\",value:function disableUpdate(flag){if(flag){Nitro.instance.ticker.remove(this.update,this);}else{Nitro.instance.ticker.remove(this.update,this);Nitro.instance.ticker.add(this.update,this);}}},{key:\"runUpdate\",value:function runUpdate(){this.update(1);}},{key:\"runVisibilityUpdate\",value:function runVisibilityUpdate(){if(!document.hidden)this.update(1,true);}},{key:\"update\",value:function update(time){var _update=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!this._roomManager)return;time=Nitro.instance.time;RoomEnterEffect.turnVisualizationOn();this.processPendingFurniture();this._roomManager.update(time,_update);this.updateRoomCameras(time);if(this._mouseCursorUpdate)this.setPointer();RoomEnterEffect.turnVisualizationOff();}},{key:\"setPointer\",value:function setPointer(){this._mouseCursorUpdate=false;var instanceData=this.getRoomInstanceData(this._activeRoomId);if(instanceData&&instanceData.hasButtonMouseCursorOwners()){document.body.style.cursor='pointer';}else{document.body.style.cursor='auto';}}},{key:\"processPendingFurniture\",value:function processPendingFurniture(){if(this._skipFurnitureCreationForNextFrame){this._skipFurnitureCreationForNextFrame=false;return;}var startTime=new Date().valueOf();var furniturePerTick=5;var hasTickLimit=true;var _iterator2=_createForOfIteratorHelper(this._roomInstanceDatas.values()),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var instanceData=_step2.value;if(!instanceData)continue;var pendingData=null;var totalFurnitureAdded=0;var furnitureAdded=false;while(pendingData=instanceData.getNextPendingFurnitureFloor()){furnitureAdded=this.processPendingFurnitureFloor(instanceData.roomId,pendingData.id,pendingData);if(hasTickLimit){if(!(++totalFurnitureAdded%furniturePerTick)){var time=new Date().valueOf();if(time-startTime>=40){this._skipFurnitureCreationForNextFrame=true;break;}}}}while(!this._skipFurnitureCreationForNextFrame&&(pendingData=instanceData.getNextPendingFurnitureWall())){furnitureAdded=this.processPendingFurnitureWall(instanceData.roomId,pendingData.id,pendingData);if(hasTickLimit){if(!(++totalFurnitureAdded%furniturePerTick)){var _time=new Date().valueOf();if(_time-startTime>=40){this._skipFurnitureCreationForNextFrame=true;break;}}}}if(furnitureAdded&&this._roomManager){var roomInstance=this._roomManager.getRoomInstance(this.getRoomId(instanceData.roomId));if(!roomInstance.hasUninitializedObjects())this.objectsInitialized(instanceData.roomId.toString());}if(this._skipFurnitureCreationForNextFrame)return;}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}},{key:\"onRoomEngineInitalized\",value:function onRoomEngineInitalized(flag){if(!flag)return;this._ready=true;this.events.dispatchEvent(new RoomEngineEvent(RoomEngineEvent.ENGINE_INITIALIZED,0));var _iterator3=_createForOfIteratorHelper(this._roomDatas.values()),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var roomData=_step3.value;if(!roomData)continue;this.createRoomInstance(roomData.roomId,roomData.data);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}}},{key:\"processPendingFurnitureFloor\",value:function processPendingFurnitureFloor(roomId,id,data){if(!data){var instanceData=this.getRoomInstanceData(roomId);if(instanceData)data=instanceData.getPendingFurnitureFloor(id);if(!data)return false;}var type=data.type;var didLoad=false;if(!type){type=this.getFurnitureFloorName(data.typeId);didLoad=true;}var object=this.createRoomObjectFloor(roomId,id,type);if(!object)return false;var model=object.model;if(model){model.setValue(RoomObjectVariable.FURNITURE_COLOR,this.getFurnitureFloorColorIndex(data.typeId));model.setValue(RoomObjectVariable.FURNITURE_TYPE_ID,data.typeId);model.setValue(RoomObjectVariable.FURNITURE_AD_URL,this.getRoomObjectAdUrl(data.type));model.setValue(RoomObjectVariable.FURNITURE_REAL_ROOM_OBJECT,data.realRoomObject?1:0);model.setValue(RoomObjectVariable.FURNITURE_EXPIRY_TIME,data.expiryTime);model.setValue(RoomObjectVariable.FURNITURE_EXPIRTY_TIMESTAMP,Nitro.instance.time);model.setValue(RoomObjectVariable.FURNITURE_USAGE_POLICY,data.usagePolicy);model.setValue(RoomObjectVariable.FURNITURE_OWNER_ID,data.ownerId);model.setValue(RoomObjectVariable.FURNITURE_OWNER_NAME,data.ownerName);}if(!this.updateRoomObjectFloor(roomId,id,data.location,data.direction,data.state,data.data,data.extra))return false;if(data.sizeZ>=0){if(!this.updateRoomObjectFloorHeight(roomId,id,data.sizeZ))return false;}if(this.events)this.events.dispatchEvent(new RoomEngineObjectEvent(RoomEngineObjectEvent.ADDED,roomId,id,RoomObjectCategory.FLOOR));var selectedRoomObjectData=this.getPlacedRoomObjectData(roomId);if(selectedRoomObjectData&&selectedRoomObjectData.id===id&&selectedRoomObjectData.category===RoomObjectCategory.FLOOR){this.selectRoomObject(roomId,id,RoomObjectCategory.FLOOR);}if(object.isReady&&data.synchronized)this.addObjectToTileMap(roomId,object);return true;}},{key:\"processPendingFurnitureWall\",value:function processPendingFurnitureWall(roomId,id,data){if(!data){var instanceData=this.getRoomInstanceData(roomId);if(instanceData)data=instanceData.getPendingFurnitureWall(id);if(!data)return false;}var extra='';if(data.data)extra=data.data.getLegacyString();var type=this.getFurnitureWallName(data.typeId,extra);if(!type)type='';var object=this.createRoomObjectWall(roomId,id,type);if(!object)return false;var model=object.model;if(model){model.setValue(RoomObjectVariable.FURNITURE_COLOR,this.getFurnitureWallColorIndex(data.typeId));model.setValue(RoomObjectVariable.FURNITURE_TYPE_ID,data.typeId);model.setValue(RoomObjectVariable.FURNITURE_AD_URL,this.getRoomObjectAdUrl(data.type));model.setValue(RoomObjectVariable.FURNITURE_REAL_ROOM_OBJECT,data.realRoomObject?1:0);model.setValue(RoomObjectVariable.OBJECT_ACCURATE_Z_VALUE,1);model.setValue(RoomObjectVariable.FURNITURE_EXPIRY_TIME,data.expiryTime);model.setValue(RoomObjectVariable.FURNITURE_EXPIRTY_TIMESTAMP,Nitro.instance.time);model.setValue(RoomObjectVariable.FURNITURE_USAGE_POLICY,data.usagePolicy);model.setValue(RoomObjectVariable.FURNITURE_OWNER_ID,data.ownerId);model.setValue(RoomObjectVariable.FURNITURE_OWNER_NAME,data.ownerName);}if(!this.updateRoomObjectWall(roomId,id,data.location,data.direction,data.state,extra))return false;if(this.events)this.events.dispatchEvent(new RoomEngineObjectEvent(RoomEngineObjectEvent.ADDED,roomId,id,RoomObjectCategory.WALL));var selectedRoomObjectData=this.getPlacedRoomObjectData(roomId);if(selectedRoomObjectData&&Math.abs(selectedRoomObjectData.id)===id&&selectedRoomObjectData.category===RoomObjectCategory.WALL){this.selectRoomObject(roomId,id,RoomObjectCategory.WALL);}return true;}},{key:\"setRoomSessionOwnUser\",value:function setRoomSessionOwnUser(roomId,objectId){if(!this._roomSessionManager)return;var session=this._roomSessionManager.getSession(roomId);if(session){session.setOwnRoomIndex(objectId);}var camera=this.getRoomCamera(roomId);if(camera){camera.targetId=objectId;camera.targetCategory=RoomObjectCategory.UNIT;camera.activateFollowing(this.cameraFollowDuration);}}},{key:\"cameraFollowDuration\",get:function get(){return 1000;//return (getBoolean(\"room.camera.follow_user\")) ? 1000 : 0;\n}},{key:\"updateRoomCameras\",value:function updateRoomCameras(time){var _iterator4=_createForOfIteratorHelper(this._roomInstanceDatas.values()),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var instanceData=_step4.value;if(!instanceData)continue;var camera=instanceData.roomCamera;if(!camera)continue;var location=null;var object=this.getRoomObject(instanceData.roomId,camera.targetId,camera.targetCategory);if(object)location=object.getLocation();if(!location)continue;if(instanceData.roomId!==this._activeRoomId||!this._activeRoomIsDragged){this.updateRoomCamera(instanceData.roomId,1,location,time);}}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}if(this._activeRoomWasDragged){var renderingCanvas=this.getRoomInstanceRenderingCanvas(this._activeRoomId,1);if(renderingCanvas)this.setRoomInstanceRenderingCanvasOffset(this._activeRoomId,1,new Point(renderingCanvas.screenOffsetX+this._activeRoomDragX,renderingCanvas.screenOffsetY+this._activeRoomDragY));this._activeRoomDragX=0;this._activeRoomDragY=0;}}},{key:\"updateRoomCamera\",value:function updateRoomCamera(roomId,canvasId,objectLocation,time){var renderingCanvas=this.getRoomInstanceRenderingCanvas(roomId,canvasId);var instanceData=this.getRoomInstanceData(roomId);if(!renderingCanvas||!instanceData||renderingCanvas.scale!==1)return;var roomGeometry=renderingCanvas.geometry;var roomCamera=instanceData.roomCamera;var roomInstance=this.getRoomInstance(roomId);if(!roomGeometry||!roomCamera||!roomInstance)return;var canvasRectangle=this.getRoomCanvasRectangle(roomId,canvasId);if(!canvasRectangle)return;var _local_10=Math.floor(objectLocation.z)+1;var width=Math.round(canvasRectangle.width);var height=Math.round(canvasRectangle.height);var bounds=this.getCanvasBoundingRectangle(canvasId);if(bounds&&(bounds.right<0||bounds.bottom<0||bounds.left>=width||bounds.top>=height)){roomCamera.reset();}if(roomCamera.screenWd!==width||roomCamera.screenHt!==height||roomCamera.scale!==roomGeometry.scale||roomCamera.geometryUpdateId!==roomGeometry.updateId||!Vector3d.isEqual(objectLocation,roomCamera.targetObjectLoc)||roomCamera.isMoving){roomCamera.targetObjectLoc=objectLocation;var _local_15=new Vector3d();_local_15.assign(objectLocation);_local_15.x=Math.round(_local_15.x);_local_15.y=Math.round(_local_15.y);var _local_16=roomInstance.model.getValue(RoomVariableEnum.ROOM_MIN_X)-0.5;var _local_17=roomInstance.model.getValue(RoomVariableEnum.ROOM_MIN_Y)-0.5;var _local_18=roomInstance.model.getValue(RoomVariableEnum.ROOM_MAX_X)+0.5;var _local_19=roomInstance.model.getValue(RoomVariableEnum.ROOM_MAX_Y)+0.5;var _local_20=Math.round((_local_16+_local_18)/2);var _local_21=Math.round((_local_17+_local_19)/2);var _local_22=2;var _local_23=new Point(_local_15.x-_local_20,_local_15.y-_local_21);var _local_24=roomGeometry.scale/Math.sqrt(2);var _local_25=_local_24/2;var _local_26=new Matrix();_local_26.rotate(-(roomGeometry.direction.x+90)/180*Math.PI);_local_23=_local_26.apply(_local_23);_local_23.y=_local_23.y*(_local_25/_local_24);var _local_27=canvasRectangle.width/2/_local_24-1;var _local_28=canvasRectangle.height/2/_local_25-1;var _local_29=0;var _local_30=0;var _local_31=0;var _local_32=0;var _local_33=roomGeometry.getScreenPoint(new Vector3d(_local_20,_local_21,_local_22));if(!_local_33)return;_local_33.x=_local_33.x+Math.round(canvasRectangle.width/2);_local_33.y=_local_33.y+Math.round(canvasRectangle.height/2);if(bounds){bounds.x+=-renderingCanvas.screenOffsetX;bounds.y+=-renderingCanvas.screenOffsetY;if(bounds.width>1&&bounds.height>1){_local_29=(bounds.left-_local_33.x-roomGeometry.scale*0.25)/_local_24;_local_31=(bounds.right-_local_33.x+roomGeometry.scale*0.25)/_local_24;_local_30=(bounds.top-_local_33.y-roomGeometry.scale*0.5)/_local_25;_local_32=(bounds.bottom-_local_33.y+roomGeometry.scale*0.5)/_local_25;}else{roomGeometry.adjustLocation(new Vector3d(-30,-30),25);return;}}else{roomGeometry.adjustLocation(new Vector3d(0,0),25);return;}var _local_34=false;var _local_35=false;var _local_36=false;var _local_37=false;var _local_38=Math.round((_local_31-_local_29)*_local_24);if(_local_38<canvasRectangle.width){_local_10=2;_local_23.x=(_local_31+_local_29)/2;_local_36=true;}else{if(_local_23.x>_local_31-_local_27){_local_23.x=_local_31-_local_27;_local_34=true;}if(_local_23.x<_local_29+_local_27){_local_23.x=_local_29+_local_27;_local_34=true;}}var _local_39=Math.round((_local_32-_local_30)*_local_25);if(_local_39<canvasRectangle.height){_local_10=2;_local_23.y=(_local_32+_local_30)/2;_local_37=true;}else{if(_local_23.y>_local_32-_local_28){_local_23.y=_local_32-_local_28;_local_35=true;}if(_local_23.y<_local_30+_local_28){_local_23.y=_local_30+_local_28;_local_35=true;}if(_local_35){_local_23.y=_local_23.y/(_local_25/_local_24);}}_local_26.invert();_local_23=_local_26.apply(_local_23);_local_23.x=_local_23.x+_local_20;_local_23.y=_local_23.y+_local_21;var _local_40=0.35;var _local_41=0.2;var _local_42=0.2;var _local_43=10;var _local_44=10;if(_local_42*width>100){_local_42=100/width;}if(_local_40*height>150){_local_40=150/height;}if(_local_41*height>150){_local_41=150/height;}if(roomCamera.limitedLocationX&&roomCamera.screenWd==width&&roomCamera.screenHt==height){_local_42=0;}if(roomCamera.limitedLocationY&&roomCamera.screenWd==width&&roomCamera.screenHt==height){_local_40=0;_local_41=0;}canvasRectangle.width=canvasRectangle.width*(1-_local_42*2);canvasRectangle.height=canvasRectangle.height*(1-(_local_40+_local_41));if(canvasRectangle.width<_local_43){canvasRectangle.width=_local_43;}if(canvasRectangle.height<_local_44){canvasRectangle.height=_local_44;}if(_local_40+_local_41>0){canvasRectangle.x+=-canvasRectangle.width/2;canvasRectangle.y+=-canvasRectangle.height*(_local_41/(_local_40+_local_41));}else{canvasRectangle.x+=-canvasRectangle.width/2;canvasRectangle.y+=-canvasRectangle.height/2;}_local_33=roomGeometry.getScreenPoint(_local_15);if(!_local_33)return;if(_local_33){_local_33.x=_local_33.x+renderingCanvas.screenOffsetX;_local_33.y=_local_33.y+renderingCanvas.screenOffsetY;_local_15.z=_local_10;_local_15.x=Math.round(_local_23.x*2)/2;_local_15.y=Math.round(_local_23.y*2)/2;if(!roomCamera.location){roomGeometry.location=_local_15;if(this.useOffsetScrolling){roomCamera.initializeLocation(new Vector3d(0,0,0));}else{roomCamera.initializeLocation(_local_15);}}var _local_45=roomGeometry.getScreenPoint(_local_15);var _local_46=new Vector3d(0,0,0);if(_local_45){_local_46.x=_local_45.x;_local_46.y=_local_45.y;}if((_local_33.x<canvasRectangle.left||_local_33.x>canvasRectangle.right)&&!roomCamera.centeredLocX||(_local_33.y<canvasRectangle.top||_local_33.y>canvasRectangle.bottom)&&!roomCamera.centeredLocY||_local_36&&!roomCamera.centeredLocX&&!(roomCamera.screenWd==width)||_local_37&&!roomCamera.centeredLocY&&!(roomCamera.screenHt==height)||!(roomCamera.roomWd==bounds.width)||!(roomCamera.roomHt==bounds.height)||!(roomCamera.screenWd==width)||!(roomCamera.screenHt==height)){roomCamera.limitedLocationX=_local_34;roomCamera.limitedLocationY=_local_35;if(this.useOffsetScrolling){roomCamera.target=_local_46;}else{roomCamera.target=_local_15;}}else{if(!_local_34)roomCamera.limitedLocationX=false;if(!_local_35)roomCamera.limitedLocationY=false;}}roomCamera.centeredLocX=_local_36;roomCamera.centeredLocY=_local_37;roomCamera.screenWd=width;roomCamera.screenHt=height;roomCamera.scale=roomGeometry.scale;roomCamera.geometryUpdateId=roomGeometry.updateId;roomCamera.roomWd=bounds.width;roomCamera.roomHt=bounds.height;if(!this._sessionDataManager.isCameraFollowDisabled){if(this.useOffsetScrolling){roomCamera.update(time,8);}else{roomCamera.update(time,0.5);}}if(this.useOffsetScrolling){this.setRoomInstanceRenderingCanvasOffset(this.activeRoomId,1,new Point(-roomCamera.location.x,-roomCamera.location.y));}else{roomGeometry.adjustLocation(roomCamera.location,25);}}else{roomCamera.limitedLocationX=false;roomCamera.limitedLocationY=false;roomCamera.centeredLocX=false;roomCamera.centeredLocY=false;}}},{key:\"getRoomCanvasRectangle\",value:function getRoomCanvasRectangle(roomId,canvasId){var canvas=this.getRoomInstanceRenderingCanvas(roomId,canvasId);if(!canvas)return null;return new Rectangle(0,0,canvas.width,canvas.height);}},{key:\"getRoomObjectBoundingRectangle\",value:function getRoomObjectBoundingRectangle(roomId,objectId,category,canvasId){var geometry=this.getRoomInstanceGeometry(roomId,canvasId);if(!geometry)return null;var roomObject=this.getRoomObject(roomId,objectId,category);if(!roomObject)return null;var visualization=roomObject.visualization;if(!visualization)return null;var rectangle=visualization.getBoundingRectangle();var canvas=this.getRoomInstanceRenderingCanvas(roomId,canvasId);var scale=canvas?canvas.scale:1;var screenPoint=geometry.getScreenPoint(roomObject.getLocation());if(!screenPoint)return null;screenPoint.x=Math.round(screenPoint.x);screenPoint.y=Math.round(screenPoint.y);rectangle.x=rectangle.x*scale;rectangle.y=rectangle.y*scale;rectangle.width=rectangle.width*scale;rectangle.height=rectangle.height*scale;screenPoint.x=screenPoint.x*scale;screenPoint.y=screenPoint.y*scale;rectangle.x+=screenPoint.x;rectangle.y+=screenPoint.y;if(!canvas)return null;rectangle.x+=Math.round(canvas.width/2)+canvas.screenOffsetX;rectangle.y+=Math.round(canvas.height/2)+canvas.screenOffsetY;return rectangle;}},{key:\"getCanvasBoundingRectangle\",value:function getCanvasBoundingRectangle(canvasId){return this.getRoomObjectBoundingRectangle(this._activeRoomId,RoomEngine.ROOM_OBJECT_ID,RoomObjectCategory.ROOM,canvasId);}},{key:\"getFurnitureFloorName\",value:function getFurnitureFloorName(typeId){if(!this._roomContentLoader)return null;return this._roomContentLoader.getFurnitureFloorNameForTypeId(typeId);}},{key:\"getFurnitureWallName\",value:function getFurnitureWallName(typeId){var extra=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!this._roomContentLoader)return null;return this._roomContentLoader.getFurnitureWallNameForTypeId(typeId,extra);}},{key:\"getFurnitureFloorColorIndex\",value:function getFurnitureFloorColorIndex(typeId){if(!this._roomContentLoader)return null;return this._roomContentLoader.getFurnitureFloorColorIndex(typeId);}},{key:\"getFurnitureWallColorIndex\",value:function getFurnitureWallColorIndex(typeId){if(!this._roomContentLoader)return null;return this._roomContentLoader.getFurnitureWallColorIndex(typeId);}},{key:\"getRoomInstanceData\",value:function getRoomInstanceData(roomId){var existing=this._roomInstanceDatas.get(roomId);if(existing)return existing;var data=new RoomInstanceData(roomId);this._roomInstanceDatas.set(data.roomId,data);return data;}},{key:\"getRoomInstanceModelName\",value:function getRoomInstanceModelName(roomId){var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return null;return instanceData.modelName;}},{key:\"setRoomInstanceModelName\",value:function setRoomInstanceModelName(roomId,name){var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return;instanceData.setModelName(name);}},{key:\"getRoomTileObjectMap\",value:function getRoomTileObjectMap(k){var roomInstance=this.getRoomInstanceData(k);if(!roomInstance)return null;return roomInstance.tileObjectMap;}},{key:\"getCurrentRoomCamera\",value:function getCurrentRoomCamera(){return this.getRoomCamera(this._activeRoomId);}},{key:\"getRoomCamera\",value:function getRoomCamera(roomId){var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return null;return instanceData.roomCamera;}},{key:\"getSelectedRoomObjectData\",value:function getSelectedRoomObjectData(roomId){var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return null;return instanceData.selectedObject;}},{key:\"setSelectedRoomObjectData\",value:function setSelectedRoomObjectData(roomId,data){var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return null;instanceData.setSelectedObject(data);if(data)instanceData.setPlacedObject(null);}},{key:\"getPlacedRoomObjectData\",value:function getPlacedRoomObjectData(roomId){var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return null;return instanceData.placedObject;}},{key:\"setPlacedRoomObjectData\",value:function setPlacedRoomObjectData(roomId,data){var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return null;instanceData.setPlacedObject(data);}},{key:\"cancelRoomObjectPlacement\",value:function cancelRoomObjectPlacement(){if(!this._roomObjectEventHandler)return;this._roomObjectEventHandler.cancelRoomObjectPlacement(this._activeRoomId);}},{key:\"getFurnitureStackingHeightMap\",value:function getFurnitureStackingHeightMap(roomId){var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return null;return instanceData.furnitureStackingHeightMap;}},{key:\"setFurnitureStackingHeightMap\",value:function setFurnitureStackingHeightMap(roomId,heightMap){var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return null;instanceData.setFurnitureStackingHeightMap(heightMap);}},{key:\"getLegacyWallGeometry\",value:function getLegacyWallGeometry(roomId){var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return null;return instanceData.legacyGeometry;}},{key:\"createRoomObjectAndInitialize\",value:function createRoomObjectAndInitialize(roomId,objectId,type,category){var instance=this.getRoomInstance(roomId);if(!instance)return null;return instance.createRoomObjectAndInitalize(objectId,type,category);}},{key:\"getTotalObjectsForManager\",value:function getTotalObjectsForManager(roomId,category){var instance=this.getRoomInstance(roomId);if(!instance)return 0;return instance.getTotalObjectsForManager(category);}},{key:\"getRoomObject\",value:function getRoomObject(roomId,objectId,category){if(!this._ready)return null;var roomIdString=this.getRoomId(roomId);if(roomId===0)roomIdString=RoomEngine.TEMPORARY_ROOM;return this.getObject(roomIdString,objectId,category);}},{key:\"getObject\",value:function getObject(roomId,objectId,category){var roomInstance=null;if(this._roomManager)roomInstance=this._roomManager.getRoomInstance(roomId);if(!roomInstance)return null;var roomObject=roomInstance.getRoomObject(objectId,category);if(!roomObject){switch(category){case RoomObjectCategory.FLOOR:this.processPendingFurnitureFloor(this.getRoomIdFromString(roomId),objectId,null);roomObject=roomInstance.getRoomObject(objectId,category);break;case RoomObjectCategory.WALL:this.processPendingFurnitureWall(this.getRoomIdFromString(roomId),objectId,null);roomObject=roomInstance.getRoomObject(objectId,category);break;}}return roomObject;}},{key:\"getRoomObjectByIndex\",value:function getRoomObjectByIndex(roomId,index,category){var instance=this.getRoomInstance(roomId);if(!instance)return null;return instance.getRoomObjectByIndex(index,category);}},{key:\"getRoomObjectCategoryForType\",value:function getRoomObjectCategoryForType(type){if(!type||!this._roomContentLoader)return RoomObjectCategory.MINIMUM;return this._roomContentLoader.getCategoryForType(type);}},{key:\"getRoomObjectCursor\",value:function getRoomObjectCursor(roomId){return this.getObject(this.getRoomId(roomId),RoomEngine.CURSOR_OBJECT_ID,RoomObjectCategory.CURSOR);}},{key:\"getRoomObjectSelectionArrow\",value:function getRoomObjectSelectionArrow(roomId){return this.getObject(this.getRoomId(roomId),RoomEngine.ARROW_OBJECT_ID,RoomObjectCategory.CURSOR);}},{key:\"getRoomOwnObject\",value:function getRoomOwnObject(roomId){return this.getObject(this.getRoomId(roomId),RoomEngine.ROOM_OBJECT_ID,RoomObjectCategory.ROOM);}},{key:\"getRoomObjectUser\",value:function getRoomObjectUser(roomId,objectId){return this.getObject(this.getRoomId(roomId),objectId,RoomObjectCategory.UNIT);}},{key:\"removeRoomObjectUser\",value:function removeRoomObjectUser(roomId,objectId){return this.removeRoomObject(roomId,objectId,RoomObjectCategory.UNIT);}},{key:\"createRoomObjectUser\",value:function createRoomObjectUser(roomId,objectId,type){return this.createRoomObjectAndInitialize(roomId,objectId,type,RoomObjectCategory.UNIT);}},{key:\"getRoomObjectFloor\",value:function getRoomObjectFloor(roomId,objectId){return this.getObject(this.getRoomId(roomId),objectId,RoomObjectCategory.FLOOR);}},{key:\"createRoomObjectFloor\",value:function createRoomObjectFloor(roomId,id,type){return this.createRoomObjectAndInitialize(roomId,id,type,RoomObjectCategory.FLOOR);}},{key:\"removeRoomObjectFloor\",value:function removeRoomObjectFloor(roomId,objectId){var userId=arguments.length>2&&arguments[2]!==undefined?arguments[2]:-1;var _arg_4=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;var roomInstanceData=this.getRoomInstanceData(roomId);if(roomInstanceData)roomInstanceData.removePendingFunitureFloor(objectId);if(this._sessionDataManager&&userId===this._sessionDataManager.userId&&!FurniId.isBuilderClubId(objectId)){var roomObject=this.getRoomObject(roomId,objectId,RoomObjectCategory.FLOOR);if(roomObject){var screenLocation=this.getRoomObjectScreenLocation(roomId,objectId,RoomObjectCategory.FLOOR,this._activeRoomActiveCanvas);if(screenLocation){var disabledPickingAnimation=roomObject.model.getValue(RoomObjectVariable.FURNITURE_DISABLE_PICKING_ANIMATION)===1;if(!disabledPickingAnimation){var typeId=roomObject.model.getValue(RoomObjectVariable.FURNITURE_TYPE_ID);var extras=roomObject.model.getValue(RoomObjectVariable.FURNITURE_EXTRAS);var dataKey=roomObject.model.getValue(RoomObjectVariable.FURNITURE_DATA_FORMAT);var objectData=ObjectDataFactory.getData(dataKey);var icon=this.getFurnitureFloorIcon(typeId,null,extras,objectData).data;if(icon){var image=TextureUtils.generateImage(icon);if(this.events){var event=new NitroToolbarAnimateIconEvent(image,screenLocation.x,screenLocation.y);event.iconName=ToolbarIconEnum.INVENTORY;this.events.dispatchEvent(event);}}}}}}this.removeRoomObject(roomId,objectId,RoomObjectCategory.FLOOR);this.setMouseDefault(roomId,RoomObjectCategory.FLOOR,objectId);if(_arg_4)this.refreshTileObjectMap(roomId,'RoomEngine.disposeObjectFurniture()');}},{key:\"getRoomObjectWall\",value:function getRoomObjectWall(roomId,objectId){return this.getObject(this.getRoomId(roomId),objectId,RoomObjectCategory.WALL);}},{key:\"removeRoomObjectWall\",value:function removeRoomObjectWall(roomId,objectId){var userId=arguments.length>2&&arguments[2]!==undefined?arguments[2]:-1;if(this._sessionDataManager&&userId===this._sessionDataManager.userId&&!FurniId.isBuilderClubId(objectId)){var roomObject=this.getRoomObject(roomId,objectId,RoomObjectCategory.WALL);if(roomObject&&roomObject.type.indexOf('post_it')===-1&&roomObject.type.indexOf('external_image_wallitem')===-1){var screenLocation=this.getRoomObjectScreenLocation(roomId,objectId,RoomObjectCategory.WALL,this._activeRoomActiveCanvas);if(screenLocation){var typeId=roomObject.model.getValue(RoomObjectVariable.FURNITURE_TYPE_ID);var objectData=roomObject.model.getValue(RoomObjectVariable.FURNITURE_DATA);var icon=this.getFurnitureWallIcon(typeId,null,objectData).data;if(icon){var image=TextureUtils.generateImage(icon);if(this.events){var event=new NitroToolbarAnimateIconEvent(image,screenLocation.x,screenLocation.y);event.iconName=ToolbarIconEnum.INVENTORY;this.events.dispatchEvent(event);}}}}}this.removeRoomObject(roomId,objectId,RoomObjectCategory.WALL);this.updateRoomObjectMask(roomId,objectId,false);this.setMouseDefault(roomId,RoomObjectCategory.WALL,objectId);}},{key:\"createRoomObjectWall\",value:function createRoomObjectWall(roomId,id,type){return this.createRoomObjectAndInitialize(roomId,id,type,RoomObjectCategory.WALL);}},{key:\"removeRoomObject\",value:function removeRoomObject(roomId,objectId,category){var instance=this.getRoomInstance(roomId);if(!instance)return null;instance.removeRoomObject(objectId,category);if(this.events)this.events.dispatchEvent(new RoomEngineObjectEvent(RoomEngineObjectEvent.REMOVED,roomId,objectId,category));}},{key:\"addFurnitureFloor\",value:function addFurnitureFloor(roomId,id,typeId,location,direction,state,objectData){var extra=arguments.length>7&&arguments[7]!==undefined?arguments[7]:NaN;var expires=arguments.length>8&&arguments[8]!==undefined?arguments[8]:-1;var usagePolicy=arguments.length>9&&arguments[9]!==undefined?arguments[9]:0;var ownerId=arguments.length>10&&arguments[10]!==undefined?arguments[10]:0;var ownerName=arguments.length>11&&arguments[11]!==undefined?arguments[11]:'';var synchronized=arguments.length>12&&arguments[12]!==undefined?arguments[12]:true;var realRoomObject=arguments.length>13&&arguments[13]!==undefined?arguments[13]:true;var sizeZ=arguments.length>14&&arguments[14]!==undefined?arguments[14]:-1;var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return false;var furnitureData=new RoomFurnitureData(id,typeId,null,location,direction,state,objectData,extra,expires,usagePolicy,ownerId,ownerName,synchronized,realRoomObject,sizeZ);instanceData.addPendingFurnitureFloor(furnitureData);return true;}},{key:\"addFurnitureFloorByTypeName\",value:function addFurnitureFloorByTypeName(roomId,id,typeName,location,direction,state,objectData){var extra=arguments.length>7&&arguments[7]!==undefined?arguments[7]:NaN;var expires=arguments.length>8&&arguments[8]!==undefined?arguments[8]:-1;var usagePolicy=arguments.length>9&&arguments[9]!==undefined?arguments[9]:0;var ownerId=arguments.length>10&&arguments[10]!==undefined?arguments[10]:0;var ownerName=arguments.length>11&&arguments[11]!==undefined?arguments[11]:'';var synchronized=arguments.length>12&&arguments[12]!==undefined?arguments[12]:true;var realRoomObject=arguments.length>13&&arguments[13]!==undefined?arguments[13]:true;var sizeZ=arguments.length>14&&arguments[14]!==undefined?arguments[14]:-1;var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return false;var furnitureData=new RoomFurnitureData(id,0,typeName,location,direction,state,objectData,extra,expires,usagePolicy,ownerId,ownerName,synchronized,realRoomObject,sizeZ);instanceData.addPendingFurnitureFloor(furnitureData);return true;}},{key:\"addFurnitureWall\",value:function addFurnitureWall(roomId,id,typeId,location,direction,state,extra){var expires=arguments.length>7&&arguments[7]!==undefined?arguments[7]:-1;var usagePolicy=arguments.length>8&&arguments[8]!==undefined?arguments[8]:0;var ownerId=arguments.length>9&&arguments[9]!==undefined?arguments[9]:0;var ownerName=arguments.length>10&&arguments[10]!==undefined?arguments[10]:'';var realRoomObject=arguments.length>11&&arguments[11]!==undefined?arguments[11]:true;var instanceData=this.getRoomInstanceData(roomId);if(!instanceData)return false;var objectData=new LegacyDataType();objectData.setString(extra);var furnitureData=new RoomFurnitureData(id,typeId,null,location,direction,state,objectData,NaN,expires,usagePolicy,ownerId,ownerName,true,realRoomObject);instanceData.addPendingFurnitureWall(furnitureData);return true;}},{key:\"updateRoomObjectFloor\",value:function updateRoomObjectFloor(roomId,objectId,location,direction,state,data){var extra=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var object=this.getRoomObjectFloor(roomId,objectId);if(!object)return false;object.processUpdateMessage(new RoomObjectUpdateMessage(location,direction));object.processUpdateMessage(new ObjectDataUpdateMessage(state,data,extra));return true;}},{key:\"updateRoomObjectWall\",value:function updateRoomObjectWall(roomId,objectId,location,direction,state){var extra=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var object=this.getRoomObjectWall(roomId,objectId);if(!object||!object.logic)return false;var updateMessage=new RoomObjectUpdateMessage(location,direction);var data=new LegacyDataType();var dataUpdateMessage=new ObjectDataUpdateMessage(state,data);data.setString(extra);object.logic.processUpdateMessage(updateMessage);object.logic.processUpdateMessage(dataUpdateMessage);this.updateRoomObjectMask(roomId,objectId);return true;}},{key:\"updateRoomObjectWallItemData\",value:function updateRoomObjectWallItemData(roomId,objectId,data){var object=this.getRoomObjectWall(roomId,objectId);if(!object||!object.logic)return false;object.logic.processUpdateMessage(new ObjectItemDataUpdateMessage(data));return true;}},{key:\"updateRoomObjectFloorHeight\",value:function updateRoomObjectFloorHeight(roomId,objectId,height){var object=this.getRoomObjectFloor(roomId,objectId);if(!object)return false;object.processUpdateMessage(new ObjectHeightUpdateMessage(null,null,height));return true;}},{key:\"updateRoomObjectFloorExpiration\",value:function updateRoomObjectFloorExpiration(roomId,objectId,expires){var object=this.getRoomObjectFloor(roomId,objectId);if(!object)return false;object.model.setValue(RoomObjectVariable.FURNITURE_EXPIRY_TIME,expires);object.model.setValue(RoomObjectVariable.FURNITURE_EXPIRTY_TIMESTAMP,Nitro.instance.time);return true;}},{key:\"updateRoomObjectWallExpiration\",value:function updateRoomObjectWallExpiration(roomId,objectId,expires){var object=this.getRoomObjectWall(roomId,objectId);if(!object)return false;object.model.setValue(RoomObjectVariable.FURNITURE_EXPIRY_TIME,expires);object.model.setValue(RoomObjectVariable.FURNITURE_EXPIRTY_TIMESTAMP,Nitro.instance.time);return true;}},{key:\"updateRoomObjectMask\",value:function updateRoomObjectMask(roomId,objectId){var _arg_3=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var maskName=RoomObjectCategory.WALL+'_'+objectId;var roomObject=this.getRoomObjectWall(roomId,objectId);var maskUpdate=null;if(roomObject&&roomObject.model){if(roomObject.model.getValue(RoomObjectVariable.FURNITURE_USES_PLANE_MASK)>0){var maskType=roomObject.model.getValue(RoomObjectVariable.FURNITURE_PLANE_MASK_TYPE);var location=roomObject.getLocation();if(_arg_3)maskUpdate=new ObjectRoomMaskUpdateMessage(ObjectRoomMaskUpdateMessage.ADD_MASK,maskName,maskType,location);else maskUpdate=new ObjectRoomMaskUpdateMessage(ObjectRoomMaskUpdateMessage.REMOVE_MASK,maskName);}}else{maskUpdate=new ObjectRoomMaskUpdateMessage(ObjectRoomMaskUpdateMessage.REMOVE_MASK,maskName);}var roomOwnObject=this.getRoomOwnObject(roomId);if(roomOwnObject&&roomOwnObject.logic&&maskUpdate)roomOwnObject.logic.processUpdateMessage(maskUpdate);}},{key:\"rollRoomObjectFloor\",value:function rollRoomObjectFloor(roomId,objectId,location,targetLocation){var object=this.getRoomObjectFloor(roomId,objectId);if(!object)return;object.processUpdateMessage(new ObjectMoveUpdateMessage(location,targetLocation,null,!!targetLocation));}},{key:\"updateRoomObjectWallLocation\",value:function updateRoomObjectWallLocation(roomId,objectId,location){var roomObject=this.getRoomObjectWall(roomId,objectId);if(!roomObject)return false;if(roomObject.logic)roomObject.logic.processUpdateMessage(new ObjectMoveUpdateMessage(location,null,null));this.updateRoomObjectMask(roomId,objectId);return true;}},{key:\"addRoomObjectUser\",value:function addRoomObjectUser(roomId,objectId,location,direction,headDirection,type,figure){var existing=this.getRoomObjectUser(roomId,objectId);if(existing)return false;var objectType=RoomObjectUserType.getTypeString(type);if(objectType===RoomObjectUserType.PET)objectType=this.getPetType(figure);var object=this.createRoomObjectUser(roomId,objectId,objectType);if(!object)return false;//object.model.setValue(RoomObjectVariable.FIGURE_HIGHLIGHT_ENABLE, 1);\nobject.processUpdateMessage(new ObjectAvatarUpdateMessage(this.fixedUserLocation(roomId,location),null,direction,headDirection,false,0));if(figure)object.processUpdateMessage(new ObjectAvatarFigureUpdateMessage(figure));if(this.events)this.events.dispatchEvent(new RoomEngineObjectEvent(RoomEngineObjectEvent.ADDED,roomId,objectId,RoomObjectCategory.UNIT));return true;}},{key:\"updateRoomObjectUserLocation\",value:function updateRoomObjectUserLocation(roomId,objectId,location,targetLocation){var canStandUp=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;var baseY=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var direction=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var headDirection=arguments.length>7&&arguments[7]!==undefined?arguments[7]:NaN;var object=this.getRoomObjectUser(roomId,objectId);if(!object)return false;if(!location)location=object.getLocation();if(!direction)direction=object.getDirection();if(isNaN(headDirection))headDirection=object.model.getValue(RoomObjectVariable.HEAD_DIRECTION);object.processUpdateMessage(new ObjectAvatarUpdateMessage(this.fixedUserLocation(roomId,location),this.fixedUserLocation(roomId,targetLocation),direction,headDirection,canStandUp,baseY));var roomSession=this._roomSessionManager&&this._roomSessionManager.getSession(roomId)||null;if(roomSession&&roomSession.ownRoomIndex===objectId){this._logicFactory.events.dispatchEvent(new RoomToObjectOwnAvatarMoveEvent(RoomToObjectOwnAvatarMoveEvent.ROAME_MOVE_TO,targetLocation));}return true;}},{key:\"fixedUserLocation\",value:function fixedUserLocation(roomId,location){if(!location)return null;var heightMap=this.getFurnitureStackingHeightMap(roomId);var wallGeometry=this.getLegacyWallGeometry(roomId);if(!heightMap||!wallGeometry)return location;var _local_5=location.z;var _local_6=heightMap.getTileHeight(location.x,location.y);var _local_7=wallGeometry.getHeight(location.x,location.y);if(Math.abs(_local_5-_local_6)<0.1&&Math.abs(_local_6-_local_7)<0.1){_local_5=wallGeometry.getFloorAltitude(location.x,location.y);}return new Vector3d(location.x,location.y,_local_5);}},{key:\"updateRoomObjectUserAction\",value:function updateRoomObjectUserAction(roomId,objectId,action,value){var parameter=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var object=this.getRoomObjectUser(roomId,objectId);if(!object)return false;var message=null;switch(action){case RoomObjectVariable.FIGURE_TALK:message=new ObjectAvatarChatUpdateMessage(value);break;case RoomObjectVariable.FIGURE_SLEEP:message=new ObjectAvatarSleepUpdateMessage(value===1);break;case RoomObjectVariable.FIGURE_IS_TYPING:message=new ObjectAvatarTypingUpdateMessage(value===1);break;case RoomObjectVariable.FIGURE_IS_MUTED:message=new ObjectAvatarMutedUpdateMessage(value===1);break;case RoomObjectVariable.FIGURE_CARRY_OBJECT:message=new ObjectAvatarCarryObjectUpdateMessage(value,parameter);break;case RoomObjectVariable.FIGURE_USE_OBJECT:message=new ObjectAvatarUseObjectUpdateMessage(value);break;case RoomObjectVariable.FIGURE_DANCE:message=new ObjectAvatarDanceUpdateMessage(value);break;case RoomObjectVariable.FIGURE_GAINED_EXPERIENCE:message=new ObjectAvatarExperienceUpdateMessage(value);break;case RoomObjectVariable.FIGURE_NUMBER_VALUE:message=new ObjectAvatarPlayerValueUpdateMessage(value);break;case RoomObjectVariable.FIGURE_SIGN:message=new ObjectAvatarSignUpdateMessage(value);break;case RoomObjectVariable.FIGURE_EXPRESSION:message=new ObjectAvatarExpressionUpdateMessage(value);break;case RoomObjectVariable.FIGURE_IS_PLAYING_GAME:message=new ObjectAvatarPlayingGameUpdateMessage(value===1);break;case RoomObjectVariable.FIGURE_GUIDE_STATUS:message=new ObjectAvatarGuideStatusUpdateMessage(value);break;}if(!message)return false;object.processUpdateMessage(message);return true;}},{key:\"updateRoomObjectUserFigure\",value:function updateRoomObjectUserFigure(roomId,objectId,figure){var gender=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var subType=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var isRiding=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;var object=this.getRoomObjectUser(roomId,objectId);if(!object)return false;object.processUpdateMessage(new ObjectAvatarFigureUpdateMessage(figure,gender,subType,isRiding));return true;}},{key:\"updateRoomObjectUserFlatControl\",value:function updateRoomObjectUserFlatControl(roomId,objectId,level){var object=this.getRoomObjectUser(roomId,objectId);if(!object)return false;object.processUpdateMessage(new ObjectAvatarFlatControlUpdateMessage(parseInt(level)));return true;}},{key:\"updateRoomObjectUserEffect\",value:function updateRoomObjectUserEffect(roomId,objectId,effectId){var delay=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var object=this.getRoomObjectUser(roomId,objectId);if(!object)return false;object.processUpdateMessage(new ObjectAvatarEffectUpdateMessage(effectId,delay));return true;}},{key:\"updateRoomObjectUserGesture\",value:function updateRoomObjectUserGesture(roomId,objectId,gestureId){var object=this.getRoomObjectUser(roomId,objectId);if(!object)return false;object.processUpdateMessage(new ObjectAvatarGestureUpdateMessage(gestureId));return true;}},{key:\"updateRoomObjectUserPetGesture\",value:function updateRoomObjectUserPetGesture(roomId,objectId,gesture){var object=this.getRoomObjectUser(roomId,objectId);if(!object)return false;object.processUpdateMessage(new ObjectAvatarPetGestureUpdateMessage(gesture));return true;}},{key:\"updateRoomObjectUserPosture\",value:function updateRoomObjectUserPosture(roomId,objectId,type){var parameter=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var object=this.getRoomObjectUser(roomId,objectId);if(!object)return false;object.processUpdateMessage(new ObjectAvatarPostureUpdateMessage(type,parameter));return true;}},{key:\"updateRoomObjectUserOwn\",value:function updateRoomObjectUserOwn(roomId,objectId){var object=this.getRoomObjectUser(roomId,objectId);if(!object)return;object.processUpdateMessage(new ObjectAvatarOwnMessage());}},{key:\"useRoomObject\",value:function useRoomObject(objectId,category){var roomObject=this.getRoomObject(this._activeRoomId,objectId,category);if(roomObject){var eventHandler=roomObject.logic;if(eventHandler){eventHandler.useObject();return true;}}return false;}},{key:\"objectInitialized\",value:function objectInitialized(roomId,objectId,category){var id=this.getRoomIdFromString(roomId);if(category===RoomObjectCategory.WALL){this.updateRoomObjectMask(id,objectId);}var object=this.getRoomObject(id,objectId,category);if(object&&object.model&&object.logic){var dataFormat=object.model.getValue(RoomObjectVariable.FURNITURE_DATA_FORMAT);if(!isNaN(dataFormat)){var data=ObjectDataFactory.getData(dataFormat);data.initializeFromRoomObjectModel(object.model);object.processUpdateMessage(new ObjectDataUpdateMessage(object.getState(0),data));}this.events.dispatchEvent(new RoomEngineObjectEvent(RoomEngineObjectEvent.CONTENT_UPDATED,id,objectId,category));}if(roomId!==RoomEngine.TEMPORARY_ROOM)this.addObjectToTileMap(id,object);}},{key:\"changeObjectModelData\",value:function changeObjectModelData(roomId,objectId,category,numberKey,numberValue){var roomObject=this.getObject(this.getRoomId(roomId),objectId,category);if(!roomObject||!roomObject.logic)return false;var message=new ObjectModelDataUpdateMessage(numberKey,numberValue);roomObject.processUpdateMessage(message);return true;}},{key:\"changeObjectState\",value:function changeObjectState(roomId,objectId,category){var roomObject=this.getObject(this.getRoomId(roomId),objectId,category);if(!roomObject||!roomObject.model)return;var stateIndex=roomObject.model.getValue(RoomObjectVariable.FURNITURE_AUTOMATIC_STATE_INDEX);if(isNaN(stateIndex))stateIndex=1;else stateIndex=stateIndex+1;roomObject.model.setValue(RoomObjectVariable.FURNITURE_AUTOMATIC_STATE_INDEX,stateIndex);var objectDataKey=roomObject.model.getValue(RoomObjectVariable.FURNITURE_DATA_FORMAT);var objectData=ObjectDataFactory.getData(objectDataKey);objectData.initializeFromRoomObjectModel(roomObject.model);if(roomObject.logic)roomObject.logic.processUpdateMessage(new ObjectDataUpdateMessage(stateIndex,objectData));}},{key:\"loadRoomObjectBadgeImage\",value:function loadRoomObjectBadgeImage(roomId,objectId,objectCategory,badgeId){var groupBadge=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;if(!this._sessionDataManager)return;var roomObject=null;if(roomId===0){var room=this._roomManager.getRoomInstance(RoomEngine.TEMPORARY_ROOM);if(room)roomObject=room.getRoomObject(objectId,objectCategory);}else{roomObject=this.getRoomObjectFloor(roomId,objectId);}if(!roomObject||!roomObject.logic)return;var badgeName=groupBadge?this._sessionDataManager.loadGroupBadgeImage(badgeId):this._sessionDataManager.loadBadgeImage(badgeId);if(!badgeName){badgeName='loading_icon';if(!this._badgeListenerObjects)this._badgeListenerObjects=new Map();if(!this._badgeListenerObjects.size){this._sessionDataManager.events.addEventListener(BadgeImageReadyEvent.IMAGE_READY,this.onBadgeImageReadyEvent);}var listeners=this._badgeListenerObjects.get(badgeId);if(!listeners)listeners=[];listeners.push(new RoomObjectBadgeImageAssetListener(roomObject,groupBadge));this._badgeListenerObjects.set(badgeId,listeners);}else{this.putBadgeInObjectAssets(roomObject,badgeId,groupBadge);}roomObject.logic.processUpdateMessage(new ObjectGroupBadgeUpdateMessage(badgeId,badgeName));}},{key:\"onBadgeImageReadyEvent\",value:function onBadgeImageReadyEvent(k){if(!this._sessionDataManager)return;var listeners=this._badgeListenerObjects&&this._badgeListenerObjects.get(k.badgeId);if(!listeners)return;var _iterator5=_createForOfIteratorHelper(listeners),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var listener=_step5.value;if(!listener)continue;this.putBadgeInObjectAssets(listener.object,k.badgeId,listener.groupBadge);var badgeName=listener.groupBadge?this._sessionDataManager.loadGroupBadgeImage(k.badgeId):this._sessionDataManager.loadBadgeImage(k.badgeId);if(listener.object&&listener.object.logic)listener.object.logic.processUpdateMessage(new ObjectGroupBadgeUpdateMessage(k.badgeId,badgeName));}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}this._badgeListenerObjects.delete(k.badgeId);if(!this._badgeListenerObjects.size){this._sessionDataManager.events.removeEventListener(BadgeImageReadyEvent.IMAGE_READY,this.onBadgeImageReadyEvent);}}},{key:\"putBadgeInObjectAssets\",value:function putBadgeInObjectAssets(object,badgeId){var groupBadge=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(!this._roomContentLoader||!this._sessionDataManager)return;var badgeName=groupBadge?this._sessionDataManager.loadGroupBadgeImage(badgeId):this._sessionDataManager.loadBadgeImage(badgeId);var badgeImage=groupBadge?this._sessionDataManager.getGroupBadgeImage(badgeId):this._sessionDataManager.getBadgeImage(badgeId);if(badgeImage)this._roomContentLoader.addAssetToCollection(object.type,badgeName,badgeImage,false);}},{key:\"dispatchMouseEvent\",value:function dispatchMouseEvent(canvasId,x,y,type,altKey,ctrlKey,shiftKey,buttonDown){var canvas=this.getRoomInstanceRenderingCanvas(this._activeRoomId,canvasId);if(!canvas)return;var overlay=this.getRenderingCanvasOverlay(canvas);var sprite=this.getOverlayIconSprite(overlay,RoomEngine.OBJECT_ICON_SPRITE);if(sprite){var rectangle=sprite.getLocalBounds();sprite.x=x-rectangle.width/2;sprite.y=y-rectangle.height/2;}if(!this.handleRoomDragging(canvas,x,y,type,altKey,ctrlKey,shiftKey)){if(!canvas.handleMouseEvent(x,y,type,altKey,ctrlKey,shiftKey,buttonDown)){var eventType=null;if(type===MouseEventType.MOUSE_CLICK){if(this.events){this.events.dispatchEvent(new RoomEngineObjectEvent(RoomEngineObjectEvent.DESELECTED,this._activeRoomId,-1,RoomObjectCategory.MINIMUM));}eventType=RoomObjectMouseEvent.CLICK;}else{if(type===MouseEventType.MOUSE_MOVE)eventType=RoomObjectMouseEvent.MOUSE_MOVE;else if(type===MouseEventType.MOUSE_DOWN)eventType=RoomObjectMouseEvent.MOUSE_DOWN;else if(type===MouseEventType.MOUSE_DOWN_LONG)eventType=RoomObjectMouseEvent.MOUSE_DOWN_LONG;else if(type===MouseEventType.MOUSE_UP)eventType=RoomObjectMouseEvent.MOUSE_UP;}this._roomObjectEventHandler.handleRoomObjectEvent(new RoomObjectMouseEvent(eventType,this.getRoomObject(this._activeRoomId,RoomEngine.ROOM_OBJECT_ID,RoomObjectCategory.ROOM),null,altKey),this._activeRoomId);}}this._activeRoomActiveCanvas=canvasId;this._activeRoomActiveCanvasMouseX=x;this._activeRoomActiveCanvasMouseY=y;}},{key:\"handleRoomDragging\",value:function handleRoomDragging(canvas,x,y,type,altKey,ctrlKey,shiftKey){var offsetX=x-this._activeRoomActiveCanvasMouseX;var offsetY=y-this._activeRoomActiveCanvasMouseY;if(type===MouseEventType.MOUSE_DOWN){if(!altKey&&!ctrlKey&&!shiftKey&&!this.isDecorating){if(this._roomAllowsDragging){this._activeRoomIsDragged=true;this._activeRoomWasDragged=false;this._activeRoomDragStartX=this._activeRoomActiveCanvasMouseX;this._activeRoomDragStartY=this._activeRoomActiveCanvasMouseY;}}}else if(type===MouseEventType.MOUSE_UP){if(this._activeRoomIsDragged){this._activeRoomIsDragged=false;if(this._activeRoomWasDragged){var instanceData=this.getRoomInstanceData(this._activeRoomId);if(instanceData){var camera=instanceData.roomCamera;if(camera){if(this.useOffsetScrolling){if(!camera.isMoving){camera.centeredLocX=false;camera.centeredLocY=false;}camera.resetLocation(new Vector3d(-canvas.screenOffsetX,-canvas.screenOffsetY));}if(this._roomDraggingAlwaysCenters)camera.reset();}}}}}else if(type===MouseEventType.MOUSE_MOVE){if(this._activeRoomIsDragged){if(!this._activeRoomWasDragged){offsetX=x-this._activeRoomDragStartX;offsetY=y-this._activeRoomDragStartY;if(offsetX<=-RoomEngine.DRAG_THRESHOLD||offsetX>=RoomEngine.DRAG_THRESHOLD||offsetY<=-RoomEngine.DRAG_THRESHOLD||offsetY>=RoomEngine.DRAG_THRESHOLD){this._activeRoomWasDragged=true;}offsetX=0;offsetY=0;}if(!(offsetX==0)||!(offsetY==0)){this._activeRoomDragX+=offsetX;this._activeRoomDragY+=offsetY;this._activeRoomWasDragged=true;}}}else if(type===MouseEventType.MOUSE_CLICK||type===MouseEventType.DOUBLE_CLICK){this._activeRoomIsDragged=false;if(this._activeRoomWasDragged){this._activeRoomWasDragged=false;return true;}}return false;}},{key:\"updateMousePointer\",value:function updateMousePointer(type,objectId,objectType){var category=this.getRoomObjectCategoryForType(objectType);switch(type){case RoomObjectFurnitureActionEvent.MOUSE_BUTTON:this.setMouseButton(this._activeRoomId,category,objectId);return;default:this.setMouseDefault(this._activeRoomId,category,objectId);return;}}},{key:\"setMouseButton\",value:function setMouseButton(roomId,category,objectId){if(!this._roomSessionManager)return;var session=this._roomSessionManager.getSession(roomId);if(!session)return;if(category!==RoomObjectCategory.FLOOR&&category!==RoomObjectCategory.WALL||session.controllerLevel>=RoomControllerLevel.GUEST){var instanceData=this.getRoomInstanceData(roomId);if(instanceData){if(instanceData.addButtonMouseCursorOwner(category+'_'+objectId))this._mouseCursorUpdate=true;}}}},{key:\"setMouseDefault\",value:function setMouseDefault(roomId,category,objectId){if(!this._roomSessionManager)return;var instanceData=this.getRoomInstanceData(roomId);if(instanceData){if(instanceData.removeButtonMouseCursorOwner(category+'_'+objectId))this._mouseCursorUpdate=true;}}},{key:\"processRoomObjectOperation\",value:function processRoomObjectOperation(objectId,category,operation){if(!this._roomObjectEventHandler)return false;this._roomObjectEventHandler.modifyRoomObject(this._activeRoomId,objectId,category,operation);}},{key:\"modifyRoomObjectDataWithMap\",value:function modifyRoomObjectDataWithMap(objectId,category,operation,data){if(!this._roomObjectEventHandler)return false;if(category!==RoomObjectCategory.FLOOR)return;this._roomObjectEventHandler.modifyRoomObjectDataWithMap(this._activeRoomId,objectId,category,operation,data);}},{key:\"modifyRoomObjectData\",value:function modifyRoomObjectData(objectId,category,colorHex,data){if(!this._roomObjectEventHandler)return false;if(category!==RoomObjectCategory.WALL)return;this._roomObjectEventHandler.modifyWallItemData(this._activeRoomId,objectId,colorHex,data);}},{key:\"processRoomObjectEvent\",value:function processRoomObjectEvent(event){if(!this._roomObjectEventHandler)return;var roomIdString=this.getRoomObjectRoomId(event.object);if(!roomIdString)return;var roomId=this.getRoomIdFromString(roomIdString);this._roomObjectEventHandler.handleRoomObjectEvent(event,roomId);}},{key:\"processRoomObjectPlacement\",value:function processRoomObjectPlacement(placementSource,id,category,typeId){var extra=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var stuffData=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var state=arguments.length>6&&arguments[6]!==undefined?arguments[6]:-1;var frameNumber=arguments.length>7&&arguments[7]!==undefined?arguments[7]:-1;var posture=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var roomInstance=this.getRoomInstance(this._activeRoomId);if(!roomInstance||roomInstance.model.getValue(RoomVariableEnum.ROOM_IS_PUBLIC)!==0)return false;if(!this._roomObjectEventHandler)return false;return this._roomObjectEventHandler.processRoomObjectPlacement(placementSource,this._activeRoomId,id,category,typeId,extra,stuffData,state,frameNumber,posture);}},{key:\"getRoomObjectScreenLocation\",value:function getRoomObjectScreenLocation(roomId,objectId,objectType){var canvasId=arguments.length>3&&arguments[3]!==undefined?arguments[3]:-1;if(canvasId==-1)canvasId=this._activeRoomActiveCanvas;var geometry=this.getRoomInstanceGeometry(roomId,canvasId);if(!geometry)return null;var roomObject=this.getRoomObject(roomId,objectId,objectType);if(!roomObject)return null;var screenPoint=geometry.getScreenPoint(roomObject.getLocation());if(!screenPoint)return null;var renderingCanvas=this.getRoomInstanceRenderingCanvas(roomId,canvasId);if(!renderingCanvas)return null;screenPoint.x=screenPoint.x*renderingCanvas.scale;screenPoint.y=screenPoint.y*renderingCanvas.scale;screenPoint.x+=renderingCanvas.width/2+renderingCanvas.screenOffsetX;screenPoint.y+=renderingCanvas.height/2+renderingCanvas.screenOffsetY;screenPoint.x=Math.round(screenPoint.x);screenPoint.y=Math.round(screenPoint.y);return screenPoint;}},{key:\"selectRoomObject\",value:function selectRoomObject(roomId,objectId,objectCategory){if(!this._roomObjectEventHandler)return;this._roomObjectEventHandler.setSelectedObject(roomId,objectId,objectCategory);}},{key:\"setSelectedAvatar\",value:function setSelectedAvatar(roomId,objectId){if(this._roomObjectEventHandler)return;this._roomObjectEventHandler.setSelectedAvatar(roomId,objectId,true);}},{key:\"cancelRoomObjectInsert\",value:function cancelRoomObjectInsert(){if(!this._roomObjectEventHandler)return;this._roomObjectEventHandler.cancelRoomObjectInsert(this._activeRoomId);}},{key:\"addOverlayIconSprite\",value:function addOverlayIconSprite(k,_arg_2,_arg_3){var scale=arguments.length>3&&arguments[3]!==undefined?arguments[3]:1;if(!k||!_arg_3)return;var sprite=this.getOverlayIconSprite(k,_arg_2);if(sprite)return null;sprite=new NitroSprite(_arg_3);sprite.name=_arg_2;sprite.scale.set(scale);k.addChild(sprite);return sprite;}},{key:\"onRoomContentLoaded\",value:function onRoomContentLoaded(id,assetName,success){if(!this._roomContentLoader||id===-1)return;this._thumbnailObjectIdBank.freeNumber(id-1);var listeners=this._thumbnailCallbacks.get(assetName);if(listeners){this._thumbnailCallbacks.delete(assetName);var image=this._roomContentLoader.getImage(assetName);if(image){var _iterator6=_createForOfIteratorHelper(listeners),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var listener=_step6.value;if(!listener)continue;listener.imageReady(id,null,image);}}catch(err){_iterator6.e(err);}finally{_iterator6.f();}}}}},{key:\"setObjectMoverIconSprite\",value:function setObjectMoverIconSprite(objectId,category,_arg_3){var instanceData=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var stuffData=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;var state=arguments.length>5&&arguments[5]!==undefined?arguments[5]:-1;var frameNumber=arguments.length>6&&arguments[6]!==undefined?arguments[6]:-1;var posture=arguments.length>7&&arguments[7]!==undefined?arguments[7]:null;var type=null;var colorIndex=0;var imageResult=null;var scale=1;if(_arg_3){imageResult=this.getRoomObjectImage(this._activeRoomId,objectId,category,new Vector3d(),1,null);}else{if(this._roomContentLoader){if(category===RoomObjectCategory.FLOOR){type=this._roomContentLoader.getFurnitureFloorNameForTypeId(objectId);colorIndex=this._roomContentLoader.getFurnitureFloorColorIndex(objectId);}else if(category===RoomObjectCategory.WALL){type=this._roomContentLoader.getFurnitureWallNameForTypeId(objectId,instanceData);colorIndex=this._roomContentLoader.getFurnitureWallColorIndex(objectId);}if(category===RoomObjectCategory.UNIT){type=RoomObjectUserType.getTypeString(objectId);if(type==='pet'){type=this.getPetType(instanceData);var petFigureData=new PetFigureData(instanceData);imageResult=this.getRoomObjectPetImage(petFigureData.typeId,petFigureData.paletteId,petFigureData.color,new Vector3d(180),64,null,true,0,petFigureData.customParts,posture);}else{imageResult=this.getGenericRoomObjectImage(type,instanceData,new Vector3d(180),64,null,0,null,stuffData,state,frameNumber,posture);}}else{imageResult=this.getGenericRoomObjectImage(type,colorIndex.toString(),new Vector3d(),1,null,0,instanceData,stuffData,state,frameNumber,posture);}}}if(!imageResult||!imageResult.data)return;var canvas=this.getActiveRoomInstanceRenderingCanvas();if(!canvas)return;var overlay=this.getRenderingCanvasOverlay(canvas);this.removeOverlayIconSprite(overlay,RoomEngine.OBJECT_ICON_SPRITE);var _local_15=this.addOverlayIconSprite(overlay,RoomEngine.OBJECT_ICON_SPRITE,imageResult.data,scale);if(_local_15){_local_15.x=this._activeRoomActiveCanvasMouseX-imageResult.data.width/2;_local_15.y=this._activeRoomActiveCanvasMouseY-imageResult.data.height/2;}}},{key:\"getRoomObjectImage\",value:function getRoomObjectImage(roomId,objectId,category,direction,scale,listener){var bgColor=arguments.length>6&&arguments[6]!==undefined?arguments[6]:0;if(!this._roomManager)return null;var id=-1;var type=null;var data=null;var color='';var extras=null;var roomIdString=this.getRoomId(roomId);var roomInstance=this._roomManager.getRoomInstance(roomIdString);if(roomInstance){var roomObject=roomInstance.getRoomObject(objectId,category);if(roomObject&&roomObject.model){id=roomObject.id;type=roomObject.type;switch(category){case RoomObjectCategory.FLOOR:case RoomObjectCategory.WALL:{color=roomObject.model.getValue(RoomObjectVariable.FURNITURE_COLOR).toString();extras=roomObject.model.getValue(RoomObjectVariable.FURNITURE_EXTRAS);var dataFormat=roomObject.model.getValue(RoomObjectVariable.FURNITURE_DATA_FORMAT);if(dataFormat!==LegacyDataType.FORMAT_KEY){data=ObjectDataFactory.getData(dataFormat);data.initializeFromRoomObjectModel(roomObject.model);}break;}case RoomObjectCategory.UNIT:color=roomObject.model.getValue(RoomObjectVariable.FIGURE);break;}}}return this.getGenericRoomObjectImage(type,color,direction,scale,listener,bgColor,extras,data,-1,-1,null,id);}},{key:\"getFurnitureFloorIconUrl\",value:function getFurnitureFloorIconUrl(typeId){var type=null;var color='';if(this._roomContentLoader){type=this._roomContentLoader.getFurnitureFloorNameForTypeId(typeId);color=this._roomContentLoader.getFurnitureFloorColorIndex(typeId).toString();return this._roomContentLoader.getAssetIconUrl(type,color);}return null;}},{key:\"getFurnitureFloorIcon\",value:function getFurnitureFloorIcon(typeId,listener){var extras=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var objectData=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;return this.getFurnitureFloorImage(typeId,new Vector3d(),1,listener,0,extras,-1,-1,objectData);}},{key:\"getFurnitureWallIconUrl\",value:function getFurnitureWallIconUrl(typeId){var extra=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var type=null;var color='';if(this._roomContentLoader){type=this._roomContentLoader.getFurnitureWallNameForTypeId(typeId,extra);color=this._roomContentLoader.getFurnitureWallColorIndex(typeId).toString();return this._roomContentLoader.getAssetIconUrl(type,color);}return null;}},{key:\"getFurnitureWallIcon\",value:function getFurnitureWallIcon(typeId,listener){var extras=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;return this.getFurnitureWallImage(typeId,new Vector3d(),1,listener,0,extras);}},{key:\"getFurnitureFloorImage\",value:function getFurnitureFloorImage(typeId,direction,scale,listener){var bgColor=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var extras=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var state=arguments.length>6&&arguments[6]!==undefined?arguments[6]:-1;var frameCount=arguments.length>7&&arguments[7]!==undefined?arguments[7]:-1;var objectData=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var type=null;var color='';if(this._roomContentLoader){type=this._roomContentLoader.getFurnitureFloorNameForTypeId(typeId);color=this._roomContentLoader.getFurnitureFloorColorIndex(typeId).toString();}if(scale===1&&listener){return this.getGenericRoomObjectThumbnail(type,color,listener,extras,objectData);}return this.getGenericRoomObjectImage(type,color,direction,scale,listener,bgColor,extras,objectData,state,frameCount);}},{key:\"getFurnitureWallImage\",value:function getFurnitureWallImage(typeId,direction,scale,listener){var bgColor=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var extras=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var state=arguments.length>6&&arguments[6]!==undefined?arguments[6]:-1;var frameCount=arguments.length>7&&arguments[7]!==undefined?arguments[7]:-1;var type=null;var color='';if(this._roomContentLoader){type=this._roomContentLoader.getFurnitureWallNameForTypeId(typeId);color=this._roomContentLoader.getFurnitureWallColorIndex(typeId).toString();}if(scale===1&&listener){return this.getGenericRoomObjectThumbnail(type,color,listener,extras,null);}return this.getGenericRoomObjectImage(type,color,direction,scale,listener,bgColor,extras,null,state,frameCount);}},{key:\"getRoomObjectPetImage\",value:function getRoomObjectPetImage(typeId,paletteId,color,direction,scale,listener){var headOnly=arguments.length>6&&arguments[6]!==undefined?arguments[6]:false;var bgColor=arguments.length>7&&arguments[7]!==undefined?arguments[7]:0;var customParts=arguments.length>8&&arguments[8]!==undefined?arguments[8]:null;var posture=arguments.length>9&&arguments[9]!==undefined?arguments[9]:null;var type=null;var value=typeId+' '+paletteId+' '+color.toString(16);if(headOnly)value=value+(' '+'head');if(customParts){value=value+(' '+customParts.length);var _iterator7=_createForOfIteratorHelper(customParts),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var _local_13=_step7.value;value=value+(' '+_local_13.layerId+' '+_local_13.partId+' '+_local_13.paletteId);}}catch(err){_iterator7.e(err);}finally{_iterator7.f();}}if(this._roomContentLoader)type=this._roomContentLoader.getPetNameForType(typeId);return this.getGenericRoomObjectImage(type,value,direction,scale,listener,bgColor,null,null,-1,-1,posture);}},{key:\"getGenericRoomObjectImage\",value:function getGenericRoomObjectImage(type,value,direction,scale,listener){var bgColor=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var extras=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var objectData=arguments.length>7&&arguments[7]!==undefined?arguments[7]:null;var state=arguments.length>8&&arguments[8]!==undefined?arguments[8]:-1;var frameCount=arguments.length>9&&arguments[9]!==undefined?arguments[9]:-1;var posture=arguments.length>10&&arguments[10]!==undefined?arguments[10]:null;var originalId=arguments.length>11&&arguments[11]!==undefined?arguments[11]:-1;if(!this._roomManager)return null;var imageResult=new ImageResult();imageResult.id=-1;if(!this._ready||!type)return imageResult;var roomInstance=this._roomManager.getRoomInstance(RoomEngine.TEMPORARY_ROOM);if(!roomInstance){roomInstance=this._roomManager.createRoomInstance(RoomEngine.TEMPORARY_ROOM);if(!roomInstance)return imageResult;}var objectId=this._imageObjectIdBank.reserveNumber();var objectCategory=this.getRoomObjectCategoryForType(type);if(objectId<0)return imageResult;objectId++;var roomObject=roomInstance.createRoomObjectAndInitalize(objectId,type,objectCategory);if(!roomObject||!roomObject.model||!roomObject.logic)return imageResult;var model=roomObject.model;switch(objectCategory){case RoomObjectCategory.FLOOR:case RoomObjectCategory.WALL:model.setValue(RoomObjectVariable.FURNITURE_COLOR,parseInt(value));model.setValue(RoomObjectVariable.FURNITURE_EXTRAS,extras);break;case RoomObjectCategory.UNIT:if(type===RoomObjectUserType.USER||type===RoomObjectUserType.BOT||type===RoomObjectUserType.RENTABLE_BOT||type===RoomObjectUserType.PET){model.setValue(RoomObjectVariable.FIGURE,value);}else{var figureData=new PetFigureData(value);model.setValue(RoomObjectVariable.PET_PALETTE_INDEX,figureData.paletteId);model.setValue(RoomObjectVariable.PET_COLOR,figureData.color);if(figureData.headOnly)model.setValue(RoomObjectVariable.PET_HEAD_ONLY,1);if(figureData.hasCustomParts){model.setValue(RoomObjectVariable.PET_CUSTOM_LAYER_IDS,figureData.customLayerIds);model.setValue(RoomObjectVariable.PET_CUSTOM_PARTS_IDS,figureData.customPartIds);model.setValue(RoomObjectVariable.PET_CUSTOM_PALETTE_IDS,figureData.customPaletteIds);}if(posture)model.setValue(RoomObjectVariable.FIGURE_POSTURE,posture);}break;case RoomObjectCategory.ROOM:break;}roomObject.setDirection(direction);var visualization=roomObject.visualization;if(!visualization){roomInstance.removeRoomObject(objectId,objectCategory);return imageResult;}if(state>-1||objectData){if(objectData&&objectData.getLegacyString()!==''){roomObject.logic.processUpdateMessage(new ObjectDataUpdateMessage(parseInt(objectData.getLegacyString()),objectData));}else{roomObject.logic.processUpdateMessage(new ObjectDataUpdateMessage(state,objectData));}}var geometry=new RoomGeometry(scale,new Vector3d(-135,30,0),new Vector3d(11,11,5));visualization.update(geometry,0,true,false);if(frameCount>0){var i=0;while(i<frameCount){visualization.update(geometry,0,true,false);i++;}}var texture=visualization.getImage(bgColor,originalId);imageResult.data=texture;imageResult.id=objectId;if(!this.isRoomContentTypeLoaded(type)&&listener){var imageListeners=this._imageCallbacks.get(objectId.toString());if(!imageListeners){imageListeners=[];this._imageCallbacks.set(objectId.toString(),imageListeners);}imageListeners.push(listener);model.setValue(RoomObjectVariable.IMAGE_QUERY_SCALE,scale);}else{roomInstance.removeRoomObject(objectId,objectCategory);this._imageObjectIdBank.freeNumber(objectId-1);imageResult.id=0;}geometry.dispose();return imageResult;}},{key:\"getGenericRoomObjectThumbnail\",value:function getGenericRoomObjectThumbnail(type,param,listener){var extraData=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var stuffData=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(!this._roomManager)return null;var imageResult=new ImageResult();imageResult.id=-1;if(!this._ready||!type)return imageResult;var roomInstance=this._roomManager.getRoomInstance(RoomEngine.TEMPORARY_ROOM);if(!roomInstance){roomInstance=this._roomManager.createRoomInstance(RoomEngine.TEMPORARY_ROOM);if(!roomInstance)return imageResult;}var objectId=this._thumbnailObjectIdBank.reserveNumber();var objectCategory=this.getRoomObjectCategoryForType(type);if(objectId<0)return imageResult;objectId++;imageResult.id=objectId;imageResult.data=null;imageResult.image=null;var assetName=[type,param].join('_');var asset=this._roomContentLoader.getImage(assetName);if(!asset&&listener){var contentListeners=this._thumbnailCallbacks.get(assetName);if(!contentListeners){contentListeners=[];this._thumbnailCallbacks.set(assetName,contentListeners);this._roomContentLoader.downloadImage(objectId,type,param,null);}contentListeners.push(listener);}else{if(asset){imageResult.image=asset;}this._thumbnailObjectIdBank.freeNumber(objectId-1);imageResult.id=0;}return imageResult;}},{key:\"initalizeTemporaryObjectsByType\",value:function initalizeTemporaryObjectsByType(type,_arg_2){var roomInstance=this._roomManager.getRoomInstance(RoomEngine.TEMPORARY_ROOM);if(!roomInstance||!this._roomContentLoader)return;var objectCategory=this._roomContentLoader.getCategoryForType(type);var objectManager=roomInstance.getManager(objectCategory);var geometry=null;var scale=0;if(objectManager&&objectManager.objects.length){var _iterator8=_createForOfIteratorHelper(objectManager.objects.getValues()),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var roomObject=_step8.value;if(roomObject&&roomObject.model&&roomObject.type===type){var objectId=roomObject.id;var visualization=roomObject.visualization;var texture=null;if(visualization){var imageScale=roomObject.model.getValue(RoomObjectVariable.IMAGE_QUERY_SCALE);if(geometry&&scale!==imageScale){geometry.dispose();geometry=null;}if(!geometry){scale=imageScale;geometry=new RoomGeometry(imageScale,new Vector3d(-135,30,0),new Vector3d(11,11,5));}visualization.update(geometry,0,true,false);texture=visualization.image;}roomInstance.removeRoomObject(objectId,objectCategory);this._imageObjectIdBank.freeNumber(objectId-1);var imageListeners=this._imageCallbacks.get(objectId.toString());if(imageListeners){this._imageCallbacks.delete(objectId.toString());var _iterator9=_createForOfIteratorHelper(imageListeners),_step9;try{for(_iterator9.s();!(_step9=_iterator9.n()).done;){var imageListener=_step9.value;if(!imageListener)continue;if(texture)imageListener.imageReady(objectId,texture);else imageListener.imageFailed(objectId);}}catch(err){_iterator9.e(err);}finally{_iterator9.f();}}}}}catch(err){_iterator8.e(err);}finally{_iterator8.f();}}if(geometry)geometry.dispose();}},{key:\"setObjectMoverIconSpriteVisible\",value:function setObjectMoverIconSpriteVisible(k){var canvas=this.getActiveRoomInstanceRenderingCanvas();if(!canvas)return;var overlay=this.getRenderingCanvasOverlay(canvas);var sprite=this.getOverlayIconSprite(overlay,RoomEngine.OBJECT_ICON_SPRITE);if(sprite){sprite.visible=k;}}},{key:\"removeObjectMoverIconSprite\",value:function removeObjectMoverIconSprite(){var canvas=this.getActiveRoomInstanceRenderingCanvas();if(!canvas)return;var sprite=this.getRenderingCanvasOverlay(canvas);this.removeOverlayIconSprite(sprite,RoomEngine.OBJECT_ICON_SPRITE);}},{key:\"getRenderingCanvasOverlay\",value:function getRenderingCanvasOverlay(k){if(!k)return null;var displayObject=k.master;if(!displayObject)return null;return displayObject.getChildByName(RoomEngine.OVERLAY)||null;}},{key:\"removeOverlayIconSprite\",value:function removeOverlayIconSprite(k,_arg_2){if(!k)return false;var index=k.children.length-1;while(index>=0){var child=k.getChildAt(index);if(child){if(child.name===_arg_2){k.removeChildAt(index);if(child.children.length){var firstChild=child.getChildAt(0);firstChild.parent.removeChild(firstChild);firstChild.destroy();}return true;}}index--;}return false;}},{key:\"getOverlayIconSprite\",value:function getOverlayIconSprite(k,_arg_2){if(!k)return null;var index=k.children.length-1;while(index>=0){var child=k.getChildAt(index);if(child){if(child.name===_arg_2)return child;}index--;}return null;}},{key:\"getRoomObjects\",value:function getRoomObjects(roomId,category){if(this._ready){var _local_3=this.getRoomId(roomId);var _local_4=this._roomManager.getRoomInstance(_local_3);if(_local_4)return _local_4.getRoomObjectsForCategory(category);}return[];}},{key:\"addObjectToTileMap\",value:function addObjectToTileMap(k,_arg_2){var tileObjectMap=this.getRoomInstanceData(k).tileObjectMap;if(tileObjectMap)tileObjectMap.addRoomObject(_arg_2);}},{key:\"refreshTileObjectMap\",value:function refreshTileObjectMap(k,_arg_2){var tileObjectMap=this.getRoomInstanceData(k).tileObjectMap;if(tileObjectMap)tileObjectMap.populate(this.getRoomObjects(k,RoomObjectCategory.FLOOR));}},{key:\"getRenderRoomMessage\",value:function getRenderRoomMessage(k,_arg_2){var _arg_3=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var _arg_4=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;var _arg_5=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;var canvasId=arguments.length>5&&arguments[5]!==undefined?arguments[5]:-1;var canvas=null;if(canvasId>-1){canvas=this.getRoomInstanceRenderingCanvas(this._activeRoomId,canvasId);}else{canvas=this.getActiveRoomInstanceRenderingCanvas();}if(!canvas)return null;if(_arg_5){canvas.skipSpriteVisibilityChecking();}var _local_8=-1;if(!_arg_4&&!(this._roomSessionManager.getSession(this._activeRoomId)==null)){_local_8=this._roomSessionManager.getSession(this._activeRoomId).ownRoomIndex;}var _local_9=new SpriteDataCollector();var _local_10=_local_9.getFurniData(k,canvas,this,_local_8);var _local_11=_local_9.getRoomRenderingModifiers(this);var _local_12=_local_9.getRoomPlanes(k,canvas,this,_arg_2);if(_arg_5)canvas.resumeSpriteVisibilityChecking();if(_arg_3){//return new RenderRoomThumbnailMessageComposer(_local_12, _local_10, _local_11, this._activeRoomId, this._sessionDataManager._Str_8500);\n}console.log(_local_10,_local_11,_local_12);//return new RenderRoomMessageComposer(_local_12, _local_10, _local_11, this._activeRoomId, this._sessionDataManager._Str_8500);\nreturn null;}},{key:\"createTextureFromRoom\",value:function createTextureFromRoom(roomId){var canvasId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:-1;var bounds=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var canvas=null;if(canvasId>-1){canvas=this.getRoomInstanceRenderingCanvas(this._activeRoomId,canvasId);}else{canvas=this.getActiveRoomInstanceRenderingCanvas();}var texture=null;if(bounds){texture=TextureUtils.generateTexture(canvas.master,bounds);}else{texture=canvas.getDisplayAsTexture();}return texture;}},{key:\"saveTextureAsScreenshot\",value:function saveTextureAsScreenshot(texture){var saveAsThumbnail=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var composer=null;if(saveAsThumbnail)composer=new RenderRoomThumbnailMessageComposer();else composer=new RenderRoomMessageComposer();composer.assignBitmap(texture);this._communication.connection.send(composer);}},{key:\"saveBase64AsScreenshot\",value:function saveBase64AsScreenshot(base64){var saveAsThumbnail=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var composer=null;if(saveAsThumbnail)composer=new RenderRoomThumbnailMessageComposer();else composer=new RenderRoomMessageComposer();composer.assignBase64(base64);this._communication.connection.send(composer);}},{key:\"objectsInitialized\",value:function objectsInitialized(k){var roomId=this.getRoomIdFromString(k);this.events.dispatchEvent(new RoomEngineEvent(RoomEngineEvent.OBJECTS_INITIALIZED,roomId));}},{key:\"getRoomId\",value:function getRoomId(id){return id.toString();}},{key:\"getRoomIdFromString\",value:function getRoomIdFromString(roomId){if(!roomId)return-1;var split=roomId.split('_');if(split.length<=0)return-1;return parseInt(split[0])||0;}},{key:\"getRoomObjectRoomId\",value:function getRoomObjectRoomId(object){if(!object||!object.model)return null;return object.model.getValue(RoomObjectVariable.OBJECT_ROOM_ID);}},{key:\"getRoomObjectAdUrl\",value:function getRoomObjectAdUrl(type){return this._roomContentLoader.getRoomObjectAdUrl(type);}},{key:\"getPetTypeId\",value:function getPetTypeId(figure){var type=-1;if(figure){var parts=figure.split(' ');if(parts.length>1)type=parseInt(parts[0]);}return type;}},{key:\"getPetType\",value:function getPetType(type){if(!type)return null;var parts=type.split(' ');if(parts.length>1){var typeId=parseInt(parts[0]);if(this._roomContentLoader)return this._roomContentLoader.getPetNameForType(typeId);return'pet';}return null;}},{key:\"isRoomContentTypeLoaded\",value:function isRoomContentTypeLoaded(name){if(!this._roomContentLoader)return false;return this._roomContentLoader.getCollection(name)!==null;}},{key:\"getPetColorResult\",value:function getPetColorResult(petIndex,paletteIndex){if(!this._roomContentLoader)return null;return this._roomContentLoader.getPetColorResult(petIndex,paletteIndex);}},{key:\"getPetColorResultsForTag\",value:function getPetColorResultsForTag(petIndex,tagName){if(!this._roomContentLoader)return null;return this._roomContentLoader.getPetColorResultsForTag(petIndex,tagName);}},{key:\"deleteRoomObject\",value:function deleteRoomObject(objectId,objectCategory){if(!this._roomObjectEventHandler||objectCategory!==RoomObjectCategory.WALL)return false;return this._roomObjectEventHandler.deleteWallItem(this._activeRoomId,objectId);}},{key:\"connection\",get:function get(){return this._communication.connection;}},{key:\"sessionDataManager\",get:function get(){return this._sessionDataManager;},set:function set(manager){this._sessionDataManager=manager;}},{key:\"roomSessionManager\",get:function get(){return this._roomSessionManager;},set:function set(manager){this._roomSessionManager=manager;}},{key:\"roomManager\",get:function get(){return this._roomManager;},set:function set(manager){this._roomManager=manager;}},{key:\"objectEventHandler\",get:function get(){return this._roomObjectEventHandler;}},{key:\"roomRendererFactory\",get:function get(){return this._roomRendererFactory;}},{key:\"visualizationFactory\",get:function get(){return this._visualizationFactory;}},{key:\"logicFactory\",get:function get(){return this._logicFactory;}},{key:\"activeRoomId\",get:function get(){return this._activeRoomId;}},{key:\"ready\",get:function get(){return this._ready;}},{key:\"roomContentLoader\",get:function get(){return this._roomContentLoader;}},{key:\"isDecorating\",get:function get(){if(!this._roomSessionManager)return false;var session=this._roomSessionManager.getSession(this._activeRoomId);return session&&session.isDecorating||false;}},{key:\"useOffsetScrolling\",get:function get(){return true;}},{key:\"selectedAvatarId\",get:function get(){if(!this._roomObjectEventHandler)return-1;return this._roomObjectEventHandler.selectedAvatarId;}},{key:\"getRoomObjectCount\",value:function getRoomObjectCount(roomId,categoryId){if(this._roomManager==null)return 0;return this._roomManager.getRoomInstance(roomId.toString()).getRoomObjectsForCategory(categoryId).length;}}]);return RoomEngine;}(NitroManager);RoomEngine.ROOM_OBJECT_ID=-1;RoomEngine.ROOM_OBJECT_TYPE='room';RoomEngine.CURSOR_OBJECT_ID=-2;RoomEngine.CURSOR_OBJECT_TYPE='tile_cursor';RoomEngine.ARROW_OBJECT_ID=-3;RoomEngine.ARROW_OBJECT_TYPE='selection_arrow';RoomEngine.OVERLAY='overlay';RoomEngine.OBJECT_ICON_SPRITE='object_icon_sprite';RoomEngine.DRAG_THRESHOLD=15;RoomEngine.TEMPORARY_ROOM='temporary_room';","map":null,"metadata":{},"sourceType":"module"}