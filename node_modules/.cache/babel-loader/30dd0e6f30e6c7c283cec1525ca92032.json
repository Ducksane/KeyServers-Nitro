{"ast":null,"code":"import _slicedToArray from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _createForOfIteratorHelper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _assertThisInitialized from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js\";import _inherits from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{NitroLogger}from'../../core/common/logger/NitroLogger';import{EventDispatcher}from'../../core/events/EventDispatcher';import{NitroEvent}from'../../core/events/NitroEvent';import{Nitro}from'../Nitro';import{AvatarAssetDownloadLibrary}from'./AvatarAssetDownloadLibrary';import{AvatarRenderEvent}from'./events/AvatarRenderEvent';import{AvatarRenderLibraryEvent}from'./events/AvatarRenderLibraryEvent';export var AvatarAssetDownloadManager=/*#__PURE__*/function(_EventDispatcher){_inherits(AvatarAssetDownloadManager,_EventDispatcher);var _super=_createSuper(AvatarAssetDownloadManager);function AvatarAssetDownloadManager(assets,structure){var _this;_classCallCheck(this,AvatarAssetDownloadManager);_this=_super.call(this);_this._assets=void 0;_this._structure=void 0;_this._missingMandatoryLibs=void 0;_this._figureMap=void 0;_this._pendingContainers=void 0;_this._figureListeners=void 0;_this._incompleteFigures=void 0;_this._pendingDownloadQueue=void 0;_this._currentDownloads=void 0;_this._libraryNames=void 0;_this._isReady=void 0;_this._assets=assets;_this._structure=structure;_this._missingMandatoryLibs=Nitro.instance.getConfiguration('avatar.mandatory.libraries');_this._figureMap=new Map();_this._pendingContainers=[];_this._figureListeners=new Map();_this._incompleteFigures=new Map();_this._pendingDownloadQueue=[];_this._currentDownloads=[];_this._libraryNames=[];_this._isReady=false;_this.onLibraryLoaded=_this.onLibraryLoaded.bind(_assertThisInitialized(_this));_this.onAvatarRenderReady=_this.onAvatarRenderReady.bind(_assertThisInitialized(_this));_this.loadFigureMap();_this._structure.renderManager.events.addEventListener(AvatarRenderEvent.AVATAR_RENDER_READY,_this.onAvatarRenderReady);return _this;}_createClass(AvatarAssetDownloadManager,[{key:\"loadFigureMap\",value:function loadFigureMap(){var _this2=this;var request=new XMLHttpRequest();try{request.open('GET',Nitro.instance.getConfiguration('avatar.figuremap.url'));request.send();request.onloadend=function(e){if(request.responseText){var data=JSON.parse(request.responseText);_this2.processFigureMap(data.libraries);_this2.processMissingLibraries();_this2._isReady=true;_this2.dispatchEvent(new NitroEvent(AvatarAssetDownloadManager.DOWNLOADER_READY));}};request.onerror=function(e){throw new Error('invalid_avatar_figure_map');};}catch(e){NitroLogger.log(e);}}},{key:\"processFigureMap\",value:function processFigureMap(data){if(!data)return;var _iterator=_createForOfIteratorHelper(data),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var library=_step.value;if(!library)continue;var id=library.id;var revision=library.revision||'';if(this._libraryNames.indexOf(id)>=0)continue;this._libraryNames.push(id);var downloadLibrary=new AvatarAssetDownloadLibrary(id,revision,this._assets,Nitro.instance.getConfiguration('avatar.asset.url'));downloadLibrary.addEventListener(AvatarRenderLibraryEvent.DOWNLOAD_COMPLETE,this.onLibraryLoaded);var _iterator2=_createForOfIteratorHelper(library.parts),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var part=_step2.value;var _id=part.id;var type=part.type;var partString=type+':'+_id;var existing=this._figureMap.get(partString);if(!existing)existing=[];existing.push(downloadLibrary);this._figureMap.set(partString,existing);}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}}catch(err){_iterator.e(err);}finally{_iterator.f();}}},{key:\"onAvatarRenderReady\",value:function onAvatarRenderReady(event){if(!event)return;var _iterator3=_createForOfIteratorHelper(this._pendingContainers),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _step3$value=_slicedToArray(_step3.value,2),container=_step3$value[0],listener=_step3$value[1];this.downloadAvatarFigure(container,listener);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}this._pendingContainers=[];}},{key:\"onLibraryLoaded\",value:function onLibraryLoaded(event){if(!event||!event.library)return;var loadedFigures=[];var _iterator4=_createForOfIteratorHelper(this._incompleteFigures.entries()),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _step4$value=_slicedToArray(_step4.value,2),_figure=_step4$value[0],libraries=_step4$value[1];var isReady=true;var _iterator5=_createForOfIteratorHelper(libraries),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var library=_step5.value;if(!library||library.isLoaded)continue;isReady=false;break;}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}if(isReady){loadedFigures.push(_figure);var listeners=this._figureListeners.get(_figure);if(listeners){var _iterator6=_createForOfIteratorHelper(listeners),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var listener=_step6.value;if(!listener||listener.disposed)continue;listener.resetFigure(_figure);}}catch(err){_iterator6.e(err);}finally{_iterator6.f();}}this._figureListeners.delete(_figure);this.dispatchEvent(new NitroEvent(AvatarAssetDownloadManager.LIBRARY_LOADED));}}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}for(var _i=0,_loadedFigures=loadedFigures;_i<_loadedFigures.length;_i++){var figure=_loadedFigures[_i];if(!figure)continue;this._incompleteFigures.delete(figure);}var index=0;while(index<this._currentDownloads.length){var download=this._currentDownloads[index];if(download){if(download.libraryName===event.library.libraryName)this._currentDownloads.splice(index,1);}index++;}}},{key:\"processMissingLibraries\",value:function processMissingLibraries(){var libraries=this._missingMandatoryLibs.slice();var _iterator7=_createForOfIteratorHelper(libraries),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var library=_step7.value;if(!library)continue;var map=this._figureMap.get(library);if(map){var _iterator8=_createForOfIteratorHelper(map),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var avatar=_step8.value;avatar&&this.downloadLibrary(avatar);}}catch(err){_iterator8.e(err);}finally{_iterator8.f();}}}}catch(err){_iterator7.e(err);}finally{_iterator7.f();}}},{key:\"isAvatarFigureContainerReady\",value:function isAvatarFigureContainerReady(container){if(!this._isReady||!this._structure.renderManager.isReady){return false;}var pendingLibraries=this.getAvatarFigurePendingLibraries(container);return!pendingLibraries.length;}},{key:\"getAvatarFigurePendingLibraries\",value:function getAvatarFigurePendingLibraries(container){var pendingLibraries=[];if(!container||!this._structure)return pendingLibraries;var figureData=this._structure.figureData;if(!figureData)return pendingLibraries;var setKeys=container.getPartTypeIds();var _iterator9=_createForOfIteratorHelper(setKeys),_step9;try{for(_iterator9.s();!(_step9=_iterator9.n()).done;){var key=_step9.value;var set=figureData.getSetType(key);if(!set)continue;var figurePartSet=set.getPartSet(container.getPartSetId(key));if(!figurePartSet)continue;var _iterator10=_createForOfIteratorHelper(figurePartSet.parts),_step10;try{for(_iterator10.s();!(_step10=_iterator10.n()).done;){var part=_step10.value;if(!part)continue;var name=part.type+':'+part.id;var existing=this._figureMap.get(name);if(existing===undefined)continue;var _iterator11=_createForOfIteratorHelper(existing),_step11;try{for(_iterator11.s();!(_step11=_iterator11.n()).done;){var library=_step11.value;if(!library||library.isLoaded)continue;if(pendingLibraries.indexOf(library)>=0)continue;pendingLibraries.push(library);}}catch(err){_iterator11.e(err);}finally{_iterator11.f();}}}catch(err){_iterator10.e(err);}finally{_iterator10.f();}}}catch(err){_iterator9.e(err);}finally{_iterator9.f();}return pendingLibraries;}},{key:\"downloadAvatarFigure\",value:function downloadAvatarFigure(container,listener){if(!this._isReady||!this._structure.renderManager.isReady){this._pendingContainers.push([container,listener]);return;}var figure=container.getFigureString();var pendingLibraries=this.getAvatarFigurePendingLibraries(container);if(pendingLibraries&&pendingLibraries.length){if(listener&&!listener.disposed){var listeners=this._figureListeners.get(figure);if(!listeners){listeners=[];this._figureListeners.set(figure,listeners);}listeners.push(listener);}this._incompleteFigures.set(figure,pendingLibraries);var _iterator12=_createForOfIteratorHelper(pendingLibraries),_step12;try{for(_iterator12.s();!(_step12=_iterator12.n()).done;){var library=_step12.value;if(!library)continue;this.downloadLibrary(library);}}catch(err){_iterator12.e(err);}finally{_iterator12.f();}}else{if(listener&&!listener.disposed)listener.resetFigure(figure);}}},{key:\"downloadLibrary\",value:function downloadLibrary(library){if(!library||library.isLoaded)return;if(this._pendingDownloadQueue.indexOf(library)>=0||this._currentDownloads.indexOf(library)>=0)return;this._pendingDownloadQueue.push(library);this.processDownloadQueue();}},{key:\"processDownloadQueue\",value:function processDownloadQueue(){while(this._pendingDownloadQueue.length){var library=this._pendingDownloadQueue[0];library.downloadAsset();this._currentDownloads.push(this._pendingDownloadQueue.shift());}}}]);return AvatarAssetDownloadManager;}(EventDispatcher);AvatarAssetDownloadManager.DOWNLOADER_READY='AADM_DOWNLOADER_READY';AvatarAssetDownloadManager.LIBRARY_LOADED='AADM_LIBRARY_LOADED';AvatarAssetDownloadManager.MAX_DOWNLOADS=2;","map":null,"metadata":{},"sourceType":"module"}