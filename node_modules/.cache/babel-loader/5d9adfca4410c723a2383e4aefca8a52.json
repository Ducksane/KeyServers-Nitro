{"ast":null,"code":"import _slicedToArray from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _createForOfIteratorHelper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _assertThisInitialized from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js\";import _inherits from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{NitroManager}from'../core/common/NitroManager';import{RoomContentLoader}from'../nitro/room/RoomContentLoader';import{RoomContentLoadedEvent}from'./events/RoomContentLoadedEvent';import{RoomInstance}from'./RoomInstance';import{RoomObjectManager}from'./RoomObjectManager';export var RoomManager=/*#__PURE__*/function(_NitroManager){_inherits(RoomManager,_NitroManager);var _super=_createSuper(RoomManager);function RoomManager(listener,visualizationFactory,logicFactory){var _this;_classCallCheck(this,RoomManager);_this=_super.call(this);_this._state=void 0;_this._rooms=void 0;_this._contentLoader=void 0;_this._updateCategories=void 0;_this._listener=void 0;_this._visualizationFactory=void 0;_this._logicFactory=void 0;_this._initialLoadList=void 0;_this._pendingContentTypes=void 0;_this._skipContentProcessing=void 0;_this._disposed=void 0;_this._state=RoomManager.ROOM_MANAGER_LOADED;_this._rooms=new Map();_this._contentLoader=null;_this._updateCategories=[];_this._listener=listener;_this._visualizationFactory=visualizationFactory;_this._logicFactory=logicFactory;_this._initialLoadList=[];_this._pendingContentTypes=[];_this._skipContentProcessing=false;_this._disposed=false;_this.onRoomContentLoadedEvent=_this.onRoomContentLoadedEvent.bind(_assertThisInitialized(_this));_this.events.addEventListener(RoomContentLoadedEvent.RCLE_SUCCESS,_this.onRoomContentLoadedEvent);_this.events.addEventListener(RoomContentLoadedEvent.RCLE_FAILURE,_this.onRoomContentLoadedEvent);_this.events.addEventListener(RoomContentLoadedEvent.RCLE_CANCEL,_this.onRoomContentLoadedEvent);return _this;}_createClass(RoomManager,[{key:\"onInit\",value:function onInit(){if(this._state>=RoomManager.ROOM_MANAGER_INITIALIZING||!this._contentLoader)return;var mandatoryLibraries=RoomContentLoader.MANDATORY_LIBRARIES;var _iterator=_createForOfIteratorHelper(mandatoryLibraries),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var library=_step.value;if(!library)continue;if(this._initialLoadList.indexOf(library)===-1){this._contentLoader.downloadAsset(library,this.events);this._initialLoadList.push(library);}}}catch(err){_iterator.e(err);}finally{_iterator.f();}this._state=RoomManager.ROOM_MANAGER_INITIALIZING;}},{key:\"getRoomInstance\",value:function getRoomInstance(roomId){var existing=this._rooms.get(roomId);if(!existing)return null;return existing;}},{key:\"createRoomInstance\",value:function createRoomInstance(roomId){if(this._rooms.get(roomId))return null;var instance=new RoomInstance(roomId,this);this._rooms.set(instance.id,instance);if(this._updateCategories.length){var _iterator2=_createForOfIteratorHelper(this._updateCategories),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var category=_step2.value;instance.addUpdateCategory(category);}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}return instance;}},{key:\"removeRoomInstance\",value:function removeRoomInstance(roomId){var existing=this._rooms.get(roomId);if(!existing)return false;this._rooms.delete(roomId);existing.dispose();return true;}},{key:\"createRoomObjectAndInitalize\",value:function createRoomObjectAndInitalize(roomId,objectId,type,category){var instance=this.getRoomInstance(roomId);if(!instance)return null;var visualization=type;var logic=type;var assetName=type;var asset=null;var isLoading=false;if(this._contentLoader.isLoaderType(type)){asset=this._contentLoader.getCollection(type);if(!asset){isLoading=true;this._contentLoader.downloadAsset(type,this.events);assetName=this._contentLoader.getPlaceholderName(type);asset=this._contentLoader.getCollection(assetName);if(!asset)return null;}visualization=asset.data.visualizationType;logic=asset.data.logicType;}var object=instance.createRoomObject(objectId,1,type,category);if(!object)return null;if(this._visualizationFactory){var visualizationInstance=this._visualizationFactory.getVisualization(visualization);if(!visualizationInstance){instance.removeRoomObject(objectId,category);return null;}visualizationInstance.asset=asset;var visualizationData=this._visualizationFactory.getVisualizationData(assetName,visualization,asset&&asset.data||null);if(!visualizationData||!visualizationInstance.initialize(visualizationData)){instance.removeRoomObject(objectId,category);return null;}object.setVisualization(visualizationInstance);}if(this._logicFactory){var logicInstance=this._logicFactory.getLogic(logic);object.setLogic(logicInstance);if(logicInstance){logicInstance.initialize(asset&&asset.data||null);}}if(!isLoading)object.isReady=true;this._contentLoader.setRoomObjectRoomId(object,roomId);return object;}},{key:\"reinitializeRoomObjectsByType\",value:function reinitializeRoomObjectsByType(type){if(!type||!this._contentLoader||!this._visualizationFactory||!this._logicFactory)return;var asset=this._contentLoader.getCollection(type);if(!asset)return;var visualization=asset.data.visualizationType;var logic=asset.data.logicType;var visualizationData=this._visualizationFactory.getVisualizationData(type,visualization,asset.data);var _iterator3=_createForOfIteratorHelper(this._rooms.values()),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var room=_step3.value;if(!room)continue;var _iterator4=_createForOfIteratorHelper(room.managers.entries()),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _step4$value=_slicedToArray(_step4.value,2),category=_step4$value[0],manager=_step4$value[1];if(!manager)continue;var _iterator5=_createForOfIteratorHelper(manager.objects.getValues()),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var object=_step5.value;if(!object||object.type!==type)continue;var visualizationInstance=this._visualizationFactory.getVisualization(visualization);if(visualizationInstance){visualizationInstance.asset=asset;if(!visualizationData||!visualizationInstance.initialize(visualizationData)){manager.removeObject(object.id);}else{object.setVisualization(visualizationInstance);var logicInstance=this._logicFactory.getLogic(logic);object.setLogic(logicInstance);if(logicInstance){logicInstance.initialize(asset.data);}object.isReady=true;if(this._listener)this._listener.objectInitialized(room.id,object.id,category);}}else{manager.removeObject(object.id);}}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}}},{key:\"addUpdateCategory\",value:function addUpdateCategory(category){var index=this._updateCategories.indexOf(category);if(index>=0)return;this._updateCategories.push(category);if(!this._rooms.size)return;var _iterator6=_createForOfIteratorHelper(this._rooms.values()),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var room=_step6.value;if(!room)continue;room.addUpdateCategory(category);}}catch(err){_iterator6.e(err);}finally{_iterator6.f();}}},{key:\"removeUpdateCategory\",value:function removeUpdateCategory(category){var index=this._updateCategories.indexOf(category);if(index===-1)return;this._updateCategories.splice(index,1);if(!this._rooms.size)return;var _iterator7=_createForOfIteratorHelper(this._rooms.values()),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var room=_step7.value;if(!room)continue;room.removeUpdateCategory(category);}}catch(err){_iterator7.e(err);}finally{_iterator7.f();}}},{key:\"setContentLoader\",value:function setContentLoader(loader){if(this._contentLoader)this._contentLoader.dispose();this._contentLoader=loader;}},{key:\"processPendingContentTypes\",value:function processPendingContentTypes(time){if(this._skipContentProcessing){this._skipContentProcessing=false;return;}while(this._pendingContentTypes.length){var type=this._pendingContentTypes.shift();var collection=this._contentLoader.getCollection(type);if(!collection){if(this._listener){this._listener.initalizeTemporaryObjectsByType(type,false);}this.logger.log(\"Invalid Collection: \".concat(type));continue;}this.reinitializeRoomObjectsByType(type);if(this._listener)this._listener.initalizeTemporaryObjectsByType(type,true);if(this._initialLoadList.length>0)this.removeFromInitialLoad(type);}}},{key:\"removeFromInitialLoad\",value:function removeFromInitialLoad(type){if(!type||this._state===RoomManager.ROOM_MANAGER_ERROR)return;if(!this._contentLoader)this._state=RoomManager.ROOM_MANAGER_ERROR;if(this._contentLoader.getCollection(type)){var i=this._initialLoadList.indexOf(type);if(i>=0)this._initialLoadList.splice(i,1);if(!this._initialLoadList.length){this._state=RoomManager.ROOM_MANAGER_INITIALIZED;if(this._listener){this._listener.onRoomEngineInitalized(true);}}}else{this._state=RoomManager.ROOM_MANAGER_ERROR;if(this._listener)this._listener.onRoomEngineInitalized(false);}}},{key:\"onRoomContentLoadedEvent\",value:function onRoomContentLoadedEvent(event){if(!this._contentLoader)return;var contentType=event.contentType;if(this._pendingContentTypes.indexOf(contentType)>=0)return;this._pendingContentTypes.push(contentType);}},{key:\"update\",value:function update(time){var _update=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;this.processPendingContentTypes(time);if(!this._rooms.size)return;var _iterator8=_createForOfIteratorHelper(this._rooms.values()),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var room=_step8.value;room&&room.update(time,_update);}}catch(err){_iterator8.e(err);}finally{_iterator8.f();}}},{key:\"createRoomObjectManager\",value:function createRoomObjectManager(category){return new RoomObjectManager();}},{key:\"rooms\",get:function get(){return this._rooms;}},{key:\"disposed\",get:function get(){return this._disposed;}}]);return RoomManager;}(NitroManager);RoomManager.ROOM_MANAGER_ERROR=-1;RoomManager.ROOM_MANAGER_LOADING=0;RoomManager.ROOM_MANAGER_LOADED=1;RoomManager.ROOM_MANAGER_INITIALIZING=2;RoomManager.ROOM_MANAGER_INITIALIZED=3;RoomManager.CONTENT_PROCESSING_TIME_LIMIT_MILLISECONDS=40;","map":null,"metadata":{},"sourceType":"module"}