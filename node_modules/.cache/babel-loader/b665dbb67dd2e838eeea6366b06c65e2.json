{"ast":null,"code":"import _slicedToArray from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{GetGuestRoomResultEvent,RoomSessionChatEvent,RoomSessionEvent}from'@nitrots/nitro-renderer';import{useCallback,useState}from'react';import{GetRoomSession}from'../../api';import{UseMessageEventHook,UseRoomSessionManagerEvent}from'../../hooks';import{useChatHistoryContext}from'./ChatHistoryContext';import{ChatEntryType}from'./common/ChatEntryType';import{currentDate}from'./common/Utilities';var CHAT_HISTORY_MAX=1000;var ROOM_HISTORY_MAX=10;export var ChatHistoryMessageHandler=function ChatHistoryMessageHandler(props){var _useChatHistoryContex=useChatHistoryContext(),_useChatHistoryContex2=_useChatHistoryContex.chatHistoryState,chatHistoryState=_useChatHistoryContex2===void 0?null:_useChatHistoryContex2,_useChatHistoryContex3=_useChatHistoryContex.roomHistoryState,roomHistoryState=_useChatHistoryContex3===void 0?null:_useChatHistoryContex3;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),needsRoomInsert=_useState2[0],setNeedsRoomInsert=_useState2[1];var addChatEntry=useCallback(function(entry){entry.id=chatHistoryState.chats.length;chatHistoryState.chats.push(entry);//check for overflow\nif(chatHistoryState.chats.length>CHAT_HISTORY_MAX){chatHistoryState.chats.shift();}chatHistoryState.notify();//dispatchUiEvent(new ChatHistoryEvent(ChatHistoryEvent.CHAT_HISTORY_CHANGED));\n},[chatHistoryState]);var addRoomHistoryEntry=useCallback(function(entry){roomHistoryState.roomHistory.push(entry);// check for overflow\nif(roomHistoryState.roomHistory.length>ROOM_HISTORY_MAX){roomHistoryState.roomHistory.shift();}roomHistoryState.notify();},[roomHistoryState]);var onChatEvent=useCallback(function(event){var roomSession=GetRoomSession();if(!roomSession)return;var userData=roomSession.userDataManager.getUserDataByIndex(event.objectId);if(!userData)return;var timeString=currentDate();var entry={id:-1,entityId:userData.webID,name:userData.name,look:userData.figure,entityType:userData.type,message:event.message,timestamp:timeString,type:ChatEntryType.TYPE_CHAT,roomId:roomSession.roomId};addChatEntry(entry);},[addChatEntry]);UseRoomSessionManagerEvent(RoomSessionChatEvent.CHAT_EVENT,onChatEvent);var onRoomSessionEvent=useCallback(function(event){switch(event.type){case RoomSessionEvent.STARTED:setNeedsRoomInsert(true);break;case RoomSessionEvent.ENDED://dispatchUiEvent(new ChatHistoryEvent(ChatHistoryEvent.HIDE_CHAT_HISTORY));\nbreak;}},[]);UseRoomSessionManagerEvent(RoomSessionEvent.ENDED,onRoomSessionEvent);UseRoomSessionManagerEvent(RoomSessionEvent.STARTED,onRoomSessionEvent);var onGetGuestRoomResultEvent=useCallback(function(event){var parser=event.getParser();if(!parser)return;var session=GetRoomSession();if(!session||session.roomId!==parser.data.roomId)return;if(needsRoomInsert){var chatEntry={id:-1,entityId:parser.data.roomId,name:parser.data.roomName,timestamp:currentDate(),type:ChatEntryType.TYPE_ROOM_INFO,roomId:parser.data.roomId};addChatEntry(chatEntry);var roomEntry={id:parser.data.roomId,name:parser.data.roomName};addRoomHistoryEntry(roomEntry);setNeedsRoomInsert(false);}},[addChatEntry,addRoomHistoryEntry,needsRoomInsert]);UseMessageEventHook(GetGuestRoomResultEvent,onGetGuestRoomResultEvent);return null;};","map":null,"metadata":{},"sourceType":"module"}