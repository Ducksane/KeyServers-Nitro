{"ast":null,"code":"import _createForOfIteratorHelper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _get from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/get.js\";import _getPrototypeOf from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js\";import _inherits from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{Disposable}from'../../core/common/disposable/Disposable';import{Vector3d}from'../../room/utils/Vector3d';import{AvatarGuideStatus}from'../avatar/enum/AvatarGuideStatus';import{PetType}from'../avatar/pets/PetType';import{ObjectsDataUpdateEvent,PetExperienceEvent}from'../communication';import{GuideSessionEndedMessageEvent}from'../communication/messages/incoming/help/GuideSessionEndedMessageEvent';import{GuideSessionErrorMessageEvent}from'../communication/messages/incoming/help/GuideSessionErrorMessageEvent';import{GuideSessionStartedMessageEvent}from'../communication/messages/incoming/help/GuideSessionStartedMessageEvent';import{ObjectsRollingEvent}from'../communication/messages/incoming/room/engine/ObjectsRollingEvent';import{DiceValueMessageEvent}from'../communication/messages/incoming/room/furniture/DiceValueMessageEvent';import{FurnitureFloorAddEvent}from'../communication/messages/incoming/room/furniture/floor/FurnitureFloorAddEvent';import{FurnitureFloorEvent}from'../communication/messages/incoming/room/furniture/floor/FurnitureFloorEvent';import{FurnitureFloorRemoveEvent}from'../communication/messages/incoming/room/furniture/floor/FurnitureFloorRemoveEvent';import{FurnitureFloorUpdateEvent}from'../communication/messages/incoming/room/furniture/floor/FurnitureFloorUpdateEvent';import{FurnitureAliasesEvent}from'../communication/messages/incoming/room/furniture/FurnitureAliasesEvent';import{FurnitureDataEvent}from'../communication/messages/incoming/room/furniture/FurnitureDataEvent';import{ItemDataUpdateMessageEvent}from'../communication/messages/incoming/room/furniture/ItemDataUpdateMessageEvent';import{OneWayDoorStatusMessageEvent}from'../communication/messages/incoming/room/furniture/OneWayDoorStatusMessageEvent';import{FurnitureWallAddEvent}from'../communication/messages/incoming/room/furniture/wall/FurnitureWallAddEvent';import{FurnitureWallEvent}from'../communication/messages/incoming/room/furniture/wall/FurnitureWallEvent';import{FurnitureWallRemoveEvent}from'../communication/messages/incoming/room/furniture/wall/FurnitureWallRemoveEvent';import{FurnitureWallUpdateEvent}from'../communication/messages/incoming/room/furniture/wall/FurnitureWallUpdateEvent';import{FloorHeightMapEvent}from'../communication/messages/incoming/room/mapping/FloorHeightMapEvent';import{RoomEntryTileMessageEvent}from'../communication/messages/incoming/room/mapping/RoomEntryTileMessageEvent';import{RoomHeightMapEvent}from'../communication/messages/incoming/room/mapping/RoomHeightMapEvent';import{RoomHeightMapUpdateEvent}from'../communication/messages/incoming/room/mapping/RoomHeightMapUpdateEvent';import{RoomPaintEvent}from'../communication/messages/incoming/room/mapping/RoomPaintEvent';import{RoomReadyMessageEvent}from'../communication/messages/incoming/room/mapping/RoomReadyMessageEvent';import{RoomVisualizationSettingsEvent}from'../communication/messages/incoming/room/mapping/RoomVisualizationSettingsEvent';import{PetFigureUpdateEvent}from'../communication/messages/incoming/room/pet/PetFigureUpdateEvent';import{YouArePlayingGameEvent}from'../communication/messages/incoming/room/session/YouArePlayingGameEvent';import{RoomUnitChatEvent}from'../communication/messages/incoming/room/unit/chat/RoomUnitChatEvent';import{RoomUnitChatShoutEvent}from'../communication/messages/incoming/room/unit/chat/RoomUnitChatShoutEvent';import{RoomUnitChatWhisperEvent}from'../communication/messages/incoming/room/unit/chat/RoomUnitChatWhisperEvent';import{RoomUnitTypingEvent}from'../communication/messages/incoming/room/unit/chat/RoomUnitTypingEvent';import{RoomUnitDanceEvent}from'../communication/messages/incoming/room/unit/RoomUnitDanceEvent';import{RoomUnitEffectEvent}from'../communication/messages/incoming/room/unit/RoomUnitEffectEvent';import{RoomUnitEvent}from'../communication/messages/incoming/room/unit/RoomUnitEvent';import{RoomUnitExpressionEvent}from'../communication/messages/incoming/room/unit/RoomUnitExpressionEvent';import{RoomUnitHandItemEvent}from'../communication/messages/incoming/room/unit/RoomUnitHandItemEvent';import{RoomUnitIdleEvent}from'../communication/messages/incoming/room/unit/RoomUnitIdleEvent';import{RoomUnitInfoEvent}from'../communication/messages/incoming/room/unit/RoomUnitInfoEvent';import{RoomUnitNumberEvent}from'../communication/messages/incoming/room/unit/RoomUnitNumberEvent';import{RoomUnitRemoveEvent}from'../communication/messages/incoming/room/unit/RoomUnitRemoveEvent';import{RoomUnitStatusEvent}from'../communication/messages/incoming/room/unit/RoomUnitStatusEvent';import{UserInfoEvent}from'../communication/messages/incoming/user/data/UserInfoEvent';import{IgnoreResultEvent}from'../communication/messages/incoming/user/IgnoreResultEvent';import{FurnitureAliasesComposer}from'../communication/messages/outgoing/room/furniture/FurnitureAliasesComposer';import{GetRoomEntryDataMessageComposer}from'../communication/messages/outgoing/room/layout/GetRoomEntryDataMessageComposer';import{RoomObjectType}from'../room/object/RoomObjectType';import{LegacyDataType}from'./object/data/type/LegacyDataType';import{RoomObjectUserType}from'./object/RoomObjectUserType';import{RoomObjectVariable}from'./object/RoomObjectVariable';import{RoomPlaneParser}from'./object/RoomPlaneParser';import{RoomVariableEnum}from'./RoomVariableEnum';import{FurnitureStackingHeightMap}from'./utils/FurnitureStackingHeightMap';import{LegacyWallGeometry}from'./utils/LegacyWallGeometry';import{ObjectRolling}from'./utils/ObjectRolling';export var RoomMessageHandler=/*#__PURE__*/function(_Disposable){_inherits(RoomMessageHandler,_Disposable);var _super=_createSuper(RoomMessageHandler);function RoomMessageHandler(roomCreator){var _this;_classCallCheck(this,RoomMessageHandler);_this=_super.call(this);_this._connection=void 0;_this._roomCreator=void 0;_this._planeParser=void 0;_this._latestEntryTileEvent=void 0;_this._currentRoomId=void 0;_this._ownUserId=void 0;_this._initialConnection=void 0;_this._guideId=void 0;_this._requesterId=void 0;_this._connection=null;_this._roomCreator=roomCreator;_this._planeParser=new RoomPlaneParser();_this._latestEntryTileEvent=null;_this._currentRoomId=0;_this._ownUserId=0;_this._initialConnection=true;_this._guideId=-1;_this._requesterId=-1;return _this;}_createClass(RoomMessageHandler,[{key:\"onDispose\",value:function onDispose(){_get(_getPrototypeOf(RoomMessageHandler.prototype),\"onDispose\",this).call(this);this._connection=null;this._roomCreator=null;this._latestEntryTileEvent=null;if(this._planeParser){this._planeParser.dispose();this._planeParser=null;}}},{key:\"setConnection\",value:function setConnection(connection){if(this._connection||!connection)return;this._connection=connection;this._connection.addMessageEvent(new UserInfoEvent(this.onUserInfoEvent.bind(this)));this._connection.addMessageEvent(new RoomReadyMessageEvent(this.onRoomReadyMessageEvent.bind(this)));this._connection.addMessageEvent(new RoomPaintEvent(this.onRoomPaintEvent.bind(this)));this._connection.addMessageEvent(new FloorHeightMapEvent(this.onRoomModelEvent.bind(this)));this._connection.addMessageEvent(new RoomHeightMapEvent(this.onRoomHeightMapEvent.bind(this)));this._connection.addMessageEvent(new RoomHeightMapUpdateEvent(this.onRoomHeightMapUpdateEvent.bind(this)));this._connection.addMessageEvent(new RoomVisualizationSettingsEvent(this.onRoomThicknessEvent.bind(this)));this._connection.addMessageEvent(new RoomEntryTileMessageEvent(this.onRoomDoorEvent.bind(this)));this._connection.addMessageEvent(new ObjectsRollingEvent(this.onRoomRollingEvent.bind(this)));this._connection.addMessageEvent(new ObjectsDataUpdateEvent(this.onObjectsDataUpdateEvent.bind(this)));this._connection.addMessageEvent(new FurnitureAliasesEvent(this.onFurnitureAliasesEvent.bind(this)));this._connection.addMessageEvent(new FurnitureFloorAddEvent(this.onFurnitureFloorAddEvent.bind(this)));this._connection.addMessageEvent(new FurnitureFloorEvent(this.onFurnitureFloorEvent.bind(this)));this._connection.addMessageEvent(new FurnitureFloorRemoveEvent(this.onFurnitureFloorRemoveEvent.bind(this)));this._connection.addMessageEvent(new FurnitureFloorUpdateEvent(this.onFurnitureFloorUpdateEvent.bind(this)));this._connection.addMessageEvent(new FurnitureWallAddEvent(this.onFurnitureWallAddEvent.bind(this)));this._connection.addMessageEvent(new FurnitureWallEvent(this.onFurnitureWallEvent.bind(this)));this._connection.addMessageEvent(new FurnitureWallRemoveEvent(this.onFurnitureWallRemoveEvent.bind(this)));this._connection.addMessageEvent(new FurnitureWallUpdateEvent(this.onFurnitureWallUpdateEvent.bind(this)));this._connection.addMessageEvent(new FurnitureDataEvent(this.onFurnitureDataEvent.bind(this)));this._connection.addMessageEvent(new ItemDataUpdateMessageEvent(this.onItemDataUpdateMessageEvent.bind(this)));this._connection.addMessageEvent(new OneWayDoorStatusMessageEvent(this.onOneWayDoorStatusMessageEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitDanceEvent(this.onRoomUnitDanceEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitEffectEvent(this.onRoomUnitEffectEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitEvent(this.onRoomUnitEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitExpressionEvent(this.onRoomUnitExpressionEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitHandItemEvent(this.onRoomUnitHandItemEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitIdleEvent(this.onRoomUnitIdleEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitInfoEvent(this.onRoomUnitInfoEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitNumberEvent(this.onRoomUnitNumberEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitRemoveEvent(this.onRoomUnitRemoveEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitStatusEvent(this.onRoomUnitStatusEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitChatEvent(this.onRoomUnitChatEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitChatShoutEvent(this.onRoomUnitChatEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitChatWhisperEvent(this.onRoomUnitChatEvent.bind(this)));this._connection.addMessageEvent(new RoomUnitTypingEvent(this.onRoomUnitTypingEvent.bind(this)));this._connection.addMessageEvent(new PetFigureUpdateEvent(this.onPetFigureUpdateEvent.bind(this)));this._connection.addMessageEvent(new PetExperienceEvent(this.onPetExperienceEvent.bind(this)));this._connection.addMessageEvent(new YouArePlayingGameEvent(this.onYouArePlayingGameEvent.bind(this)));this._connection.addMessageEvent(new DiceValueMessageEvent(this.onDiceValueMessageEvent.bind(this)));this._connection.addMessageEvent(new IgnoreResultEvent(this.onIgnoreResultEvent.bind(this)));this._connection.addMessageEvent(new GuideSessionStartedMessageEvent(this.onGuideSessionStartedMessageEvent.bind(this)));this._connection.addMessageEvent(new GuideSessionEndedMessageEvent(this.onGuideSessionEndedMessageEvent.bind(this)));this._connection.addMessageEvent(new GuideSessionErrorMessageEvent(this.onGuideSessionErrorMessageEvent.bind(this)));}},{key:\"setRoomId\",value:function setRoomId(id){if(this._currentRoomId!==0){if(this._roomCreator)this._roomCreator.destroyRoom(this._currentRoomId);}this._currentRoomId=id;this._latestEntryTileEvent=null;}},{key:\"clearRoomId\",value:function clearRoomId(){this._currentRoomId=0;this._latestEntryTileEvent=null;}},{key:\"onUserInfoEvent\",value:function onUserInfoEvent(event){if(!(event instanceof UserInfoEvent)||!event.connection)return;var parser=event.getParser();if(!parser)return;this._ownUserId=parser.userInfo.userId;}},{key:\"onRoomReadyMessageEvent\",value:function onRoomReadyMessageEvent(event){var parser=event.getParser();if(this._currentRoomId!==parser.roomId){this.setRoomId(parser.roomId);}if(this._roomCreator){this._roomCreator.setRoomInstanceModelName(parser.roomId,parser.name);}if(this._initialConnection){event.connection.send(new FurnitureAliasesComposer());this._initialConnection=false;return;}event.connection.send(new GetRoomEntryDataMessageComposer());}},{key:\"onRoomPaintEvent\",value:function onRoomPaintEvent(event){if(!(event instanceof RoomPaintEvent))return;var parser=event.getParser();if(!parser)return;var floorType=parser.floorType;var wallType=parser.wallType;var landscapeType=parser.landscapeType;if(this._roomCreator){this._roomCreator.updateRoomInstancePlaneType(this._currentRoomId,floorType,wallType,landscapeType);}}},{key:\"onRoomModelEvent\",value:function onRoomModelEvent(event){if(!(event instanceof FloorHeightMapEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;var wallGeometry=this._roomCreator.getLegacyWallGeometry(this._currentRoomId);if(!wallGeometry)return;this._planeParser.reset();var width=parser.width;var height=parser.height;this._planeParser.initializeTileMap(width,height);var entryTile=null;if(this._latestEntryTileEvent)entryTile=this._latestEntryTileEvent.getParser();var doorX=-1;var doorY=-1;var doorZ=0;var doorDirection=0;var y=0;while(y<height){var x=0;while(x<width){var tileHeight=parser.getHeight(x,y);if((y>0&&y<height-1||x>0&&x<width-1)&&!(tileHeight==RoomPlaneParser.TILE_BLOCKED)&&(entryTile==null||x==entryTile.x&&y==entryTile.y)){if(parser.getHeight(x,y-1)==RoomPlaneParser.TILE_BLOCKED&&parser.getHeight(x-1,y)==RoomPlaneParser.TILE_BLOCKED&&parser.getHeight(x,y+1)==RoomPlaneParser.TILE_BLOCKED){doorX=x+0.5;doorY=y;doorZ=tileHeight;doorDirection=90;}if(parser.getHeight(x,y-1)==RoomPlaneParser.TILE_BLOCKED&&parser.getHeight(x-1,y)==RoomPlaneParser.TILE_BLOCKED&&parser.getHeight(x+1,y)==RoomPlaneParser.TILE_BLOCKED){doorX=x;doorY=y+0.5;doorZ=tileHeight;doorDirection=180;}}this._planeParser.setTileHeight(x,y,tileHeight);x++;}y++;}this._planeParser.setTileHeight(Math.floor(doorX),Math.floor(doorY),doorZ);this._planeParser.initializeFromTileData(parser.wallHeight);this._planeParser.setTileHeight(Math.floor(doorX),Math.floor(doorY),doorZ+this._planeParser.wallHeight);if(parser.scale===64){this._planeParser.restrictsDragging=true;this._planeParser.restrictsScaling=true;this._planeParser.restrictedScale=0.5;}else{this._planeParser.restrictsDragging=false;this._planeParser.restrictsScaling=false;this._planeParser.restrictedScale=1;}wallGeometry.scale=LegacyWallGeometry.DEFAULT_SCALE;wallGeometry.initialize(width,height,this._planeParser.floorHeight);var heightIterator=parser.height-1;while(heightIterator>=0){var widthIterator=parser.width-1;while(widthIterator>=0){wallGeometry.setHeight(widthIterator,heightIterator,this._planeParser.getTileHeight(widthIterator,heightIterator));widthIterator--;}heightIterator--;}var roomMap=this._planeParser.getMapData();roomMap.doors.push({x:doorX,y:doorY,z:doorZ,dir:doorDirection});this._roomCreator.createRoomInstance(this._currentRoomId,roomMap);}},{key:\"onRoomHeightMapEvent\",value:function onRoomHeightMapEvent(event){if(!(event instanceof RoomHeightMapEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;var width=parser.width;var height=parser.height;var heightMap=new FurnitureStackingHeightMap(width,height);var y=0;while(y<height){var x=0;while(x<width){heightMap.setTileHeight(x,y,parser.getTileHeight(x,y));heightMap.setStackingBlocked(x,y,parser.getStackingBlocked(x,y));heightMap.setIsRoomTile(x,y,parser.isRoomTile(x,y));x++;}y++;}this._roomCreator.setFurnitureStackingHeightMap(this._currentRoomId,heightMap);}},{key:\"onRoomHeightMapUpdateEvent\",value:function onRoomHeightMapUpdateEvent(event){if(!(event instanceof RoomHeightMapUpdateEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;var heightMap=this._roomCreator.getFurnitureStackingHeightMap(this._currentRoomId);if(!heightMap)return;while(parser.next()){heightMap.setTileHeight(parser.x,parser.y,parser.tileHeight());heightMap.setStackingBlocked(parser.x,parser.y,parser.isStackingBlocked());heightMap.setIsRoomTile(parser.x,parser.y,parser.isRoomTile());}this._roomCreator.refreshTileObjectMap(this._currentRoomId,'RoomMessageHandler.onRoomHeightMapUpdateEvent()');}},{key:\"onRoomThicknessEvent\",value:function onRoomThicknessEvent(event){if(!(event instanceof RoomVisualizationSettingsEvent))return;var parser=event.getParser();if(!parser)return;var visibleWall=!parser.hideWalls;var visibleFloor=true;var thicknessWall=parser.thicknessWall;var thicknessFloor=parser.thicknessFloor;if(this._roomCreator){this._roomCreator.updateRoomInstancePlaneVisibility(this._currentRoomId,visibleWall,visibleFloor);this._roomCreator.updateRoomInstancePlaneThickness(this._currentRoomId,thicknessWall,thicknessFloor);}}},{key:\"onRoomDoorEvent\",value:function onRoomDoorEvent(event){if(!(event instanceof RoomEntryTileMessageEvent))return;this._latestEntryTileEvent=event;}},{key:\"onRoomRollingEvent\",value:function onRoomRollingEvent(event){if(!(event instanceof ObjectsRollingEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();this._roomCreator.updateRoomObjectFloor(this._currentRoomId,parser.rollerId,null,null,1,null);this._roomCreator.updateRoomObjectFloor(this._currentRoomId,parser.rollerId,null,null,2,null);var furnitureRolling=parser.itemsRolling;if(furnitureRolling&&furnitureRolling.length){var _iterator=_createForOfIteratorHelper(furnitureRolling),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var rollData=_step.value;if(!rollData)continue;this._roomCreator.rollRoomObjectFloor(this._currentRoomId,rollData.id,rollData.location,rollData.targetLocation);}}catch(err){_iterator.e(err);}finally{_iterator.f();}}var unitRollData=parser.unitRolling;if(unitRollData){this._roomCreator.updateRoomObjectUserLocation(this._currentRoomId,unitRollData.id,unitRollData.location,unitRollData.targetLocation);var object=this._roomCreator.getRoomObjectUser(this._currentRoomId,unitRollData.id);if(object&&object.type!==RoomObjectUserType.MONSTER_PLANT){var posture='std';switch(unitRollData.movementType){case ObjectRolling.MOVE:posture='mv';break;case ObjectRolling.SLIDE:posture='std';break;}this._roomCreator.updateRoomObjectUserPosture(this._currentRoomId,unitRollData.id,posture);}}}},{key:\"onObjectsDataUpdateEvent\",value:function onObjectsDataUpdateEvent(event){if(!(event instanceof ObjectsDataUpdateEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;var _iterator2=_createForOfIteratorHelper(parser.objects),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var object=_step2.value;this._roomCreator.updateRoomObjectFloor(this._currentRoomId,object.id,null,null,object.state,object.data);}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}},{key:\"onFurnitureAliasesEvent\",value:function onFurnitureAliasesEvent(event){if(!(event instanceof FurnitureAliasesEvent)||!event.connection||!this._roomCreator)return;var alises=event.getParser().aliases;this._connection.send(new GetRoomEntryDataMessageComposer());}},{key:\"onFurnitureFloorAddEvent\",value:function onFurnitureFloorAddEvent(event){if(!(event instanceof FurnitureFloorAddEvent)||!event.connection||!this._roomCreator)return;var item=event.getParser().item;if(!item)return;this.addRoomObjectFurnitureFloor(this._currentRoomId,item);}},{key:\"onFurnitureFloorEvent\",value:function onFurnitureFloorEvent(event){if(!(event instanceof FurnitureFloorEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;var totalObjects=parser.items.length;var iterator=0;while(iterator<totalObjects){var object=parser.items[iterator];if(object)this.addRoomObjectFurnitureFloor(this._currentRoomId,object);iterator++;}}},{key:\"onFurnitureFloorRemoveEvent\",value:function onFurnitureFloorRemoveEvent(event){var _this2=this;if(!(event instanceof FurnitureFloorRemoveEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;if(parser.delay>0){setTimeout(function(){_this2._roomCreator.removeRoomObjectFloor(_this2._currentRoomId,parser.itemId,parser.isExpired?-1:parser.userId,true);},parser.delay);}else{this._roomCreator.removeRoomObjectFloor(this._currentRoomId,parser.itemId,parser.isExpired?-1:parser.userId,true);}}},{key:\"onFurnitureFloorUpdateEvent\",value:function onFurnitureFloorUpdateEvent(event){if(!(event instanceof FurnitureFloorUpdateEvent)||!event.connection||!this._roomCreator)return;var item=event.getParser().item;if(!item)return;var location=new Vector3d(item.x,item.y,item.z);var direction=new Vector3d(item.direction);this._roomCreator.updateRoomObjectFloor(this._currentRoomId,item.itemId,location,direction,item.data.state,item.data,item.extra);this._roomCreator.updateRoomObjectFloorHeight(this._currentRoomId,item.itemId,item.stackHeight);this._roomCreator.updateRoomObjectFloorExpiration(this._currentRoomId,item.itemId,item.expires);}},{key:\"onFurnitureWallAddEvent\",value:function onFurnitureWallAddEvent(event){if(!(event instanceof FurnitureWallAddEvent)||!event.connection||!this._roomCreator)return;var data=event.getParser().item;if(!data)return;this.addRoomObjectFurnitureWall(this._currentRoomId,data);}},{key:\"onFurnitureWallEvent\",value:function onFurnitureWallEvent(event){if(!(event instanceof FurnitureWallEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;var totalObjects=parser.items.length;var iterator=0;while(iterator<totalObjects){var data=parser.items[iterator];if(data)this.addRoomObjectFurnitureWall(this._currentRoomId,data);iterator++;}}},{key:\"onFurnitureWallRemoveEvent\",value:function onFurnitureWallRemoveEvent(event){if(!(event instanceof FurnitureWallRemoveEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;this._roomCreator.removeRoomObjectWall(this._currentRoomId,parser.itemId,parser.userId);}},{key:\"onFurnitureWallUpdateEvent\",value:function onFurnitureWallUpdateEvent(event){if(!(event instanceof FurnitureWallUpdateEvent)||!event.connection||!this._roomCreator)return;var wallGeometry=this._roomCreator.getLegacyWallGeometry(this._currentRoomId);if(!wallGeometry)return;var item=event.getParser().item;if(!item)return;var location=wallGeometry.getLocation(item.width,item.height,item.localX,item.localY,item.direction);var direction=new Vector3d(wallGeometry.getDirection(item.direction));this._roomCreator.updateRoomObjectWall(this._currentRoomId,item.itemId,location,direction,item.state,item.stuffData);this._roomCreator.updateRoomObjectWallExpiration(this._currentRoomId,item.itemId,item.secondsToExpiration);}},{key:\"onFurnitureDataEvent\",value:function onFurnitureDataEvent(event){if(!(event instanceof FurnitureDataEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();this._roomCreator.updateRoomObjectFloor(this._currentRoomId,parser.furnitureId,null,null,parser.objectData.state,parser.objectData);}},{key:\"onItemDataUpdateMessageEvent\",value:function onItemDataUpdateMessageEvent(event){if(!(event instanceof ItemDataUpdateMessageEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();this._roomCreator.updateRoomObjectWallItemData(this._currentRoomId,parser.furnitureId,parser.data);}},{key:\"onOneWayDoorStatusMessageEvent\",value:function onOneWayDoorStatusMessageEvent(event){if(!(event instanceof OneWayDoorStatusMessageEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();this._roomCreator.updateRoomObjectFloor(this._currentRoomId,parser.itemId,null,null,parser.state,new LegacyDataType());}},{key:\"onDiceValueMessageEvent\",value:function onDiceValueMessageEvent(event){if(!(event instanceof DiceValueMessageEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();this._roomCreator.updateRoomObjectFloor(this._currentRoomId,parser.itemId,null,null,parser.value,new LegacyDataType());}},{key:\"onRoomUnitDanceEvent\",value:function onRoomUnitDanceEvent(event){if(!(event instanceof RoomUnitDanceEvent)||!event.connection||!this._roomCreator)return;this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,event.getParser().unitId,RoomObjectVariable.FIGURE_DANCE,event.getParser().danceId);}},{key:\"onRoomUnitEffectEvent\",value:function onRoomUnitEffectEvent(event){if(!(event instanceof RoomUnitEffectEvent)||!event.connection||!this._roomCreator)return;this._roomCreator.updateRoomObjectUserEffect(this._currentRoomId,event.getParser().unitId,event.getParser().effectId,event.getParser().delay);}},{key:\"onRoomUnitEvent\",value:function onRoomUnitEvent(event){if(!(event instanceof RoomUnitEvent)||!event.connection||!this._roomCreator)return;var users=event.getParser().users;if(!users||!users.length)return;var _iterator3=_createForOfIteratorHelper(users),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var user=_step3.value;if(!user)continue;var location=new Vector3d(user.x,user.y,user.z);var direction=new Vector3d(user.dir);this._roomCreator.addRoomObjectUser(this._currentRoomId,user.roomIndex,location,direction,user.dir,user.userType,user.figure);if(user.webID===this._ownUserId){this._roomCreator.setRoomSessionOwnUser(this._currentRoomId,user.roomIndex);this._roomCreator.updateRoomObjectUserOwn(this._currentRoomId,user.roomIndex);}this._roomCreator.updateRoomObjectUserFigure(this._currentRoomId,user.roomIndex,user.figure,user.sex,user.subType,user.isRiding);if(RoomObjectUserType.getTypeString(user.userType)===RoomObjectUserType.PET){if(this._roomCreator.getPetTypeId(user.figure)===PetType.MONSTERPLANT){this._roomCreator.updateRoomObjectUserPosture(this._currentRoomId,user.roomIndex,user.petPosture);}}this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,user.roomIndex,RoomObjectVariable.FIGURE_IS_MUTED,this._roomCreator.sessionDataManager.isUserIgnored(user.name)?1:0);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}this.updateGuideMarker();}},{key:\"onRoomUnitExpressionEvent\",value:function onRoomUnitExpressionEvent(event){if(!(event instanceof RoomUnitExpressionEvent)||!event.connection||!this._roomCreator)return;this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,event.getParser().unitId,RoomObjectVariable.FIGURE_EXPRESSION,event.getParser().expression);}},{key:\"onRoomUnitHandItemEvent\",value:function onRoomUnitHandItemEvent(event){if(!(event instanceof RoomUnitHandItemEvent)||!event.connection||!this._roomCreator)return;this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,event.getParser().unitId,RoomObjectVariable.FIGURE_CARRY_OBJECT,event.getParser().handId);}},{key:\"onRoomUnitIdleEvent\",value:function onRoomUnitIdleEvent(event){if(!(event instanceof RoomUnitIdleEvent)||!event.connection||!this._roomCreator)return;this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,event.getParser().unitId,RoomObjectVariable.FIGURE_SLEEP,event.getParser().isIdle?1:0);}},{key:\"onRoomUnitInfoEvent\",value:function onRoomUnitInfoEvent(event){if(!(event instanceof RoomUnitInfoEvent)||!event.connection||!this._roomCreator)return;this._roomCreator.updateRoomObjectUserFigure(this._currentRoomId,event.getParser().unitId,event.getParser().figure,event.getParser().gender);}},{key:\"onRoomUnitNumberEvent\",value:function onRoomUnitNumberEvent(event){if(!(event instanceof RoomUnitNumberEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,parser.unitId,RoomObjectVariable.FIGURE_NUMBER_VALUE,parser.value);}},{key:\"onRoomUnitRemoveEvent\",value:function onRoomUnitRemoveEvent(event){if(!(event instanceof RoomUnitRemoveEvent)||!event.connection||!this._roomCreator)return;this._roomCreator.removeRoomObjectUser(this._currentRoomId,event.getParser().unitId);this.updateGuideMarker();}},{key:\"onRoomUnitStatusEvent\",value:function onRoomUnitStatusEvent(event){if(!(event instanceof RoomUnitStatusEvent)||!event.connection||!this._roomCreator)return;var statuses=event.getParser().statuses;if(!statuses||!statuses.length)return;var roomInstance=this._roomCreator.getRoomInstance(this._currentRoomId);if(!roomInstance)return;var zScale=roomInstance.model.getValue(RoomVariableEnum.ROOM_Z_SCALE)||1;var _iterator4=_createForOfIteratorHelper(statuses),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var status=_step4.value;if(!status)continue;var height=status.height;if(height)height=height/zScale;var location=new Vector3d(status.x,status.y,status.z+height);var direction=new Vector3d(status.direction);var goal=null;if(status.didMove)goal=new Vector3d(status.targetX,status.targetY,status.targetZ);this._roomCreator.updateRoomObjectUserLocation(this._currentRoomId,status.id,location,goal,status.canStandUp,height,direction,status.headDirection);this._roomCreator.updateRoomObjectUserFlatControl(this._currentRoomId,status.id,null);var isPosture=true;var postureUpdate=false;var postureType=RoomObjectVariable.STD;var parameter='';if(status.actions&&status.actions.length){var _iterator5=_createForOfIteratorHelper(status.actions),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var action=_step5.value;if(!action)continue;switch(action.action){case'flatctrl':this._roomCreator.updateRoomObjectUserFlatControl(this._currentRoomId,status.id,action.value);break;case'sign':if(status.actions.length===1)isPosture=false;this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,status.id,RoomObjectVariable.FIGURE_SIGN,parseInt(action.value));break;case'gst':if(status.actions.length===1)isPosture=false;this._roomCreator.updateRoomObjectUserPetGesture(this._currentRoomId,status.id,action.value);break;case'wav':case'mv':postureUpdate=true;postureType=action.action;parameter=action.value;break;case'trd':break;default:postureUpdate=true;postureType=action.action;parameter=action.value;break;}}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}}if(postureUpdate)this._roomCreator.updateRoomObjectUserPosture(this._currentRoomId,status.id,postureType,parameter);else if(isPosture)this._roomCreator.updateRoomObjectUserPosture(this._currentRoomId,status.id,RoomObjectVariable.STD,'');}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}this.updateGuideMarker();}},{key:\"onRoomUnitChatEvent\",value:function onRoomUnitChatEvent(event){if(!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;this._roomCreator.updateRoomObjectUserGesture(this._currentRoomId,parser.roomIndex,parser.gesture);this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,parser.roomIndex,RoomObjectVariable.FIGURE_TALK,parser.message.length/10);}},{key:\"onRoomUnitTypingEvent\",value:function onRoomUnitTypingEvent(event){if(!(event instanceof RoomUnitTypingEvent)||!event.connection||!this._roomCreator)return;this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,event.getParser().unitId,RoomObjectVariable.FIGURE_IS_TYPING,event.getParser().isTyping?1:0);}},{key:\"onPetFigureUpdateEvent\",value:function onPetFigureUpdateEvent(event){if(!(event instanceof PetFigureUpdateEvent)||!event.connection||!this._roomCreator)return;var parser=event.getParser();if(!parser)return;this._roomCreator.updateRoomObjectUserFigure(this._currentRoomId,parser.roomIndex,parser.figureData.figuredata,'','',parser.isRiding);}},{key:\"onPetExperienceEvent\",value:function onPetExperienceEvent(event){var parser=event.getParser();if(!parser)return;this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,parser.roomIndex,RoomObjectVariable.FIGURE_GAINED_EXPERIENCE,parser.gainedExperience);}},{key:\"onYouArePlayingGameEvent\",value:function onYouArePlayingGameEvent(event){if(!event)return;var parser=event.getParser();if(!parser)return;this._roomCreator.setRoomEngineGameMode(this._currentRoomId,parser.isPlaying);}},{key:\"addRoomObjectFurnitureFloor\",value:function addRoomObjectFurnitureFloor(roomId,data){if(!data||!this._roomCreator)return;var location=new Vector3d(data.x,data.y,data.z);var direction=new Vector3d(data.direction);if(data.spriteName){this._roomCreator.addFurnitureFloorByTypeName(roomId,data.itemId,data.spriteName,location,direction,data.state,data.data,data.extra,data.expires,data.usagePolicy,data.userId,data.username,true,true,data.stackHeight);}else{this._roomCreator.addFurnitureFloor(roomId,data.itemId,data.spriteId,location,direction,data.state,data.data,data.extra,data.expires,data.usagePolicy,data.userId,data.username,true,true,data.stackHeight);}}},{key:\"addRoomObjectFurnitureWall\",value:function addRoomObjectFurnitureWall(roomId,data){if(!data||!this._roomCreator)return;var wallGeometry=this._roomCreator.getLegacyWallGeometry(roomId);if(!wallGeometry)return;var location=null;if(!data.isOldFormat){location=wallGeometry.getLocation(data.width,data.height,data.localX,data.localY,data.direction);}else{//location = wallGeometry.getLocationOldFormat(data.y, data.z, data.direction);\n}var direction=new Vector3d(wallGeometry.getDirection(data.direction));this._roomCreator.addFurnitureWall(roomId,data.itemId,data.spriteId,location,direction,data.state,data.stuffData,data.secondsToExpiration,data.usagePolicy,data.userId,data.username);}},{key:\"onIgnoreResultEvent\",value:function onIgnoreResultEvent(event){if(!event)return;var parser=event.getParser();if(!parser)return;var roomSession=this._roomCreator.roomSessionManager.getSession(this._currentRoomId);if(!roomSession)return;var userData=roomSession.userDataManager.getUserDataByName(parser.name);if(!userData)return;switch(parser.result){case 1:case 2:this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,userData.roomIndex,RoomObjectVariable.FIGURE_IS_MUTED,1);return;case 3:this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,userData.roomIndex,RoomObjectVariable.FIGURE_IS_MUTED,0);return;}}},{key:\"onGuideSessionStartedMessageEvent\",value:function onGuideSessionStartedMessageEvent(event){var parser=event.getParser();this._guideId=parser.guideUserId;this._requesterId=parser.requesterUserId;this.updateGuideMarker();}},{key:\"onGuideSessionEndedMessageEvent\",value:function onGuideSessionEndedMessageEvent(k){this.removeGuideMarker();}},{key:\"onGuideSessionErrorMessageEvent\",value:function onGuideSessionErrorMessageEvent(k){this.removeGuideMarker();}},{key:\"updateGuideMarker\",value:function updateGuideMarker(){var userId=this._roomCreator.sessionDataManager.userId;this.setUserGuideStatus(this._guideId,this._requesterId===userId?AvatarGuideStatus.GUIDE:AvatarGuideStatus.NONE);this.setUserGuideStatus(this._requesterId,this._guideId===userId?AvatarGuideStatus.REQUESTER:AvatarGuideStatus.NONE);}},{key:\"removeGuideMarker\",value:function removeGuideMarker(){this.setUserGuideStatus(this._guideId,AvatarGuideStatus.NONE);this.setUserGuideStatus(this._requesterId,AvatarGuideStatus.NONE);this._guideId=-1;this._requesterId=-1;}},{key:\"setUserGuideStatus\",value:function setUserGuideStatus(userId,status){if(!this._roomCreator||!this._roomCreator.roomSessionManager)return;var roomSession=this._roomCreator.roomSessionManager.getSession(this._currentRoomId);if(!roomSession)return;var userData=roomSession.userDataManager.getDataByType(userId,RoomObjectType.USER);if(!userData)return;this._roomCreator.updateRoomObjectUserAction(this._currentRoomId,userData.roomIndex,RoomObjectVariable.FIGURE_GUIDE_STATUS,status);}// public _SafeStr_10580(event:_SafeStr_2242): void\n// {\n//     var arrayIndex: number;\n//     var discoColours:Array;\n//     var discoTimer:Timer;\n//     var eventParser:_SafeStr_4576 = (event.parser as _SafeStr_4576);\n//     switch (eventParser._SafeStr_7025)\n//     {\n//         case 0:\n//             _SafeStr_4588.init(250, 5000);\n//             _SafeStr_4588._SafeStr_6766();\n//             return;\n//         case 1:\n//             _SafeStr_4231.init(250, 5000);\n//             _SafeStr_4231._SafeStr_6766();\n//             return;\n//         case 2:\n//             this._SafeStr_10592.roomSessionManager.events.dispatchEvent(new _SafeStr_2821(this._SafeStr_10593, -1, true));\n//             return;\n//         case 3:\n//             arrayIndex = 0;\n//             discoColours = [29371, 16731195, 16764980, 0x99FF00, 29371, 16731195, 16764980, 0x99FF00, 0];\n//             discoTimer = new Timer(1000, (discoColours.length + 1));\n//             discoTimer.addEventListener(TimerEvent.TIMER, function (k:TimerEvent): void\n//             {\n//                 if (arrayIndex == discoColours.length)\n//                 {\n//                     _SafeStr_10592._SafeStr_21164(_SafeStr_10593, discoColours[arrayIndex++], 176, true);\n//                 } else\n//                 {\n//                     _SafeStr_10592._SafeStr_21164(_SafeStr_10593, discoColours[arrayIndex++], 176, false);\n//                 };\n//             });\n//             discoTimer.start();\n//             return;\n//     };\n// }\n},{key:\"currentRoomId\",get:function get(){return this._currentRoomId;}}]);return RoomMessageHandler;}(Disposable);","map":null,"metadata":{},"sourceType":"module"}