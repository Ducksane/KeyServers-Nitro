{"ast":null,"code":"import _classCallCheck from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createClass.js\";import{Texture}from'@pixi/core';import{Point}from'@pixi/math';import{NitroSprite}from'../../../core';import{RoomId}from'../../../room/utils/RoomId';import{Vector3d}from'../../../room/utils/Vector3d';import{FloorHeightMapMessageParser}from'../../communication/messages/parser/room/mapping/FloorHeightMapMessageParser';import{Nitro}from'../../Nitro';import{RoomEngineEvent}from'../events/RoomEngineEvent';import{RoomEngineObjectEvent}from'../events/RoomEngineObjectEvent';import{ObjectRoomMapUpdateMessage}from'../messages/ObjectRoomMapUpdateMessage';import{LegacyDataType}from'../object/data/type/LegacyDataType';import{RoomObjectCategory}from'../object/RoomObjectCategory';import{RoomObjectUserType}from'../object/RoomObjectUserType';import{RoomObjectVariable}from'../object/RoomObjectVariable';import{RoomPlaneParser}from'../object/RoomPlaneParser';import{RoomEngine}from'../RoomEngine';import{LegacyWallGeometry}from'../utils/LegacyWallGeometry';export var RoomPreviewer=/*#__PURE__*/function(){function RoomPreviewer(roomEngine){var roomId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;_classCallCheck(this,RoomPreviewer);this._roomEngine=void 0;this._planeParser=void 0;this._previewRoomId=1;this._currentPreviewObjectType=0;this._currentPreviewObjectCategory=0;this._currentPreviewObjectData='';this._currentPreviewRectangle=null;this._currentPreviewCanvasWidth=0;this._currentPreviewCanvasHeight=0;this._currentPreviewScale=64;this._currentPreviewNeedsZoomOut=void 0;this._automaticStateChange=void 0;this._previousAutomaticStateChangeTime=void 0;this._addViewOffset=void 0;this._backgroundColor=305148561;this._backgroundSprite=null;this._disableUpdate=false;this._roomEngine=roomEngine;this._planeParser=new RoomPlaneParser();this._previewRoomId=RoomId.makeRoomPreviewerId(roomId);this._addViewOffset=new Point(0,0);this.onRoomObjectAdded=this.onRoomObjectAdded.bind(this);this.onRoomInitializedonRoomInitialized=this.onRoomInitializedonRoomInitialized.bind(this);if(this.isRoomEngineReady&&this._roomEngine.events){this._roomEngine.events.addEventListener(RoomEngineObjectEvent.ADDED,this.onRoomObjectAdded);this._roomEngine.events.addEventListener(RoomEngineObjectEvent.CONTENT_UPDATED,this.onRoomObjectAdded);this._roomEngine.events.addEventListener(RoomEngineEvent.INITIALIZED,this.onRoomInitializedonRoomInitialized);}this.createRoomForPreview();}_createClass(RoomPreviewer,[{key:\"dispose\",value:function dispose(){this.reset(true);if(this.isRoomEngineReady&&this._roomEngine.events){this._roomEngine.events.removeEventListener(RoomEngineObjectEvent.ADDED,this.onRoomObjectAdded);this._roomEngine.events.removeEventListener(RoomEngineObjectEvent.CONTENT_UPDATED,this.onRoomObjectAdded);this._roomEngine.events.removeEventListener(RoomEngineEvent.INITIALIZED,this.onRoomInitializedonRoomInitialized);}if(this._backgroundSprite){this._backgroundSprite.destroy();this._backgroundSprite=null;}if(this._planeParser){this._planeParser.dispose();this._planeParser=null;}}},{key:\"createRoomForPreview\",value:function createRoomForPreview(){if(this.isRoomEngineReady){var size=7;var planeParser=new RoomPlaneParser();planeParser.initializeTileMap(size+2,size+2);var y=1;while(y<1+size){var x=1;while(x<1+size){planeParser.setTileHeight(x,y,0);x++;}y++;}planeParser.initializeFromTileData();this._roomEngine.createRoomInstance(this._previewRoomId,planeParser.getMapData());planeParser.dispose();}}},{key:\"reset\",value:function reset(k){if(this.isRoomEngineReady){this._roomEngine.removeRoomObjectFloor(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID);this._roomEngine.removeRoomObjectWall(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID);this._roomEngine.removeRoomObjectUser(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID);if(!k)this.updatePreviewRoomView();}this._currentPreviewObjectCategory=RoomObjectCategory.MINIMUM;}},{key:\"updatePreviewModel\",value:function updatePreviewModel(model,wallHeight){var scale=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var parser=new FloorHeightMapMessageParser();parser.flush();parser.parseModel(model,wallHeight,scale);//@ts-ignore\nvar wallGeometry=this._roomEngine.getLegacyWallGeometry(this._previewRoomId);if(!wallGeometry)return;this._planeParser.reset();var width=parser.width;var height=parser.height;this._planeParser.initializeTileMap(width,height);var entryTile=null;var doorX=-1;var doorY=-1;var doorZ=0;var doorDirection=0;var y=0;while(y<height){var x=0;while(x<width){var tileHeight=parser.getHeight(x,y);if((y>0&&y<height-1||x>0&&x<width-1)&&!(tileHeight==RoomPlaneParser.TILE_BLOCKED)&&(entryTile==null||x==entryTile.x&&y==entryTile.y)){if(parser.getHeight(x,y-1)==RoomPlaneParser.TILE_BLOCKED&&parser.getHeight(x-1,y)==RoomPlaneParser.TILE_BLOCKED&&parser.getHeight(x,y+1)==RoomPlaneParser.TILE_BLOCKED){doorX=x+0.5;doorY=y;doorZ=tileHeight;doorDirection=90;}if(parser.getHeight(x,y-1)==RoomPlaneParser.TILE_BLOCKED&&parser.getHeight(x-1,y)==RoomPlaneParser.TILE_BLOCKED&&parser.getHeight(x+1,y)==RoomPlaneParser.TILE_BLOCKED){doorX=x;doorY=y+0.5;doorZ=tileHeight;doorDirection=180;}}this._planeParser.setTileHeight(x,y,tileHeight);x++;}y++;}this._planeParser.setTileHeight(Math.floor(doorX),Math.floor(doorY),doorZ);this._planeParser.initializeFromTileData(parser.wallHeight);this._planeParser.setTileHeight(Math.floor(doorX),Math.floor(doorY),doorZ+this._planeParser.wallHeight);wallGeometry.scale=LegacyWallGeometry.DEFAULT_SCALE;wallGeometry.initialize(width,height,this._planeParser.floorHeight);var heightIterator=parser.height-1;while(heightIterator>=0){var widthIterator=parser.width-1;while(widthIterator>=0){wallGeometry.setHeight(widthIterator,heightIterator,this._planeParser.getTileHeight(widthIterator,heightIterator));widthIterator--;}heightIterator--;}var roomMap=this._planeParser.getMapData();roomMap.doors.push({x:doorX,y:doorY,z:doorZ,dir:doorDirection});var roomObject=this.getRoomPreviewOwnRoomObject();if(roomObject)roomObject.processUpdateMessage(new ObjectRoomMapUpdateMessage(roomMap));}},{key:\"addFurnitureIntoRoom\",value:function addFurnitureIntoRoom(classId,direction){var objectData=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var extra=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;if(!objectData)objectData=new LegacyDataType();if(this.isRoomEngineReady){this.reset(false);this._currentPreviewObjectType=classId;this._currentPreviewObjectCategory=RoomObjectCategory.FLOOR;this._currentPreviewObjectData='';if(this._roomEngine.addFurnitureFloor(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,classId,new Vector3d(RoomPreviewer.PREVIEW_OBJECT_LOCATION_X,RoomPreviewer.PREVIEW_OBJECT_LOCATION_Y,0),direction,0,objectData,NaN,-1,0,-1,'',true,false)){this._previousAutomaticStateChangeTime=Nitro.instance.time;this._automaticStateChange=true;var roomObject=this._roomEngine.getRoomObject(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,this._currentPreviewObjectCategory);if(roomObject&&extra)roomObject.model.setValue(RoomObjectVariable.FURNITURE_EXTRAS,extra);this.updatePreviewRoomView();return RoomPreviewer.PREVIEW_OBJECT_ID;}}return-1;}},{key:\"addWallItemIntoRoom\",value:function addWallItemIntoRoom(classId,direction,objectData){if(this.isRoomEngineReady){if(this._currentPreviewObjectCategory===RoomObjectCategory.WALL&&this._currentPreviewObjectType===classId&&this._currentPreviewObjectData===objectData)return RoomPreviewer.PREVIEW_OBJECT_ID;this.reset(false);this._currentPreviewObjectType=classId;this._currentPreviewObjectCategory=RoomObjectCategory.WALL;this._currentPreviewObjectData=objectData;if(this._roomEngine.addFurnitureWall(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,classId,new Vector3d(0.5,2.3,1.8),direction,0,objectData,0,0,-1,'',false)){this._previousAutomaticStateChangeTime=Nitro.instance.time;this._automaticStateChange=true;this.updatePreviewRoomView();return RoomPreviewer.PREVIEW_OBJECT_ID;}}return-1;}},{key:\"addAvatarIntoRoom\",value:function addAvatarIntoRoom(figure,effect){if(this.isRoomEngineReady){this.reset(false);this._currentPreviewObjectType=1;this._currentPreviewObjectCategory=RoomObjectCategory.UNIT;this._currentPreviewObjectData=figure;if(this._roomEngine.addRoomObjectUser(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,new Vector3d(RoomPreviewer.PREVIEW_OBJECT_LOCATION_X,RoomPreviewer.PREVIEW_OBJECT_LOCATION_Y,0),new Vector3d(90,0,0),135,RoomObjectUserType.getTypeNumber(RoomObjectUserType.USER),figure)){this._previousAutomaticStateChangeTime=Nitro.instance.time;this._automaticStateChange=true;this.updateUserGesture(1);this.updateUserEffect(effect);this.updateUserPosture('std');}this.updatePreviewRoomView();return RoomPreviewer.PREVIEW_OBJECT_ID;}return-1;}},{key:\"addPetIntoRoom\",value:function addPetIntoRoom(figure){if(this.isRoomEngineReady){this.reset(false);this._currentPreviewObjectType=1;this._currentPreviewObjectCategory=RoomObjectCategory.UNIT;this._currentPreviewObjectData=figure;if(this._roomEngine.addRoomObjectUser(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,new Vector3d(RoomPreviewer.PREVIEW_OBJECT_LOCATION_X,RoomPreviewer.PREVIEW_OBJECT_LOCATION_Y,0),new Vector3d(90,0,0),90,RoomObjectUserType.getTypeNumber(RoomObjectUserType.PET),figure)){this._previousAutomaticStateChangeTime=Nitro.instance.time;this._automaticStateChange=false;this.updateUserGesture(1);this.updateUserPosture('std');}this.updatePreviewRoomView();return RoomPreviewer.PREVIEW_OBJECT_ID;}return-1;}},{key:\"updateUserPosture\",value:function updateUserPosture(type){var parameter=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'';if(this.isRoomEngineReady)this._roomEngine.updateRoomObjectUserPosture(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,type,parameter);}},{key:\"updateUserGesture\",value:function updateUserGesture(gestureId){if(this.isRoomEngineReady)this._roomEngine.updateRoomObjectUserGesture(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,gestureId);}},{key:\"updateUserEffect\",value:function updateUserEffect(effectId){if(this.isRoomEngineReady)this._roomEngine.updateRoomObjectUserEffect(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,effectId);}},{key:\"updateObjectUserFigure\",value:function updateObjectUserFigure(figure){var gender=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var subType=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var isRiding=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(this.isRoomEngineReady)return this._roomEngine.updateRoomObjectUserFigure(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,figure,gender,subType,isRiding);return false;}},{key:\"updateObjectUserAction\",value:function updateObjectUserAction(action,value){var parameter=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(this.isRoomEngineReady)this._roomEngine.updateRoomObjectUserAction(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,action,value,parameter);}},{key:\"updateObjectStuffData\",value:function updateObjectStuffData(stuffData){if(this.isRoomEngineReady)this._roomEngine.updateRoomObjectFloor(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,null,null,stuffData.state,stuffData);}},{key:\"changeRoomObjectState\",value:function changeRoomObjectState(){if(this.isRoomEngineReady){this._automaticStateChange=false;if(this._currentPreviewObjectCategory!==RoomObjectCategory.UNIT)this._roomEngine.changeObjectState(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,this._currentPreviewObjectCategory);}}},{key:\"changeRoomObjectDirection\",value:function changeRoomObjectDirection(){if(this.isRoomEngineReady){var roomObject=this._roomEngine.getRoomObject(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,this._currentPreviewObjectCategory);if(!roomObject)return;var direction=this._roomEngine.objectEventHandler.getValidRoomObjectDirection(roomObject,true);switch(this._currentPreviewObjectCategory){case RoomObjectCategory.FLOOR:{var floorLocation=new Vector3d(RoomPreviewer.PREVIEW_OBJECT_LOCATION_X,RoomPreviewer.PREVIEW_OBJECT_LOCATION_Y);var floorDirection=new Vector3d(direction,direction,direction);this._roomEngine.updateRoomObjectFloor(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,floorLocation,floorDirection,null,null);return;}case RoomObjectCategory.WALL://this._roomEngine.updateRoomObjectWall(this._previewRoomId, RoomPreviewer.PREVIEW_OBJECT_ID, null, direction, null, null);\nreturn;}}}},{key:\"checkAutomaticRoomObjectStateChange\",value:function checkAutomaticRoomObjectStateChange(){if(this._automaticStateChange){var time=Nitro.instance.time;if(time>this._previousAutomaticStateChangeTime+RoomPreviewer.AUTOMATIC_STATE_CHANGE_INTERVAL){this._previousAutomaticStateChangeTime=time;if(this.isRoomEngineReady)this._roomEngine.changeObjectState(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,this._currentPreviewObjectCategory);}}}},{key:\"getRoomCanvas\",value:function getRoomCanvas(width,height){if(this.isRoomEngineReady){var displayObject=this._roomEngine.getRoomInstanceDisplay(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID,width,height,this._currentPreviewScale);if(displayObject&&this._backgroundColor!==null){var backgroundSprite=this._backgroundSprite;if(!backgroundSprite){backgroundSprite=new NitroSprite(Texture.WHITE);displayObject.addChildAt(backgroundSprite,0);}backgroundSprite.width=width;backgroundSprite.height=height;backgroundSprite.tint=this._backgroundColor;}this._roomEngine.setRoomInstanceRenderingCanvasMask(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID,true);var geometry=this._roomEngine.getRoomInstanceGeometry(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID);if(geometry)geometry.adjustLocation(new Vector3d(RoomPreviewer.PREVIEW_OBJECT_LOCATION_X,RoomPreviewer.PREVIEW_OBJECT_LOCATION_Y,0),30);this._currentPreviewCanvasWidth=width;this._currentPreviewCanvasHeight=height;return displayObject;}return null;}},{key:\"modifyRoomCanvas\",value:function modifyRoomCanvas(width,height){if(this.isRoomEngineReady){this._currentPreviewCanvasWidth=width;this._currentPreviewCanvasHeight=height;if(this._backgroundSprite){this._backgroundSprite.width=width;this._backgroundSprite.height=height;}this._roomEngine.initializeRoomInstanceRenderingCanvas(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID,width,height);}}},{key:\"addViewOffset\",get:function get(){return this._addViewOffset;},set:function set(point){this._addViewOffset=point;}},{key:\"updatePreviewObjectBoundingRectangle\",value:function updatePreviewObjectBoundingRectangle(point){var objectBounds=this._roomEngine.getRoomObjectBoundingRectangle(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,this._currentPreviewObjectCategory,RoomPreviewer.PREVIEW_CANVAS_ID);if(objectBounds&&point){objectBounds.x+=-(this._currentPreviewCanvasWidth>>1);objectBounds.y+=-(this._currentPreviewCanvasHeight>>1);objectBounds.x+=-point.x;objectBounds.y+=-point.y;if(!this._currentPreviewRectangle){this._currentPreviewRectangle=objectBounds;}else{var bounds=this._currentPreviewRectangle.clone().enlarge(objectBounds);if(bounds.width-this._currentPreviewRectangle.width>this._currentPreviewCanvasWidth-this._currentPreviewRectangle.width>>1||bounds.height-this._currentPreviewRectangle.height>this._currentPreviewCanvasHeight-this._currentPreviewRectangle.height>>1||this._currentPreviewRectangle.width<1||this._currentPreviewRectangle.height<1)this._currentPreviewRectangle=bounds;}}}},{key:\"validatePreviewSize\",value:function validatePreviewSize(point){if(this._currentPreviewRectangle.width<1||this._currentPreviewRectangle.height<1){return point;}if(this.isRoomEngineReady){var geometry=this._roomEngine.getRoomInstanceGeometry(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID);if(this._currentPreviewRectangle.width>this._currentPreviewCanvasWidth*(1+RoomPreviewer.ALLOWED_IMAGE_CUT)||this._currentPreviewRectangle.height>this._currentPreviewCanvasHeight*(1+RoomPreviewer.ALLOWED_IMAGE_CUT)){if(RoomPreviewer.ZOOM_ENABLED){if(this._roomEngine.getRoomInstanceRenderingCanvasScale(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID)!==0.5){this._roomEngine.setRoomInstanceRenderingCanvasScale(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID,0.5,null,null);this._currentPreviewScale=RoomPreviewer.SCALE_SMALL;this._currentPreviewNeedsZoomOut=true;point.x=point.x>>1;point.y=point.y>>1;this._currentPreviewRectangle.x=this._currentPreviewRectangle.x>>2;this._currentPreviewRectangle.y=this._currentPreviewRectangle.y>>2;this._currentPreviewRectangle.width=this._currentPreviewRectangle.width>>2;this._currentPreviewRectangle.height=this._currentPreviewRectangle.height>>2;}}else{if(geometry.isZoomedIn()){geometry.performZoomOut();this._currentPreviewScale=RoomPreviewer.SCALE_SMALL;this._currentPreviewNeedsZoomOut=true;}}}else if(!this._currentPreviewNeedsZoomOut){if(RoomPreviewer.ZOOM_ENABLED){if(this._roomEngine.getRoomInstanceRenderingCanvasScale(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID)!==1){this._roomEngine.setRoomInstanceRenderingCanvasScale(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID,1,null,null);this._currentPreviewScale=RoomPreviewer.SCALE_NORMAL;}}else{if(!geometry.isZoomedIn()){geometry.performZoomIn();this._currentPreviewScale=RoomPreviewer.SCALE_NORMAL;}}}}return point;}},{key:\"zoomIn\",value:function zoomIn(){if(this.isRoomEngineReady){if(RoomPreviewer.ZOOM_ENABLED){this._roomEngine.setRoomInstanceRenderingCanvasScale(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID,1);}else{var geometry=this._roomEngine.getRoomInstanceGeometry(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID);geometry.performZoomIn();}}this._currentPreviewScale=RoomPreviewer.SCALE_NORMAL;}},{key:\"zoomOut\",value:function zoomOut(){if(this.isRoomEngineReady){if(RoomPreviewer.ZOOM_ENABLED){this._roomEngine.setRoomInstanceRenderingCanvasScale(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID,0.5);}else{var geometry=this._roomEngine.getRoomInstanceGeometry(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID);geometry.performZoomOut();}}this._currentPreviewScale=RoomPreviewer.SCALE_SMALL;}},{key:\"updateAvatarDirection\",value:function updateAvatarDirection(direction,headDirection){if(this.isRoomEngineReady){this._roomEngine.updateRoomObjectUserLocation(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,new Vector3d(RoomPreviewer.PREVIEW_OBJECT_LOCATION_X,RoomPreviewer.PREVIEW_OBJECT_LOCATION_Y,0),new Vector3d(RoomPreviewer.PREVIEW_OBJECT_LOCATION_X,RoomPreviewer.PREVIEW_OBJECT_LOCATION_Y,0),false,0,new Vector3d(direction*45,0,0),headDirection*45);}}},{key:\"updateObjectRoom\",value:function updateObjectRoom(){var floorType=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var wallType=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var landscapeType=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var _arg_4=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(this.isRoomEngineReady)return this._roomEngine.updateRoomInstancePlaneType(this._previewRoomId,floorType,wallType,landscapeType,_arg_4);return false;}},{key:\"updateRoomWallsAndFloorVisibility\",value:function updateRoomWallsAndFloorVisibility(wallsVisible){var floorsVisible=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;if(this.isRoomEngineReady)this._roomEngine.updateRoomInstancePlaneVisibility(this._previewRoomId,wallsVisible,floorsVisible);}},{key:\"getCanvasOffset\",value:function getCanvasOffset(point){if(this._currentPreviewRectangle.width<1||this._currentPreviewRectangle.height<1)return point;var x=-(this._currentPreviewRectangle.left+this._currentPreviewRectangle.right)>>1;var y=-(this._currentPreviewRectangle.top+this._currentPreviewRectangle.bottom)>>1;var height=this._currentPreviewCanvasHeight-this._currentPreviewRectangle.height>>1;if(height>10){y=y+Math.min(15,height-10);}else{if(this._currentPreviewObjectCategory!==RoomObjectCategory.UNIT){y=y+(5-Math.max(0,height/2));}else{y=y-(5-Math.min(0,height/2));}}y=y+this._addViewOffset.y;x=x+this._addViewOffset.x;var offsetX=x-point.x;var offsetY=y-point.y;if(offsetX!==0||offsetY!==0){var _local_7=Math.sqrt(offsetX*offsetX+offsetY*offsetY);if(_local_7>10){x=point.x+offsetX*10/_local_7;y=point.y+offsetY*10/_local_7;}return new Point(x,y);}return null;}},{key:\"updatePreviewRoomView\",value:function updatePreviewRoomView(){var k=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this._disableUpdate&&!k)return;this.checkAutomaticRoomObjectStateChange();if(this.isRoomEngineReady){var offset=this._roomEngine.getRoomInstanceRenderingCanvasOffset(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID);if(offset){this.updatePreviewObjectBoundingRectangle(offset);if(this._currentPreviewRectangle){var scale=this._currentPreviewScale;offset=this.validatePreviewSize(offset);var canvasOffset=this.getCanvasOffset(offset);if(canvasOffset){this._roomEngine.setRoomInstanceRenderingCanvasOffset(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID,canvasOffset);}if(this._currentPreviewScale!==scale)this._currentPreviewRectangle=null;}}}}},{key:\"disableUpdate\",set:function set(flag){this._disableUpdate=flag;}},{key:\"disableRoomEngineUpdate\",set:function set(flag){if(this.isRoomEngineReady)this._roomEngine.disableUpdate(flag);}},{key:\"onRoomInitializedonRoomInitialized\",value:function onRoomInitializedonRoomInitialized(event){if(!event)return;switch(event.type){case RoomEngineEvent.INITIALIZED:if(event.roomId===this._previewRoomId&&this.isRoomEngineReady){this._roomEngine.updateRoomInstancePlaneType(this._previewRoomId,'110','99999');}return;}}},{key:\"onRoomObjectAdded\",value:function onRoomObjectAdded(event){if(event.roomId===this._previewRoomId&&event.objectId===RoomPreviewer.PREVIEW_OBJECT_ID&&event.category===this._currentPreviewObjectCategory){this._currentPreviewRectangle=null;this._currentPreviewNeedsZoomOut=false;var roomObject=this._roomEngine.getRoomObject(event.roomId,event.objectId,event.category);if(roomObject&&roomObject.model&&event.category===RoomObjectCategory.WALL){var sizeZ=roomObject.model.getValue(RoomObjectVariable.FURNITURE_SIZE_Z);var centerZ=roomObject.model.getValue(RoomObjectVariable.FURNITURE_CENTER_Z);if(sizeZ!==null||centerZ!==null){this._roomEngine.updateRoomObjectWallLocation(event.roomId,event.objectId,new Vector3d(0.5,2.3,(3.6-sizeZ)/2+centerZ));}}}}},{key:\"updateRoomEngine\",value:function updateRoomEngine(){if(this.isRoomEngineReady)this._roomEngine.runUpdate();}},{key:\"getRenderingCanvas\",value:function getRenderingCanvas(){var renderingCanvas=this._roomEngine.getRoomInstanceRenderingCanvas(this._previewRoomId,RoomPreviewer.PREVIEW_CANVAS_ID);if(!renderingCanvas)return null;return renderingCanvas;}},{key:\"getGenericRoomObjectImage\",value:function getGenericRoomObjectImage(type,value,direction,scale,listener){var bgColor=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var extras=arguments.length>6&&arguments[6]!==undefined?arguments[6]:null;var objectData=arguments.length>7&&arguments[7]!==undefined?arguments[7]:null;var state=arguments.length>8&&arguments[8]!==undefined?arguments[8]:-1;var frame=arguments.length>9&&arguments[9]!==undefined?arguments[9]:-1;var posture=arguments.length>10&&arguments[10]!==undefined?arguments[10]:null;if(this.isRoomEngineReady){return this._roomEngine.getGenericRoomObjectImage(type,value,direction,scale,listener,bgColor,extras,objectData,state,frame,posture);}return null;}},{key:\"getRoomObjectImage\",value:function getRoomObjectImage(direction,scale,listener){var bgColor=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;if(this.isRoomEngineReady){return this._roomEngine.getRoomObjectImage(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,this._currentPreviewObjectCategory,direction,scale,listener,bgColor);}return null;}},{key:\"getRoomObjectCurrentImage\",value:function getRoomObjectCurrentImage(){if(this.isRoomEngineReady){var roomObject=this._roomEngine.getRoomObject(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,this._currentPreviewObjectCategory);if(roomObject&&roomObject.visualization)return roomObject.visualization.getImage(0xFFFFFF,-1);}return null;}},{key:\"getRoomPreviewObject\",value:function getRoomPreviewObject(){if(this.isRoomEngineReady){var roomObject=this._roomEngine.getRoomObject(this._previewRoomId,RoomPreviewer.PREVIEW_OBJECT_ID,this._currentPreviewObjectCategory);if(roomObject)return roomObject;}return null;}},{key:\"getRoomPreviewOwnRoomObject\",value:function getRoomPreviewOwnRoomObject(){if(this.isRoomEngineReady){var roomObject=this._roomEngine.getRoomObject(this._previewRoomId,RoomEngine.ROOM_OBJECT_ID,RoomObjectCategory.ROOM);if(roomObject)return roomObject;}return null;}},{key:\"isRoomEngineReady\",get:function get(){return this._roomEngine&&this._roomEngine.ready;}},{key:\"roomId\",get:function get(){return this._previewRoomId;}},{key:\"backgroundColor\",get:function get(){return this._backgroundColor;},set:function set(color){this._backgroundColor=color;}},{key:\"width\",get:function get(){return this._currentPreviewCanvasWidth;}},{key:\"height\",get:function get(){return this._currentPreviewCanvasHeight;}}]);return RoomPreviewer;}();RoomPreviewer.SCALE_NORMAL=64;RoomPreviewer.SCALE_SMALL=32;RoomPreviewer.PREVIEW_COUNTER=0;RoomPreviewer.PREVIEW_CANVAS_ID=1;RoomPreviewer.PREVIEW_OBJECT_ID=1;RoomPreviewer.PREVIEW_OBJECT_LOCATION_X=2;RoomPreviewer.PREVIEW_OBJECT_LOCATION_Y=2;RoomPreviewer.ALLOWED_IMAGE_CUT=0.25;RoomPreviewer.AUTOMATIC_STATE_CHANGE_INTERVAL=2500;RoomPreviewer.ZOOM_ENABLED=true;","map":null,"metadata":{},"sourceType":"module"}