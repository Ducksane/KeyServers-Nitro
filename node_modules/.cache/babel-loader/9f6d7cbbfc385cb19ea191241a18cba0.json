{"ast":null,"code":"import _toConsumableArray from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _slicedToArray from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{GuideOnDutyStatusMessageEvent,GuideSessionAttachedMessageEvent,GuideSessionDetachedMessageEvent,GuideSessionEndedMessageEvent,GuideSessionInvitedToGuideRoomMessageEvent,GuideSessionMessageMessageEvent,GuideSessionOnDutyUpdateMessageComposer,GuideSessionPartnerIsTypingMessageEvent,GuideSessionStartedMessageEvent,PerkAllowancesMessageEvent,PerkEnum}from'@nitrots/nitro-renderer';import{useCallback,useEffect,useState}from'react';import{AddEventLinkTracker,GetConfiguration,GetSessionDataManager,LocalizeText,RemoveLinkEventTracker,SendMessageComposer}from'../../api';import{NitroCardContentView,NitroCardHeaderView,NitroCardView}from'../../common';import{GuideToolEvent,NotificationAlertEvent}from'../../events';import{DispatchUiEvent,UseMessageEventHook,UseUiEvent}from'../../hooks';import{GuideSessionState}from'./common/GuideSessionState';import{GuideToolMessage}from'./common/GuideToolMessage';import{GuideToolMessageGroup}from'./common/GuideToolMessageGroup';import{GuideToolAcceptView}from'./views/GuideToolAcceptView';import{GuideToolMenuView}from'./views/GuideToolMenuView';import{GuideToolOngoingView}from'./views/GuideToolOngoingView';import{GuideToolUserCreateRequestView}from'./views/GuideToolUserCreateRequestView';import{GuideToolUserFeedbackView}from'./views/GuideToolUserFeedbackView';import{GuideToolUserPendingView}from'./views/GuideToolUserPendingView';import{GuideToolUserThanksView}from'./views/GuideToolUserThanksView';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export var GuideToolView=function GuideToolView(props){var _useState=useState(false),_useState2=_slicedToArray(_useState,2),isVisible=_useState2[0],setIsVisible=_useState2[1];var _useState3=useState(LocalizeText('guide.help.guide.tool.title')),_useState4=_slicedToArray(_useState3,2),headerText=_useState4[0],setHeaderText=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),noCloseButton=_useState6[0],setNoCloseButton=_useState6[1];var _useState7=useState(GuideSessionState.GUIDE_TOOL_MENU),_useState8=_slicedToArray(_useState7,2),sessionState=_useState8[0],setSessionState=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),isOnDuty=_useState10[0],setIsOnDuty=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),isHandlingBullyReports=_useState12[0],setIsHandlingBullyReports=_useState12[1];var _useState13=useState(false),_useState14=_slicedToArray(_useState13,2),isHandlingGuideRequests=_useState14[0],setIsHandlingGuideRequests=_useState14[1];var _useState15=useState(false),_useState16=_slicedToArray(_useState15,2),isHandlingHelpRequests=_useState16[0],setIsHandlingHelpRequests=_useState16[1];var _useState17=useState(0),_useState18=_slicedToArray(_useState17,2),helpersOnDuty=_useState18[0],setHelpersOnDuty=_useState18[1];var _useState19=useState(0),_useState20=_slicedToArray(_useState19,2),guidesOnDuty=_useState20[0],setGuidesOnDuty=_useState20[1];var _useState21=useState(0),_useState22=_slicedToArray(_useState21,2),guardiansOnDuty=_useState22[0],setGuardiansOnDuty=_useState22[1];var _useState23=useState(''),_useState24=_slicedToArray(_useState23,2),userRequest=_useState24[0],setUserRequest=_useState24[1];var _useState25=useState(null),_useState26=_slicedToArray(_useState25,2),helpRequestDescription=_useState26[0],setHelpRequestDescription=_useState26[1];var _useState27=useState(0),_useState28=_slicedToArray(_useState27,2),helpRequestAverageTime=_useState28[0],setHelpRequestAverageTime=_useState28[1];var _useState29=useState(0),_useState30=_slicedToArray(_useState29,2),ongoingUserId=_useState30[0],setOngoingUserId=_useState30[1];var _useState31=useState(null),_useState32=_slicedToArray(_useState31,2),ongoingUsername=_useState32[0],setOngoingUsername=_useState32[1];var _useState33=useState(null),_useState34=_slicedToArray(_useState33,2),ongoingFigure=_useState34[0],setOngoingFigure=_useState34[1];var _useState35=useState(false),_useState36=_slicedToArray(_useState35,2),ongoingIsTyping=_useState36[0],setOngoingIsTyping=_useState36[1];var _useState37=useState([]),_useState38=_slicedToArray(_useState37,2),ongoingMessageGroups=_useState38[0],setOngoingMessageGroups=_useState38[1];var updateSessionState=useCallback(function(newState,replacement){switch(newState){case GuideSessionState.GUIDE_TOOL_MENU:setHeaderText(LocalizeText('guide.help.guide.tool.title'));setNoCloseButton(false);break;case GuideSessionState.GUIDE_ACCEPT:setHeaderText(LocalizeText('guide.help.request.guide.accept.title'));setNoCloseButton(true);break;case GuideSessionState.GUIDE_ONGOING:setHeaderText(LocalizeText('guide.help.request.guide.ongoing.title',['name'],[replacement]));setNoCloseButton(true);break;case GuideSessionState.USER_CREATE:setHeaderText(LocalizeText('guide.help.request.user.create.title'));setNoCloseButton(false);break;case GuideSessionState.USER_PENDING:setHeaderText(LocalizeText('guide.help.request.user.pending.title'));setNoCloseButton(true);break;case GuideSessionState.USER_ONGOING:setHeaderText(LocalizeText('guide.help.request.user.ongoing.title',['name'],[replacement]));setNoCloseButton(true);break;case GuideSessionState.USER_FEEDBACK:setHeaderText(LocalizeText('guide.help.request.user.feedback.title'));setNoCloseButton(true);break;case GuideSessionState.USER_THANKS:setHeaderText(LocalizeText('guide.help.request.user.thanks.title'));setNoCloseButton(false);break;}setSessionState(newState);setIsVisible(true);},[]);var onGuideToolEvent=useCallback(function(event){switch(event.type){case GuideToolEvent.SHOW_GUIDE_TOOL:setIsVisible(true);return;case GuideToolEvent.HIDE_GUIDE_TOOL:setIsVisible(false);return;case GuideToolEvent.TOGGLE_GUIDE_TOOL:setIsVisible(function(value){return!value;});return;case GuideToolEvent.CREATE_HELP_REQUEST:updateSessionState(GuideSessionState.USER_CREATE);return;}},[updateSessionState]);UseUiEvent(GuideToolEvent.SHOW_GUIDE_TOOL,onGuideToolEvent);UseUiEvent(GuideToolEvent.HIDE_GUIDE_TOOL,onGuideToolEvent);UseUiEvent(GuideToolEvent.TOGGLE_GUIDE_TOOL,onGuideToolEvent);UseUiEvent(GuideToolEvent.CREATE_HELP_REQUEST,onGuideToolEvent);var onPerkAllowancesMessageEvent=useCallback(function(event){var parser=event.getParser();if(!parser.isAllowed(PerkEnum.USE_GUIDE_TOOL)&&isOnDuty){setIsOnDuty(false);SendMessageComposer(new GuideSessionOnDutyUpdateMessageComposer(false,false,false,false));}},[isOnDuty,setIsOnDuty]);UseMessageEventHook(PerkAllowancesMessageEvent,onPerkAllowancesMessageEvent);var onGuideOnDutyStatusMessageEvent=useCallback(function(event){var parser=event.getParser();setIsOnDuty(parser.onDuty);setGuidesOnDuty(parser.guidesOnDuty);setHelpersOnDuty(parser.helpersOnDuty);setGuardiansOnDuty(parser.guardiansOnDuty);},[setIsOnDuty,setHelpersOnDuty,setGuidesOnDuty,setGuardiansOnDuty]);UseMessageEventHook(GuideOnDutyStatusMessageEvent,onGuideOnDutyStatusMessageEvent);var onGuideSessionAttachedMessageEvent=useCallback(function(event){var parser=event.getParser();setHelpRequestDescription(parser.helpRequestDescription);setHelpRequestAverageTime(parser.roleSpecificWaitTime);if(parser.asGuide&&isOnDuty)updateSessionState(GuideSessionState.GUIDE_ACCEPT);if(!parser.asGuide)updateSessionState(GuideSessionState.USER_PENDING);},[isOnDuty,updateSessionState]);UseMessageEventHook(GuideSessionAttachedMessageEvent,onGuideSessionAttachedMessageEvent);var onGuideSessionStartedMessageEvent=useCallback(function(event){var parser=event.getParser();if(isOnDuty){setOngoingUserId(parser.requesterUserId);setOngoingUsername(parser.requesterName);setOngoingFigure(parser.requesterFigure);updateSessionState(GuideSessionState.GUIDE_ONGOING,parser.requesterName);}else{setOngoingUserId(parser.guideUserId);setOngoingUsername(parser.guideName);setOngoingFigure(parser.guideFigure);updateSessionState(GuideSessionState.USER_ONGOING,parser.guideName);}},[isOnDuty,updateSessionState]);UseMessageEventHook(GuideSessionStartedMessageEvent,onGuideSessionStartedMessageEvent);var onGuideSessionPartnerIsTypingMessageEvent=useCallback(function(event){var parser=event.getParser();setOngoingIsTyping(parser.isTyping);},[]);UseMessageEventHook(GuideSessionPartnerIsTypingMessageEvent,onGuideSessionPartnerIsTypingMessageEvent);var onGuideSessionMessageMessageEvent=useCallback(function(event){var parser=event.getParser();var messageGroups=_toConsumableArray(ongoingMessageGroups);var lastGroup=messageGroups[messageGroups.length-1];if(!lastGroup||lastGroup.userId!==parser.senderId){lastGroup=new GuideToolMessageGroup(parser.senderId);messageGroups.push(lastGroup);}lastGroup.addChat(new GuideToolMessage(parser.chatMessage));setOngoingMessageGroups(messageGroups);},[ongoingMessageGroups]);UseMessageEventHook(GuideSessionMessageMessageEvent,onGuideSessionMessageMessageEvent);var onGuideSessionInvitedToGuideRoomMessageEvent=useCallback(function(event){var parser=event.getParser();var messageGroups=_toConsumableArray(ongoingMessageGroups);var lastGroup=messageGroups[messageGroups.length-1];var guideId=isOnDuty?GetSessionDataManager().userId:ongoingUserId;if(!lastGroup||lastGroup.userId!==guideId){lastGroup=new GuideToolMessageGroup(guideId);messageGroups.push(lastGroup);}lastGroup.addChat(new GuideToolMessage(parser.roomName,parser.roomId));setOngoingMessageGroups(messageGroups);},[isOnDuty,ongoingMessageGroups,ongoingUserId]);UseMessageEventHook(GuideSessionInvitedToGuideRoomMessageEvent,onGuideSessionInvitedToGuideRoomMessageEvent);var onGuideSessionEndedMessageEvent=useCallback(function(event){if(isOnDuty){setOngoingUserId(0);setOngoingUsername(null);setOngoingFigure(null);setOngoingIsTyping(false);setOngoingMessageGroups([]);updateSessionState(GuideSessionState.GUIDE_TOOL_MENU);}else{updateSessionState(GuideSessionState.USER_FEEDBACK);}},[isOnDuty,updateSessionState]);UseMessageEventHook(GuideSessionEndedMessageEvent,onGuideSessionEndedMessageEvent);var onGuideSessionDetachedMessageEvent=useCallback(function(event){setOngoingUserId(0);setOngoingUsername(null);setOngoingFigure(null);setOngoingIsTyping(false);setOngoingMessageGroups([]);if(isOnDuty){updateSessionState(GuideSessionState.GUIDE_TOOL_MENU);}else{updateSessionState(GuideSessionState.USER_THANKS);}},[isOnDuty,updateSessionState]);UseMessageEventHook(GuideSessionDetachedMessageEvent,onGuideSessionDetachedMessageEvent);var linkReceived=useCallback(function(url){var parts=url.split('/');if(parts.length<2)return;switch(parts[1]){case'tour'://Create Tour Request\nreturn;}},[]);useEffect(function(){var linkTracker={linkReceived:linkReceived,eventUrlPrefix:'help/'};AddEventLinkTracker(linkTracker);return function(){return RemoveLinkEventTracker(linkTracker);};},[linkReceived]);var processAction=useCallback(function(action){switch(action){case'close':setIsVisible(false);setUserRequest('');setSessionState(GuideSessionState.GUIDE_TOOL_MENU);return;case'toggle_duty':if(!isHandlingBullyReports&&!isHandlingGuideRequests&&!isHandlingHelpRequests){DispatchUiEvent(new NotificationAlertEvent([LocalizeText('guide.help.guide.tool.noqueueselected.message')],null,null,null,LocalizeText('guide.help.guide.tool.noqueueselected.caption'),null));return;}setIsOnDuty(function(v){SendMessageComposer(new GuideSessionOnDutyUpdateMessageComposer(!v,v?false:isHandlingGuideRequests,v?false:isHandlingHelpRequests,v?false:isHandlingBullyReports));return!v;});return;case'forum_link':var url=GetConfiguration('group.homepage.url','').replace('%groupid%',GetConfiguration('guide.help.alpha.groupid','0'));window.open(url);return;}},[isHandlingBullyReports,isHandlingGuideRequests,isHandlingHelpRequests]);if(!isVisible)return null;return/*#__PURE__*/_jsxs(NitroCardView,{className:\"nitro-guide-tool\",theme:\"primary-slim\",children:[/*#__PURE__*/_jsx(NitroCardHeaderView,{headerText:headerText,onCloseClick:function onCloseClick(event){return processAction('close');},noCloseButton:noCloseButton}),/*#__PURE__*/_jsxs(NitroCardContentView,{className:\"text-black\",children:[sessionState===GuideSessionState.GUIDE_TOOL_MENU&&/*#__PURE__*/_jsx(GuideToolMenuView,{isOnDuty:isOnDuty,isHandlingGuideRequests:isHandlingGuideRequests,setIsHandlingGuideRequests:setIsHandlingGuideRequests,isHandlingHelpRequests:isHandlingHelpRequests,setIsHandlingHelpRequests:setIsHandlingHelpRequests,isHandlingBullyReports:isHandlingBullyReports,setIsHandlingBullyReports:setIsHandlingBullyReports,guidesOnDuty:guidesOnDuty,helpersOnDuty:helpersOnDuty,guardiansOnDuty:guardiansOnDuty,processAction:processAction}),sessionState===GuideSessionState.GUIDE_ACCEPT&&/*#__PURE__*/_jsx(GuideToolAcceptView,{helpRequestDescription:helpRequestDescription,helpRequestAverageTime:helpRequestAverageTime}),[GuideSessionState.GUIDE_ONGOING,GuideSessionState.USER_ONGOING].includes(sessionState)&&/*#__PURE__*/_jsx(GuideToolOngoingView,{isGuide:isOnDuty,userId:ongoingUserId,userName:ongoingUsername,userFigure:ongoingFigure,isTyping:ongoingIsTyping,messageGroups:ongoingMessageGroups}),sessionState===GuideSessionState.USER_CREATE&&/*#__PURE__*/_jsx(GuideToolUserCreateRequestView,{userRequest:userRequest,setUserRequest:setUserRequest}),sessionState===GuideSessionState.USER_PENDING&&/*#__PURE__*/_jsx(GuideToolUserPendingView,{helpRequestDescription:helpRequestDescription,helpRequestAverageTime:helpRequestAverageTime}),sessionState===GuideSessionState.USER_FEEDBACK&&/*#__PURE__*/_jsx(GuideToolUserFeedbackView,{userName:ongoingUsername}),sessionState===GuideSessionState.USER_THANKS&&/*#__PURE__*/_jsx(GuideToolUserThanksView,{})]})]});};","map":null,"metadata":{},"sourceType":"module"}