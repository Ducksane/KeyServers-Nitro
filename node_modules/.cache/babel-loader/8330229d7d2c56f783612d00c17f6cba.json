{"ast":null,"code":"import _createForOfIteratorHelper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _get from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/get.js\";import _getPrototypeOf from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js\";import _inherits from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{BLEND_MODES}from'@pixi/constants';import{Texture}from'@pixi/core';import{AdvancedMap}from'../../../../../core/utils/AdvancedMap';import{AlphaTolerance}from'../../../../../room/object/enum/AlphaTolerance';import{RoomObjectSpriteType}from'../../../../../room/object/enum/RoomObjectSpriteType';import{RoomObjectSpriteVisualization}from'../../../../../room/object/visualization/RoomObjectSpriteVisualization';import{AvatarAction}from'../../../../avatar/enum/AvatarAction';import{AvatarGuideStatus}from'../../../../avatar/enum/AvatarGuideStatus';import{AvatarSetType}from'../../../../avatar/enum/AvatarSetType';import{RoomObjectVariable}from'../../RoomObjectVariable';import{ExpressionAdditionFactory}from'./additions/ExpressionAdditionFactory';import{FloatingIdleZAddition}from'./additions/FloatingIdleZAddition';import{GameClickTargetAddition}from'./additions/GameClickTargetAddition';import{GuideStatusBubbleAddition}from'./additions/GuideStatusBubbleAddition';import{MutedBubbleAddition}from'./additions/MutedBubbleAddition';import{NumberBubbleAddition}from'./additions/NumberBubbleAddition';import{TypingBubbleAddition}from'./additions/TypingBubbleAddition';import{AvatarVisualizationData}from'./AvatarVisualizationData';export var AvatarVisualization=/*#__PURE__*/function(_RoomObjectSpriteVisu){_inherits(AvatarVisualization,_RoomObjectSpriteVisu);var _super=_createSuper(AvatarVisualization);function AvatarVisualization(){var _this;_classCallCheck(this,AvatarVisualization);_this=_super.call(this);_this._data=void 0;_this._avatarImage=void 0;_this._cachedAvatars=void 0;_this._cachedAvatarEffects=void 0;_this._shadow=void 0;_this._lastUpdate=void 0;_this._disposed=void 0;_this._figure=void 0;_this._gender=void 0;_this._direction=void 0;_this._headDirection=void 0;_this._posture=void 0;_this._postureParameter=void 0;_this._canStandUp=void 0;_this._postureOffset=void 0;_this._verticalOffset=void 0;_this._angle=void 0;_this._headAngle=void 0;_this._talk=void 0;_this._expression=void 0;_this._sleep=void 0;_this._blink=void 0;_this._gesture=void 0;_this._sign=void 0;_this._highlightEnabled=void 0;_this._highlight=void 0;_this._dance=void 0;_this._effect=void 0;_this._carryObject=void 0;_this._useObject=void 0;_this._ownUser=void 0;_this._isLaying=void 0;_this._layInside=void 0;_this._isAnimating=void 0;_this._extraSpritesStartIndex=void 0;_this._forcedAnimFrames=void 0;_this._updatesUntilFrameUpdate=void 0;_this._isAvatarReady=void 0;_this._needsUpdate=void 0;_this._geometryUpdateCounter=void 0;_this._additions=void 0;_this._data=null;_this._avatarImage=null;_this._cachedAvatars=new AdvancedMap();_this._cachedAvatarEffects=new AdvancedMap();_this._shadow=null;_this._lastUpdate=-1000;_this._disposed=false;_this._figure=null;_this._gender=null;_this._direction=-1;_this._headDirection=-1;_this._posture='';_this._postureParameter='';_this._canStandUp=false;_this._postureOffset=0;_this._verticalOffset=0;_this._angle=-1;_this._headAngle=-1;_this._talk=false;_this._expression=0;_this._sleep=false;_this._blink=false;_this._gesture=0;_this._sign=-1;_this._highlightEnabled=false;_this._highlight=false;_this._dance=0;_this._effect=0;_this._carryObject=0;_this._useObject=0;_this._ownUser=false;_this._isLaying=false;_this._layInside=false;_this._isAnimating=false;_this._extraSpritesStartIndex=2;_this._forcedAnimFrames=0;_this._updatesUntilFrameUpdate=0;_this._isAvatarReady=false;_this._needsUpdate=false;_this._geometryUpdateCounter=-1;_this._additions=new Map();return _this;}_createClass(AvatarVisualization,[{key:\"initialize\",value:function initialize(data){if(!(data instanceof AvatarVisualizationData))return false;this._data=data;this.createSprites(AvatarVisualization.INITIAL_RESERVED_SPRITES);_get(_getPrototypeOf(AvatarVisualization.prototype),\"initialize\",this).call(this,data);return true;}},{key:\"dispose\",value:function dispose(){if(this._disposed)return;_get(_getPrototypeOf(AvatarVisualization.prototype),\"dispose\",this).call(this);if(this._avatarImage)this._avatarImage.dispose();this._shadow=null;this._disposed=true;}},{key:\"update\",value:function update(geometry,time,_update,skipUpdate){if(!this.object||!geometry||!this._data)return;if(time<this._lastUpdate+AvatarVisualization.UPDATE_TIME_INCREASER)return;this._lastUpdate+=AvatarVisualization.UPDATE_TIME_INCREASER;if(this._lastUpdate+AvatarVisualization.UPDATE_TIME_INCREASER<time)this._lastUpdate=time-AvatarVisualization.UPDATE_TIME_INCREASER;var model=this.object.model;var scale=geometry.scale;var effect=this._effect;var didScaleUpdate=false;var didEffectUpdate=false;var otherUpdate=false;var objectUpdate=false;var updateModel=this.updateModel(model,scale);if(updateModel||scale!==this._scale||!this._avatarImage){if(scale!==this._scale){didScaleUpdate=true;this.updateScale(scale);}if(effect!==this._effect)didEffectUpdate=true;if(didScaleUpdate||!this._avatarImage||didEffectUpdate){this._avatarImage=this.createAvatarImage(scale,this._effect);if(!this._avatarImage)return;otherUpdate=true;var sprite=this.getSprite(AvatarVisualization.AVATAR_LAYER_ID);if(sprite&&this._avatarImage&&this._avatarImage.isPlaceholder()){sprite.alpha=150;}else if(sprite){sprite.alpha=255;}}if(!this._avatarImage)return;if(didEffectUpdate&&this._avatarImage.animationHasResetOnToggle)this._avatarImage.resetAnimationFrameCounter();this.updateShadow(scale);objectUpdate=this.updateObject(this.object,geometry,_update,true);this.processActionsForAvatar(this._avatarImage);if(this._additions){var index=this._extraSpritesStartIndex;var _iterator=_createForOfIteratorHelper(this._additions.values()),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var addition=_step.value;addition.update(this.getSprite(index++),scale);}}catch(err){_iterator.e(err);}finally{_iterator.f();}}this._scale=scale;}else{objectUpdate=this.updateObject(this.object,geometry,_update);}if(this._additions){var _index=this._extraSpritesStartIndex;var _iterator2=_createForOfIteratorHelper(this._additions.values()),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _addition=_step2.value;if(_addition.animate(this.getSprite(_index++)))this.updateSpriteCounter++;}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}var update1=objectUpdate||updateModel||didScaleUpdate;var update2=(this._isAnimating||this._forcedAnimFrames>0)&&_update;if(update1)this._forcedAnimFrames=AvatarVisualization.ANIMATION_FRAME_UPDATE_INTERVAL;if(update1||update2){this.updateSpriteCounter++;this._forcedAnimFrames--;this._updatesUntilFrameUpdate--;if(this._updatesUntilFrameUpdate<=0||didScaleUpdate||updateModel||otherUpdate){this._avatarImage.updateAnimationByFrames(1);this._updatesUntilFrameUpdate=AvatarVisualization.ANIMATION_FRAME_UPDATE_INTERVAL;}else{return;}var _local_20=this._avatarImage.getCanvasOffsets();if(!_local_20||_local_20.length<3)_local_20=AvatarVisualization.DEFAULT_CANVAS_OFFSETS;var _sprite=this.getSprite(AvatarVisualization.SPRITE_INDEX_AVATAR);if(_sprite){var highlightEnabled=this.object.model.getValue(RoomObjectVariable.FIGURE_HIGHLIGHT_ENABLE)===1&&this.object.model.getValue(RoomObjectVariable.FIGURE_HIGHLIGHT)===1;var avatarImage=this._avatarImage.getImage(AvatarSetType.FULL,highlightEnabled);if(avatarImage){_sprite.texture=avatarImage;if(highlightEnabled){// sprite.filters  = [\n//     new GlowFilter({\n//         color: 0xFFFFFF,\n//         distance: 6\n//     })\n// ];\n}else{_sprite.filters=[];}}if(_sprite.texture){_sprite.offsetX=-1*scale/2+_local_20[0]-(_sprite.texture.width-scale)/2;_sprite.offsetY=-_sprite.texture.height+scale/4+_local_20[1]+this._postureOffset;}if(this._isLaying){if(this._layInside)_sprite.relativeDepth=-0.5;else _sprite.relativeDepth=AvatarVisualization.AVATAR_SPRITE_LAYING_DEPTH+_local_20[2];}else{_sprite.relativeDepth=AvatarVisualization.AVATAR_SPRITE_DEFAULT_DEPTH+_local_20[2];}if(this._ownUser){_sprite.relativeDepth-=AvatarVisualization.AVATAR_OWN_DEPTH_ADJUST;_sprite.spriteType=RoomObjectSpriteType.AVATAR_OWN;}else{_sprite.spriteType=RoomObjectSpriteType.AVATAR;}}var typingBubble=this.getAddition(AvatarVisualization.TYPING_BUBBLE_ID);if(typingBubble){if(!this._isLaying)typingBubble.relativeDepth=AvatarVisualization.AVATAR_SPRITE_DEFAULT_DEPTH-0.01+_local_20[2];else typingBubble.relativeDepth=AvatarVisualization.AVATAR_SPRITE_LAYING_DEPTH-0.01+_local_20[2];}this._isAnimating=this._avatarImage.isAnimating();var _local_21=AvatarVisualization.INITIAL_RESERVED_SPRITES;var direction=this._avatarImage.getDirection();var _iterator3=_createForOfIteratorHelper(this._avatarImage.getSprites()),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var spriteData=_step3.value;if(spriteData.id===AvatarVisualization.AVATAR){var _sprite2=this.getSprite(AvatarVisualization.SPRITE_INDEX_AVATAR);if(_sprite2){var layerData=this._avatarImage.getLayerData(spriteData);var offsetX=spriteData.getDirectionOffsetX(direction);var offsetY=spriteData.getDirectionOffsetY(direction);if(layerData){offsetX+=layerData.dx;offsetY+=layerData.dy;}if(scale<48){offsetX/=2;offsetY/=2;}if(!this._canStandUp){_sprite2.offsetX+=offsetX;_sprite2.offsetY+=offsetY;}}}else{var _sprite3=this.getSprite(_local_21);if(_sprite3){_sprite3.alphaTolerance=AlphaTolerance.MATCH_NOTHING;_sprite3.visible=true;var _layerData=this._avatarImage.getLayerData(spriteData);var frameNumber=0;var _offsetX=spriteData.getDirectionOffsetX(direction);var _offsetY=spriteData.getDirectionOffsetY(direction);var offsetZ=spriteData.getDirectionOffsetZ(direction);var dd=0;if(spriteData.hasDirections)dd=direction;if(_layerData){frameNumber=_layerData.animationFrame;_offsetX+=_layerData.dx;_offsetY+=_layerData.dy;dd+=_layerData.dd;}if(scale<48){_offsetX/=2;_offsetY/=2;}if(dd<0)dd+=8;else{if(dd>7)dd-=8;}var assetName=this._avatarImage.getScale()+'_'+spriteData.member+'_'+dd+'_'+frameNumber;var asset=this._avatarImage.getAsset(assetName);if(!asset)continue;_sprite3.texture=asset.texture;_sprite3.offsetX=asset.offsetX-scale/2+_offsetX;_sprite3.offsetY=asset.offsetY+_offsetY;_sprite3.flipH=asset.flipH;if(spriteData.hasStaticY){_sprite3.offsetY+=this._verticalOffset*scale/(2*AvatarVisualization.BASE_Y_SCALE);}else{_sprite3.offsetY+=this._postureOffset;}if(this._isLaying){_sprite3.relativeDepth=AvatarVisualization.AVATAR_SPRITE_LAYING_DEPTH-0.001*this.totalSprites*offsetZ;}else{_sprite3.relativeDepth=AvatarVisualization.AVATAR_SPRITE_DEFAULT_DEPTH-0.001*this.totalSprites*offsetZ;}if(spriteData.ink===33)_sprite3.blendMode=BLEND_MODES.ADD;else _sprite3.blendMode=BLEND_MODES.NORMAL;}_local_21++;}}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}}}},{key:\"createAvatarImage\",value:function createAvatarImage(scale,effectId){var cachedImage=null;var imageName='avatarImage'+scale.toString();if(!effectId){cachedImage=this._cachedAvatars.getValue(imageName);}else{imageName+='-'+effectId;cachedImage=this._cachedAvatarEffects.getValue(imageName);}if(!cachedImage){cachedImage=this._data.createAvatarImage(this._figure,scale,this._gender,this,this);if(cachedImage){if(!effectId){this._cachedAvatars.add(imageName,cachedImage);}else{if(this._cachedAvatarEffects.length>=AvatarVisualization.MAX_EFFECT_CACHE){var cached=this._cachedAvatarEffects.remove(this._cachedAvatarEffects.getKey(0));if(cached)cached.dispose();}this._cachedAvatarEffects.add(imageName,cachedImage);}}}return cachedImage;}},{key:\"updateObject\",value:function updateObject(object,geometry,update){var _arg_4=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(!_arg_4&&this.updateObjectCounter===object.updateCounter&&this._geometryUpdateCounter===geometry.updateId)return false;var direction=object.getDirection().x-geometry.direction.x;var headDirection=this._headDirection-geometry.direction.x;if(this._posture==='float')headDirection=direction;direction=(direction%360+360)%360;headDirection=(headDirection%360+360)%360;if(this._posture==='sit'&&this._canStandUp){direction-=direction%90-45;headDirection-=headDirection%90-45;}if(direction!==this._angle||_arg_4){update=true;this._angle=direction;direction=direction-(135-22.5);direction=(direction+360)%360;this._avatarImage.setDirectionAngle(AvatarSetType.FULL,direction);}if(headDirection!==this._headAngle||_arg_4){update=true;this._headAngle=headDirection;if(this._headAngle!==this._angle){headDirection=headDirection-(135-22.5);headDirection=(headDirection+360)%360;this._avatarImage.setDirectionAngle(AvatarSetType.HEAD,headDirection);}}this._geometryUpdateCounter=geometry.updateId;this.updateObjectCounter=this.object.updateCounter;return update;}},{key:\"updateModel\",value:function updateModel(model,scale){if(!model)return false;if(this.updateModelCounter===model.updateCounter)return false;var needsUpdate=false;var talk=model.getValue(RoomObjectVariable.FIGURE_TALK)>0;if(talk!==this._talk){this._talk=talk;needsUpdate=true;}var expression=model.getValue(RoomObjectVariable.FIGURE_EXPRESSION);if(expression!==this._expression){this._expression=expression;needsUpdate=true;}var sleep=model.getValue(RoomObjectVariable.FIGURE_SLEEP)>0;if(sleep!==this._sleep){this._sleep=sleep;needsUpdate=true;}var blink=model.getValue(RoomObjectVariable.FIGURE_BLINK)>0;if(blink!==this._blink){this._blink=blink;needsUpdate=true;}var gesture=model.getValue(RoomObjectVariable.FIGURE_GESTURE)||0;if(gesture!==this._gesture){this._gesture=gesture;needsUpdate=true;}var posture=model.getValue(RoomObjectVariable.FIGURE_POSTURE);if(posture!==this._posture){this._posture=posture;needsUpdate=true;}var postureParameter=model.getValue(RoomObjectVariable.FIGURE_POSTURE_PARAMETER);if(postureParameter!==this._postureParameter){this._postureParameter=postureParameter;needsUpdate=true;}var canStandUp=model.getValue(RoomObjectVariable.FIGURE_CAN_STAND_UP);if(canStandUp!==this._canStandUp){this._canStandUp=canStandUp;needsUpdate=true;}var verticalOffset=model.getValue(RoomObjectVariable.FIGURE_VERTICAL_OFFSET)*AvatarVisualization.BASE_Y_SCALE;if(verticalOffset!==this._verticalOffset){this._verticalOffset=verticalOffset;needsUpdate=true;}var dance=model.getValue(RoomObjectVariable.FIGURE_DANCE)||0;if(dance!==this._dance){this._dance=dance;needsUpdate=true;}var effect=model.getValue(RoomObjectVariable.FIGURE_EFFECT)||0;if(effect!==this._effect){this._effect=effect;needsUpdate=true;}var carryObject=model.getValue(RoomObjectVariable.FIGURE_CARRY_OBJECT)||0;if(carryObject!==this._carryObject){this._carryObject=carryObject;needsUpdate=true;}var useObject=model.getValue(RoomObjectVariable.FIGURE_USE_OBJECT)||0;if(useObject!==this._useObject){this._useObject=useObject;needsUpdate=true;}var headDirection=model.getValue(RoomObjectVariable.HEAD_DIRECTION);if(headDirection!==this._headDirection){this._headDirection=headDirection;needsUpdate=true;}if(this._carryObject>0&&useObject>0){if(this._useObject!==this._carryObject){this._useObject=this._carryObject;needsUpdate=true;}}else{if(this._useObject!==0){this._useObject=0;needsUpdate=true;}}var idleAddition=this.getAddition(AvatarVisualization.FLOATING_IDLE_Z_ID);if(this._sleep){if(!idleAddition)idleAddition=this.addAddition(new FloatingIdleZAddition(AvatarVisualization.FLOATING_IDLE_Z_ID,this));needsUpdate=true;}else{if(idleAddition)this.removeAddition(AvatarVisualization.FLOATING_IDLE_Z_ID);}var isMuted=model.getValue(RoomObjectVariable.FIGURE_IS_MUTED)>0;var mutedAddition=this.getAddition(AvatarVisualization.MUTED_BUBBLE_ID);if(isMuted){if(!mutedAddition)mutedAddition=this.addAddition(new MutedBubbleAddition(AvatarVisualization.MUTED_BUBBLE_ID,this));needsUpdate=true;}else{if(mutedAddition){this.removeAddition(AvatarVisualization.MUTED_BUBBLE_ID);needsUpdate=true;}var isTyping=model.getValue(RoomObjectVariable.FIGURE_IS_TYPING)>0;var typingAddition=this.getAddition(AvatarVisualization.TYPING_BUBBLE_ID);if(isTyping){if(!typingAddition)typingAddition=this.addAddition(new TypingBubbleAddition(AvatarVisualization.TYPING_BUBBLE_ID,this));needsUpdate=true;}else{if(typingAddition){this.removeAddition(AvatarVisualization.TYPING_BUBBLE_ID);needsUpdate=true;}}}var guideStatusValue=model.getValue(RoomObjectVariable.FIGURE_GUIDE_STATUS)||0;if(guideStatusValue!==AvatarGuideStatus.NONE){this.removeAddition(AvatarVisualization.GUIDE_BUBBLE_ID);this.addAddition(new GuideStatusBubbleAddition(AvatarVisualization.GUIDE_BUBBLE_ID,this,guideStatusValue));needsUpdate=true;}else{if(this.getAddition(AvatarVisualization.GUIDE_BUBBLE_ID)){this.removeAddition(AvatarVisualization.GUIDE_BUBBLE_ID);needsUpdate=true;}}var isPlayingGame=model.getValue(RoomObjectVariable.FIGURE_IS_PLAYING_GAME)>0;var gameClickAddition=this.getAddition(AvatarVisualization.GAME_CLICK_TARGET_ID);if(isPlayingGame){if(!gameClickAddition)gameClickAddition=this.addAddition(new GameClickTargetAddition(AvatarVisualization.GAME_CLICK_TARGET_ID));needsUpdate=true;}else{if(gameClickAddition)this.removeAddition(AvatarVisualization.GAME_CLICK_TARGET_ID);}var numberValue=model.getValue(RoomObjectVariable.FIGURE_NUMBER_VALUE);var numberAddition=this.getAddition(AvatarVisualization.NUMBER_BUBBLE_ID);if(numberValue>0){if(!numberAddition)numberAddition=this.addAddition(new NumberBubbleAddition(AvatarVisualization.NUMBER_BUBBLE_ID,numberValue,this));needsUpdate=true;}else{if(numberAddition)this.removeAddition(AvatarVisualization.NUMBER_BUBBLE_ID);}var expressionAddition=this.getAddition(AvatarVisualization.EXPRESSION_ID);if(this._expression>0){if(!expressionAddition){expressionAddition=ExpressionAdditionFactory.getExpressionAddition(AvatarVisualization.EXPRESSION_ID,this._expression,this);if(expressionAddition)this.addAddition(expressionAddition);}}else{if(expressionAddition)this.removeAddition(AvatarVisualization.EXPRESSION_ID);}this.updateScale(scale);var gender=model.getValue(RoomObjectVariable.GENDER);if(gender!==this._gender){this._gender=gender;needsUpdate=true;}if(this.updateFigure(model.getValue(RoomObjectVariable.FIGURE)))needsUpdate=true;var sign=model.getValue(RoomObjectVariable.FIGURE_SIGN);if(sign===null)sign=-1;if(this._sign!==sign){this._sign=sign;needsUpdate=true;}var highlightEnabled=model.getValue(RoomObjectVariable.FIGURE_HIGHLIGHT_ENABLE)>0;if(highlightEnabled!==this._highlightEnabled){this._highlightEnabled=highlightEnabled;needsUpdate=true;}if(this._highlightEnabled){var highlight=model.getValue(RoomObjectVariable.FIGURE_HIGHLIGHT)>0;if(highlight!==this._highlight){this._highlight=highlight;needsUpdate=true;}}var ownUser=model.getValue(RoomObjectVariable.OWN_USER)>0;if(ownUser!==this._ownUser){this._ownUser=ownUser;needsUpdate=true;}this.updateModelCounter=model.updateCounter;return needsUpdate;}},{key:\"setDirection\",value:function setDirection(direction){if(this._direction===direction)return;this._direction=direction;this._needsUpdate=true;}},{key:\"updateScale\",value:function updateScale(scale){if(scale<48)this._blink=false;if(this._posture==='sit'||this._posture==='lay'){this._postureOffset=scale/2;}else{this._postureOffset=0;}this._layInside=false;this._isLaying=false;if(this._posture==='lay'){this._isLaying=true;var _local_2=parseInt(this._postureParameter);if(_local_2<0)this._layInside=true;}}},{key:\"processActionsForAvatar\",value:function processActionsForAvatar(avatar){if(!avatar)return;avatar.initActionAppends();avatar.appendAction(AvatarAction.POSTURE,this._posture,this._postureParameter);if(this._gesture>0)this._avatarImage.appendAction(AvatarAction.GESTURE,AvatarAction.getGesture(this._gesture));if(this._dance>0)this._avatarImage.appendAction(AvatarAction.DANCE,this._dance);if(this._sign>-1)this._avatarImage.appendAction(AvatarAction.SIGN,this._sign);if(this._carryObject>0)this._avatarImage.appendAction(AvatarAction.CARRY_OBJECT,this._carryObject);if(this._useObject>0)this._avatarImage.appendAction(AvatarAction.USE_OBJECT,this._useObject);if(this._talk)this._avatarImage.appendAction(AvatarAction.TALK);if(this._sleep||this._blink)this._avatarImage.appendAction(AvatarAction.SLEEP);if(this._expression>0){var expression=AvatarAction.getExpression(this._expression);if(expression!==''){switch(expression){case AvatarAction.DANCE:this._avatarImage.appendAction(AvatarAction.DANCE,2);break;default:this._avatarImage.appendAction(expression);break;}}}if(this._effect>0)this._avatarImage.appendAction(AvatarAction.EFFECT,this._effect);avatar.endActionAppends();this._isAnimating=avatar.isAnimating();var spriteCount=AvatarVisualization.INITIAL_RESERVED_SPRITES;var _iterator4=_createForOfIteratorHelper(this._avatarImage.getSprites()),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var sprite=_step4.value;if(sprite.id!==AvatarVisualization.AVATAR)spriteCount++;}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}if(spriteCount!==this.totalSprites)this.createSprites(spriteCount);this._extraSpritesStartIndex=spriteCount;if(this._additions){var _iterator5=_createForOfIteratorHelper(this._additions.values()),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var addition=_step5.value;this.createSprite();}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}}}},{key:\"updateFigure\",value:function updateFigure(figure){if(this._figure===figure)return false;this._figure=figure;this.clearAvatar();return true;}},{key:\"resetFigure\",value:function resetFigure(figure){this.clearAvatar();}},{key:\"resetEffect\",value:function resetEffect(effect){this.clearAvatar();}},{key:\"clearAvatar\",value:function clearAvatar(){var _iterator6=_createForOfIteratorHelper(this._cachedAvatars.getValues()),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var avatar=_step6.value;avatar&&avatar.dispose();}}catch(err){_iterator6.e(err);}finally{_iterator6.f();}var _iterator7=_createForOfIteratorHelper(this._cachedAvatarEffects.getValues()),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var _avatar=_step7.value;_avatar&&_avatar.dispose();}}catch(err){_iterator7.e(err);}finally{_iterator7.f();}this._cachedAvatars.reset();this._cachedAvatarEffects.reset();this._avatarImage=null;var sprite=this.getSprite(AvatarVisualization.AVATAR_LAYER_ID);if(sprite){sprite.texture=Texture.EMPTY;sprite.alpha=255;}}},{key:\"getAddition\",value:function getAddition(id){if(!this._additions)return null;var existing=this._additions.get(id);if(!existing)return null;return existing;}},{key:\"addAddition\",value:function addAddition(addition){var existing=this.getAddition(addition.id);if(existing)return;this._additions.set(addition.id,addition);return addition;}},{key:\"removeAddition\",value:function removeAddition(id){var addition=this.getAddition(id);if(!addition)return;this._additions.delete(addition.id);addition.dispose();}},{key:\"updateShadow\",value:function updateShadow(scale){this._shadow=null;var sprite=this.getSprite(AvatarVisualization.SHADOW_LAYER_ID);if(!sprite)return;var hasShadow=this._posture==='mv'||this._posture==='std'||this._posture==='sit'&&this._canStandUp;if(this._effect===AvatarVisualization.SNOWBOARDING_EFFECT)hasShadow=false;if(hasShadow){sprite.visible=true;if(!this._shadow||scale!==this._scale){var offsetX=0;var offsetY=0;if(scale<48){sprite.libraryAssetName='sh_std_sd_1_0_0';this._shadow=this._avatarImage.getAsset(sprite.libraryAssetName);offsetX=-8;offsetY=this._canStandUp?6:-3;}else{sprite.libraryAssetName='h_std_sd_1_0_0';this._shadow=this._avatarImage.getAsset(sprite.libraryAssetName);offsetX=-17;offsetY=this._canStandUp?10:-7;}if(this._shadow){sprite.texture=this._shadow.texture;sprite.offsetX=offsetX;sprite.offsetY=offsetY;sprite.alpha=50;sprite.relativeDepth=1;}else{sprite.visible=false;}}}else{this._shadow=null;sprite.visible=false;}}},{key:\"getAvatarRenderAsset\",value:function getAvatarRenderAsset(name){return this._data?this._data.getAvatarRendererAsset(name):null;}},{key:\"direction\",get:function get(){return this._direction;}},{key:\"posture\",get:function get(){return this._posture;}},{key:\"angle\",get:function get(){return this._angle;}},{key:\"disposed\",get:function get(){return this._disposed;}}]);return AvatarVisualization;}(RoomObjectSpriteVisualization);AvatarVisualization.AVATAR='avatar';AvatarVisualization.FLOATING_IDLE_Z_ID=1;AvatarVisualization.TYPING_BUBBLE_ID=2;AvatarVisualization.EXPRESSION_ID=3;AvatarVisualization.NUMBER_BUBBLE_ID=4;AvatarVisualization.GAME_CLICK_TARGET_ID=5;AvatarVisualization.MUTED_BUBBLE_ID=6;AvatarVisualization.GUIDE_BUBBLE_ID=7;AvatarVisualization.OWN_USER_ID=4;AvatarVisualization.UPDATE_TIME_INCREASER=41;AvatarVisualization.AVATAR_LAYER_ID=0;AvatarVisualization.SHADOW_LAYER_ID=1;AvatarVisualization.SNOWBOARDING_EFFECT=97;AvatarVisualization.INITIAL_RESERVED_SPRITES=2;AvatarVisualization.ANIMATION_FRAME_UPDATE_INTERVAL=2;AvatarVisualization.DEFAULT_CANVAS_OFFSETS=[0,0,0];AvatarVisualization.MAX_EFFECT_CACHE=2;AvatarVisualization.SPRITE_INDEX_AVATAR=0;AvatarVisualization.BASE_Y_SCALE=1000;AvatarVisualization.AVATAR_SPRITE_DEFAULT_DEPTH=-0.01;AvatarVisualization.AVATAR_OWN_DEPTH_ADJUST=0.001;AvatarVisualization.AVATAR_SPRITE_LAYING_DEPTH=-0.409;","map":null,"metadata":{},"sourceType":"module"}