{"ast":null,"code":"import _toConsumableArray from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _createForOfIteratorHelper from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Luis/Downloads/Habboom/Nitro-Edit/node_modules/@babel/runtime/helpers/esm/createClass.js\";import{NitroContainer,NitroTexture}from'../../..';import{NitroSprite}from'../../../core/utils/proxy/NitroSprite';import{GroupBadgePartsEvent}from'../../communication/messages/incoming/group/GroupBadgePartsEvent';import{Nitro}from'../../Nitro';import{BadgeImageReadyEvent}from'../events/BadgeImageReadyEvent';import{TextureUtils}from'./../../../room/utils/TextureUtils';import{BadgeInfo}from'./BadgeInfo';import{GroupBadge}from'./GroupBadge';import{GroupBadgePart}from'./GroupBadgePart';export var BadgeImageManager=/*#__PURE__*/function(){function BadgeImageManager(assetManager,sessionDataManager){_classCallCheck(this,BadgeImageManager);this._assets=void 0;this._sessionDataManager=void 0;this._messages=void 0;this._groupBases=void 0;this._groupSymbols=void 0;this._groupPartColors=void 0;this._requestedBadges=void 0;this._groupBadgesQueue=void 0;this._readyToGenerateGroupBadges=void 0;this._assets=assetManager;this._sessionDataManager=sessionDataManager;this._groupBases=new Map();this._groupSymbols=new Map();this._groupPartColors=new Map();this._requestedBadges=new Map();this._groupBadgesQueue=new Map();this._readyToGenerateGroupBadges=false;}_createClass(BadgeImageManager,[{key:\"init\",value:function init(){if(this._sessionDataManager&&this._sessionDataManager.communication){this._messages=[new GroupBadgePartsEvent(this.onGroupBadgePartsEvent.bind(this))];var _iterator=_createForOfIteratorHelper(this._messages),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var message=_step.value;this._sessionDataManager.communication.registerMessageEvent(message);}//this._sessionDataManager.send(new GroupBadgePartsComposer());\n}catch(err){_iterator.e(err);}finally{_iterator.f();}}}},{key:\"dispose\",value:function dispose(){if(this._messages&&this._messages.length){var _iterator2=_createForOfIteratorHelper(this._messages),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var message=_step2.value;this._sessionDataManager.communication.removeMessageEvent(message);}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}this._messages=null;}this._sessionDataManager=null;}},{key:\"getBadgeImage\",value:function getBadgeImage(badgeName){var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:BadgeImageManager.NORMAL_BADGE;var load=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var badge=this.getBadgeTexture(badgeName,type);if(!badge&&load)badge=this.getBadgePlaceholder();return badge;}},{key:\"getBadgeInfo\",value:function getBadgeInfo(k){var badge=this.getBadgeTexture(k);return badge?new BadgeInfo(badge,false):new BadgeInfo(this.getBadgePlaceholder(),true);}},{key:\"loadBadgeImage\",value:function loadBadgeImage(badgeName){var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:BadgeImageManager.NORMAL_BADGE;if(this._assets.getTexture(this.getBadgeUrl(badgeName,type)))return badgeName;this.getBadgeTexture(badgeName,type);return null;}},{key:\"getBadgeTexture\",value:function getBadgeTexture(badgeName){var _this=this;var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:BadgeImageManager.NORMAL_BADGE;var url=this.getBadgeUrl(badgeName,type);if(!url||!url.length)return null;var existing=this._assets.getTexture(url);if(existing)return existing.clone();if(type===BadgeImageManager.NORMAL_BADGE){if(this._requestedBadges.get(badgeName))return null;this._requestedBadges.set(badgeName,true);this._assets.downloadAsset(url,function(flag){if(flag){_this._requestedBadges.delete(badgeName);var texture=_this._assets.getTexture(url);if(texture&&_this._sessionDataManager)_this._sessionDataManager.events.dispatchEvent(new BadgeImageReadyEvent(badgeName,texture.clone()));}});}else if(type===BadgeImageManager.GROUP_BADGE){if(this._groupBadgesQueue.get(badgeName))return;this._groupBadgesQueue.set(badgeName,true);if(this._readyToGenerateGroupBadges)this.loadGroupBadge(badgeName);}return null;}},{key:\"getBadgePlaceholder\",value:function getBadgePlaceholder(){var url=Nitro.instance.getConfiguration('images.url')+'/loading_icon.png';var existing=this._assets.getTexture(url);if(!existing)return null;return existing.clone();}},{key:\"getBadgeUrl\",value:function getBadgeUrl(badge){var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:BadgeImageManager.NORMAL_BADGE;var url=null;switch(type){case BadgeImageManager.NORMAL_BADGE:url=Nitro.instance.getConfiguration('badge.asset.url').replace('%badgename%',badge);break;case BadgeImageManager.GROUP_BADGE:url=badge;break;}return url;}},{key:\"loadGroupBadge\",value:function loadGroupBadge(badgeCode){var groupBadge=new GroupBadge(badgeCode);var partMatches=_toConsumableArray(badgeCode.matchAll(/[b|s][0-9]{4,6}/g));var _iterator3=_createForOfIteratorHelper(partMatches),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var partMatch=_step3.value;var partCode=partMatch[0];var shortMethod=partCode.length===6;var partType=partCode[0];var partId=parseInt(partCode.slice(1,shortMethod?3:4));var partColor=parseInt(partCode.slice(shortMethod?3:4,shortMethod?5:6));var partPosition=partCode.length<6?0:parseInt(partCode.slice(shortMethod?5:6,shortMethod?6:7));// sometimes position is ommitted \nvar part=new GroupBadgePart(partType,partId,partColor,partPosition);groupBadge.parts.push(part);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}this.renderGroupBadge(groupBadge);}},{key:\"renderGroupBadge\",value:function renderGroupBadge(groupBadge){var container=new NitroContainer();var tempSprite=new NitroSprite(NitroTexture.EMPTY);tempSprite.width=GroupBadgePart.IMAGE_WIDTH;tempSprite.height=GroupBadgePart.IMAGE_HEIGHT;container.addChild(tempSprite);var _iterator4=_createForOfIteratorHelper(groupBadge.parts),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var part=_step4.value;var isFirst=true;var partNames=part.type==='b'?this._groupBases.get(part.key):this._groupSymbols.get(part.key);if(partNames){var _iterator5=_createForOfIteratorHelper(partNames),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var partName=_step5.value;if(!partName||!partName.length)continue;var _texture=this._assets.getTexture(\"badgepart_\".concat(partName));if(!_texture)continue;var _part$calculatePositi=part.calculatePosition(_texture),x=_part$calculatePositi.x,y=_part$calculatePositi.y;var sprite=new NitroSprite(_texture);sprite.position.set(x,y);if(isFirst)sprite.tint=parseInt(this._groupPartColors.get(part.color),16);isFirst=false;container.addChild(sprite);}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}}}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}this._requestedBadges.delete(groupBadge.code);this._groupBadgesQueue.delete(groupBadge.code);var texture=TextureUtils.generateTexture(container);this._assets.setTexture(groupBadge.code,texture);if(this._sessionDataManager)this._sessionDataManager.events.dispatchEvent(new BadgeImageReadyEvent(groupBadge.code,texture));}},{key:\"onGroupBadgePartsEvent\",value:function onGroupBadgePartsEvent(event){var _this2=this;if(!event)return;var data=event.getParser();if(!data)return;data.bases.forEach(function(names,id){return _this2._groupBases.set(id,names.map(function(val){return val.replace('.png','').replace('.gif','');}));});data.symbols.forEach(function(names,id){return _this2._groupSymbols.set(id,names.map(function(val){return val.replace('.png','').replace('.gif','');}));});this._groupPartColors=data.partColors;this._readyToGenerateGroupBadges=true;var _iterator6=_createForOfIteratorHelper(this._groupBadgesQueue.keys()),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var badgeCode=_step6.value;this.loadGroupBadge(badgeCode);}}catch(err){_iterator6.e(err);}finally{_iterator6.f();}}},{key:\"disposed\",get:function get(){return!!this._sessionDataManager;}}]);return BadgeImageManager;}();BadgeImageManager.GROUP_BADGE='group_badge';BadgeImageManager.NORMAL_BADGE='normal_badge';","map":null,"metadata":{},"sourceType":"module"}