{"ast":null,"code":"import _createForOfIteratorHelper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";import _classCallCheck from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _get from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/get.js\";import _getPrototypeOf from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js\";import _inherits from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"C:/Users/Administrator/Desktop/nitro/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import{EventDispatcher}from'../../core/events/EventDispatcher';import{AvatarActionManager}from'./actions/AvatarActionManager';import{AnimationManager}from'./animation/AnimationManager';import{AvatarImagePartContainer}from'./AvatarImagePartContainer';import{AvatarDirectionAngle}from'./enum/AvatarDirectionAngle';import{AvatarModelGeometry}from'./geometry/AvatarModelGeometry';import{AnimationAction}from'./structure/animation/AnimationAction';import{AvatarAnimationData}from'./structure/AvatarAnimationData';import{FigureSetData}from'./structure/FigureSetData';import{PartSetsData}from'./structure/PartSetsData';export var AvatarStructure=/*#__PURE__*/function(_EventDispatcher){_inherits(AvatarStructure,_EventDispatcher);var _super=_createSuper(AvatarStructure);function AvatarStructure(renderManager){var _this;_classCallCheck(this,AvatarStructure);_this=_super.call(this);_this._renderManager=void 0;_this._geometry=void 0;_this._figureData=void 0;_this._partSetsData=void 0;_this._animationData=void 0;_this._animationManager=void 0;_this._mandatorySetTypeIds=void 0;_this._actionManager=void 0;_this._defaultAction=void 0;_this._renderManager=renderManager;_this._geometry=null;_this._figureData=new FigureSetData();_this._partSetsData=new PartSetsData();_this._animationData=new AvatarAnimationData();_this._animationManager=new AnimationManager();_this._mandatorySetTypeIds={};_this._actionManager=null;_this._defaultAction=null;return _this;}_createClass(AvatarStructure,[{key:\"init\",value:function init(){}},{key:\"dispose\",value:function dispose(){if(this.disposed)return;_get(_getPrototypeOf(AvatarStructure.prototype),\"dispose\",this).call(this);this._renderManager=null;this._figureData=null;this._partSetsData=null;this._animationData=null;this._mandatorySetTypeIds=null;}},{key:\"initGeometry\",value:function initGeometry(k){if(!k)return;this._geometry=new AvatarModelGeometry(k);}},{key:\"initActions\",value:function initActions(k,_arg_2){if(!_arg_2)return;this._actionManager=new AvatarActionManager(k,_arg_2);this._defaultAction=this._actionManager.getDefaultAction();}},{key:\"updateActions\",value:function updateActions(data){this._actionManager.updateActions(data);this._defaultAction=this._actionManager.getDefaultAction();}},{key:\"initPartSets\",value:function initPartSets(k){if(!k)return false;if(this._partSetsData.parse(k)){this._partSetsData.getPartDefinition('ri').appendToFigure=true;this._partSetsData.getPartDefinition('li').appendToFigure=true;return true;}return false;}},{key:\"initAnimation\",value:function initAnimation(k){if(!k)return false;return this._animationData.parse(k);}},{key:\"initFigureData\",value:function initFigureData(k){if(!k)return false;return this._figureData.parse(k);}},{key:\"injectFigureData\",value:function injectFigureData(data){this._figureData.injectJSON(data);}},{key:\"registerAnimations\",value:function registerAnimations(k){var _arg_2=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'fx';var _arg_3=arguments.length>2&&arguments[2]!==undefined?arguments[2]:200;var index=0;while(index<_arg_3){var collection=k.getCollection(_arg_2+index);if(collection){var animationData=collection.data;this._animationManager.registerAnimation(this,animationData.animations);}index++;}}},{key:\"registerAnimation\",value:function registerAnimation(data){this._animationManager.registerAnimation(this,data);}},{key:\"getPartColor\",value:function getPartColor(k,_arg_2){var _arg_3=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var _local_4=k.getPartColorIds(_arg_2);if(!_local_4||_local_4.length<_arg_3)return null;var _local_5=this._figureData.getSetType(_arg_2);if(_local_5==null)return null;var _local_6=this._figureData.getPalette(_local_5.paletteID);if(!_local_6)return null;return _local_6.getColor(_local_4[_arg_3]);}},{key:\"getBodyPartData\",value:function getBodyPartData(animation,frameCount,spriteId){return this._animationManager.getLayerData(animation,frameCount,spriteId);}},{key:\"getAnimation\",value:function getAnimation(k){return this._animationManager.getAnimation(k);}},{key:\"getActionDefinition\",value:function getActionDefinition(k){return this._actionManager.getActionDefinition(k);}},{key:\"getActionDefinitionWithState\",value:function getActionDefinitionWithState(k){return this._actionManager.getActionDefinitionWithState(k);}},{key:\"isMainAvatarSet\",value:function isMainAvatarSet(k){return this._geometry.isMainAvatarSet(k);}},{key:\"sortActions\",value:function sortActions(k){return this._actionManager.sortActions(k);}},{key:\"maxFrames\",value:function maxFrames(k){var _local_2=0;var _iterator=_createForOfIteratorHelper(k),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var _local_3=_step.value;_local_2=Math.max(_local_2,this._animationData.getFrameCount(_local_3.definition));}}catch(err){_iterator.e(err);}finally{_iterator.f();}return _local_2;}},{key:\"getMandatorySetTypeIds\",value:function getMandatorySetTypeIds(k,_arg_2){if(!this._mandatorySetTypeIds[k]){this._mandatorySetTypeIds[k]=[];}if(this._mandatorySetTypeIds[k][_arg_2]){return this._mandatorySetTypeIds[k][_arg_2];}this._mandatorySetTypeIds[k][_arg_2]=this._figureData.getMandatorySetTypeIds(k,_arg_2);return this._mandatorySetTypeIds[k][_arg_2];}},{key:\"getDefaultPartSet\",value:function getDefaultPartSet(k,_arg_2){return this._figureData.getDefaultPartSet(k,_arg_2);}},{key:\"getCanvasOffsets\",value:function getCanvasOffsets(k,_arg_2,_arg_3){return this._actionManager.getCanvasOffsets(k,_arg_2,_arg_3);}},{key:\"getCanvas\",value:function getCanvas(k,_arg_2){return this._geometry.getCanvas(k,_arg_2);}},{key:\"removeDynamicItems\",value:function removeDynamicItems(k){this._geometry.removeDynamicItems(k);}},{key:\"getActiveBodyPartIds\",value:function getActiveBodyPartIds(k,_arg_2){var _local_3=[];var _local_4=[];var _local_5=k.definition.geometryType;if(k.definition.isAnimation){var _local_7=k.definition.state+'.'+k.actionParameter;var _local_8=this._animationManager.getAnimation(_local_7);if(_local_8){_local_3=_local_8.getAnimatedBodyPartIds(0,k.overridingAction);if(_local_8.hasAddData()){var _local_11={id:'',x:0,y:0,z:0,radius:0.01,nx:0,ny:0,nz:-1,double:1};var _local_12={setType:''};var _iterator2=_createForOfIteratorHelper(_local_8.addData),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var _local_13=_step2.value;var _local_6=this._geometry.getBodyPart(_local_5,_local_13.align);if(_local_6){_local_11.id=_local_13.id;_local_6.addPart(_local_11,_arg_2);_local_12.setType=_local_13.id;var _local_10=this._partSetsData.addPartDefinition(_local_12);_local_10.appendToFigure=true;if(_local_13.base==='')_local_10.staticId=1;if(_local_4.indexOf(_local_6.id)===-1)_local_4.push(_local_6.id);}}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}}}var _iterator3=_createForOfIteratorHelper(_local_3),_step3;try{for(_iterator3.s();!(_step3=_iterator3.n()).done;){var _local_9=_step3.value;var _local_=this._geometry.getBodyPart(_local_5,_local_9);if(_local_&&_local_4.indexOf(_local_.id)===-1)_local_4.push(_local_.id);}}catch(err){_iterator3.e(err);}finally{_iterator3.f();}}else{_local_3=this._partSetsData.getActiveParts(k.definition);var _iterator4=_createForOfIteratorHelper(_local_3),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _local_14=_step4.value;var _local_49=this._geometry.getBodyPartOfItem(_local_5,_local_14,_arg_2);if(_local_49&&_local_4.indexOf(_local_49.id)===-1)_local_4.push(_local_49.id);}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}}return _local_4;}},{key:\"getBodyPartsUnordered\",value:function getBodyPartsUnordered(k){return this._geometry.getBodyPartIdsInAvatarSet(k);}},{key:\"getBodyParts\",value:function getBodyParts(k,_arg_2,_arg_3){var _local_4=AvatarDirectionAngle.DIRECTION_TO_ANGLE[_arg_3];return this._geometry.getBodyPartsAtAngle(k,_local_4,_arg_2);}},{key:\"getFrameBodyPartOffset\",value:function getFrameBodyPartOffset(k,_arg_2,_arg_3,_arg_4){var _local_5=this._animationData.getAction(k.definition);if(_local_5)return _local_5.getFrameBodyPartOffset(_arg_2,_arg_3,_arg_4);return AnimationAction.DEFAULT_OFFSET;}},{key:\"getParts\",value:function getParts(k,_arg_2,_arg_3,_arg_4,_arg_5,removes,_arg_7){var _arg_8=arguments.length>7&&arguments[7]!==undefined?arguments[7]:null;var _local_10=null;var _local_34=null;var _local_20=[];var _local_36=null;if(!_arg_3==null)return[];var _local_9=this._partSetsData.getActiveParts(_arg_3.definition);var _local_11=[];var _local_14=[0];var _local_15=this._animationData.getAction(_arg_3.definition);if(_arg_3.definition.isAnimation){var _local_24=_arg_3.definition.state+'.'+_arg_3.actionParameter;var _local_50=this._animationManager.getAnimation(_local_24);if(_local_50){_local_14=this.getPopulatedArray(_local_50.frameCount(_arg_3.overridingAction));var _iterator5=_createForOfIteratorHelper(_local_50.getAnimatedBodyPartIds(0,_arg_3.overridingAction)),_step5;try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){var _local_25=_step5.value;if(_local_25===k){var _local_26=this._geometry.getBodyPart(_arg_4,_local_25);if(_local_26){var _iterator6=_createForOfIteratorHelper(_local_26.getDynamicParts(_arg_7)),_step6;try{for(_iterator6.s();!(_step6=_iterator6.n()).done;){var _local_27=_step6.value;_local_9.push(_local_27.id);}}catch(err){_iterator6.e(err);}finally{_iterator6.f();}}}}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}}}var _local_16=this._geometry.getParts(_arg_4,k,_arg_5,_local_9,_arg_7);var _local_21=_arg_2.getPartTypeIds();var _iterator7=_createForOfIteratorHelper(_local_21),_step7;try{for(_iterator7.s();!(_step7=_iterator7.n()).done;){var _local_17=_step7.value;if(_arg_8){if(_arg_8.get(_local_17))continue;}var _local_28=_arg_2.getPartSetId(_local_17);var _local_29=_arg_2.getPartColorIds(_local_17);var _local_30=this._figureData.getSetType(_local_17);if(_local_30){var _local_31=this._figureData.getPalette(_local_30.paletteID);if(_local_31){var _local_32=_local_30.getPartSet(_local_28);if(_local_32){removes=removes.concat(_local_32.hiddenLayers);var _iterator9=_createForOfIteratorHelper(_local_32.parts),_step9;try{for(_iterator9.s();!(_step9=_iterator9.n()).done;){var _local_33=_step9.value;if(_local_16.indexOf(_local_33.type)>-1){if(_local_15){var _local_19=_local_15.getPart(_local_33.type);if(_local_19){_local_20=_local_19.frames;}else{_local_20=_local_14;}}else{_local_20=_local_14;}_local_34=_arg_3.definition;if(_local_9.indexOf(_local_33.type)===-1)_local_34=this._defaultAction;var _local_13=this._partSetsData.getPartDefinition(_local_33.type);var _local_35=!_local_13?_local_33.type:_local_13.flippedSetType;if(!_local_35||_local_35==='')_local_35=_local_33.type;if(_local_29&&_local_29.length>_local_33.colorLayerIndex-1){_local_36=_local_31.getColor(_local_29[_local_33.colorLayerIndex-1]);}var _local_37=_local_33.colorLayerIndex>0;var _local_18=new AvatarImagePartContainer(k,_local_33.type,_local_33.id.toString(),_local_36,_local_20,_local_34,_local_37,_local_33.paletteMap,_local_35);_local_11.push(_local_18);}}}catch(err){_iterator9.e(err);}finally{_iterator9.f();}}}}}}catch(err){_iterator7.e(err);}finally{_iterator7.f();}var _local_22=[];var _iterator8=_createForOfIteratorHelper(_local_16),_step8;try{for(_iterator8.s();!(_step8=_iterator8.n()).done;){var _local_12=_step8.value;var _local_39=null;var _local_38=false;var _local_40=_arg_8&&_arg_8.get(_local_12);var _iterator10=_createForOfIteratorHelper(_local_11),_step10;try{for(_iterator10.s();!(_step10=_iterator10.n()).done;){var _local_23=_step10.value;if(_local_23.partType===_local_12){if(_local_40){_local_39=_local_23.color;}else{_local_38=true;if(removes.indexOf(_local_12)===-1)_local_22.push(_local_23);}}}}catch(err){_iterator10.e(err);}finally{_iterator10.f();}if(!_local_38){if(_local_40){var _local_41=_arg_8.get(_local_12);var _local_42=0;var _local_43=0;while(_local_43<_local_41.length){_local_42=_local_42+_local_41.charCodeAt(_local_43);_local_43++;}if(_local_15){var _local_52=_local_15.getPart(_local_12);if(_local_52){_local_20=_local_52.frames;}else{_local_20=_local_14;}}else{_local_20=_local_14;}var _local_51=new AvatarImagePartContainer(k,_local_12,_local_41,_local_39,_local_20,_arg_3.definition,!(_local_39==null),-1,_local_12,false,1);_local_22.push(_local_51);}else{if(_local_9.indexOf(_local_12)>-1){var _local_44=this._geometry.getBodyPartOfItem(_arg_4,_local_12,_arg_7);if(k!==_local_44.id){//\n}else{var _local_53=this._partSetsData.getPartDefinition(_local_12);var _local_45=false;var _local_46=1;if(_local_53.appendToFigure){var _local_47='1';if(_arg_3.actionParameter!==''){_local_47=_arg_3.actionParameter;}if(_local_53.hasStaticId()){_local_47=_local_53.staticId.toString();}if(_local_10!=null){var _local_48=_local_10.getAddData(_local_12);if(_local_48){_local_45=_local_48.isBlended;_local_46=_local_48.blend;}}if(_local_15){var _local_55=_local_15.getPart(_local_12);if(_local_55){_local_20=_local_55.frames;}else{_local_20=_local_14;}}else{_local_20=_local_14;}var _local_54=new AvatarImagePartContainer(k,_local_12,_local_47,null,_local_20,_arg_3.definition,false,-1,_local_12,_local_45,_local_46);_local_22.push(_local_54);}}}}}}}catch(err){_iterator8.e(err);}finally{_iterator8.f();}return _local_22;}},{key:\"getPopulatedArray\",value:function getPopulatedArray(k){var _local_2=[];var index=0;while(index<k){_local_2.push(index);index++;}return _local_2;}},{key:\"getItemIds\",value:function getItemIds(){if(this._actionManager){var k=this._actionManager.getActionDefinition('CarryItem').params;var _local_2=[];var _iterator11=_createForOfIteratorHelper(k.values()),_step11;try{for(_iterator11.s();!(_step11=_iterator11.n()).done;){var _local_3=_step11.value;_local_2.push(_local_3);}}catch(err){_iterator11.e(err);}finally{_iterator11.f();}return _local_2;}return[];}},{key:\"renderManager\",get:function get(){return this._renderManager;}},{key:\"figureData\",get:function get(){return this._figureData;}},{key:\"partData\",get:function get(){return this._partSetsData;}},{key:\"animationManager\",get:function get(){return this._animationManager;}}]);return AvatarStructure;}(EventDispatcher);","map":null,"metadata":{},"sourceType":"module"}