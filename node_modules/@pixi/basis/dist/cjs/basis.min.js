/*!
 * @pixi/basis - v6.3.0
 * Compiled Wed, 23 Mar 2022 18:58:56 UTC
 *
 * @pixi/basis is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _a,_b,_c,loaders=require("@pixi/loaders"),constants=require("@pixi/constants"),core=require("@pixi/core"),compressedTextures=require("@pixi/compressed-textures"),runner=require("@pixi/runner");function __awaiter(e,r,t,s){return new(t||(t=Promise))(function(n,o){function a(e){try{i(s.next(e))}catch(e){o(e)}}function c(e){try{i(s.throw(e))}catch(e){o(e)}}function i(e){e.done?n(e.value):new t(function(r){r(e.value)}).then(a,c)}i((s=s.apply(e,r||[])).next())})}function __generator(e,r){var t,s,n,o,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(o){return function(c){return function(o){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,s&&(n=2&o[0]?s.return:o[0]?s.throw||((n=s.return)&&n.call(s),0):s.next)&&!(n=n.call(s,o[1])).done)return n;switch(s=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,s=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(n=(n=a.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){a.label=o[1];break}if(6===o[0]&&a.label<n[1]){a.label=n[1],n=o;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(o);break}n[2]&&a.ops.pop(),a.trys.pop();continue}o=r.call(e,a)}catch(e){o=[6,e],s=0}finally{t=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}}!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444"}(exports.BASIS_FORMATS||(exports.BASIS_FORMATS={}));var BASIS_FORMAT_TO_INTERNAL_FORMAT=((_a={})[exports.BASIS_FORMATS.cTFETC1]=compressedTextures.INTERNAL_FORMATS.COMPRESSED_RGB_ETC1_WEBGL,_a[exports.BASIS_FORMATS.cTFBC1]=compressedTextures.INTERNAL_FORMATS.COMPRESSED_RGB_S3TC_DXT1_EXT,_a[exports.BASIS_FORMATS.cTFBC3]=compressedTextures.INTERNAL_FORMATS.COMPRESSED_RGBA_S3TC_DXT5_EXT,_a[exports.BASIS_FORMATS.cTFPVRTC1_4_RGB]=compressedTextures.INTERNAL_FORMATS.COMPRESSED_RGB_PVRTC_4BPPV1_IMG,_a[exports.BASIS_FORMATS.cTFPVRTC1_4_RGBA]=compressedTextures.INTERNAL_FORMATS.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG,_a[exports.BASIS_FORMATS.cTFATC_RGB]=compressedTextures.INTERNAL_FORMATS.COMPRESSED_RGB_ATC_WEBGL,_a[exports.BASIS_FORMATS.cTFASTC_4x4]=compressedTextures.INTERNAL_FORMATS.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL,_a),BASIS_FORMAT_TO_TYPE=((_b={})[exports.BASIS_FORMATS.cTFRGBA32]=constants.TYPES.UNSIGNED_BYTE,_b[exports.BASIS_FORMATS.cTFRGB565]=constants.TYPES.UNSIGNED_SHORT_5_6_5,_b[exports.BASIS_FORMATS.cTFRGBA4444]=constants.TYPES.UNSIGNED_SHORT_4_4_4_4,_b),INTERNAL_FORMAT_TO_BASIS_FORMAT=Object.keys(BASIS_FORMAT_TO_INTERNAL_FORMAT).map(function(e){return Number(e)}).reduce(function(e,r){return e[BASIS_FORMAT_TO_INTERNAL_FORMAT[r]]=r,e},{}),BASIS_FORMATS_ALPHA=((_c={})[exports.BASIS_FORMATS.cTFBC3]=!0,_c[exports.BASIS_FORMATS.cTFPVRTC1_4_RGBA]=!0,_c[exports.BASIS_FORMATS.cTFASTC_4x4]=!0,_c);function TranscoderWorkerWrapper(){var e,r={init:function(r){return self.BASIS?(self.BASIS({wasmBinary:r.wasmSource}).then(function(r){r.initializeBasis(),e=r,self.postMessage({type:"init",success:!0})}),null):(console.warn("jsSource was not prepended?"),{type:"init",success:!1})},transcode:function(r){var t=r.basisData,s=new e.BasisFile(t),n=s.getNumImages(),o=s.getHasAlpha()?r.rgbaFormat:r.rgbFormat,a=new Array(n),c=!1;if(!s.startTranscoding())return s.close(),s.delete(),{type:"transcode",requestID:r.requestID,success:!1,imageArray:null};for(var i=0;i<n;i++){for(var u=s.getNumLevels(i),T={imageID:i,levelArray:new Array,width:null,height:null},_=0;_<u;_++){var A=c?14:o,l=s.getImageWidth(i,_),d=s.getImageHeight(i,_),S=s.getImageTranscodedSizeInBytes(i,_,A),R=l+3&-4,f=d+3&-4;0===_&&(T.width=R,T.height=f);var B=new Uint8Array(S);if(!s.transcodeImage(B,i,_,A,!1,!1)){if(c)return console.error("Basis failed to transcode image "+i+", level "+_+"!"),{type:"transcode",requestID:r.requestID,success:!1};console.warn("Basis failed to transcode image "+i+", level "+_+"! Retrying to an uncompressed texture format!"),i=-1,c=!0;break}T.levelArray.push({levelID:_,levelWidth:l,levelHeight:d,levelBuffer:B})}a[i]=T}return s.close(),s.delete(),{type:"transcode",requestID:r.requestID,success:!0,basisFormat:c?14:o,imageArray:a}}};self.onmessage=function(e){var t=e.data,s=r[t.type](t);s&&self.postMessage(s)}}var TranscoderWorker=function(){function e(){var r=this;this.requests={},this.onMessage=function(e){var t=e.data;if("init"===t.type){if(!t.success)throw new Error("BasisResource.TranscoderWorker failed to initialize.");r.isInit=!0,r.onInit()}else if("transcode"===t.type){--r.load;var s=t.requestID;t.success?r.requests[s].resolve(t):r.requests[s].reject(),delete r.requests[s]}},this.isInit=!1,this.load=0,this.initPromise=new Promise(function(e){r.onInit=e}),e.wasmSource||console.warn("PIXI.resources.BasisResource.TranscoderWorker has not been given the transcoder WASM binary!"),this.worker=new Worker(e.workerURL),this.worker.onmessage=this.onMessage,this.worker.postMessage({type:"init",jsSource:e.jsSource,wasmSource:e.wasmSource})}return Object.defineProperty(e,"workerURL",{get:function(){if(!e._workerURL){var r=TranscoderWorkerWrapper.toString(),t=r.indexOf("{"),s=r.lastIndexOf("}");r=r.slice(t+1,s),e.jsSource&&(r=e.jsSource+"\n"+r),e._workerURL=URL.createObjectURL(new Blob([r]))}return e._workerURL},enumerable:!1,configurable:!0}),e.prototype.initAsync=function(){return this.initPromise},e.prototype.transcodeAsync=function(r,t,s){return __awaiter(this,void 0,Promise,function(){var n,o,a=this;return __generator(this,function(c){return++this.load,n=e._tempID++,o=new Promise(function(e,r){a.requests[n]={resolve:e,reject:r}}),this.worker.postMessage({requestID:n,basisData:r,rgbaFormat:t,rgbFormat:s,type:"transcode"}),[2,o]})})},e.loadTranscoder=function(r,t){var s=fetch(r).then(function(e){return e.text()}).then(function(r){e.jsSource=r}),n=fetch(t).then(function(e){return e.arrayBuffer()}).then(function(r){e.wasmSource=r});return Promise.all([s,n]).then(function(r){return e.onTranscoderInitialized.emit(),r})},e.setTranscoder=function(r,t){e.jsSource=r,e.wasmSource=t},e.onTranscoderInitialized=new runner.Runner("onTranscoderInitialized"),e._tempID=0,e}();loaders.LoaderResource.setExtensionXhrType("basis",loaders.LoaderResource.XHR_RESPONSE_TYPE.BUFFER);var BasisLoader=function(){function e(){}return e.use=function(r,t){"basis"===r.extension&&r.data?e.basisBinding||e.TranscoderWorker.wasmSource?e.transcode(r,t):TranscoderWorker.onTranscoderInitialized.add(function(){e.transcode(r,t)}):t()},e.transcode=function(r,t){return __awaiter(this,void 0,Promise,function(){var s,n,o;return __generator(this,function(a){switch(a.label){case 0:return a.trys.push([0,4,,5]),s=r.data,n=void 0,"undefined"!=typeof Worker&&e.TranscoderWorker.wasmSource?[4,e.transcodeAsync(s)]:[3,2];case 1:return n=a.sent(),[3,3];case 2:n=e.transcodeSync(s),a.label=3;case 3:return Object.assign(r,e.registerTextures(r.url,n,r.metadata)),[3,5];case 4:return o=a.sent(),t(o),[2];case 5:return t(),[2]}})})},e.registerTextures=function(e,r,t){var s={textures:{},texture:null};if(!r)return s;var n=BASIS_FORMAT_TO_TYPE[r.basisFormat],o=r.basisFormat!==exports.BASIS_FORMATS.cTFRGBA32?constants.FORMATS.RGB:constants.FORMATS.RGBA;return r.map(function(e){return new core.Texture(new core.BaseTexture(e,Object.assign({mipmap:e instanceof compressedTextures.CompressedTextureResource&&e.levels>1?constants.MIPMAP_MODES.ON_MANUAL:constants.MIPMAP_MODES.OFF,alphaMode:constants.ALPHA_MODES.NO_PREMULTIPLIED_ALPHA,type:n,format:o},t)))}).forEach(function(r,t){var n=r.baseTexture,o=e+"-"+(t+1);core.BaseTexture.addToCache(n,o),core.Texture.addToCache(r,o),0===t&&(core.BaseTexture.addToCache(n,e),core.Texture.addToCache(r,e),s.texture=r),s.textures[o]=r}),s},e.transcodeAsync=function(r){return __awaiter(this,void 0,Promise,function(){var t,s,n,o,a,c,i,u,T,_;return __generator(this,function(A){switch(A.label){case 0:for(t=e.workerPool,s=268435456,n=null,T=0,_=t.length;T<_;T++)t[T].load<s&&(n=t[T],s=n.load);return n||(n=new TranscoderWorker,t.push(n)),[4,n.initAsync()];case 1:return A.sent(),[4,n.transcodeAsync(new Uint8Array(r),e.defaultRGBAFormat.basisFormat,e.defaultRGBFormat.basisFormat)];case 2:if(o=A.sent(),a=o.basisFormat,c=o.imageArray,a>12)i=c.map(function(e){return new core.BufferResource(new Uint16Array(e.levelArray[0].levelBuffer.buffer),{width:e.width,height:e.height})});else for(u=BASIS_FORMAT_TO_INTERNAL_FORMAT[o.basisFormat],i=new Array(c.length),T=0,_=c.length;T<_;T++)i[T]=new compressedTextures.CompressedTextureResource(null,{format:u,width:c[T].width,height:c[T].height,levelBuffers:c[T].levelArray,levels:c[T].levelArray.length});return i.basisFormat=a,[2,i]}})})},e.transcodeSync=function(r){var t=e.basisBinding,s=new Uint8Array(r),n=new t.BasisFile(s),o=n.getNumImages(),a=n.getHasAlpha()?e.defaultRGBAFormat.basisFormat:e.defaultRGBFormat.basisFormat,c=exports.BASIS_FORMATS.cTFRGB565,i=new Array(o),u=e.fallbackMode;if(!n.startTranscoding())return n.close(),n.delete(),null;for(var T=0;T<o;T++){for(var _=u?1:n.getNumLevels(T),A=n.getImageWidth(T,0),l=n.getImageHeight(T,0),d=A+3&-4,S=l+3&-4,R=new Array(_),f=0;f<_;f++){var B=n.getImageWidth(T,f),F=n.getImageHeight(T,f),p=n.getImageTranscodedSizeInBytes(T,0,u?c:a);if(R[f]={levelID:f,levelBuffer:new Uint8Array(p),levelWidth:B,levelHeight:F},n.transcodeImage(R[f].levelBuffer,T,0,u?c:a,!1,!1));else{if(u)break;T=-1,u=!0}}var m=void 0;m=u?new core.BufferResource(new Uint16Array(R[0].levelBuffer.buffer),{width:A,height:l}):new compressedTextures.CompressedTextureResource(null,{format:BASIS_FORMAT_TO_INTERNAL_FORMAT[a],width:d,height:S,levelBuffers:R,levels:_}),i[T]=m}n.close(),n.delete();var I=i;return I.basisFormat=u?c:a,I},e.autoDetectFormats=function(r){if(!r){var t=document.createElement("canvas").getContext("webgl");if(!t)return void console.error("WebGL not available for BASIS transcoding. Silently failing.");r={s3tc:t.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:t.getExtension("WEBGL_compressed_texture_s3tc_srgb"),etc:t.getExtension("WEBGL_compressed_texture_etc"),etc1:t.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:t.getExtension("WEBGL_compressed_texture_atc"),astc:t.getExtension("WEBGL_compressed_texture_astc")}}var s={};for(var n in r){var o=r[n];o&&Object.assign(s,Object.getPrototypeOf(o))}for(var a=0;a<2;a++){var c=!!a,i=void 0,u=void 0;for(var T in s)if(void 0!==(u=INTERNAL_FORMAT_TO_BASIS_FORMAT[i=s[T]])&&(c&&BASIS_FORMATS_ALPHA[u]||!c&&!BASIS_FORMATS_ALPHA[u]))break;i?e[c?"defaultRGBAFormat":"defaultRGBFormat"]={textureFormat:i,basisFormat:u}:(e[c?"defaultRGBAFormat":"defaultRGBFormat"]={textureFormat:constants.TYPES.UNSIGNED_SHORT_5_6_5,basisFormat:exports.BASIS_FORMATS.cTFRGB565},e.fallbackMode=!0)}},e.bindTranscoder=function(r){e.basisBinding=r},e.loadTranscoder=function(r,t){return e.TranscoderWorker.loadTranscoder(r,t)},e.setTranscoder=function(r,t){e.TranscoderWorker.setTranscoder(r,t)},Object.defineProperty(e,"TRANSCODER_WORKER_POOL_LIMIT",{get:function(){return this.workerPool.length||1},set:function(e){for(var r=this.workerPool.length;r<e;r++)this.workerPool[r]=new TranscoderWorker,this.workerPool[r].initAsync()},enumerable:!1,configurable:!0}),e.fallbackMode=!1,e.workerPool=[],e.TranscoderWorker=TranscoderWorker,e}();BasisLoader.autoDetectFormats(),loaders.Loader.registerPlugin(BasisLoader),exports.BASIS_FORMATS_ALPHA=BASIS_FORMATS_ALPHA,exports.BASIS_FORMAT_TO_INTERNAL_FORMAT=BASIS_FORMAT_TO_INTERNAL_FORMAT,exports.BASIS_FORMAT_TO_TYPE=BASIS_FORMAT_TO_TYPE,exports.BasisLoader=BasisLoader,exports.INTERNAL_FORMAT_TO_BASIS_FORMAT=INTERNAL_FORMAT_TO_BASIS_FORMAT;
//# sourceMappingURL=basis.min.js.map
