/*!
 * @pixi/basis - v6.3.0
 * Compiled Wed, 23 Mar 2022 18:58:56 UTC
 *
 * @pixi/basis is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 */
import{LoaderResource as e,Loader as r}from"@pixi/loaders";import{TYPES as t,FORMATS as n,MIPMAP_MODES as s,ALPHA_MODES as o}from"@pixi/constants";import{Texture as a,BaseTexture as i,BufferResource as c}from"@pixi/core";import{INTERNAL_FORMATS as u,CompressedTextureResource as l}from"@pixi/compressed-textures";import{Runner as f}from"@pixi/runner";function d(e,r,t,n){return new(t||(t=Promise))(function(s,o){function a(e){try{c(n.next(e))}catch(e){o(e)}}function i(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){e.done?s(e.value):new t(function(r){r(e.value)}).then(a,i)}c((n=n.apply(e,r||[])).next())})}function T(e,r){var t,n,s,o,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(o){return function(i){return function(o){if(t)throw new TypeError("Generator is already executing.");for(;a;)try{if(t=1,n&&(s=2&o[0]?n.return:o[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,o[1])).done)return s;switch(n=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(s=(s=a.trys).length>0&&s[s.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){a.label=o[1];break}if(6===o[0]&&a.label<s[1]){a.label=s[1],s=o;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(o);break}s[2]&&a.ops.pop(),a.trys.pop();continue}o=r.call(e,a)}catch(e){o=[6,e],n=0}finally{t=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,i])}}}var m,_,h,g;!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444"}(g||(g={}));var B=((m={})[g.cTFETC1]=u.COMPRESSED_RGB_ETC1_WEBGL,m[g.cTFBC1]=u.COMPRESSED_RGB_S3TC_DXT1_EXT,m[g.cTFBC3]=u.COMPRESSED_RGBA_S3TC_DXT5_EXT,m[g.cTFPVRTC1_4_RGB]=u.COMPRESSED_RGB_PVRTC_4BPPV1_IMG,m[g.cTFPVRTC1_4_RGBA]=u.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG,m[g.cTFATC_RGB]=u.COMPRESSED_RGB_ATC_WEBGL,m[g.cTFASTC_4x4]=u.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL,m),v=((_={})[g.cTFRGBA32]=t.UNSIGNED_BYTE,_[g.cTFRGB565]=t.UNSIGNED_SHORT_5_6_5,_[g.cTFRGBA4444]=t.UNSIGNED_SHORT_4_4_4_4,_),R=Object.keys(B).map(function(e){return Number(e)}).reduce(function(e,r){return e[B[r]]=r,e},{}),F=((h={})[g.cTFBC3]=!0,h[g.cTFPVRTC1_4_RGBA]=!0,h[g.cTFASTC_4x4]=!0,h);var p=function(){function e(){var r=this;this.requests={},this.onMessage=function(e){var t=e.data;if("init"===t.type){if(!t.success)throw new Error("BasisResource.TranscoderWorker failed to initialize.");r.isInit=!0,r.onInit()}else if("transcode"===t.type){--r.load;var n=t.requestID;t.success?r.requests[n].resolve(t):r.requests[n].reject(),delete r.requests[n]}},this.isInit=!1,this.load=0,this.initPromise=new Promise(function(e){r.onInit=e}),e.wasmSource||console.warn("PIXI.resources.BasisResource.TranscoderWorker has not been given the transcoder WASM binary!"),this.worker=new Worker(e.workerURL),this.worker.onmessage=this.onMessage,this.worker.postMessage({type:"init",jsSource:e.jsSource,wasmSource:e.wasmSource})}return Object.defineProperty(e,"workerURL",{get:function(){if(!e._workerURL){var r=function(){var e,r={init:function(r){return self.BASIS?(self.BASIS({wasmBinary:r.wasmSource}).then(function(r){r.initializeBasis(),e=r,self.postMessage({type:"init",success:!0})}),null):(console.warn("jsSource was not prepended?"),{type:"init",success:!1})},transcode:function(r){var t=r.basisData,n=new e.BasisFile(t),s=n.getNumImages(),o=n.getHasAlpha()?r.rgbaFormat:r.rgbFormat,a=new Array(s),i=!1;if(!n.startTranscoding())return n.close(),n.delete(),{type:"transcode",requestID:r.requestID,success:!1,imageArray:null};for(var c=0;c<s;c++){for(var u=n.getNumLevels(c),l={imageID:c,levelArray:new Array,width:null,height:null},f=0;f<u;f++){var d=i?14:o,T=n.getImageWidth(c,f),m=n.getImageHeight(c,f),_=n.getImageTranscodedSizeInBytes(c,f,d),h=T+3&-4,g=m+3&-4;0===f&&(l.width=h,l.height=g);var B=new Uint8Array(_);if(!n.transcodeImage(B,c,f,d,!1,!1)){if(i)return console.error("Basis failed to transcode image "+c+", level "+f+"!"),{type:"transcode",requestID:r.requestID,success:!1};console.warn("Basis failed to transcode image "+c+", level "+f+"! Retrying to an uncompressed texture format!"),c=-1,i=!0;break}l.levelArray.push({levelID:f,levelWidth:T,levelHeight:m,levelBuffer:B})}a[c]=l}return n.close(),n.delete(),{type:"transcode",requestID:r.requestID,success:!0,basisFormat:i?14:o,imageArray:a}}};self.onmessage=function(e){var t=e.data,n=r[t.type](t);n&&self.postMessage(n)}}.toString(),t=r.indexOf("{"),n=r.lastIndexOf("}");r=r.slice(t+1,n),e.jsSource&&(r=e.jsSource+"\n"+r),e._workerURL=URL.createObjectURL(new Blob([r]))}return e._workerURL},enumerable:!1,configurable:!0}),e.prototype.initAsync=function(){return this.initPromise},e.prototype.transcodeAsync=function(r,t,n){return d(this,void 0,Promise,function(){var s,o,a=this;return T(this,function(i){return++this.load,s=e._tempID++,o=new Promise(function(e,r){a.requests[s]={resolve:e,reject:r}}),this.worker.postMessage({requestID:s,basisData:r,rgbaFormat:t,rgbFormat:n,type:"transcode"}),[2,o]})})},e.loadTranscoder=function(r,t){var n=fetch(r).then(function(e){return e.text()}).then(function(r){e.jsSource=r}),s=fetch(t).then(function(e){return e.arrayBuffer()}).then(function(r){e.wasmSource=r});return Promise.all([n,s]).then(function(r){return e.onTranscoderInitialized.emit(),r})},e.setTranscoder=function(r,t){e.jsSource=r,e.wasmSource=t},e.onTranscoderInitialized=new f("onTranscoderInitialized"),e._tempID=0,e}();e.setExtensionXhrType("basis",e.XHR_RESPONSE_TYPE.BUFFER);var A=function(){function e(){}return e.use=function(r,t){"basis"===r.extension&&r.data?e.basisBinding||e.TranscoderWorker.wasmSource?e.transcode(r,t):p.onTranscoderInitialized.add(function(){e.transcode(r,t)}):t()},e.transcode=function(r,t){return d(this,void 0,Promise,function(){var n,s,o;return T(this,function(a){switch(a.label){case 0:return a.trys.push([0,4,,5]),n=r.data,s=void 0,"undefined"!=typeof Worker&&e.TranscoderWorker.wasmSource?[4,e.transcodeAsync(n)]:[3,2];case 1:return s=a.sent(),[3,3];case 2:s=e.transcodeSync(n),a.label=3;case 3:return Object.assign(r,e.registerTextures(r.url,s,r.metadata)),[3,5];case 4:return o=a.sent(),t(o),[2];case 5:return t(),[2]}})})},e.registerTextures=function(e,r,t){var c={textures:{},texture:null};if(!r)return c;var u=v[r.basisFormat],f=r.basisFormat!==g.cTFRGBA32?n.RGB:n.RGBA;return r.map(function(e){return new a(new i(e,Object.assign({mipmap:e instanceof l&&e.levels>1?s.ON_MANUAL:s.OFF,alphaMode:o.NO_PREMULTIPLIED_ALPHA,type:u,format:f},t)))}).forEach(function(r,t){var n=r.baseTexture,s=e+"-"+(t+1);i.addToCache(n,s),a.addToCache(r,s),0===t&&(i.addToCache(n,e),a.addToCache(r,e),c.texture=r),c.textures[s]=r}),c},e.transcodeAsync=function(r){return d(this,void 0,Promise,function(){var t,n,s,o,a,i,u,f,d,m;return T(this,function(T){switch(T.label){case 0:for(t=e.workerPool,n=268435456,s=null,d=0,m=t.length;d<m;d++)t[d].load<n&&(s=t[d],n=s.load);return s||(s=new p,t.push(s)),[4,s.initAsync()];case 1:return T.sent(),[4,s.transcodeAsync(new Uint8Array(r),e.defaultRGBAFormat.basisFormat,e.defaultRGBFormat.basisFormat)];case 2:if(o=T.sent(),a=o.basisFormat,i=o.imageArray,a>12)u=i.map(function(e){return new c(new Uint16Array(e.levelArray[0].levelBuffer.buffer),{width:e.width,height:e.height})});else for(f=B[o.basisFormat],u=new Array(i.length),d=0,m=i.length;d<m;d++)u[d]=new l(null,{format:f,width:i[d].width,height:i[d].height,levelBuffers:i[d].levelArray,levels:i[d].levelArray.length});return u.basisFormat=a,[2,u]}})})},e.transcodeSync=function(r){var t=e.basisBinding,n=new Uint8Array(r),s=new t.BasisFile(n),o=s.getNumImages(),a=s.getHasAlpha()?e.defaultRGBAFormat.basisFormat:e.defaultRGBFormat.basisFormat,i=g.cTFRGB565,u=new Array(o),f=e.fallbackMode;if(!s.startTranscoding())return s.close(),s.delete(),null;for(var d=0;d<o;d++){for(var T=f?1:s.getNumLevels(d),m=s.getImageWidth(d,0),_=s.getImageHeight(d,0),h=m+3&-4,v=_+3&-4,R=new Array(T),F=0;F<T;F++){var p=s.getImageWidth(d,F),A=s.getImageHeight(d,F),w=s.getImageTranscodedSizeInBytes(d,0,f?i:a);if(R[F]={levelID:F,levelBuffer:new Uint8Array(w),levelWidth:p,levelHeight:A},s.transcodeImage(R[F].levelBuffer,d,0,f?i:a,!1,!1));else{if(f)break;d=-1,f=!0}}var b=void 0;b=f?new c(new Uint16Array(R[0].levelBuffer.buffer),{width:m,height:_}):new l(null,{format:B[a],width:h,height:v,levelBuffers:R,levels:T}),u[d]=b}s.close(),s.delete();var y=u;return y.basisFormat=f?i:a,y},e.autoDetectFormats=function(r){if(!r){var n=document.createElement("canvas").getContext("webgl");if(!n)return void console.error("WebGL not available for BASIS transcoding. Silently failing.");r={s3tc:n.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:n.getExtension("WEBGL_compressed_texture_s3tc_srgb"),etc:n.getExtension("WEBGL_compressed_texture_etc"),etc1:n.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:n.getExtension("WEBGL_compressed_texture_pvrtc")||n.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:n.getExtension("WEBGL_compressed_texture_atc"),astc:n.getExtension("WEBGL_compressed_texture_astc")}}var s={};for(var o in r){var a=r[o];a&&Object.assign(s,Object.getPrototypeOf(a))}for(var i=0;i<2;i++){var c=!!i,u=void 0,l=void 0;for(var f in s)if(void 0!==(l=R[u=s[f]])&&(c&&F[l]||!c&&!F[l]))break;u?e[c?"defaultRGBAFormat":"defaultRGBFormat"]={textureFormat:u,basisFormat:l}:(e[c?"defaultRGBAFormat":"defaultRGBFormat"]={textureFormat:t.UNSIGNED_SHORT_5_6_5,basisFormat:g.cTFRGB565},e.fallbackMode=!0)}},e.bindTranscoder=function(r){e.basisBinding=r},e.loadTranscoder=function(r,t){return e.TranscoderWorker.loadTranscoder(r,t)},e.setTranscoder=function(r,t){e.TranscoderWorker.setTranscoder(r,t)},Object.defineProperty(e,"TRANSCODER_WORKER_POOL_LIMIT",{get:function(){return this.workerPool.length||1},set:function(e){for(var r=this.workerPool.length;r<e;r++)this.workerPool[r]=new p,this.workerPool[r].initAsync()},enumerable:!1,configurable:!0}),e.fallbackMode=!1,e.workerPool=[],e.TranscoderWorker=p,e}();A.autoDetectFormats(),r.registerPlugin(A);export{g as BASIS_FORMATS,F as BASIS_FORMATS_ALPHA,B as BASIS_FORMAT_TO_INTERNAL_FORMAT,v as BASIS_FORMAT_TO_TYPE,A as BasisLoader,R as INTERNAL_FORMAT_TO_BASIS_FORMAT};
//# sourceMappingURL=basis.min.js.map
